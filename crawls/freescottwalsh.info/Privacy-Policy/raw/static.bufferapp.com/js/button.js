/* Copyright (C) 2012 Buffer */(function(window,document,undefined){var NO_JQUERY={};(function(e,t,n){var r=!0;if(!("console"in e)||r){var i=e.console={};i.log=i.warn=i.error=i.debug=function(){}}t===NO_JQUERY&&(t={fn:{},extend:function(){var e=arguments[0];for(var t=1,n=arguments.length;t<n;t++){var r=arguments[t];for(var i in r)e[i]=r[i]}return e}});t.fn.pm=function(){console.log("usage: \nto send:    $.pm(options)\nto receive: $.pm.bind(type, fn, [origin])");return this};t.pm=e.bufferpm=function(e){s.send(e)};t.pm.bind=e.bufferpm.bind=function(e,t,n,r){s.bind(e,t,n,r)};t.pm.unbind=e.bufferpm.unbind=function(e,t){s.unbind(e,t)};t.pm.origin=e.bufferpm.origin=null;t.pm.poll=e.bufferpm.poll=200;var s={send:function(e){var n=t.extend({},s.defaults,e),r=n.target;if(!n.target){console.warn("postmessage target window required");return}if(!n.type){console.warn("postmessage type required");return}var i={data:n.data,type:n.type};n.success&&(i.callback=s._callback(n.success));n.error&&(i.errback=s._callback(n.error));if("postMessage"in r&&!n.hash){s._bind();r.postMessage(JSON.stringify(i),n.origin||"*")}else{s.hash._bind();s.hash.send(n,i)}},bind:function(n,r,i,o){"postMessage"in e&&!o?s._bind():s.hash._bind();var u=s.data("listeners.postmessage");if(!u){u={};s.data("listeners.postmessage",u)}var f=u[n];if(!f){f=[];u[n]=f}f.push({fn:r,origin:i||t.pm.origin})},unbind:function(e,t){var n=s.data("listeners.postmessage");if(n)if(e)if(t){var r=n[e];if(r){var i=[];for(var o=0,u=r.length;o<u;o++){var a=r[o];a.fn!==t&&i.push(a)}n[e]=i}}else delete n[e];else for(var o in n)delete n[o]},data:function(e,t){if(t===n)return s._data[e];s._data[e]=t;return t},_data:{},_CHARS:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),_random:function(){var e=[];for(var t=0;t<32;t++)e[t]=s._CHARS[0|Math.random()*32];return e.join("")},_callback:function(e){var t=s.data("callbacks.postmessage");if(!t){t={};s.data("callbacks.postmessage",t)}var n=s._random();t[n]=e;return n},_bind:function(){if(!s.data("listening.postmessage")){e.addEventListener?e.addEventListener("message",s._dispatch,!1):e.attachEvent&&e.attachEvent("onmessage",s._dispatch);s.data("listening.postmessage",1)}},_dispatch:function(e){try{var t=JSON.parse(e.data)}catch(n){console.warn("postmessage data invalid json: ",n);return}if(!t.type){console.warn("postmessage message type required");return}var r=s.data("callbacks.postmessage")||{},i=r[t.type];if(i)i(t.data);else{var o=s.data("listeners.postmessage")||{},u=o[t.type]||[];for(var a=0,f=u.length;a<f;a++){var l=u[a];if(l.origin&&e.origin!==l.origin){console.warn("postmessage message origin mismatch",e.origin,l.origin);if(t.errback){var c={message:"postmessage origin mismatch",origin:[e.origin,l.origin]};s.send({target:e.source,data:c,type:t.errback})}continue}try{var h=l.fn(t.data);t.callback&&s.send({target:e.source,data:h,type:t.callback})}catch(n){t.errback&&s.send({target:e.source,data:n,type:t.errback})}}}}};s.hash={send:function(t,n){var r=t.target,i=t.url;if(!i){console.warn("postmessage target window url is required");return}i=s.hash._url(i);var o,u=s.hash._url(e.location.href);if(e==r.parent)o="parent";else try{for(var f=0,l=parent.frames.length;f<l;f++){var c=parent.frames[f];if(c==e){o=f;break}}}catch(h){o=e.name}if(o==null){console.warn("postmessage windows must be direct parent/child windows and the child must be available through the parent window.frames list");return}var p={"x-requested-with":"postmessage",source:{name:o,url:u},postmessage:n},d="#x-postmessage-id="+s._random();r.location=i+d+encodeURIComponent(JSON.stringify(p))},_regex:/^\#x\-postmessage\-id\=(\w{32})/,_regex_len:"#x-postmessage-id=".length+32,_bind:function(){if(!s.data("polling.postmessage")){setInterval(function(){var t=""+e.location.hash,n=s.hash._regex.exec(t);if(n){var r=n[1];if(s.hash._last!==r){s.hash._last=r;s.hash._dispatch(t.substring(s.hash._regex_len))}}},t.pm.poll||200);s.data("polling.postmessage",1)}},_dispatch:function(t){if(!t)return;try{t=JSON.parse(decodeURIComponent(t));if(!(t["x-requested-with"]==="postmessage"&&t.source&&t.source.name!=null&&t.source.url&&t.postmessage))return}catch(n){return}var r=t.postmessage,i=s.data("callbacks.postmessage")||{},o=i[r.type];if(o)o(r.data);else{var u;t.source.name==="parent"?u=e.parent:u=e.frames[t.source.name];var f=s.data("listeners.postmessage")||{},l=f[r.type]||[];for(var c=0,h=l.length;c<h;c++){var p=l[c];if(p.origin){var d=/https?\:\/\/[^\/]*/.exec(t.source.url)[0];if(d!==p.origin){console.warn("postmessage message origin mismatch",d,p.origin);if(r.errback){var v={message:"postmessage origin mismatch",origin:[d,p.origin]};s.send({target:u,data:v,type:r.errback,hash:!0,url:t.source.url})}continue}}try{var m=p.fn(r.data);r.callback&&s.send({target:u,data:m,type:r.callback,hash:!0,url:t.source.url})}catch(n){r.errback&&s.send({target:u,data:n,type:r.errback,hash:!0,url:t.source.url})}}}},_url:function(e){return(""+e).replace(/#.*$/,"")}};t.extend(s,{defaults:{target:null,url:null,type:null,data:null,success:null,error:null,origin:"*",hash:!1}})})(this,typeof jQuery=="undefined"?NO_JQUERY:jQuery);"JSON"in window&&window.JSON||(JSON={});(function(){function f(e){return e<10?"0"+e:e}function quote(e){escapable.lastIndex=0;return escapable.test(e)?'"'+e.replace(escapable,function(e){var t=meta[e];return typeof t=="string"?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}function str(e,t){var n,r,i,s,o=gap,u,a=t[e];a&&typeof a=="object"&&typeof a.toJSON=="function"&&(a=a.toJSON(e));typeof rep=="function"&&(a=rep.call(t,e,a));switch(typeof a){case"string":return quote(a);case"number":return isFinite(a)?String(a):"null";case"boolean":case"null":return String(a);case"object":if(!a)return"null";gap+=indent;u=[];if(Object.prototype.toString.apply(a)==="[object Array]"){s=a.length;for(n=0;n<s;n+=1)u[n]=str(n,a)||"null";i=u.length===0?"[]":gap?"[\n"+gap+u.join(",\n"+gap)+"\n"+o+"]":"["+u.join(",")+"]";gap=o;return i}if(rep&&typeof rep=="object"){s=rep.length;for(n=0;n<s;n+=1){r=rep[n];if(typeof r=="string"){i=str(r,a);i&&u.push(quote(r)+(gap?": ":":")+i)}}}else for(r in a)if(Object.hasOwnProperty.call(a,r)){i=str(r,a);i&&u.push(quote(r)+(gap?": ":":")+i)}i=u.length===0?"{}":gap?"{\n"+gap+u.join(",\n"+gap)+"\n"+o+"}":"{"+u.join(",")+"}";gap=o;return i}}if(typeof Date.prototype.toJSON!="function"){Date.prototype.toJSON=function(e){return this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z"};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(e){return this.valueOf()}}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;typeof JSON.stringify!="function"&&(JSON.stringify=function(e,t,n){var r;gap="";indent="";if(typeof n=="number")for(r=0;r<n;r+=1)indent+=" ";else typeof n=="string"&&(indent=n);rep=t;if(!t||typeof t=="function"||typeof t=="object"&&typeof t.length=="number")return str("",{"":e});throw new Error("JSON.stringify")});typeof JSON.parse!="function"&&(JSON.parse=function(text,reviver){function walk(e,t){var n,r,i=e[t];if(i&&typeof i=="object")for(n in i)if(Object.hasOwnProperty.call(i,n)){r=walk(i,n);r!==undefined?i[n]=r:delete i[n]}return reviver.call(e,t,i)}var j;cx.lastIndex=0;cx.test(text)&&(text=text.replace(cx,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver=="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")})})();document.getElementsByClassName||(document.getElementsByClassName=function(e){if(document.querySelectorAll)return document.querySelectorAll("."+e);var t,n,r,i=[];if(document.evaluate){n=".//[contains(concat(' ', @class, ' '), ' "+e+" ')]";t=document.evaluate(n,document,null,0,null);while(r=t.iterateNext())i.push(r)}else{t=document.getElementsByTagName("*");n=new RegExp("(^|\\s)"+e+"(\\s|$)");for(r=0;r<t.length;r++)n.test(t[r].className)&&i.push(t[r])}return i});var ButtonIframe=function(e){var t=function(){var t=config.button.endpoint.http;if(e.local==="nocache"||e.local==="cache")t=config.button.endpoint.local;var n=!0,r=0;for(var i=0,s=config.attributes.length;i<s;i++){var o=config.attributes[i];if(!e[o.name])continue;if(n){t+="?";n=!1}r+=1;r>1&&(t+="&");t+=o.name+"="+o.encode(e[o.name])}for(var i=0,s=config.button.attributes.length;i<s;i++){var o=config.button.attributes[i];if(n){t+="?";n=!1}r+=1;r>1&&(t+="&");t+=o.name+"="+o.get(e)}return t},n=document.createElement("iframe");n.allowtransparency="true";n.scrolling="no";n.frameBorder="0";n.tabindex="0";n.className="buffer-button";n.style.cssText=config.button.getCSS(e.count);n.src=t();return n},OverlayIframe=function(e,t){var n=function(){var t=config.overlay.endpoint;e.local&&(t=config.overlay.localendpoint);var n=!0,r=0;for(var i=0,s=config.attributes.length;i<s;i++){var o=config.attributes[i];if(!e[o.name])continue;if(n){t+="?";n=!1}r+=1;r>1&&(t+="&");t+=o.name+"="+o.encode(e[o.name])}return t},r=document.createElement("iframe");r.allowtransparency="true";r.scrolling="no";r.id="buffer_overlay";r.name="buffer_overlay";r.style.cssText=config.overlay.getCSS();r.src=n();document.body.appendChild(r);bufferpm.bind("buffermessage",function(e){document.body.removeChild(r);bufferpm.unbind("buffermessage");setTimeout(function(){t(e)},0)})},BufferButton=function(e,t){var n=undefined,r={id:t};for(var i=0,s=config.attributes.length;i<s;i++){var o=config.attributes[i];if(o.name=="id")continue;r[o.name]=o.get(e.getAttribute("data-"+o.name))}n=ButtonIframe(r);e.parentNode.appendChild(n);var u=function(e){e.count>0&&bufferpm({target:n.contentWindow,type:"buffer_update",data:e})};bufferpm.bind("buffer_loaded",function(){setTimeout(function(){bufferpm({target:n.contentWindow,type:"buffer_id",data:{id:t}});bufferpm({target:window,type:"buffer_id",data:{id:t}})},0)});bufferpm.bind("buffer_click_"+t,function(){setTimeout(function(){OverlayIframe(r,u)},0)});return{id:r.id,data:r,element:n}},config={};config.attributes=[{name:"id",get:function(e){return e},encode:function(e){return e}},{name:"url",get:function(e){return!e||e.length<1?window.location.href:e},encode:function(e){return encodeURIComponent(e)}},{name:"text",get:function(e){return!e||e.toString().length<1?document.title:e},encode:function(e){return encodeURIComponent(e)}},{name:"via",get:function(e){return e},encode:function(e){return e}},{name:"count",get:function(e){return!e||e.length<1?"vertical":e!=="vertical"&&e!=="horizontal"?"none":e},encode:function(e){return e}},{name:"picture",get:function(e){return e},encode:function(e){return encodeURIComponent(e)}},{name:"local",get:function(e){return e==="nocache"||e==="cache"?e:!1},encode:function(e){return e==="nocache"?e+"&fresh=true":e}},{name:"placement",get:function(){return"button"},encode:function(e){return encodeURIComponent(e)}}];config.button={endpoint:{http:document.location.protocol+"//widgets.bufferapp.com/button/",local:"http://local.bufferapp.com/button/"},style:"border: none;",getCSS:function(e){return this.style+"width:"+this[e].width+"px;height:"+this[e].height+"px;"},vertical:{width:55,height:62},horizontal:{width:110,height:20},none:{width:55,height:20},attributes:[{name:"utm_source",get:function(e){return encodeURIComponent(window.location.href)}},{name:"utm_medium",get:function(){return"buffer_button"}},{name:"utm_campaign",get:function(){return"buffer"}}]};config.overlay={endpoint:document.location.protocol+"//bufferapp.com/add/",localendpoint:document.location.protocol+"//local.bufferapp.com/add/",getCSS:function(){return"border:none;height:100%;width:100%;position:fixed;z-index:99999999;top:0;left:0;"}};var buttons=[],S4=function(){return((1+Math.random())*65536|0).toString(16).substring(1)},genid=function(){return S4()+S4()+S4()+S4()},links=document.getElementsByClassName("buffer-add-button"),count=0;for(var i=0,l=links.length;i<l;i++){count+=1;buttons.push(BufferButton(links[i],genid()))}for(var i=0;i<count;i++){var link=links[0];link.parentNode.removeChild(link)}})(window,document);