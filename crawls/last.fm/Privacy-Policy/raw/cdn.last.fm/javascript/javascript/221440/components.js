LFM.set("Observable",Class.create({GUI_ACTION_CLASS_PREFIX:"lfmradio",identifier:"You-forgot-to-override-the-identifier-didnt-you?",initialize:function(){this.observers=[];},notifyObservers:function(event){for(var i=0;i<this.observers.length;i++){this.observers[i].notify(event);}},addObserver:function(subscriber){this.observers.push(subscriber);},addGUIActionListener:function(parentElementID){$(parentElementID).observe("click",this._GUIActionHandler.bindAsEventListener(this));},_GUIActionHandler:function(event){var element=event.element();var className="";var called=[];element=LFM.DomSearch.findParentByClassName(element,/lfmradio\:/);if(element){className=element.className;}if(!className){return false;}var matches=className.match(new RegExp(this.GUI_ACTION_CLASS_PREFIX+":([^ ]+)","g"));if(matches&&matches.length){called=[];for(var i=0,ilen=matches.length;i<ilen;i++){var match=matches[i].replace(new RegExp(this.GUI_ACTION_CLASS_PREFIX+":"),"");var handler="_GUIActionHandler"+match.capitalize();if(this[handler]){called.push(match);this[handler](event,element);}else{this.log("No handler implemented for: "+match);}}}if(called.length){return called;}return false;},log:function(){var args=[this.identifier+":"];for(var i=0,ilen=arguments.length;i<ilen;i++){args.push(arguments[i]);}LFM.log.apply(this,args);}}));LFM.set("Observer",Class.create({notify:function(event){}}));LFM.set("Event",Class.create({}));LFM.set("Event",{ShoutComplete:Class.create(LFM.Event,{initialize:function(){this.identifier="ShoutComplete";}}),ShoutCaptchaShown:Class.create(LFM.Event,{initialize:function(){this.identifier="ShoutCaptchaShown";}})});LFM.set("Activityfeed",{DeleteListener:Class.create({initialize:function(){document.observe("click",this.bin.bindAsEventListener(this));},bin:function(event){var link=event.findElement("a.removeActivity");if(!link){return;}event.stop();var itemNameContainer=link.up("li");new Ajax.Request("/ajax/deleteActivity",{parameters:{ajax:1,activities:itemNameContainer.id,formtoken:LFM.Session.formtoken},onComplete:function(resp){var ajaxResponse=new LFM.Ajax.Response(resp);if(ajaxResponse.isSuccess()){itemNameContainer.remove();}}});}})});LFM.set("Activity",{buildFeedItem:function(data){var activity=new Element("ul",{"class":"minifeedSmall"});var li=new Element("li",{"class":data.action});if(data.icon){li.insert(data.icon);}li.insert(data.message);activity.update(li);return activity;}});new LFM.Activityfeed.DeleteListener();LFM.set("Util",{AdblockDetector:Class.create({initialize:function(){},isBlocking:function(){if(LFM.Session.language!="en"){return false;}return this.isABP();},isABP:function(){return this.isEasyList();},isEasyList:function(){if($("footer_ads")&&$("footer_ads").visible()&&$("footer_ads").getStyle("-moz-binding")){return $("footer_ads").getStyle("-moz-binding").include("abp-elemhidehit");}}})});LFM.set("Library",{AddListener:Class.create({options:{},initialize:function(bindTo,options){this.bindTo=$(bindTo);this.bindTo.observe("click",this._onClick.bindAsEventListener(this));Object.extend(this.options,options||{});},_onClick:function(e){var element=e.element();if(!element||!element.hasClassName("lfmAddButton")){return true;}e.stop();this._showDialog(this.options.resource||{url:element.getAttribute("href")});},_showDialog:function(resource){var dialogURL="/ajax/dialog/add";var dialogOptions={resource:resource,onConfirm:this._onConfirmDialog.bindAsEventListener(this)};this._dialog=new LFM.Dialog(dialogOptions);this._dialog.show(dialogURL);},_onConfirmDialog:function(e){}})});LFM.set("Adserver",{getSponsoredByBranding:function(pixelTracker,brandLogo,clickThrough,hidePresentedBy){var brand=new Element("div",{"class":"brand"});if(!hidePresentedBy){var sponsored=new Element("img",{"class":"sponsored",src:LFM.Session.staticHost+"/promotions/notifications_presented_grey.gif",width:88,height:5}).setStyle({padding:"2px 0"});}var tracker=new Element("img",{src:pixelTracker,width:1,height:1}).setStyle({position:"absolute",top:0,left:0,visibility:"hidden"});if(brandLogo){var logo=new Element("img",{src:brandLogo,width:88,height:31});if(clickThrough){logo=logo.wrap(new Element("a",{href:clickThrough,target:"_blank"}));}if(sponsored){brand.insert(sponsored);}brand.insert(logo);}brand.insert(tracker);return brand;},adPlacements:{},registerAd:function(placement){var $placement=$("LastAd_"+placement),that=this;this.adPlacements[placement]={loaded:false,tested:false,height:null};document.observe("dom:loaded",function(){if(!that.testAd(placement,$placement)){Event.observe(window,"load",function(){that.testAd(placement,$placement);});}});},testAd:function(placement,$placement){var loaded=false;if(placement=="skin"||placement=="beacon"){if(/url/i.test($(document.body).getStyle("backgroundImage"))){loaded=true;$(document.body).addClassName("skin-active");}}else{if($placement&&$placement.offsetHeight>5){if(placement=="mpu"&&$placement.offsetHeight>320){$placement.addClassName("ad-mpu--double");}$placement.removeClassName("inactive");$placement.addClassName("active");loaded=true;}}this.adPlacements[placement]={loaded:loaded,tested:true,height:$placement&&$placement.offsetHeight?$placement.offsetHeight:null};return loaded;},isAdActive:function(placement){return !!(this.adPlacements[placement]);}});LFM.set("Library",{AlbumStrip:Class.create({initialize:function(albumstrip){var albumCount=$$("#libraryAlbums ul.albums li").length,visibleAlbums=8,hiddenAlbums=albumCount-visibleAlbums;$("hideAlbums").hide();$$("#libraryAlbums ul.albums li").splice(visibleAlbums,hiddenAlbums).invoke("hide");$("showAlbums").observe("click",function(e){e.preventDefault();$$("#libraryAlbums ul.albums li").invoke("show");this.hide();$("hideAlbums").show();});$("hideAlbums").observe("click",function(e){e.preventDefault();$$("#libraryAlbums ul.albums li").splice(visibleAlbums,hiddenAlbums).invoke("hide");this.hide();$("showAlbums").show();});}})});LFM.set("Analytics",{Tracker:Class.create({ATTRIBUTE_FLAG_CANCEL_EVENT:"data-x-cancel-event",pageIdentifier:null,hostname:null,taggingSource:"",initialize:function(pageIdentifier,hostname){this.pageIdentifier=pageIdentifier;this.hostname=hostname;},bindOutboundLinkListener:function(){$(document).observe("mousedown",this._outboundLinkListener.bind(this));$(document).observe("click",this._clickListener.bind(this));},bindEventListener:function(){$(document).observe("click",this._eventListener.bind(this));},bindSocialListeners:function(){this._bindFacebookListener();this._bindTwitterListener();this._bindPlusoneListener();},_bindFacebookListener:function(){var self=this;LFM.Social.networks.facebook.onLike(function(targetUrl){var resType=self.retrieveResourceTypeForURL(targetUrl);self.trackSocial("facebook","like",resType);});LFM.Social.networks.facebook.onUnlike(function(targetUrl){var resType=self.retrieveResourceTypeForURL(targetUrl);self.trackSocial("facebook","unlike",resType);});LFM.Social.networks.facebook.onSend(function(targetUrl){var resType=self.retrieveResourceTypeForURL(targetUrl);self.trackSocial("facebook","send",resType);});},_bindTwitterListener:function(){var self=this;LFM.Social.networks.twitter.onTweet(function(intent_event){var resType;if(intent_event&&intent_event.target&&intent_event.target.nodeName=="IFRAME"){var url=self.extractParamFromUri(intent_event.target.src,"url");resType=self.retrieveResourceTypeForURL(url);}self.trackSocial("twitter","tweet",resType);});},_bindPlusoneListener:function(){var self=this;LFM.Social.networks.plusone.onPlusone(function(data){var resType=self.retrieveResourceTypeForURL(data.href);self.trackSocial("google","+1",resType);});LFM.Social.networks.plusone.onMinusone(function(data){var resType=self.retrieveResourceTypeForURL(data.href);self.trackSocial("google","-1",resType);});},extractParamFromUri:function(uri,paramName){if(!uri){return;}var regex=new RegExp("[\\?&#]"+paramName+"=([^&#]*)");var params=regex.exec(uri);if(params!=null){return unescape(params[1]);}return;},resTypeUrlMap:{},storeResourceTypeForURL:function(url,resType){var urlA=this.removeEscaping(url);var path=this.getPathFromURL(urlA);this.resTypeUrlMap[path]=resType;},retrieveResourceTypeForURL:function(url){var urlA=this.removeEscaping(url);urlA=this.removeEncoding(urlA);var urlB=this.removeEncoding(url);urlB=this.removeEscaping(urlB);var pathA=this.getPathFromURL(urlA);var pathB=this.getPathFromURL(urlB);if(this.resTypeUrlMap[pathA]){return this.resTypeUrlMap[pathA];}else{return this.resTypeUrlMap[pathB];}},getPathFromURL:function(url){var a=document.createElement("a");a.href=url;return a.pathname.substr(0,1)==="/"?a.pathname:"/"+a.pathname;},removeEscaping:function(url){var i=0;var urlA=url;var urlB;while(urlA!=urlB&&i<20){urlB=urlA;urlA=unescape(urlA);i++;}if(urlA!=urlB){return false;}return urlA;},removeEncoding:function(url){var i=0;var urlA=url;var urlB;while(urlA!=urlB&&i<20){urlB=urlA;try{urlA=decodeURIComponent(urlA);}catch(e){}i++;}if(urlA!=urlB){return false;}return urlA;},track:function(action,label,value){var event=["eT._trackEvent"];event.push(this.pageIdentifier);event.push(action);event.push(label||"");if(value){event.push(parseInt(value));}LFM.log("GA Event:",event);_gaq.push(event);},trackSocial:function(network,socialAction,opt_target){var pageTrackerEvent=["pT._trackSocial"];var eventTrackerEvent=["eT._trackSocial"];pageTrackerEvent.push(network);eventTrackerEvent.push(network);pageTrackerEvent.push(socialAction);eventTrackerEvent.push(socialAction);pageTrackerEvent.push(opt_target);eventTrackerEvent.push(opt_target);pageTrackerEvent.push(this.pageIdentifier);eventTrackerEvent.push(this.pageIdentifier);LFM.log("GA Social Event:",pageTrackerEvent);LFM.log("GA Social Event:",eventTrackerEvent);_gaq.push(pageTrackerEvent,eventTrackerEvent);},_eventListener:function(event){var elm=$(event.target);if(!elm.readAttribute("data-analytics-action")&&!elm.readAttribute("data-analytics-social-network")){elm=elm.up("[data-analytics-action], [data-analytics-social-network]");}if(!elm){return;}if(elm.readAttribute("data-analytics-action")){var action=elm.readAttribute("data-analytics-action");var label=elm.readAttribute("data-analytics-label");var value=elm.readAttribute("data-analytics-value");if(action){this.track(action,label,value);}}else{if(elm.readAttribute("data-analytics-social-network")){var network=elm.readAttribute("data-analytics-social-network");var socialAction=elm.readAttribute("data-analytics-social-action");var resType=elm.readAttribute("data-analytics-social-restype");if(network){this.trackSocial(network,socialAction,resType);}}}},_outboundLinkListener:function(event){var elm=$(event.target);var type=elm.tagName.toLowerCase();if(type=="a"){var href=elm.readAttribute("href");if(this.isOutboundLink(href)&&!elm.readAttribute("onclick")){this.outboundClick(href);var isKeyModifier=event.altKey||event.ctrlKey||event.shiftKey||event.metaKey;var isRadio=window.location.pathname.match(/^\/listen/)?true:false;var isTargetBlank=elm.readAttribute("target")&&elm.readAttribute("target").toLowerCase()=="_blank";var isDisabled=elm.readAttribute("data-analytics-redirect")=="false"?true:false;if(event.isLeftClick()&&!isKeyModifier&&!isRadio&&!isTargetBlank&&!isDisabled){event.stop();elm.writeAttribute(this.ATTRIBUTE_FLAG_CANCEL_EVENT,true);(function(){document.location=href;}).delay(0.3);return false;}}}return true;},_clickListener:function(event){var elm=$(event.target);if(elm.readAttribute(this.ATTRIBUTE_FLAG_CANCEL_EVENT)){event.preventDefault();elm.writeAttribute(this.ATTRIBUTE_FLAG_CANCEL_EVENT,"");}},isOutboundLink:function(href){var regexIsAbsolute=new RegExp("^(https?://|//)","i");var regexIsInternal=new RegExp("^(https?://|//)"+this.hostname,"i");if(href.match(regexIsAbsolute)&&!href.match(regexIsInternal)){return true;}return false;},outboundClick:function(url){this.track("OutboundClick",url);},storeTagSource:function(taggingSource){LFM.log("store tagging source",this.taggingSource);this.taggingSource=taggingSource;},retrieveTagSource:function(){LFM.log("retrieve tagging source",this.taggingSource);return this.taggingSource;},eventAddToLibrary:function(location){this.track("AddToLibrary",location);},eventRemoveFromLibrary:function(location){this.track("RemoveFromLibrary",location);},eventAddFriend:function(count){count=count||1;this.track("AddFriend",null,count);},eventDeleteFriend:function(count){count=count||1;this.track("DeleteFriend",null,count);},eventRejectFriend:function(count){count=count||1;this.track("RejectFriend",null,count);},eventJoinGroup:function(){this.track("JoinGroup");},eventLeaveGroup:function(){this.track("LeaveGroup");},eventMultiBuy:function(){this.track("MultiBuy");},eventBuyDropDown:function(productTypes){this.track("BuyShowOptions",productTypes);},eventAddToPlaylist:function(location){this.track("AddToPlaylist",location);},eventRadioProblem:function(){this.track("RadioProblem");},socialEventShareByEmail:function(resType){this.trackSocial("last.fm","send",resType);},socialEventSecondaryShareByEmail:function(resType){this.trackSocial("last.fm","send_secondary",resType);},eventRadioStillListening:function(){this.track("RadioStillListening");},eventAddTags:function(){this.track("AddTags");},eventClientDownload:function(platform){this.track("ClientDownload",platform);},eventSendMessage:function(){this.track("SendMessage");},eventDeletePlaylist:function(){this.track("DeletePlaylist");},eventShoutPost:function(){this.track("ShoutPost");},eventCommentPost:function(){this.track("CommentPost");},eventPlayTrack:function(type){this.track("PlayTrack",type);},eventPlayTrackFinished:function(type){this.track("PlayTrackFinished",type);},eventEventAttendance:function(status){this.track("EventAttendance",status);},eventLoveTrack:function(source){this.track("LoveTrack",source);},eventUnloveTrack:function(source){this.track("UnloveTrack",source);},eventBanTrack:function(source){this.track("BanTrack",source);},eventSkipTrack:function(source){this.track("SkipTrack",source);},eventPauseTrack:function(source){this.track("PauseTrack",source);},eventStartStation:function(){this.track("StartStation");},eventRadioMetadataClick:function(location){this.track("RadioMetadataClick",location);},eventRadioPaneSwitch:function(pane){this.track("RadioPaneSwitch",pane);},eventRadioError:function(error){this.track("RadioError",error);},eventRadioVideoAdStart:function(type){this.track("RadioVideoAdStart",type);},eventRadioVideoAdComplete:function(type){this.track("RadioVideoAdComplete",type);},eventPromobarLink:function(barName){this.track("PromobarLink",barName);},eventPromobarDismiss:function(barName){this.track("PromobarDismiss",barName);},eventFacebookBootstrapEdit:function(){this.track("FacebookBootstrapEdit");},eventFacebookBootstrapImageToggle:function(){this.track("FacebookBootstrapImageToggle");},eventPaintItBlack:function(){this.track("ColourToggle","PaintItBlack");},eventSimplyRed:function(){this.track("ColourToggle","SimplyRed");},eventGoingToEvent:function(){this.track("GoingToEvent");},eventInterestedInEvent:function(){this.track("InterestedInEvent");},eventNotGoingToOrInterestedInEvent:function(){this.track("NotGoingToOrInterestedInEvent");},eventDiscoverShareEmail:function(){this.track("DiscoverShareEmail");},eventDiscoverShareFacebook:function(){this.track("DiscoverShareFacebook");},eventDiscoverShareTwitter:function(){this.track("DiscoverShareTwitter");},eventDiscoverJumpListClick:function(){this.track("DiscoverJumpListClick");},eventDiscoverPinnedButtonClick:function(){this.track("DiscoverJumpListClick");},eventDiscover:function(name,value){if(typeof value=="undefined"){this.track("Discover"+name);}else{this.track("Discover"+name,value);}},eventWikiReadMore:function(){this.track("ReadMore","Wiki");},eventVideoPlay:function(player){this.track("VideoPlay",player);}})});LFM.set("Form",{Attachbutton:Class.create({initialize:function(button,options){this.button=$(button);if(!options){options={};}this.options=options;this._bindToButton();},_bindToButton:function(){Event.observe(this.button,"click",function(e){Event.stop(e);var picker=new LFM.Form.ResourcePicker({onSelect:this._onSelect.bind(this)});picker.show();}.bindAsEventListener(this));},_onSelect:function(res){if(res){this._appendAttachment(res.type,res.id);}},_appendAttachment:function(type,id){if(!this.itemcontainer&&this.options.itemcontainer){this.itemcontainer=$(this.options.itemcontainer);}if(this.itemcontainer){this.itemcontainer.show();this.itemcontainer.down("img.progress").show();new Ajax.Request("/ajax/attachment",{method:"get",parameters:"type="+type+"&id="+id,onComplete:this._appendAttachmentCallback.bind(this)});}var form=this.button.up("form");if(form){var attachmenttypeInput=form.down("input[name=attachmenttype]");var attachmentidInput=form.down("input[name=attachmentid]");if(!attachmenttypeInput){var attachmenttypeInput=document.createElement("input");attachmenttypeInput.setAttribute("type","hidden");attachmenttypeInput.setAttribute("name","attachmenttype");var attachmentidInput=document.createElement("input");attachmentidInput.setAttribute("type","hidden");attachmentidInput.setAttribute("name","attachmentid");attachmenttypeInput.setAttribute("value",type);attachmentidInput.setAttribute("value",id);form.appendChild(attachmenttypeInput);form.appendChild(attachmentidInput);}else{attachmenttypeInput.setAttribute("value",type);attachmentidInput.setAttribute("value",id);}}},_appendAttachmentCallback:function(req){var result=req.responseText.evalJSON();if(this.itemcontainer){this.itemcontainer.insert({top:result.attachment});this.itemcontainer.down("img.progress").hide();}}})});LFM.set("Button",{MultiButton:{setup:function(){this.activeButton=false;this.menu=$("multiButtonMenu");this.loadedInfo=$H();this.menu.observe("click",this.observeMenu.bindAsEventListener(this));$(document.body).observe("click",this.observeDocument.bindAsEventListener(this));this.clickOffObserver=this.clickOff.bindAsEventListener(this);this.parentIsUser=LFM.ParentResource&&LFM.ParentResource.type==4;this.parentIsLoggedInUser=LFM.Session.loggedIn&&this.parentIsUser&&LFM.ParentResource.name==LFM.Session.userName;this.loving={};},observeDocument:function(e){var button=e.findElement("a.lfmMultiButton");if(!button){return false;}e.stop();if(this.activeButton&&this.activeButton!=button){this.clickOff();}else{if(this.activeButton&&this.activeButton==button){this.clickOff();return;}}this.activeButton=button;if(this.activeButton.hasClassName("lfmSmallButton")){this.activeButton.addClassName("lfmSmallActiveMultiButton");}else{this.activeButton.addClassName("lfmBigActiveMultiButton");}if(this.activeButton.hasClassName("mBuy")){this.updatePriceFromAjax();}if(LFM.Session.loggedIn&&!this.parentIsLoggedInUser&&button.hasClassName("lfmButtonFortrack")){this.updateMenuFromAjax(this.activeButton);}else{this.showMenu(this.activeButton);}document.observe("click",this.clickOffObserver);},clickOff:function(){this.hideMenu(this.activeButton);this.activeButton.removeClassName("lfmSmallActiveMultiButton");this.activeButton.removeClassName("lfmBigActiveMultiButton");this.activeButton=false;var firstChild=this.menu.down("li.mBuy a span");if(firstChild){firstChild.remove();}document.stopObserving("click",this.clickOffObserver);},updatePriceFromAjax:function(){this.menu.down("li.mBuy a").insert(' <img class="loading" src="'+LFM.Session.staticHost+'/flatness/spinner_13x13.gif" height="7" />');var request=new Ajax.Request("/ajax/affiliableprice",{parameters:{url:this.activeButton.href,cachebuster:Math.round(Math.random()*100)},method:"get",onComplete:function(response){this.menu.down("li.mBuy a img").remove();if(response.responseText){this.menu.down("li.mBuy a").insert(" "+response.responseText);}}.bind(this)});},updateMenuFromAjax:function(button){var button=button;if(this.loadedInfo.get(button.href)){button.className=this.loadedInfo.get(button.href);this.sortOutClassNames(button);this.showMenu(button);}else{var request=new Ajax.Request("/ajax/library/gettrackinfo",{parameters:{url:button.href,cachebuster:Math.round(Math.random()*100)},method:"get",onComplete:function(response){var ajaxResponse=new LFM.Ajax.Response(response);if(ajaxResponse.isSuccess()){if(ajaxResponse.get("loved")){button.removeClassName("mLove");button.addClassName("mUnlove");}else{button.addClassName("mLove");button.removeClassName("mUnlove");}if(ajaxResponse.get("banned")){button.removeClassName("mBan");button.addClassName("mUnban");}else{if(button.hasClassName("lfmMultiButtonAllowBan")){button.addClassName("mBan");}button.removeClassName("mUnban");}if(button.hasClassName("lfmMultiButtonFull")){if(ajaxResponse.get("playcount")!==null){button.addClassName("mRemoveFromLibrary");button.removeClassName("mAddToLibrary");}else{button.removeClassName("mRemoveFromLibrary");button.addClassName("mAddToLibrary");}}this.loadedInfo.set(button.href,button.className);}if(button==this.activeButton&&!request.shown){this.sortOutClassNames(button);this.showMenu(button);}}.bind(this)});(function checkTimeout(){if(!(request&&request.getStatus()==200)&&button==this.activeButton){request.shown=true;this.sortOutClassNames(button);this.showMenu(button);}}).bind(this).delay(0.5);}},showMenu:function(button,options){var options=options||{};var position=button.cumulativeOffset();var pagePosition=$("page").hasClassName("page-hack")?$$("body")[0].cumulativeOffset():$("page").cumulativeOffset();position.left=position.left-7-pagePosition.left;position.top=position.top+button.getHeight()-pagePosition.top;var minwidth=this.activeButton.getWidth();if(Prototype.Browser.IE){if(window.external&&typeof window.XMLHttpRequest=="undefined"){position.left=position.left-35;}else{if(button.hasClassName("lfmSmallMultiButton")&&button.up("div.module")){position.left=position.left-15;}}}this.menu.setStyle({top:position.top+"px",left:position.left+"px"});var list=this.menu.down("ul");minwidth=minwidth-list.getStyle("border-left-width").toPixels()-list.getStyle("border-right-width").toPixels()-list.getStyle("padding-left").toPixels()-list.getStyle("padding-right").toPixels();list.setStyle({minWidth:minwidth+"px"});$w("tr li").each(function(nodeName){var element=button.up(nodeName);if(element){element.addClassName("open");}});var customClass=options.showLoadingState?"mLoading":false;this.sortOutClassNames(button,customClass);this.menu.show();},hideMenu:function(button){$w("tr li").each(function(nodeName){var element=button.up(nodeName);if(element){element.removeClassName("open");}});this.menu.down("ul").setStyle({minWidth:"0px"});this.menu.hide();},sortOutClassNames:function(button,custom){if(custom){this.menu.className=custom;this.menu.down("div").className=custom;}else{var innerClass=button.className.match(/\blfmButtonFor([a-z]*)\b/)[1];innerClass+="MultiMenu";this.menu.className=innerClass;var containerClass=button.className;this.menu.down("div").className=containerClass;}},observeMenu:function(e){e.stop();var clickSource=this.activeButton.hasClassName("lfmBigMultiButton")?"moreBtn":"multiBtn";LFM.Page.Tracker.storeTagSource(clickSource);var action=e.findElement("li").className;if(Prototype.Browser.IE){action=action.replace(/\b\w*hover_/gi,"").strip();}switch(action){case"mSave":LFM.Save({url:this.activeButton.href});break;case"mObsess":LFM.Obsess({url:this.activeButton.href});break;case"mAddToPlaylist":LFM.Playlist({url:this.activeButton.href});break;case"mAddTags":LFM.Tag({url:this.activeButton.href});break;case"mAddToFriends":case"mAddToLibrary":LFM.Add({url:this.activeButton.href});break;case"mRemoveFromLibrary":LFM.RemoveFromLibrary({url:this.activeButton.href},{onDone:function(response){var LibraryDeleteListener=LFM.get("Page","LibraryDeleteListener");var LibraryRemoveTagFromItemListener=LFM.get("Page","LibraryRemoveTagFromItemListener");if(LibraryDeleteListener){LibraryDeleteListener.onDone(response);}if(LibraryRemoveTagFromItemListener){LibraryRemoveTagFromItemListener.onSuccess(response);}}});break;case"mSend":LFM.Send({url:this.activeButton.href},{parameters:{secondary:true}});break;case"mEditDetails":location.href=LFM.ParentResource.url+"/settings";break;case"mMessageAll":location.href=LFM.ParentResource.url+"/messageall";break;case"mEditPermissions":location.href=LFM.ParentResource.url+"/permissions";break;case"mAbdicate":location.href=LFM.ParentResource.url+"/abdicate";break;case"mLeave":LFM.Leave({url:this.activeButton.href},{parameters:{leave:1}});break;case"mLove":this.love.bind(this)(this.activeButton,true);break;case"mUnlove":this.love.bind(this)(this.activeButton,false);break;case"mBan":this.ban.bind(this)(this.activeButton,true);break;case"mUnban":this.ban.bind(this)(this.activeButton,false);break;case"mBuy":LFM.BuyDialog({url:this.activeButton.href});break;default:LFM.Page.Tracker.storeTagSource("");break;}this.clickOff();},love:function(href,loved){var button=this.activeButton,that=this;if(this.loving[button.href]){return;}this.loving[button.href]=true;new Ajax.Request("/ajax/library/love",{parameters:{ajax:true,url:button.href,loved:loved,formtoken:LFM.Session.formtoken},onComplete:function(){delete that.loving[button.href];},onSuccess:function(response){var ajaxResponse=new LFM.Ajax.Response(response);if(ajaxResponse.isSuccess()){var tableRow=button.up("tr");var listItem=button.up("li");if(tableRow){if(tableRow.hasClassName("odd")&&tableRow.up("table").hasClassName("chart")){var endcolor="#f4f4f4";}else{var endcolor="#ffffff";}}if((!this.parentIsUser||this.parentIsLoggedInUser)&&tableRow){var lovedContainer=tableRow.down("td.lovedCell");}else{if(LFM.ParentResource&&LFM.ParentResource.type==9&&$("lovedIndicator")){if(loved){if(LFM.Page.onAddToLibrary){LFM.Page.onAddToLibrary(ajaxResponse);}$("lovedIndicator").show();}else{$("lovedIndicator").hide();}}}this.loadedInfo.unset(button.href);if(loved){LFM.Page.Tracker.eventLoveTrack("Page");button.removeClassName("mLove");button.addClassName("mUnlove");if(lovedContainer){lovedContainer.insert({top:LFM.Element.icon_loved_indicator});}if(listItem){listItem.addClassName("loved");}}else{button.addClassName("mLove");button.removeClassName("mUnlove");if(lovedContainer){var lovedIcon=lovedContainer.down("img.loved_indicator_icon");if(lovedIcon){lovedIcon.remove();}}if(listItem){listItem.removeClassName("loved");}}if(lovedContainer){new Effect.Highlight(tableRow,{endcolor:endcolor,afterFinish:function(object){object.element.removeAttribute("style");}});}if(LFM.LazyLoading.eventMediator){var event=loved?"user.loved":"user.unloved";LFM.LazyLoading.eventMediator.publish(event,{track_url:button.href});}}}.bind(this)});},ban:function(href,banned){var button=this.activeButton;new Ajax.Request("/ajax/library/ban",{parameters:{ajax:true,url:button.href,banned:banned,formtoken:LFM.Session.formtoken},onSuccess:function(response){var ajaxResponse=new LFM.Ajax.Response(response);if(ajaxResponse.isSuccess()){var tableRow=button.up("tr");if(tableRow){if(tableRow.hasClassName("odd")&&tableRow.up("table").hasClassName("chart")){var endcolor="#f4f4f4";}else{var endcolor="#ffffff";}}if(LFM.ParentResource){if(this.parentIsLoggedInUser&&tableRow){var bannedContainer=tableRow.down("td.bannedCell");}else{if(LFM.ParentResource.type==9&&$("bannedIndicator")){if(banned){$("bannedIndicator").show();}else{$("bannedIndicator").hide();}}}}this.loadedInfo.unset(button.href);if(banned){if(bannedContainer){bannedContainer.insert({top:LFM.Element.icon_banned_indicator});}}else{if(bannedContainer){var bannedIcon=bannedContainer.down("img.banned_indicator_icon");if(bannedIcon){bannedIcon.remove();}}}if(tableRow){new Effect.Fade(tableRow,{duration:0.5});}}}.bind(this)});}},affiliations:{"suppliers[]":[],"restypes[]":[],"resids[]":[]},pushAffiliation:function(supplier,restype,resid){LFM.Button.affiliations["suppliers[]"].push(supplier);LFM.Button.affiliations["restypes[]"].push(restype);LFM.Button.affiliations["resids[]"].push(resid);}});LFM.set("Input",{Captcha:Class.create({captchaId:null,initialize:function(id){this.captchaId=id;$("recaptcha_response_field").observe("focus",function(){$(id).select(".fieldstatus").invoke("show");});},show:function(callback){$(this.captchaId).blindDown({duration:0.5,afterFinish:function(){$("recaptcha_response_field").focus();callback&&callback();}});},hide:function(){$(this.captchaId).blindUp();},isVisible:function(){return $(this.captchaId).visible();},reload:function(){if(typeof Recaptcha==="object"){Recaptcha.reload();}},destroy:function(){Recaptcha.destroy();$("recaptcha_response_field").stopObserving();}})});LFM.set("Charts",{Switch:Class.create({initialize:function(container,parameters){this.container=$(container);this.parameters=parameters;this.morelink=this.container.select("span.moduleOptions a")[0]||false;this.cachedcharts=new Hash();this.container.down("div.horizontalOptions").observe("click",this.switchChartEvent.bindAsEventListener(this));this.container.select("div.chart").each(function(chart){var rangetype=this.getRangeTypeFromClassName(chart.className);if(rangetype){this.cachedcharts.set(rangetype,chart);}}.bind(this));},switchChartEvent:function(event){var clickedLink=event.element();if(!clickedLink.match("a")){return;}event.stop();var listItem=clickedLink.up("li");if(listItem.hasClassName("current")){return;}this.container.down("div.horizontalOptions ul").childElements().invoke("removeClassName","current");listItem.addClassName("current");var rangetype=this.getRangeTypeFromClassName(listItem.className);this.switchChart(rangetype);},refresh:function(){this.cachedcharts=new Hash();this.switchChart();},switchChart:function(rangetype){if(rangetype&&this.cachedcharts.get(rangetype)){this.cachedcharts.each(function(pair){pair.value.hide();});this.cachedcharts.get(rangetype).show();if(this.morelink){this.morelink.href=this.container.down("ul li.chart"+rangetype+" a").href;}}else{var parameters=Object.extend(this.parameters,{rangetype:rangetype,ajax:1,cachebuster:Math.round(Math.random()*100)});new Ajax.Request("/module",{method:"get",parameters:parameters,onComplete:function(t){var response=new LFM.Ajax.Response(t);if(response.isSuccess()){this.container.insert({bottom:response.get("content").strip()});var reset=!rangetype;var newChart=this.container.childElements().last();ieHover.add(newChart);if(!rangetype){rangetype=this.getRangeTypeFromClassName(newChart.className);this.container.down("div.horizontalOptions ul").childElements().invoke("removeClassName","current");this.container.down("div.horizontalOptions ul li.chart"+rangetype).addClassName("current");}this.cachedcharts.set(rangetype,newChart);if(this.morelink){this.morelink.up().insert({before:this.cachedcharts.get(rangetype)});}if(reset){this.container.select("div.chart").each(function(chart){if(chart!=newChart){chart.remove();}}.bind(this));}this.cachedcharts.each(function(pair){if(pair.key!=rangetype){pair.value.hide();}});this.cachedcharts.get(rangetype).show().setStyle({visibility:"visible"});if(this.morelink){this.morelink.href=this.container.down("ul li.chart"+rangetype+" a").href;}this.container.removeClassName("loading");}}.bind(this),onCreate:function(){this.container.addClassName("loading");}.bind(this),onFailure:function(){this.container.removeClassName("loading");}.bind(this)});}},getRangeTypeFromClassName:function(className){var rangetype=className.match(/chart[^ ]+/)[0];return rangetype.substr(5);}})});var ClickTaleTagBuffer=[];function BufferedClickTaleTag(tag){if(typeof ClickTaleTag=="function"){ClickTaleTag(tag);}else{ClickTaleTagBuffer.push(tag);}}Event.observe(document,"dom:loaded",function(){setTimeout(function(){if(typeof ClickTaleTag=="function"){for(var i=0;i<ClickTaleTagBuffer.length;i++){ClickTaleTag(ClickTaleTagBuffer[i]);}}else{setTimeout(arguments.callee,100);}},100);if(/\/\+images\/\d+/.test(document.location.pathname)){BufferedClickTaleTag("Image Selected");}else{if(/\/\+images$/.test(document.location.pathname)){BufferedClickTaleTag("Image Gallery");}else{if(/\/\+similar/.test(document.location.pathname)){BufferedClickTaleTag("Similar Artists");}else{if(/\/\+wiki/.test(document.location.pathname)){BufferedClickTaleTag("Biorgaphy");}else{if(/\/\+videos/.test(document.location.pathname)){BufferedClickTaleTag("Video Selected");}else{if(LFM.Page.Tracker.pageIdentifier=="Music/Album/Overview"){BufferedClickTaleTag("Album Overview");}else{if(LFM.Page.Tracker.pageIdentifier=="Music/Track/Overview"){BufferedClickTaleTag("Track Overview");}else{if(LFM.Page.Tracker.pageIdentifier=="Music/Artist/Overview"){BufferedClickTaleTag("Artist Overview");}}}}}}}}if(LFM.Session.userName==undefined){BufferedClickTaleTag("Not Logged In");}else{BufferedClickTaleTag("Logged In");}if(document.getElementById("idBadgerDropper")){Event.observe("idBadgerDropper","click",function(event){var code="document.getElementById('idBadgerDropper').click();";if(typeof ClickTaleExec=="function"){ClickTaleExec(code);}});}if(document.getElementById("headerLangToggle")){Event.observe("headerLangToggle","click",function(event){var code="document.getElementById('headerLangToggle').click();";if(typeof ClickTaleExec=="function"){ClickTaleExec(code);}});}if(document.getElementById("colourToggle")){Event.observe("colourToggle","click",function(event){var code="document.getElementById('colourToggle').click();";if(typeof ClickTaleExec=="function"){ClickTaleExec(code);}});}});LFM.set("Display",{CollapsibleBox:Class.create({initialize:function(){var containers=$$(".collapsibleBox");containers.each(function(container){container.observe("click",this.clickHandler.bindAsEventListener(this));container.observe("mouseover",this.focusHandler.bindAsEventListener(this));container.observe("mouseout",this.blurHandler.bindAsEventListener(this));if(Modernizr.csstransitions){var boxbody=this.getBoxBody(container);boxbody.observe(this.getTransitionEndEventName(),this.transitionEndHandler.bindAsEventListener(this));setTimeout(function(){boxbody.addClassName("s-animated");});}},this);},getBoxBodyInner:function(container){return container.down(".collapsibleBox-body-inner");},getBoxBody:function(container){return container.down(".collapsibleBox-body");},getContainerFromEvent:function(e){var target=$(e.target);if(target.hasClassName("collapsibleBox")){return target;}else{return target.up(".collapsibleBox");}},getTransitionEndEventName:function(){var transEndEventNames={"WebkitTransition":"webkitTransitionEnd","MozTransition":"transitionend","OTransition":"oTransitionEnd","msTransition":"msTransitionEnd"};transEndEventName=transEndEventNames[Modernizr.prefixed("transition")];return transEndEventName?transEndEventName:"transitionEnd";},open:function(container){var boxbody=this.getBoxBody(container);var boxbodyInner=this.getBoxBodyInner(container);this.activateBoxBody(container);if(Modernizr.csstransitions){boxbody.setStyle({height:boxbodyInner.getHeight()+"px"});this.positionBodyInnerForAnimation(container);}else{this.positionBodyInnerForReflow(container);}container.removeClassName("s-closed");container.addClassName("s-open");Event.fire(container,"CollapsibleBox:open");},close:function(container){var boxbody=this.getBoxBody(container);var boxbodyInner=this.getBoxBodyInner(container);if(!Modernizr.csstransitions&&!container.hasClassName("s-hover")){this.deactivateBoxBody(container);}this.positionBodyInnerForAnimation(container);if(Modernizr.csstransitions){boxbody.removeClassName("s-animated");boxbody.setStyle({height:boxbodyInner.getHeight()+"px"});setTimeout(function(){boxbody.addClassName("s-animated");container.removeClassName("s-open");container.addClassName("s-closed");Event.fire(container,"CollapsibleBox:close");},0);}else{container.removeClassName("s-open");container.addClassName("s-closed");Event.fire(container,"CollapsibleBox:close");}},deactivateBoxBody:function(container){var boxbodyInner=this.getBoxBodyInner(container);$(boxbodyInner).setStyle({display:"none"});},activateBoxBody:function(container){var boxbodyInner=this.getBoxBodyInner(container);$(boxbodyInner).setStyle({display:"block"});},positionBodyInnerForAnimation:function(container){var boxbodyInner=this.getBoxBodyInner(container);boxbodyInner.setStyle({position:"absolute"});},positionBodyInnerForReflow:function(container){var boxbodyInner=this.getBoxBodyInner(container);boxbodyInner.setStyle({position:"relative"});},clickHandler:function(e){var target=$(e.target);var container=this.getContainerFromEvent(e);if(container&&container.hasClassName("s-closed")){e.preventDefault();this.open(container);}else{if(target.hasClassName(".collapsibleBox-heading")||target.up(".collapsibleBox-heading")){e.preventDefault();if(container&&container.hasClassName("s-open")){this.close(container);}else{if(container){this.open(container);}}}}},focusHandler:function(e){var container=this.getContainerFromEvent(e);if(container){if(container.hasClassName("s-closed")){this.activateBoxBody(container);}container.addClassName("s-hover");}},blurHandler:function(e){var container=this.getContainerFromEvent(e);if(container){container.removeClassName("s-hover");if(!Modernizr.csstransitions&&container.hasClassName("s-closed")){this.deactivateBoxBody(container);}}},transitionEndHandler:function(e){var container=this.getContainerFromEvent(e);var boxbody=this.getBoxBody(container);var boxbodyInner=this.getBoxBodyInner(container);if(container.hasClassName("s-open")){if(Modernizr.csstransitions){boxbody.removeClassName("s-animated");boxbody.setStyle({height:""});this.positionBodyInnerForReflow(container);setTimeout(function(){boxbody.addClassName("s-animated");},0);}}if(container.hasClassName("s-closed")){if(!container.hasClassName("s-hover")){this.deactivateBoxBody(container);}}}})});LFM.set("Display",{DismissRec:Class.create({DURATION:0.3,initialize:function(){},setQueue:function(queue){if(!queue){throw new Error("A queue is required, undo feature is not optional");}this.queue=queue;},observeAll:function(){var self=this;var forms=$$(".dismissRec");forms.invoke("observe","submit",this.onSubmit.bind(this));},onSubmit:function(ev){ev.preventDefault();var form=Event.element(ev);var id=this.queue.add(this.dismiss.bind(this).curry(form),true);var self=this;this.displayShim(form,id,function(){self.queue.start(id);});return false;},displayShim:function(form,id,callback){var container=Element.up(form,".recommended");var el=new Element("div");var shimType=form.readAttribute("data-shimtype");var self=this;el.addClassName("undo");this.render(form,container,el,callback);if(shimType==="resize"&&this.resizeSupport(container)){this.bindOnClickForResize(id,container,el);container.style.overflow="hidden";new Effect.Morph(container,{duration:this.DURATION,style:"height: 40px;"});new Effect.Morph(el,{duration:this.DURATION,style:"height: 40px;"});}else{this.bindOnClickForReveal(id,container,el);}},resizeSupport:function(container){var height=parseInt(container.getHeight(),10);var pTop=parseInt(container.getStyle("paddingTop"),10);var pBot=parseInt(container.getStyle("paddingBottom"),10);var bTop=parseInt(container.getStyle("borderTopWidth"),10);var bBot=parseInt(container.getStyle("borderBottomWidth"),10);var cssHeight=container.style.height,result;var targetHeight=(height-1-pTop-pBot-bTop-bBot)+"px";container.style.height=targetHeight;result=container.getHeight()<height;container.style.height=cssHeight;return result;},render:function(form,container,el,callback){var msg;var name=Element.select(container,"[data-title]").first();var data={recType:$F(form["recType"]).capitalize(),name:name&&name.innerText};var self=this;if(self.template){var msg=Mustache.render(this.template,data);this.insertShim(msg,form,container,el);if(callback){callback();}}else{new Ajax.Request("/recommendations/tmpl/undo",{onSuccess:function(response){self.template=response.responseText;var msg=Mustache.render(self.template,data);self.insertShim(msg,form,container,el);if(callback){callback();}}});}},insertShim:function(msg,form,container,el){el.insert(msg);el.setStyle({height:container.getHeight()+"px",width:container.getWidth()+"px"});form.insert({after:el});},bindOnClickForResize:function(id,container,el){var height=container.getHeight();var self=this;el.observe("click",function(ev){if(ev.target.tagName.toLowerCase()!=="a"){return;}ev.preventDefault();self.queue.del(id);new Effect.Morph(container,{duration:self.DURATION,style:"height: "+height+"px;"});new Effect.Morph(el,{duration:self.DURATION,style:"height: "+height+"px;",queue:{position:"end",scope:"undo"+container.id}});new Effect.Fade(el,{duration:self.DURATION,queue:{position:"end",scope:"undo"+container.id},afterFinish:function(){el.remove();}});});},bindOnClickForReveal:function(id,container,el){var self=this;el.observe("click",function(ev){if(ev.target.tagName.toLowerCase()!=="a"){return;}ev.preventDefault();self.queue.del(id);new Effect.Fade(el,{duration:self.DURATION,afterFinish:function(){el.remove;}});});},dismiss:function(form,async){var self=this;var rec=Element.up(form,".recommended");form.request({parameters:{ajax:true},asynchronous:!!async,onException:function(response,error){LFM.log("onException(",response,error,")");},onSuccess:function(response){if((new LFM.Ajax.Response(response)).isSuccess()){self.hideUndo(rec.down(".undo"));}},onFailure:function(response){LFM.log("onFailure(",response,")");}});},hideUndo:function(undoEl){var link=undoEl.select("a").first();var p=undoEl.select("p").first();link&&link.fade({duration:this.DURATION});p&&p.morph("opacity: 0.6");undoEl.stopObserving("click");},remove:function(el){var undo=el.down(".undo");undo.stopObserving("click");switch(el.tagName.toLowerCase()){case"tr":this.removeTableRow(el);break;case"li":case"div":this.removeElement(el);break;default:throw new Error("No method for removing a tag of type "+el.tagName.toLowerCase());break;}},removeTableRow:function(row){var below=row.next();var above=row.previous();row.blindUp({duration:0.3,queue:{position:"end",scope:"row"+row.id},afterFinish:function(){row.remove();}});if((above&&above.down("th"))&&(!below||below.down("th"))){above.fade({duration:0.3,queue:{position:"end",scope:"row"+row.id},afterFinish:function(){above.remove();}});}},removeElement:function(el){el.blindUp({duration:0.3,afterFinish:function(){el.remove();}});}})});document.observe("dom:loaded",function(){dis=new LFM.Display.DismissRec();dis.setQueue(new LFM.Util.UndoQueue({"window":window}));dis.observeAll();});LFM.set("Display",{candyStripe:function(container,options){var options=options||false;if(is_array(container)){var rows=container;}else{container=$(container);if(options.selector){var rows=container.select(options.selector);}else{if(container.tagName=="TABLE"){container=container.down("tbody");}var rows=container.childElements();}}if(rows.length>0){rows[0].up("table").addClassName("candyStriped");rows.each(function(row,i){if(i%2){row.removeClassName("odd");}else{row.addClassName("odd");}row.removeClassName("first");row.removeClassName("last");if(options.renumber){var position=row.down("td.position");if(position){position.update(i+1);}}});rows.first().addClassName("first");rows.last().addClassName("last");}},toggleSelector:function(selector){var els=$$(selector);if(els){els.each(function(e){e.toggle();});}}});LFM.set("DomSearch",{findParentByClassName:function(element,regex){if(element==null){return null;}if(element.className&&element.className.match(regex)){return element;}else{return this.findParentByClassName(element.parentNode,regex);}}});document.observe("dom:loaded",function(event){$$(".downloadDriver").each(function(container){container.observe("click",function(e){var el=e.findElement("a");if(el&&el.match("a")){var hasManualAdded=LFM.get("Page","hasManualAdded");var linkName="New user download CTA ("+(hasManualAdded?"after":"before")+" library add)";}});});});LFM.set("Display",{DropDown:Class.create({initialize:function(container,toggler,ddbody,options){this.container=$(container);this.toggler=$(toggler);this.ddbody=$(ddbody);this.ddbody.hide();this.ddbody.setStyle({position:"absolute",zIndex:999999});this.use_iframe=/Linux/.test(navigator.platform);if(this.use_iframe){this.iframe=new Element("iframe",{"src":"javascript: false","frameborder":0,"scrolling":"no","allowtransparency":"true"}).setStyle({position:"absolute",zIndex:999998,border:0});}this.shownOnce=false;this.options=options||{};this.container.addClassName("toggle");this.offBinding=this.clickOff.bindAsEventListener(this);this.toggler.observe("click",this.toggle.bindAsEventListener(this));},hide:function(){if(this.options.onHide){this.options.onHide(this);}if(this.use_iframe){this.iframe.setStyle({"display":"none"});}this.ddbody.hide();this.container.removeClassName("expanded");this.ddbody.removeClassName("lfmDropDown-expanded");Event.stopObserving(document,"click",this.offBinding,true);if(LFM.Display.openDropDown&&LFM.Display.openDropDown==this){LFM.Display.openDropDown=false;}},show:function(){if(LFM.Display.openDropDown){LFM.Display.openDropDown.hide(this);}if(!this.shownOnce){if(this.use_iframe){$("page").insert(this.iframe);}$("page").insert(this.ddbody);this.shownOnce=true;}var position=this.container.cumulativeOffset();var pagePosition=$("page").cumulativeOffset();position.left=position.left-pagePosition.left;position.top=position.top+this.container.getHeight()-pagePosition.top;if(Prototype.Browser.IE&&this.container.getStyle("display")=="inline-block"){var minwidth=this.toggler.getWidth();}else{var minwidth=this.container.getWidth();}var documentWidth=$("page").getWidth();if((this.options.align&&this.options.align=="right")||((position.left+this.ddbody.getWidth())>documentWidth)){var right=(documentWidth-minwidth-position.left)+"px";var left="auto";}else{var left=position.left+"px";var right="auto";if(Prototype.Browser.IE){if(window.external&&typeof window.XMLHttpRequest=="undefined"){left=(position.left-35)+"px";}}}if(!this.options.autoWidth){minwidth=minwidth-this.ddbody.getStyle("border-left-width").toPixels()-this.ddbody.getStyle("border-right-width").toPixels()-this.ddbody.getStyle("padding-left").toPixels()-this.ddbody.getStyle("padding-right").toPixels();this.ddbody.setStyle({minWidth:minwidth+"px"});if(this.use_iframe){this.iframe.setStyle({minWidth:minwidth+"px"});}}this.ddbody.setStyle({top:position.top+"px",left:left,right:right}).show();var body_position=this.ddbody.cumulativeOffset();if(this.use_iframe){this.iframe.clonePosition(this.ddbody);this.iframe.show();}if(this.options.onShow){this.options.onShow(this);}var tr=this.container.up("tr");if(tr){tr.addClassName("open");}LFM.Display.openDropDown=this;this.container.addClassName("expanded");this.ddbody.addClassName("lfmDropDown-expanded");Event.observe(document,"click",this.offBinding,true);},toggle:function(event){if(this.ddbody.visible()){this.hide();}else{this.show();}if(event.findElement("A")){event.findElement("A").blur();}event.stop();},clickOff:function(event){var target=Event.element(event);var cancel=false;while(target.parentNode){if(target==this.ddbody){return true;}else{if(target==this.toggler){cancel=true;}}target=target.parentNode;}this.hide();if(cancel){event.stop();}}})});Event.observe(document,"dom:loaded",function(){if($("message")&&$("editorSubmit")){LFM.set("Page",{editorMessage:$("message").value});window.onbeforeunload=function(){if($("message").value!=LFM.Page.editorMessage&&typeof LFM.Page.Captcha==="undefined"){return LFM.Page.editorWarning;}};Event.observe(document,"click",function(event){if(event.target&&event.target.id=="editorSubmit"){LFM.set("Page",{editorMessage:$("message").value});}});}});var EventCalendar={calendars:null,currentMonth:null,lastRequested:null,next:function(url,anchor,prev){anchor.blur();Element.addClassName(anchor,"busy");var c=EventCalendar.getCurrentMonth();var month=prev?EventCalendar.getPrevMonthAfterTable(c):EventCalendar.getNextMonthAfterTable(c);var next=null;var matches=null;if(!prev){matches=document.getElementsByClassName("month-"+month,$("calendar"));next=matches.length>0?matches[0]:false;}else{var m=EventCalendar.getPrevMonthAfterTable(c);matches=document.getElementsByClassName("month-"+m,$("calendar"));next=matches.length>0?matches[0]:false;}if(next){c.style.display="none";next.style.display="table";EventCalendar.currentMonth=next;Element.removeClassName(anchor,"busy");}else{if(next==-1){Element.removeClassName(anchor,"busy");}else{url=url.replace(/startdate=\d+-\d+-\d+(&)?/,"");url=EventCalendar.convertURL(url);var separator=/\?$/.test(url)?"":"&";EventCalendar.lastRequested=month;var ajax=new Ajax.Request(url+separator+"startdate="+month+"-01",{onSuccess:EventCalendar.receiveMonth.bind(anchor),onFailure:EventCalendar.receiveMonthFailed.bind(anchor)});}}},prev:function(url,anchor){EventCalendar.next(url,anchor,true);},convertURL:function(url){var match=/(events|festivals)/.exec(url);var namespace=new RegExp("^/"+match[1]);url=url.replace(namespace,"");return"/"+match[1]+"/calendar"+url;},receiveMonth:function(transport){if(transport.responseText.indexOf("calendar")==-1){var func=EventCalendar.receiveMonthFailed.bind(this);func();return;}Element.removeClassName(this,"busy");new Insertion.Bottom("calendar",transport.responseText);var matches=document.getElementsByClassName("calendar",$("calendar"));if(matches.length>0){EventCalendar.currentMonth.style.display="none";matches[matches.length-1].style.display="table";EventCalendar.currentMonth=matches[matches.length-1];}},receiveMonthFailed:function(){Element.removeClassName(this,"busy");},getNextMonthAfterTable:function(table){var month=EventCalendar.getMonthForTable(table);var bits=month.split("-");var nextYear=bits[0];var nextMonth=bits[1];if(nextMonth==12){nextMonth=1;nextYear++;}else{nextMonth++;}if(nextMonth<10){nextMonth="0"+nextMonth;}return nextYear+"-"+nextMonth;},getPrevMonthAfterTable:function(table){var month=EventCalendar.getMonthForTable(table);var bits=month.split("-");var prevYear=bits[0];var prevMonth=bits[1];if(prevMonth=="01"){prevMonth=12;prevYear--;}else{prevMonth--;}if(prevMonth<10){prevMonth="0"+prevMonth;}return prevYear+"-"+prevMonth;},getMonthForTable:function(table){if(table.month){return table.month;}var classes=$A(table.className.split(/\s+/));var c=classes.find(function(c){return c.substring(0,5)=="month";});table.month=c.substring(6);return table.month;},getCurrentMonth:function(){if(EventCalendar.currentMonth){return EventCalendar.currentMonth;}EventCalendar.calendars=$A(document.getElementsByClassName("calendar",$("calendar")));EventCalendar.currentMonth=EventCalendar.calendars.find(function(c){return Element.hasClassName(c,"first");});EventCalendar.lastRequested=EventCalendar.getMonthForTable(EventCalendar.currentMonth);return EventCalendar.currentMonth;}};LFM.set("Adserver",{"ExpandingAd":Class.create({inner_id:"",outer_id:"",embed_id:"",adExpandedHeight:0,adExpandedWidth:0,adCollapsedHeight:0,adCollapsedWidth:0,isCollapsing:false,toggleState:false,initialize:function(outer_id,inner_id,embed_id){this.inner_id=inner_id;this.outer_id=outer_id;this.embed_id=embed_id;this.getDimensions();this.setStyles();this.bindEventListeners();},getDimensions:function(){this.adExpandedHeight=$(this.embed_id).getHeight();this.adExpandedWidth=$(this.embed_id).getWidth();this.adCollapsedHeight=$(this.outer_id).getHeight();this.adCollapsedWidth=$(this.outer_id).getWidth();},setStyles:function(){$(this.outer_id).setStyle({"zIndex":0,"overflow":"visible","position":"relative"});$(this.inner_id).setStyle({"zIndex":0,"position":"relative","top":0,"text-align":"center"});},bindEventListeners:function(){var expander=this;$(document).observe("click",function(e){expander.collapse();});$(this.inner_id).observe("click",function(e){e.stop();});$(this.inner_id).observe("mouseover",function(e){expander.isCollapsing=false;if(expander.toggleState){expander.expand();}});$(this.inner_id).observe("mouseout",function(e){if(!expander.isCollapsing){expander.isCollapsing=true;setTimeout(function(){if(expander.isCollapsing){expander.collapse();expander.isCollapsing=false;}},2000);}});$(this.embed_id).observe("focus",function(e){expander.expand();expander.toggleState=true;});$(this.embed_id).observe("blur",function(e){expander.toggleState=false;});},collapse:function(){$(this.outer_id).setStyle({"zIndex":0});$(this.inner_id).setStyle({"zIndex":0,"width":this.adCollapsedWidth+"px","height":this.adCollapsedHeight+"px"});this.isCollapsing=false;},expand:function(){$(this.outer_id).setStyle({"zIndex":99999});$(this.inner_id).setStyle({"zIndex":99999,"width":this.adExpandedWidth+"px","height":this.adExpandedHeight+"px"});}})});LFM.set("Form",{Placeholder:Class.create({nativeSupport:Prototype.Browser.WebKit?true:false,required:true,initialize:function(element,required){if(typeof required!="undefined"){this.required=required;}if(element){this.element=$(element);}if(this.element){if(this.element.match("input")||this.element.match("textarea")){this.setUp(this.element);}else{this.element.select("input[placeholder]").each(function(input){this.setUp(input);}.bind(this));}}else{if(!this.element){$$("input[placeholder]").each(function(input){this.setUp(input);}.bind(this));}}},setText:function(input,text){input.setAttribute("placeholder",text);if(!this.nativeSupport||input.match("textarea")){if($F(input)==""||input.hasClassName("hint")){input.addClassName("hint");input.value=text;}}},clearPlaceholder:function(input,indicator){if($F(input)==input.getAttribute("placeholder")){input.removeClassName("hint");input.value="";}indicator.disabled=true;},resetPlaceholder:function(input,indicator){if(!$F(input).strip()){input.addClassName("hint");input.value=input.getAttribute("placeholder");indicator.disabled=false;}},setUp:function(input){this.setText(input,input.getAttribute("placeholder"));if(!this.nativeSupport||input.match("textarea")){var indicator=new Element("input",{"type":"hidden","name":"placeholder","value":1});input.insert({after:indicator});input.observe("focus",function(e){this.clearPlaceholder(input,indicator);}.bind(this));input.observe("blur",function(e){this.resetPlaceholder(input,indicator);}.bind(this));if(this.required){var form=input.up("form");form.observe("submit",function(e){this.clearPlaceholder(input,indicator);}.bind(this));}}}})});LFM.set("Form",{focusToRange:0,focusTo:function(element,selectFrom){if(typeof selectFrom=="undefined"){selectFrom=element.value.length;}if(element.createTextRange){if(LFM.Form.focusToRange==0){LFM.Form.focusToRange=element.createTextRange();}LFM.Form.focusToRange.moveEnd("character",element.value.length);LFM.Form.focusToRange.moveStart("character",selectFrom);setTimeout("LFM.Form.focusToRange.select()",10);}else{if(element.setSelectionRange){element.focus();element.select();element.setSelectionRange(selectFrom,element.value.length);}else{element.focus();}}}});LFM.set("Form",{CustomSelect:Class.create({config:{replacedClass:"customSelect-replaced",customSelectClass:"customSelect-dummy",customSelectWrapperClass:"customSelect-dummy-wrap",customSelectTextClass:"customSelect-text",activeClass:"s-active",wrapperElementClass:"customSelect-wrap"},initialize:function(target){if(!$$("body")[0].hasClassName("ie6")){if(typeof target=="string"){$$(target).each(function(selectElem){this._initializeOne(selectElem);},this);}else{if(target.each){target.each(function(selectElem){this._initializeOne(selectElem);},this);}else{this._initializeOne(target);}}}},_initializeOne:function(target){target.addClassName(this.config.replacedClass);target.wrap("div",{"class":this.config.wrapperElementClass});var span=new Element("span",{"class":this.config.customSelectClass,"aria-hidden":true}).insert({top:new Element("span",{"class":this.config.customSelectWrapperClass}).insert({top:new Element("span",{"class":this.config.customSelectTextClass})})});target.insert({after:span});target.observe("change",this.changeListener.bindAsEventListener(this));target.observe("keyup",this.changeListener.bindAsEventListener(this));target.observe("CustomSelect:change",this.changeListener.bindAsEventListener(this));target.observe("mouseenter",this.setActive.bindAsEventListener(this));target.observe("mouseleave",this.setInactive.bindAsEventListener(this));target.observe("focus",this.setActive.bindAsEventListener(this));target.observe("blur",this.setInactive.bindAsEventListener(this));this.update(target);this.setWidth(target);},update:function(target){var selectedOption=target.select("option:selected")[0];var val;if(selectedOption.hasAttribute("label")){val=selectedOption.readAttribute("label");}else{val=selectedOption.innerHTML;}var textElem=target.up().select("."+this.config.customSelectTextClass)[0];textElem.update(val);var customSelectElem=target.up().select("."+this.config.customSelectClass)[0];if(target.disabled){customSelectElem.addClassName("s-disabled");}else{customSelectElem.removeClassName("s-disabled");}},changeListener:function(e){var target=$(e.target);this.update(target);this.setWidth(target);},setActive:function(e){var target=$(e.target);target.up("."+this.config.wrapperElementClass).select("."+this.config.customSelectClass)[0].addClassName(this.config.activeClass);},setInactive:function(e){var target=$(e.target);target.up("."+this.config.wrapperElementClass).select("."+this.config.customSelectClass)[0].removeClassName(this.config.activeClass);},setWidth:function(target){target.setStyle({width:""});realWidth=target.getWidth();target.setStyle({width:realWidth+22+"px"});}})});document.observe("dom:loaded",function(){new LFM.Form.CustomSelect("select.customSelect");});LFM.set("Form",{MasterSlaveSelectBox:Class.create({initialize:function(target){if(typeof target=="string"){$$(target).each(function(selectElem){this._initializeOne(selectElem);},this);}else{if(target.each){target.each(function(selectElem){this._initializeOne(selectElem);},this);}else{this._initializeOne(target);}}},_initializeOne:function(target){var selectedOption=target.getValue();var selectedOptionElem=target.select("option:selected")[0];var selectedGroup=selectedOptionElem.up().readAttribute("label");var optgroups=target.select("optgroup");var groups=new Hash();optgroups.each(function(optgroupElem,index){var opts=optgroupElem.select("option");var optsCloned=[];opts.each(function(opt){clonedOpt=opt.clone(true);if(opt==selectedOptionElem){clonedOpt.writeAttribute("selected","selected");}optsCloned.push(clonedOpt);});groups.set(optgroupElem.readAttribute("label"),optsCloned);});var master=new Element("select",{"id":target.readAttribute("id")+"-master"});groups.each(function(group){var newOption=new Element("option");master.insert({bottom:newOption.update(group.key)});});master.setValue(selectedGroup);target.insert({after:master});var slave=new Element("select",{"id":target.readAttribute("id")+"-slave"});Element.hide(target);var targetId=target.readAttribute("id");$$('label[for="'+targetId+'"]')[0].writeAttribute("for","");master.insert({before:slave});target.store("MasterSlaveSelectBox.master",master);target.store("MasterSlaveSelectBox.slave",slave);master.store("MasterSlaveSelectBox.slave",slave);slave.store("MasterSlaveSelectBox.master",master);slave.store("MasterSlaveSelectBox.groups",groups);slave.store("MasterSlaveSelectBox.original",target);master.observe("change",this.masterChangeListener.bindAsEventListener(this));master.observe("keyup",this.masterChangeListener.bindAsEventListener(this));slave.observe("change",this.slaveChangeListener.bindAsEventListener(this));slave.observe("keyup",this.slaveChangeListener.bindAsEventListener(this));slave.observe("MasterSlaveSelectBox:change",this.slaveChangeListener.bindAsEventListener(this));this.update(master);},update:function(target){var selectedGroup=target.getValue();var slave=target.retrieve("MasterSlaveSelectBox.slave");var groups=slave.retrieve("MasterSlaveSelectBox.groups");slave.update();groups.get(selectedGroup).each(function(optionElem){slave.insert(optionElem);});this.updateOriginal(slave);Event.fire(slave,"CustomSelect:change");},updateOriginal:function(target){var original=target.retrieve("MasterSlaveSelectBox.original");original.setValue(target.getValue());},masterChangeListener:function(e){var target=$(e.target);this.update(target);},slaveChangeListener:function(e){var target=$(e.target);this.updateOriginal(target);}})});LFM.set("Display",{setupHeader:function(){if(LFM.Session.loggedIn){$("idBadger").addClassName("withDropDown");LFM.set("Page",{navDropDown:new LFM.Display.DropDown("idBadger","idBadgerDropper","idBadgerDropDown",{align:"right"})});}new LFM.Form.Placeholder("siteSearchBox");LFM.Links.setupPost("logoutLink");},colourToggle:function(link){link=$(link);$(document.body).toggleClassName("lfmBlack");link.blur();var fromColour,toColour;if($(document.body).hasClassName("lfmBlack")){fromColour="red";toColour="black";link.update(LFM.String.toRedStr);LFM.Page.Tracker.eventPaintItBlack();}else{fromColour="black";toColour="red";link.update(LFM.String.toBlackStr);LFM.Page.Tracker.eventSimplyRed();}LFM.setCookie("LFM_Colour",toColour);return false;}});if((Math.round(Math.random()*100)>98)&&(LFM.get("Button","affiliations"))&&(LFM.Button.affiliations["suppliers[]"].length)){document.observe("dom:loaded",function(event){var url="/ajax/affiliableLookup?";new Ajax.Request(url,{method:"post",parameters:LFM.Button.affiliations});});}function log(){if(typeof console!=="undefined"&&LFM&&LFM.get("config","DEVELOPMENT_SERVER")){if(console.log.apply){console.log.apply(console,arguments);}else{console.log(arguments[0]);}}}LFM.set("Display",{setMinHeight:function(){document.observe("dom:loaded",function(){var secondaryNavigation=$("secondaryNavigation");if(secondaryNavigation){var minHeight=secondaryNavigation.getHeight()-2;var content=$("content");if(content&&content.getHeight()<minHeight){var container=$$("#content > .rightCol");container=container[0]||content;if(container.match(".rightCol")){content.setStyle("min-height: 0");}minHeight-=container.getStyle("padding-top").toPixels(container);minHeight-=container.getStyle("padding-bottom").toPixels(container);container.setStyle({minHeight:(minHeight>300?minHeight:300)+"px"});}}});},addImageOrientationClass:function(targetSelector){var isImageOk=function(img){if(!img.complete){return false;}if(typeof img.naturalWidth!="undefined"&&img.naturalWidth==0){return false;}return true;};var setOriantationClass=function(item,image){var dimensions=image.getDimensions();if(dimensions.width>dimensions.height){item.addClassName("landscape");}else{item.addClassName("portrait");}};$$(targetSelector).each(function(item){var image=item.select("img")[0];var checkImage=function(){if(isImageOk(image)){item.removeClassName("rankItem-imageCrop-hidden");setOriantationClass(item,image);}else{setTimeout(checkImage,500);}};checkImage();});}});if(LFM&&LFM.get("config","DEVELOPMENT_SERVER")){LFM.set("Timers",{});}function startTimer(name){if(LFM&&LFM.get("config","DEVELOPMENT_SERVER")){LFM.Timers[name]={};LFM.Timers[name].startTime=new Date();LFM.Timers[name].startTime=LFM.Timers[name].startTime.getTime();}}function stopTimer(name){if(LFM&&LFM.get("config","DEVELOPMENT_SERVER")){if(LFM.Timers[name]){LFM.Timers[name].endTime=new Date();LFM.Timers[name].endTime=LFM.Timers[name].endTime.getTime();log(LFM.Timers[name].endTime-LFM.Timers[name].startTime);}else{log("Timer "+name+" doesnt exist.");}}}function loadStyleSheet(styleSheetURL){if(isset(document.createStyleSheet)){document.createStyleSheet(styleSheetURL);}else{var styleSheetLink=document.createElement("link");styleSheetLink.setAttribute("rel","stylesheet");styleSheetLink.setAttribute("type","text/css");styleSheetLink.setAttribute("href",styleSheetURL);document.getElementsByTagName("head")[0].appendChild(styleSheetLink);}}function is_array(obj){return obj.constructor==Array;}function isset(obj){return typeof obj!=="undefined";}String.prototype.pad=function(pad_length,pad_string,pad_type){if(pad_length){pad_length=pad_length-this.length;}else{return this;}var input=this;if(pad_string){pad_string=pad_string+"";}else{pad_string=" ";}if(!isset(pad_type)){pad_type="STR_PAD_LEFT";}if(pad_type=="STR_PAD_BOTH"){var odd=pad_length%2;var side=pad_length/2;side=Math.round(side);var left=pad_string.times(side);var right=pad_string.times(side-odd);input=left+input+right;}else{var pad_string=pad_string.times(pad_length);if(pad_type=="PAD_STR_RIGHT"){input=input+pad_string;}else{input=pad_string+input;}}return input;};Number.prototype.toPixels=function(){return this;};String.prototype.toPixels=function(reference){var size=this.match(/^(-?)(\d+(?:.\d+)?)(px|pt|em|)$/i);var negative=size[1]?-1:1;var value=size[2];var unit=size[3].toLowerCase();function rule(value,unit){var ruler=document.getElementById(unit+"Ruler");if(!ruler){ruler=document.createElement("div");document.getElementsByTagName("BODY")[0].appendChild(ruler);ruler.id=unit+"Ruler";}ruler.style.width=value+unit;return ruler.clientWidth*negative;}switch(unit){case"px":return value*negative;case"pt":return rule(value,unit);case"em":if(!reference){log("Its better to give a reference element when calculating pixels from ems");return rule(value,unit);}else{var ruler=document.createElement(reference.tagName);ruler.style.display="block";ruler.style.position="absolute";ruler.style.left="-9999px";ruler.style.top="-9999px";ruler.style.height="0";ruler.style.padding="0";ruler.style.border="0";ruler.style.width=value+unit;reference.parentNode.appendChild(ruler);returnValue=ruler.clientWidth;reference.parentNode.removeChild(ruler);return returnValue*negative;}default:return value*negative;}};var CSSUtils={getCSSRule:function(ruleName,deleteFlag){ruleName=ruleName.toLowerCase();if(document.styleSheets){for(var i=0;i<document.styleSheets.length;i++){var styleSheet=document.styleSheets[i];var ii=0;var cssRule=false;do{if(styleSheet.cssRules){cssRule=styleSheet.cssRules[ii];}else{cssRule=styleSheet.rules[ii];}if(cssRule){if(cssRule.selectorText.toLowerCase()==ruleName){if(deleteFlag=="delete"){if(styleSheet.cssRules){styleSheet.deleteRule(ii);}else{styleSheet.removeRule(ii);}return true;}else{return cssRule;}}}ii++;}while(cssRule);}}return false;},killCSSRule:function(ruleName){return CSSUtils.getCSSRule(ruleName,"delete");},addCSSRule:function(ruleName){if(document.styleSheets){if(!CSSUtils.getCSSRule(ruleName)){if(document.styleSheets[0].addRule){document.styleSheets[0].addRule(ruleName,null,0);}else{document.styleSheets[0].insertRule(ruleName+" { }",0);}}}return CSSUtils.getCSSRule(ruleName);}};function actsAsAspect(object){object.yield=null;object.rv={};object.before=function(method,f){var original=eval("this."+method);this[method]=function(){f.apply(this,arguments);return original.apply(this,arguments);};};object.after=function(method,f){var original=eval("this."+method);this[method]=function(){this.rv[method]=original.apply(this,arguments);return f.apply(this,arguments);};};object.around=function(method,f){var original=eval("this."+method);this[method]=function(){this.yield=original;return f.apply(this,arguments);};};}var ieHover={selector:"tr, li",add:function(stuff){if(!(/MSIE (5|6|8)/).test(navigator.userAgent)){return;}var stuff=stuff||false;if(Object.isString(stuff)&&$(stuff)){$(stuff).select(ieHover.selector).each(function(item){ieHover.prepareItem(item);});}else{if(Object.isElement(stuff)){stuff=$(stuff);if(stuff.match("tr, li")){ieHover.prepareItem(stuff);}else{stuff.select(ieHover.selector).each(function(item){ieHover.prepareItem(item);});}}else{if(Object.isArray(stuff)){stuff.each(function(item){ieHover.prepareItem(item);});}}}},prepareItem:function(item){item.observe("mouseenter",ieHover.mouseOver);item.observe("mouseleave",ieHover.mouseOut);},mouseOver:function(event){this.className=this.className.replace(/(\S+)/g,"$1 $1hover_")+" hover_";},mouseOut:function(event){this.className=this.className.replace(/(\S+)?hover_(\S+)?/g,"").replace(/\s+/g," ");},setUp:function(){if(!(/MSIE (5|6|8)/).test(navigator.userAgent)){return;}var hoverStyleSheet=document.createStyleSheet();var rulesToAdd=[];var currentSheet;var sheets=document.styleSheets,l=sheets.length;for(var i=0;i<l;i++){parseStylesheet(sheets[i]);}function parseStylesheet(sheet){if(sheet.imports){try{var imports=sheet.imports,l=imports.length;for(var i=0;i<l;i++){parseStylesheet(sheet.imports[i]);}}catch(securityException){}}try{var rules=(currentSheet=sheet).rules;var l=rules.length;var select=false;var style=false;for(var j=0;j<l;j++){select=rules[j].selectorText;style=rules[j].style.cssText;if(select.match(/(tr|li)(\.(\w*))*:hover/ig)&&style){rulesToAdd.push([select.replace(/(tr|li)(\.(\w*))*:hover/ig,"$1.$3hover_"),style]);}}}catch(securityException){}}var cssText="";for(var i=rulesToAdd.length-1;i>=0;i--){cssText+=rulesToAdd[i][0]+"\n{ "+rulesToAdd[i][1]+"}\n";}hoverStyleSheet.cssText=cssText;var items=[];var page=$("page");ieHover.selector.split(",").each(function(weee){items.push($A(page.getElementsByTagName(weee.strip())));});items=items.flatten();var i=items.length-1;for(i;i>=0;i--){Event.observe(items[i],"mouseenter",ieHover.mouseOver);Event.observe(items[i],"mouseleave",ieHover.mouseOut);}}};HighlightEachOther=Class.create({initialize:function(el1,tag1,el2,tag2){this.els=[$(el1).select(tag1),$(el2).select(tag2)].flatten();this.els.each(function(el){el.observe("mouseover",function(e){this.highlight(el);}.bindAsEventListener(this));el.observe("mouseout",function(e){this.highlight(el);}.bindAsEventListener(this));}.bind(this));},highlight:function(el){var el=el;if(!el.relatives){this.getRelatives(el);}el.relatives.each(function(_1b4){Element.toggleClassName(_1b4,"highlight");});},getRelatives:function(el){el.relatives=new Array();var rel=el.readAttribute("class");this.els.each(function(item){if(item.readAttribute("class")==rel){el.relatives.push(item);}});}});LFM.set("Page",{"InlineTabSwitcher":Class.create({initialize:function(namespace){this.menu=$(namespace+"Tabs");this.namespace=namespace;if(!this.menu){LFM.log("couldn't find #"+namespace+"Tabs, InlineTabSwitcher not created");return;}var switcher=this;this.menu.observe("click",function(event){Event.stop(event);var li=event.findElement("li");if(li&&li.match("li")){switcher.switchTabs(li);var anchor=li.select("a");if(anchor&&anchor.length){anchor[0].blur();}}});var menuItems=this.menu.select("li");if(menuItems&&menuItems.length){var hash=window.location.hash?window.location.hash.replace(/#/,""):"";var activeTab=null;menuItems.each(function(menuItem){switcher._getContentContainerForTab(menuItem).hide();if(menuItem.hasClassName("current")){activeTab=menuItem;}else{if(menuItem.hasClassName("tabident-"+hash)){activeTab=menuItem;}}});if(!activeTab){activeTab=menuItems[0];}this.switchTabs(activeTab);}},switchTabs:function(li){var menuItems=this.menu.select("li");var switcher=this;menuItems.each(function(menuItem){if(menuItem==li){menuItem.addClassName("current");switcher._getContentContainerForTab(menuItem).show();}else{menuItem.removeClassName("current");switcher._getContentContainerForTab(menuItem).hide();}});var matches=li.className.match(/tabident-([^ "]+)/);if(matches&&matches.length>=2){var tabident=matches[1].replace(/hover_/g,"");var loc=window.location;var url=loc.toString().replace(/\#.*/,"");loc.replace(url+"#"+tabident);}},_getContentContainerForTab:function(li){var contentId=this.namespace+li.id.replace("Tab","").capitalize();return $(contentId);}})});Ajax.JSONRequest=Class.create(Ajax.Base,(function(){var id=0,head=document.getElementsByTagName("head")[0];return{initialize:function($super,url,options){$super(options);this.options.url=url;this.options.callbackParamName=this.options.callbackParamName||"callback";this.options.timeout=this.options.timeout||10;this.options.invokeImmediately=(!Object.isUndefined(this.options.invokeImmediately))?this.options.invokeImmediately:true;if(this.options.invokeImmediately){this.request();}},_cleanup:function(){if(this.timeout){clearTimeout(this.timeout);this.timeout=null;}if(this.transport&&Object.isElement(this.transport)){this.transport.remove();this.transport=null;}},request:function(){var response=new Ajax.JSONResponse(this);var key=this.options.callbackParamName,name="_prototypeJSONPCallback_"+(id++),complete=function(){if(Object.isFunction(this.options.onComplete)){this.options.onComplete.call(this,response);}Ajax.Responders.dispatch("onComplete",this,response);}.bind(this);this.options.parameters[key]=name;var url=this.options.url+((this.options.url.include("?")?"&":"?")+Object.toQueryString(this.options.parameters));window[name]=function(json){this._cleanup();window[name]=undefined;response.status=200;response.statusText="OK";response.setResponseContent(json);if(Object.isFunction(this.options.onSuccess)){this.options.onSuccess.call(this,response);}Ajax.Responders.dispatch("onSuccess",this,response);complete();}.bind(this);this.transport=new Element("script",{type:"text/javascript",src:url});if(Object.isFunction(this.options.onCreate)){this.options.onCreate.call(this,response);}Ajax.Responders.dispatch("onCreate",this);head.appendChild(this.transport);this.timeout=setTimeout(function(){this._cleanup();window[name]=Prototype.emptyFunction;if(Object.isFunction(this.options.onFailure)){response.status=504;response.statusText="Gateway Timeout";this.options.onFailure.call(this,response);}complete();}.bind(this),this.options.timeout*1000);},toString:function(){return"[object Ajax.JSONRequest]";}};})());Ajax.JSONResponse=Class.create({initialize:function(request){this.request=request;},request:undefined,status:0,statusText:"",responseJSON:undefined,responseText:undefined,setResponseContent:function(json){this.responseJSON=json;this.responseText=Object.toJSON(json);},getTransport:function(){if(this.request){return this.request.transport;}},toString:function(){return"[object Ajax.JSONResponse]";}});LFM.set("LiveSwitch",Class.create({initialize:function(element,options){this.element=$(element);this.options={selectedClass:"selected"};Object.extend(this.options,options);this.items=this.element.select("li");this.items.each(function(li){var a=li.down("a");a.observe("click",this.dispatchOnChange.bindAsEventListener(this));}.bind(this));},dispatchOnChange:function(event){event.stop();event.element().blur();var li=event.findElement("li");this.items.invoke("removeClassName",this.options.selectedClass);li.addClassName(this.options.selectedClass);this.options.onChange(li);}}));LFM.set("Module",{Buttons:Class.create({initialize:function(container,options){this.container=$(container);if(options){Object.extend(this,options);}if(!this.onComplete){this.onComplete=this._defaultOnComplete;}if(!this.resource){this.resource=LFM.ParentResource;}this.container.observe("click",this.observeMenu.bindAsEventListener(this));},observeMenu:function(event){var link=event.findElement("a");if(!link){return;}if(link.hasClassName("mEdit")){event.stop();var url="/ajax/dialog/moduleedit?module="+this.moduleName;this._dialog=new LFM.Dialog({action:url,classname:"modulePreferences",onConfirm:this._onConfirmDialog.bindAsEventListener(this)});this._dialog.show(url);}else{if(link.hasClassName("mFeeds")){event.stop();var params={module:this.moduleName,type:this.resource.type,id:this.resource.id};var url="/ajax/dialog/feeds?"+Object.toQueryString(params);this._dialog=new LFM.Dialog({classname:"feedDialog",onConfirm:function(event){event.stop();this.hide();}});this._dialog.show(url);}else{if(link.hasClassName("mPaste")){event.stop();var tablink=$$(".modulechartsartists li.current a")[0].getAttribute("href");var regex=/rangetype=([^&]*)/;var charttype=tablink.match(regex)[1];var params={module:this.moduleName,type:this.resource.type,id:this.resource.id,period:charttype};var url="/ajax/dialog/pasteyourtaste?"+Object.toQueryString(params);this._dialog=new LFM.Dialog({classname:"pasteDialog",onConfirm:function(event){event.stop();this.hide();}});this._dialog.show(url);}}}},_defaultOnComplete:function(){if(this.container.down(".module-body")){var url="/module";var params={method:"get",parameters:{name:this.moduleName,ajax:1},onComplete:this._defaultRefreshCallback.bind(this),onCreate:function(){this.container.addClassName("loading");}.bind(this),onFailure:function(){this.container.removeClassName("loading");}.bind(this)};new Ajax.Request(url,params);}},_onConfirmDialog:function(event,form){event.stop();if(form){form.action="/ajax/dialog/moduleedit?module="+this.moduleName;form.request({onComplete:this.onComplete.bind(this)});}else{this._dialog.hide();this._dialog.overlayForm.request({onComplete:this.onComplete.bind(this)});}},_defaultRefreshCallback:function(transport){var response=new LFM.Ajax.Response(transport);if(response.isSuccess()){this.container.down(".module-body").replace(response.get("content"));}else{this.container.removeClassName("loading");}}}),onRefresh:function(containerid,callback){if(!LFM.Module.refreshers){LFM.Module.refreshers={};}LFM.Module.refreshers[containerid]=callback;}});LFM.set("Button",{MultiButtonIcons:Class.create({initialize:function(){$$("body")[0].observe("click",this.clickHandler.bindAsEventListener(this));this.addBuyButtons();},clickHandler:function(e){var target=$(e.target);if(target.hasAttribute("data-source")){e.stop();var dataSource=$(target.getAttribute("data-source"));var resource={id:dataSource.getAttribute("data-res-id"),type:dataSource.getAttribute("data-res-type"),url:dataSource.getAttribute("data-res-url")};var container=dataSource;var className=target.up("li").className;var regex=/(multiButtonIcons-action-([^\s]+)\s?)/;var action=regex.exec(className)[2];switch(action){case"love":this.love(container,resource);break;case"unlove":this.unlove(container,resource);break;case"addLibrary":this.addLibrary(container,resource);break;case"removeLibrary":this.removeLibrary(container,resource);break;case"buy":this.buy(container,resource);break;case"tag":this.tag(container,resource);break;case"share":this.share(container,resource);break;case"playlist":this.playlist(container,resource);break;}}},love:function(container,resource){container.down(".multiButtonIcons-action-love").addClassName("multiButtonIcons-hidden");container.down(".multiButtonIcons-action-unlove").removeClassName("multiButtonIcons-hidden");if(resource){LFM.Love(resource,{onDone:function(){LFM.Page.Tracker.eventLoveTrack("Page");},onError:function(){this.unlove(container);}});}},unlove:function(container,resource){container.down(".multiButtonIcons-action-unlove").addClassName("multiButtonIcons-hidden");container.down(".multiButtonIcons-action-love").removeClassName("multiButtonIcons-hidden");if(resource){LFM.Unlove(resource,{onError:function(){this.love(container);}});}},addLibrary:function(container,resource){if(resource){LFM.Add(resource,{onDone:function(){container.down(".multiButtonIcons-action-addLibrary").addClassName("multiButtonIcons-hidden");container.down(".multiButtonIcons-action-removeLibrary").removeClassName("multiButtonIcons-hidden");}});}},removeLibrary:function(container,resource){if(resource){LFM.RemoveFromLibrary(resource,{onDone:function(){container.down(".multiButtonIcons-action-removeLibrary").addClassName("multiButtonIcons-hidden");container.down(".multiButtonIcons-action-addLibrary").removeClassName("multiButtonIcons-hidden");}});}},buy:function(container,resource){if(resource){LFM.BuyDialog(resource);}},tag:function(container,resource){if(resource){LFM.Tag(resource);}},share:function(container,resource){if(resource){LFM.Send(resource,{parameters:{secondary:true}});}},playlist:function(container,resource){if(resource){LFM.Playlist(resource);}},addBuyButtons:function(){var buyButton=$$(".multiButtonIcons-action-buy");buyButton.each(function(item){var resource={};if(item.hasAttribute("data-res-id")){resource.id=item.getAttribute("data-res-id");}else{resource.id=item.up("*[data-res-id]").getAttribute("data-res-id");}if(item.hasAttribute("data-res-type")){resource.id=item.getAttribute("data-res-type");}else{resource.type=item.up("*[data-res-type]").getAttribute("data-res-type");}var params=Object.extend({cachebuster:Math.round(Math.random()*100)},resource);var request=new Ajax.Request("/ajax/affiliablepricejson",{parameters:params,method:"get",onComplete:function(response){if(response.responseJSON.data.affiliable){item.removeClassName("multiButtonIcons-hidden");if(typeof response.responseJSON.data.lowestPriceString=="string"){var textContainer=item.select(".tooltip-text")[0];textContainer.update(textContainer.innerHTML+" ("+response.responseJSON.data.lowestPriceString+")");}}}.bind(this)});});}})});document.observe("dom:loaded",function(){new LFM.Button.MultiButtonIcons();});LFM.set("Display",{MultiTuner:Class.create({initialize:function(form,options){this.uuid=Math.round(Math.random()*100000);this.form=$(form);this.restype=options.restype;this.sampleContent=$(options.sampleContent);this.slotID=options.slotID||"slot"+this.uuid;this.slotClass=options.slotClass||"";this.choices=$(options.choices);this.autocomplete=$(options.autocomplete);this.length=options.length||3;this.itemClass=options.itemClass||"";this.onSelect=options.onSelect;this.onDeselect=options.onDeselect;this.onResourceJSON=options.onResourceJSON;this.slots=this.setupSlots(this.length);this.selections=$H();this.matching_choices=$H();this.filled=0;this.setupListeners();},setupListeners:function(){if(!LFM.get("Session","prefersClient")&&!this.form.down("input[name=ajax]")){this.form.insert(new Element("input",{"type":"hidden","name":"ajax","value":1}));}if(this.choices){this.choices.observe("click",function(e){e.stop();var item=e.findElement("li");this.select(item.down("a").innerHTML.unescapeHTML());}.bind(this));}if(this.autocomplete){this.autocomplete.observe("submit",function(e){e.stop();var form_fields=this.autocomplete.serialize(true);if(!form_fields.placeholder&&form_fields.name){this.select(form_fields.name.unescapeHTML());this.autocomplete.down("input[name=name]").value="";}}.bind(this));}},setupSlots:function(slots){var that=this;var numbers=$A($R(1,slots));numbers.reverse(false).each(function(i){if(!$(that.slotID+i)){var slot=new Element("div",{"id":that.slotID+i,"class":that.slotClass});that.form.insert({top:slot});}});return numbers.inject($H(),function(hash,i){hash.set(i,false);return hash;});},generate_item_id:function(content){return"item"+this.uuid+"_"+content.toLowerCase().replace(/_/g,"__").replace(/ /g,"_");},updateSampleContent:function(){if(this.sampleContent&&this.restype){var sampleContentContainer=this.sampleContent.up("p");if(!this.filled){sampleContentContainer.hide();sampleContentContainer.next("p.noSampleContent").hide();this.sampleContent.update();}else{var that=this;new Ajax.Request("/listen/tune",{parameters:Object.extend({"ajax":1},this.form.serialize(true)),onComplete:function(transport){var response=new LFM.Ajax.Response(transport);if(response.isError()){var sampleContentContainer=that.sampleContent.up("p");that.sampleContent.update();sampleContentContainer.hide();sampleContentContainer.next("p.noSampleContent").hide();sampleContentContainer.next("p.sampleContentError").show();}else{var sampleData=response.get("sampleContent");var sampleContentContainer=that.sampleContent.up("p");if(sampleData&&sampleData.items&&sampleData.items.length){var sampleContent=sampleData.items.inGroupsOf(3)[0].collect(function(item){if(!item){throw $break;}return item.res.name;}).join(", ");that.sampleContent.update(sampleContent);sampleContentContainer.next("p.noSampleContent").hide();sampleContentContainer.next("p.sampleContentError").hide();sampleContentContainer.show();}else{that.sampleContent.update();sampleContentContainer.hide();sampleContentContainer.next("p.sampleContentError").hide();sampleContentContainer.next("p.noSampleContent").show();}}}});}}},fetchResourceJSON:function(content,slot_item){var that=this;new Ajax.Request("/ajax/getResource",{method:"get",parameters:{"type":this.restype,"name":content},onComplete:function(transport){var response=new LFM.Ajax.Response(transport);that.onResourceJSON(response,slot_item);}});},deselect:function(item_id){var slot=this.selections.unset(item_id);this.slots.set(slot,false);var slot_item=$(item_id);slot_item.remove();$(item_id+"_input").remove();this.filled--;var matching_choice=this.matching_choices.get(item_id);if(matching_choice){matching_choice.removeClassName("disabled");}this.updateSampleContent();if(this.onDeselect){this.onDeselect(slot_item);}},select:function(content){var item_id=this.generate_item_id(content);if(this.selections.get(item_id)){this.deselect(item_id);return false;}if(this.filled>=this.length){return false;}if(this.choices){var matching_choice=this.choices.select("li").find(function(item){return(item.down("a").innerHTML==content);});this.matching_choices.set(item_id,matching_choice);}this.form.insert(new Element("input",{"type":"hidden","name":"names[]","value":content,"id":item_id+"_input"}));var slot_item=new Element("a",{"href":"#","class":this.itemClass,"id":item_id}).observe("click",function(e){e.stop();this.deselect(item_id);}.bind(this));slot_item.insert(new Element("span").update(content));var next_slot_number=this.slots.find(function(item){return(item.value===false);}).key;var next_slot=$(this.slotID+next_slot_number);next_slot.insert(slot_item);this.selections.set(item_id,next_slot_number);this.slots.set(next_slot_number,true);this.filled++;if(matching_choice){matching_choice.addClassName("disabled");}this.updateSampleContent();if(this.onResourceJSON){this.fetchResourceJSON(content,slot_item);}if(this.onSelect){this.onSelect(content,slot_item);}}})});(function(){var MVT_COOKIE_NAME="mvt";LFM=LFM||{};LFM.Multivariate=LFM.Multivariate||{};LFM.Multivariate.setExperiment=function(id,variation){var cookie=LFM.getCookie(MVT_COOKIE_NAME)||"",experiments=cookie?cookie.split("|"):[],set=false;for(var i=0;i<experiments.length;i++){var pair=experiments[i].split("="),key=pair[0],value=pair[1];if(key==id){value=variation;set=true;}experiments[i]=key+"="+value;}if(!set){experiments.push(id+"="+variation);}cookie=experiments.join("|");LFM.setCookie(MVT_COOKIE_NAME,cookie);};})();LFM.set("Display",{MustacheRenderer:Class.create({templates:{},templateName:"",initialize:function(templateName){if(templateName){this.setTemplatePath(templateName);}},setTemplatePath:function(templateName){this.templateName=templateName;},getTemplatePath:function(){return this.templateName;},renderTemplate:function(templateName,data,successFunction,partialNames){if(!partialNames){partialNames=[];}var self=this;var templateNames=partialNames.clone();templateNames.push(templateName);this.getTemplates(templateNames,function(templates){if(templates.constructor==Error){if(typeof successFunction=="function"){successFunction(templates);}}else{template=templates[templateName];partials=templates;delete partials[templateName];var html=Mustache.render(template,data,partials);if(typeof successFunction=="function"){successFunction(html);}}});},getTemplates:function(templateNames,successFunction){var templates={};var error;templateNames.each(function(templateName){this.getTemplate(templateName,function(template){templates[templateName]=template;if(templates[templateName].constructor==Error){error=template;}if(Object.keys(templates).length==templateNames.length){if(typeof successFunction=="function"){if(error){successFunction(error);}else{successFunction(templates);}}}});},this);},getTemplateSuccessQueue:{},getTemplate:function(templateName,successFunction){if(!this.templates[templateName]){this.templates[templateName]=true;var self=this;var request=new Ajax.Request("/template/"+this.getTemplatePath()+templateName,{onComplete:function(response){if(request.success()){self.templates[templateName]=response.responseText;}else{var templatePath=self.getTemplatePath()+templateName;var error=new Error("the template "+templatePath+" does not exist");self.templates[templateName]=error;}self.getTemplate(templateName,successFunction);if(self.getTemplateSuccessQueue[templateName]){self.getTemplateSuccessQueue[templateName].each(function(item){self.getTemplate(templateName,item[0]);},self);self.getTemplateSuccessQueue[templateName]=null;}if(self.templates[templateName].constructor==Error){self.templates[templateName]=false;}}});}else{if(this.templates[templateName]===true){if(!this.getTemplateSuccessQueue[templateName]){this.getTemplateSuccessQueue[templateName]=[];}this.getTemplateSuccessQueue[templateName].push([successFunction]);}else{if(typeof successFunction=="function"){successFunction(this.templates[templateName]);}}}}})});document.observe("dom:loaded",function(event){if($("noobStrapSubmit")){new LFM.Form.Placeholder("noobStrapTextarea");$("noobStrapSubmit").observe("click",function(e){if($F("noobStrapTextarea")&&$F("noobStrapTextarea")!=$F("noobStrapPlaceholder")){}else{e.stop();}});}});LFM.set("PreviewButtonManager",Class.create({buttonSelector:"a.previewbutton",activeClass:"previewbutton-active",trackIdAttribute:"data-track-id",trackDurationAttribute:"data-track-duration",loadingAnimation:null,loadingAnimationParams:{startFrame:3,length:5,loop:true,fps:10,play:true},playbackAnimation:null,playbackAnimationParams:{startFrame:8,length:33},playbackId:null,initialize:function(trackPlaybackManager){this.trackPlaybackManager=trackPlaybackManager;this.trackPlaybackManager.onReady(this.apply.bind(this));},apply:function(){document.observe("click",this.onClick.bind(this));document.observe("trackPlaybackManager:finish",this.onFinish.bind(this));document.observe("trackPlaybackManager:stop",this.onStop.bind(this));document.observe("trackPlaybackManager:error",this.onError.bind(this));document.observe("trackPlaybackManager:playback",this.onPlayback.bind(this));},getAudioURL:function(elementAnchor){var audioURL=elementAnchor.getAttribute("href");if(!audioURL.endsWith(".mp3")){audioURL=false;var dataTrackScrabble=elementAnchor.getAttribute("data-track-scrabble");if(dataTrackScrabble){audioURL=dataTrackScrabble;}}return audioURL;},getTrack:function(elementAnchor){var track={};track.id=elementAnchor.getAttribute(this.trackIdAttribute);track.duration=parseInt(elementAnchor.getAttribute(this.trackDurationAttribute),10);if(track.id&&track.duration){return track;}return false;},isFullLength:function(elementAnchor){return elementAnchor.hasClassName("full-length-track");},play:function(elementAnchor,elementImage,audioURL,trackToScrobble,isFullLength){this.loadingAnimation=new LFM.Util.SpriteAnimation(elementImage,this.loadingAnimationParams);this.playbackAnimation=new LFM.Util.SpriteAnimation(elementImage,this.playbackAnimationParams);elementAnchor.addClassName(this.activeClass);if(isFullLength){this.playbackId=this.trackPlaybackManager.playFLP(audioURL,trackToScrobble);this.trackPlaybackManager.startPlayback();}else{if(audioURL){this.playbackId=this.trackPlaybackManager.playPreview(audioURL);this.trackPlaybackManager.startPlayback();}}},stop:function(){this.trackPlaybackManager.stopPlayback();this.cleanupAnimation();var activeButtonSelector=this.buttonSelector+"."+this.activeClass;$$(activeButtonSelector).invoke("removeClassName",this.activeClass);},cleanupAnimation:function(){if(this.loadingAnimation){this.loadingAnimation.stop();this.loadingAnimation.cleanup();delete this.loadingAnimation;}if(this.playbackAnimation){this.playbackAnimation.cleanup();delete this.playbackAnimation;}},onClick:function(event){var element=event.element();var elementAnchor=element.match(this.buttonSelector)?element:element.up(this.buttonSelector);var elementImage=elementAnchor?elementAnchor.down("img",0):null;if(!elementImage||!elementAnchor){return;}var isPlaying=elementAnchor.hasClassName(this.activeClass);var audioURL=this.getAudioURL(elementAnchor);var trackToScrobble=this.getTrack(elementAnchor);var isFullLength=this.isFullLength(elementAnchor);this.stop();if(audioURL||track){event.preventDefault();elementAnchor.blur();if(!isPlaying){this.play(elementAnchor,elementImage,audioURL,trackToScrobble,isFullLength);}}},onPlayback:function(evt){var id=evt.memo[0];if(id==this.playbackId){var position=evt.memo[1];var duration=evt.memo[2];if(this.loadingAnimation.isPlaying()){this.loadingAnimation.stop();this.playbackAnimation.reset();}var audioProgress=position/duration*100;var animationProgress=(this.playbackAnimation.getFramePosition()+1)/this.playbackAnimation.getLength()*100;if(audioProgress>animationProgress){this.playbackAnimation.next();}}},onFinish:function(){this.stop();},onStop:function(){this.stop();},onError:function(){this.stop();}}));document.observe("dom:loaded",function(){new LFM.PreviewButtonManager(LFM.Modules.getTrackPlaybackManagerInstance());});LFM.set("Page",{Extract:{trackIds:function(rootElement,unique){if(typeof unique=="undefined"){unique=true;}rootElement=$(rootElement)||document.body;var trackIds=rootElement.select("*[data-track-id]").collect(function(elem){return elem.getAttribute("data-track-id");});return unique?this._unique(trackIds):trackIds;},_unique:function(list){var sorted=list.sortBy(function(item){return Number(item);});uniques=[list[0]];for(var i=1;i<sorted.length;i++){if(sorted[i-1]==sorted[i]){}else{uniques.push(sorted[i]);}}return uniques;}}});LFM.set("Input",{RichText:Class.create({hasFocus:false,busy:false,wordSeparators:" \t\n,.()!?|=-\\",initialize:function(div,options){this.div=$(div);this.options=options?options:{};this.caret=this.div.down("span.caret");this.caret.style.color="white";this.caret.style.borderLeft="1px solid white";this.textarea=this.div.next("textarea");Event.observe(this.textarea,"keypress",this.keyPress.bindAsEventListener(this));Event.observe(this.textarea,"keydown",this.keyDown.bindAsEventListener(this));Event.observe(window,"keydown",this.keyDown.bindAsEventListener(this));Event.observe(this.div,"click",this.focus.bindAsEventListener(this));Event.observe(window,"blur",this.blur.bindAsEventListener(this));new Ajax.Request("/ajax/getArtists",{onComplete:function(resp){var out=resp.responseText.evalJSON();this.artists=out.items;}.bind(this)});},keyDown:function(e){e=window.event||e;var keyCode=e.charCode||e.keyCode||e.which;var s=String.fromCharCode(keyCode);this.cancelOnDown=false;if(this.specialKeyDown(keyCode,e)){Event.stop(e);this.cancelOnDown=true;return false;}if(e.ctrlKey){s=s.toLowerCase();if(s=="a"||s=="m"){Event.stop(e);var sel=this.getSelection();var name=this.getSelectedText(sel);var richtext;if(s=="a"){richtext="<lfm:artist>"+name.strip().escapeHTML()+"</lfm:artist>";}else{if(s=="m"){richtext='<lfm:artist name="'+name.strip().escapeHTML()+'"><lfm:image size="small" /></lfm:artist>';}}this.replaceSelection(richtext,sel);}}},getSelection:function(){var sel;if(window.getSelection){sel=window.getSelection();}else{if(document.selection){sel=document.selection.createRange();}}return sel;},getSelectedText:function(sel){var name="";var next=sel.anchorNode;while(next){if(next.nodeValue){name+=next.nodeValue;}if(next==sel.focusNode){break;}next=next.nextSibling;}return name;},replaceSelection:function(richtext,sel){new Ajax.Request("/ajax/richtextrenderer",{method:"post",parameters:{richtext:richtext},onComplete:function(resp){var out=resp.responseText.evalJSON();var range=sel.getRangeAt(0);$(document.body).insert({bottom:out.rendered});var node=$(document.body).lastChild;node.remove();range.deleteContents();range.insertNode(node);this.textarea.value+=out.richtext;}});},keyPress:function(e){e=window.event||e;var keyCode=e.charCode||e.keyCode||e.which;var s=String.fromCharCode(keyCode);if(this.specialKeyPress(keyCode,e)){Event.stop(e);return false;}if(e.altKey){Event.stop(e);return false;}if(!this.hasFocus||e.element()==window){return;}var prev=this.caret.previousSibling;if(prev&&prev.nodeType==3&&prev.nodeValue.strip().empty()&&prev.nodeValue!="\n"){var parentNode=prev.parentNode;var range=prev.ownerDocument.createRange();range.setStartBefore(prev);var newChar=range.createContextualFragment(s);var n=parentNode.replaceChild(newChar,prev);var range=this.caret.ownerDocument.createRange();range.setStartBefore(this.caret.previousSibling);var space=range.createContextualFragment(" ");parentNode.insertBefore(space,this.caret.previousSibling);}else{this.caret.insert({before:s});}},_delete:function(prev){var newline=false;var prevPrev=prev.previousSibling;if(prev.nodeType==1){if(prev.nodeName=="A"){var child=prev.firstChild;prev.parentNode.replaceChild(child,prev);child.unlinked=true;var start=this.textarea.selectionStart;var tag="";var i=start-2;while(i>=0&&(this.textarea.value.charAt(i)!="/")){tag=this.textarea.value.charAt(i)+tag;i--;}var closeTagPosition=i;var openTag="<"+tag+">";var openTagLength=openTag.length;while(i>=0&&(this.textarea.value.substr(i,openTagLength)!=openTag)){i--;}var value=this.textarea.value.substr(0,i);var contentStart=i+openTagLength;value+=this.textarea.value.substr(contentStart,closeTagPosition-contentStart-1);value+=this.textarea.value.substr(start);this.textarea.value=value;return;}}if(prev.nodeValue=="\n"){newline=true;}var parentNode=prev.parentNode;if(prev.nodeType==3){var start=this.textarea.selectionStart;var value=this.textarea.value.substr(0,start-1);if(start<this.textarea.value.length){value+=""+this.textarea.value.substr(start);}this.textarea.value=value;if(this.textarea.createTextRange){var oRange=this.textarea.createTextRange();oRange.moveStart("character",start-1);oRange.moveEnd("character",start-1);oRange.select();}else{if(this.textarea.setSelectionRange){this.textarea.setSelectionRange(start-1,start-1);}}if(prev.nodeValue.length>1){prev.nodeValue=prev.nodeValue.substr(0,prev.nodeValue.length-1);return;}}else{if(prev.nodeName=="BR"){this.textarea.value=this.textarea.value.substr(0,this.textarea.value.length-6);}}parentNode.removeChild(prev);if(prevPrev&&prevPrev.nodeType==3&&prevPrev.nodeValue.strip().empty()&&prevPrev.nodeValue!="\n"){var range=prevPrev.ownerDocument.createRange();range.setStartAfter(prevPrev);var nbsp=range.createContextualFragment("&nbsp;");parentNode.replaceChild(nbsp,prevPrev);prevPrev=nbsp;}if(newline){var prevPrev=prev.previousSibling;parentNode.removeChild(prev);this.caret.previousSibling=prevPrev;this.caret.remove();}if(prevPrev){parentNode.insertBefore(this.caret,prevPrev.nextSibling);}},specialKeyDown:function(keyCode,e){if(keyCode>=37&&keyCode<=40&&!(e.ctrlKey||e.altKey||e.shiftKey||e.metaKey)){var prev=this.caret.previousSibling;var next=this.caret.nextSibling;var parent=this.caret.parentNode;if(keyCode==37&&prev){this.caret.remove();parent.insertBefore(this.caret,prev);var start=this.textarea.selectionStart;if(this.textarea.createTextRange){var oRange=this.textarea.createTextRange();oRange.moveStart("character",start-1);oRange.moveEnd("character",start-1);oRange.select();}else{if(this.textarea.setSelectionRange){this.textarea.setSelectionRange(start-1,start-1);}}}else{if(keyCode==39&&next){this.caret.remove();parent.insertBefore(this.caret,next.nextSibling);var start=this.textarea.selectionStart;if(this.textarea.createTextRange){var oRange=this.textarea.createTextRange();oRange.moveStart("character",start+1);oRange.moveEnd("character",start+1);oRange.select();}else{if(this.textarea.setSelectionRange){this.textarea.setSelectionRange(start+1,start+1);}}}}this.textarea.focus();return true;}else{if(keyCode==46){if(this.caret.nextSibling){this.moveTextAreaCursorBy(1);var next=this.caret.nextSibling;this.caret.remove();next.parentNode.insertBefore(this.caret,next.nextSibling);this._delete(next);}return true;}else{if(keyCode==8){if(this.caret.previousSibling){this._delete(this.caret.previousSibling);}return true;}else{if(keyCode==13){this.caret.insert({before:"<br />"});this.textarea.value+="<br />";return true;}}}}},specialKeyPress:function(keyCode,e){var s=String.fromCharCode(keyCode);if(this.cancelOnDown){return true;}if(this.wordSeparators.indexOf(s)>=0){var lastChar=this.caret;if(lastChar.previousSibling&&lastChar.previousSibling.nodeType==3&&!lastChar.previousSibling.unlinked){var back=0;var name="";var insertPoint;while((lastChar=lastChar.previousSibling)&&lastChar.nodeType==3&&lastChar.nodeValue.unescapeHTML().strip()!=""){name=lastChar.nodeValue+name;back++;}insertPoint=lastChar;var richtext=false;name=name.strip();if(s!="."&&name.match(/^((ht|f)tp(s?)\:\/\/|~\/|\/)?([\w]+:\w+@)?([a-zA-Z]{1}([\w\-]+\.)+([\w]{2,5}))(:[\d]{1,5})?((\/?\w+\/)+|\/?)(\w+\.[\w]{3,4})?((\?\w+=\w+)?(&\w+=\w+)*)?/)){richtext='<a href="'+name.escapeHTML()+'">'+name.escapeHTML()+"</a>";}else{var upperName=name.toUpperCase();var found=this.artists.find(function(a){return a.toUpperCase()==upperName;});if(found){richtext="<lfm:artist>"+name.escapeHTML()+"</lfm:artist>";}}if(richtext){var textareaStart=this.textarea.selectionStart;new Ajax.Request("/ajax/richtextrenderer",{method:"post",parameters:{richtext:richtext},onComplete:function(resp){var out=resp.responseText.evalJSON();var lastChar=insertPoint.nextSibling;for(;back>0;back--){var tmp=lastChar.nextSibling;lastChar.parentNode.removeChild(lastChar);lastChar=tmp;}if(insertPoint){var range=insertPoint.ownerDocument.createRange();range.setStartAfter(insertPoint);var element=range.createContextualFragment(out.rendered);insertPoint.parentNode.insertBefore(element,insertPoint.nextSibling);}else{this.div.insert({top:out.rendered});}var value=this.textarea.value.substr(0,textareaStart-name.length);value+=out.richtext;value+=""+this.textarea.value.substr(textareaStart);this.textarea.value=value;}.bind(this)});}}}else{if(s=="/"){var lastChar=this.caret.previousSibling;if(!lastChar||lastChar.nodeValue!="["){return false;}var nextToCursor=lastChar;var contents="";var tag="";var back=2;while((lastChar=lastChar.previousSibling)&&lastChar.nodeType==3&&lastChar.nodeValue!="]"){contents=lastChar.nodeValue+contents;back++;}while((lastChar=lastChar.previousSibling)&&lastChar.nodeType==3&&lastChar.nodeValue!="["){tag=lastChar.nodeValue+tag;back++;}if(tag=="artist"){contents=contents.strip();var textareaStart=this.textarea.selectionStart;var richtext="<lfm:artist>"+contents.escapeHTML()+"</lfm:artist>";new Ajax.Request("/ajax/richtextrenderer",{method:"post",parameters:{richtext:richtext},onComplete:function(resp){var out=resp.responseText.evalJSON();lastChar=nextToCursor;for(var i=back;i>0;i--){var tmp=lastChar.previousSibling;lastChar.parentNode.removeChild(lastChar);lastChar=tmp;}if(this.caret.previousSibling){var rm=this.caret.previousSibling;rm.parentNode.removeChild(rm);}this.caret.insert({before:out.rendered});var value=this.textarea.value.substr(0,textareaStart-back-1);value+=""+out.richtext;value+=""+this.textarea.value.substr(textareaStart);this.textarea.value=value;}.bind(this)});return true;}}}if(s==" "){this.caret.insert({before:"&nbsp;"});this.textarea.value+=" ";return true;}},moveTextAreaCursorBy:function(n){var start=this.textarea.selectionStart;if(this.textarea.createTextRange){var oRange=this.textarea.createTextRange();oRange.moveStart("character",start+n);oRange.moveEnd("character",start+n);oRange.select();}else{if(this.textarea.setSelectionRange){this.textarea.setSelectionRange(start+n,start+n);}}},focus:function(e){Event.stop(e);var rangeParent=e.rangeParent;if(this.caret.parentNode){this.caret.remove();}if(rangeParent!=this.caret&&rangeParent!=this.div){rangeParent.parentNode.insertBefore(this.caret,rangeParent.nextSibling);}else{this.div.appendChild(this.caret);}this.hasFocus=true;this.textarea.focus();this.startBlinkingCaret();},blur:function(){this.hasFocus=false;this.stopBlinkingCaret();},startBlinkingCaret:function(){this.caret.style.borderLeft="1px solid black";},stopBlinkingCaret:function(){this.blinkCaret();},blinkCaret:function(){this.caret.style.borderLeft=this.caret.style.borderLeft=="1px solid black"?"1px solid white":"1px solid black";}})});LFM.set("Scrobbler",new (Class.create({minScrobbleDuration:30,scrobbleURL:"/ajax/scrobble",nowPlayingURL:"/ajax/nowplaying",initialize:function(){},sendScrobble:function(track,successCallback,failureCallback,application){var params={method:"post",parameters:{track:track.id,formtoken:LFM.Session.formtoken},onSuccess:successCallback,onFailure:failureCallback};if(application){params.parameters.application=application;}new Ajax.Request(this.scrobbleURL,params);},sendNowPlaying:function(track,successCallback,failureCallback,application){var params={method:"post",parameters:{track:track.id,formtoken:LFM.Session.formtoken},onSuccess:successCallback,onFailure:failureCallback};if(application){params.parameters.application=application;}new Ajax.Request(this.nowPlayingURL,params);},isScrobblable:function(track){var isValidDuration=track.duration&&track.duration>this.minScrobbleDuration;var hasValidMetadata=track.id;return isValidDuration&&hasValidMetadata;},getScrobblePoint:function(track){return Math.min(Math.round(track.duration/2),4*60);},shouldScrobble:function(track,position){return position>this.getScrobblePoint(track);}}))());LFM.set("ScrobbleStream",Class.create({id:null,updateInterval:10,updateLimit:50,maxUpdates:20,updateCount:0,scrobbles:[],streamURL:"/ajax/getgloballisteners",interval:null,isUpdating:false,isPopulated:false,initialize:function(id){this.id=id;},start:function(){if(this.interval){return;}this.update();this.interval=setInterval(this.update.bind(this),this.updateInterval*1000);},stop:function(){clearInterval(this.interval);this.interval=null;},updateData:function(){if(this.updateCount>=this.maxUpdates){this.stop();return;}this.updateCount++;if(this.isUpdating){return;}this.isUpdating=true;new Ajax.Request(this.streamURL,{parameters:{limit:this.updateLimit,formtoken:LFM.Session.formtoken},onException:(function(r){this.isUpdating=false;}).bind(this),onFailure:(function(r){this.isUpdating=false;}).bind(this),onSuccess:(function(response){if(response.responseText){var scrobbles=response.responseText.evalJSON();for(var i=0;i<scrobbles.length;i++){this.scrobbles.push(scrobbles[i]);}}this.isUpdating=false;}).bind(this)});},update:function(){if(this.scrobbles.length<=1){this.updateData();}if(this.scrobbles.length==0){return;}var scrobble=this.scrobbles.shift();var li=new Element("li",{"style":"display: none;"}).update(scrobble);$(this.id).insert({"top":li});new Effect.SlideDown(li,{duration:1});}}));var Scroller=Class.create({initialize:function(scroller){this.scroller=$(scroller);this.imageTrackContainer=$(document).getElementsByClassName("imageTrackContainer",this.scroller)[0];this.imageTrack=this.imageTrackContainer.getElementsByTagName("UL")[0];this.isScrolling=false;this.makeScrollingWork();this.centerSelectedImage();},makeScrollingWork:function(){Element.addClassName(this.scroller,"scrollerJS");if(this.getWidth()<=this.getVisibleWidth()){if(window.attachEvent&&!window.opera){Element.setStyle(this.scroller,{width:this.getWidth()+"px"});}}else{Element.setStyle(this.scroller,{padding:"0 10px",marginLeft:0,marginRight:0,overflow:"hidden"});this.leftScrollButton=document.createElement("a");this.leftScrollButton.innerHTML="scroll left";this.leftScrollButton.href="#";Element.addClassName(this.leftScrollButton,"scrollLeft");this.scroller.insertBefore(this.leftScrollButton,this.imageTrackContainer);Event.observe(this.leftScrollButton,"click",this.scrollLeft.bindAsEventListener(this));this.rightScrollButton=document.createElement("a");this.rightScrollButton.innerHTML="scroll right";this.rightScrollButton.href="#";Element.addClassName(this.rightScrollButton,"scrollRight");this.scroller.insertBefore(this.rightScrollButton,this.imageTrackContainer);Event.observe(this.rightScrollButton,"click",this.scrollRight.bindAsEventListener(this));Event.observe(window,"resize",this.onResize.bindAsEventListener(this));this.setWidth();}},setWidth:function(){if(!this.imageWidth){this.imageWidth=this.getImageWidth();}Element.setStyle(this.scroller,{maxWidth:this.getWidth()+"px"});var optimalWidth=this.getVisibleWidth();modulo=optimalWidth%this.imageWidth;optimalWidth=optimalWidth-modulo;if(optimalWidth>this.getWidth()){optimalWidth=this.getWidth();}Element.setStyle(this.scroller,{maxWidth:optimalWidth+"px"});var scrollDelta=this.getWidth()*-1+Math.abs(this.getOffset())+this.getVisibleWidth();var properScrollDelta=(this.getWidth()-this.getVisibleWidth())*-1;this.setOffset(properScrollDelta);this.refreshButtonStates();},onResize:function(event){this.setWidth();},getImageWidth:function(){if(this.imageWidth){return this.imageWidth;}else{sampleImage=this.imageTrack.getElementsByTagName("LI")[0];if(sampleImage){this.imageWidth=sampleImage.offsetWidth;this.imageWidth=this.imageWidth+Element.getStyle(sampleImage,"padding-left").replace("px","")*1;this.imageWidth=this.imageWidth+Element.getStyle(sampleImage,"padding-right").replace("px","")*1;this.imageWidth=this.imageWidth+Element.getStyle(sampleImage,"margin-left").replace("px","")*1;this.imageWidth=this.imageWidth+Element.getStyle(sampleImage,"margin-right").replace("px","")*1;var borderLeftWidth=Element.getStyle(sampleImage,"border-left-width").replace("px","")*1;if(!isNaN(borderLeftWidth)){this.imageWidth=this.imageWidth+borderLeftWidth;}var borderRightWidth=Element.getStyle(sampleImage,"border-right-width").replace("px","")*1;if(!isNaN(borderRightWidth)){this.imageWidth=this.imageWidth+borderRightWidth;}return this.imageWidth;}else{return false;}}},getMiddle:function(){return Math.ceil(this.imageTrackContainer.offsetWidth/2);},getWidth:function(){return this.imageTrack.offsetWidth;},getVisibleWidth:function(){return this.imageTrackContainer.offsetWidth;},getNumberOfVisibleImages:function(){return Math.floor(this.getVisibleWidth()/this.getImageWidth());},getNumberOfImages:function(){return Math.floor(this.imageTrack.getElementsByTagName("LI").length);},getOffset:function(){offset=Element.getStyle(this.imageTrack,"left");if(offset){offset=offset.replace("px","")*1;if(!isNaN(offset)){return offset;}else{return 0;}}else{return 0;}},setOffset:function(offset){var blah=this.getWidth()-this.getVisibleWidth();this.imageTrack.setStyle({left:offset+"px"});},scrollLeft:function(event){if(!this.isScrolling&&this.getOffset()<0){var maxDelta=Math.abs(this.getOffset());var delta=this.getVisibleWidth();if(delta>maxDelta){delta=maxDelta;}this.scroll(delta);}this.refreshButtonStates();this.leftScrollButton.blur();Event.stop(event);},scrollRight:function(event){if(!this.isScrolling&&(Math.abs(this.getOffset())+this.getVisibleWidth())<this.getWidth()){var maxDelta=this.getWidth()-(Math.abs(this.getOffset())+this.getVisibleWidth());var delta=this.getVisibleWidth();if(delta>maxDelta){delta=maxDelta;}delta=delta*-1;this.scroll(delta);}this.refreshButtonStates();this.rightScrollButton.blur();Event.stop(event);},scroll:function(delta,force){if(!this.isScrolling||force){new Effect.Move(this.imageTrack,{x:delta,y:0,mode:"relative",duration:0.5,afterFinish:this.afterScrolling.bind(this),beforeStart:this.beforeScrolling.bind(this),queue:{position:"end",scope:"scroller"}});}},beforeScrolling:function(effect){this.isScrolling=true;this.totalDelta=this.totalDelta+effect.options.x;},afterScrolling:function(effect){this.isScrolling=false;this.totalDelta=this.totalDelta-effect.options.x;this.refreshButtonStates();},refreshButtonStates:function(){if(this.rightScrollButton&&this.leftScrollButton){if((Math.abs(this.getOffset())+this.getVisibleWidth())<this.getWidth()){this.rightScrollButton.className="scrollRight";}else{this.rightScrollButton.className="scrollRight disabled";}if(this.getOffset()<0){this.leftScrollButton.className="scrollLeft";}else{this.leftScrollButton.className="scrollLeft disabled";}}},getSelectedImage:function(){selectedImage=$(document).getElementsByClassName("selected",this.imageTrack)[0];if(selectedImage){return $(selectedImage);}else{return false;}},centerSelectedImage:function(){if(this.getVisibleWidth()!=this.getWidth()){var offset=this.getSelectedImage().id;if(offset&&this.getImageWidth()){offset=(offset.substring(5)*1)-1;var imageOffset=offset*this.getImageWidth();imageOffset=imageOffset-this.getMiddle()+this.getImageWidth()/2;if(imageOffset>(this.getWidth()-this.getVisibleWidth())){imageOffset=this.getWidth()-this.getVisibleWidth();}imageOffset=imageOffset*-1;if(imageOffset>0){imageOffset=0;}Element.setStyle(this.imageTrack,{left:imageOffset+"px"});this.refreshButtonStates();}}}});LFM.set("Form",{SelectAChain:Class.create({initialize:function(containerElem){if(!containerElem){containerElem=document.body;}containerElem=$(containerElem);this.clickListenerElem=containerElem;this.boundClickListener=this.clickHandler.bindAsEventListener(this);this.clickListenerElem.observe("click",this.boundClickListener);this.renderer=new LFM.Display.MustacheRenderer("selectachain/");this.renderer.getTemplates(["root","items","item","selectbox"]);},destroy:function(){this.clickListenerElem.stopObserving("click",this.boundClickListener);},create:function(selectachain,treeSettings,state){selectachain.childElements().each(function(liItem){this.initialiseLiItem(liItem);},this);if(!treeSettings){var domTreeSettings=this.getTreeSettingsFromDOM(selectachain);if(domTreeSettings){treeSettings=domTreeSettings;}}this.setTreeSettings(selectachain,treeSettings);if(!state){var domState=this.getStateFromDOM(selectachain);if(domState){state=domState;}}this.setState(selectachain,state);},getJSONFromDOM:function(domNode){var domText=domNode.innerHTML;domText=domText.strip();domText=domText.substring(1,domText.length-1);return domText.evalJSON();},getTreeSettingsFromDOM:function(selectachain){var treeSettingsNode=$(selectachain.readAttribute("id")+"-treesettings");if(treeSettingsNode){return this.getJSONFromDOM(treeSettingsNode);}},setTreeSettings:function(selectachain,treeSettings){selectachain.store("selectachain-treeSettings",treeSettings);},getTreeSettings:function(selectachain){return selectachain.retrieve("selectachain-treeSettings");},getStateFromDOM:function(selectachain){var stateNode=$(selectachain.readAttribute("id")+"-state");if(stateNode){return this.getJSONFromDOM(stateNode);}},setState:function(selectachain,state){selectachain.store("selectachain-state",state);},getState:function(selectachain){return selectachain.retrieve("selectachain-state");},initialiseLiItem:function(liItem){this.styleSelectBox(liItem);this.setupChangeEvents(liItem);},styleSelectBox:function(liItem){var selectElem=liItem.down("select");if(selectElem){if(LFM.Form.CustomSelect){new LFM.Form.CustomSelect(selectElem);}}},setupChangeEvents:function(liItem){var inputElem=liItem.down("input");if(inputElem){inputElem.observe("change",this.freetextChangeHandler.bindAsEventListener(this));}var selectElem=liItem.down("select");if(selectElem){selectElem.observe("change",this.optionChangeHandler.bindAsEventListener(this));selectElem.observe("keyup",this.optionChangeHandler.bindAsEventListener(this));}},getSelectachainByKey:function(key){var selectachain=$$(".selectachain[data-selectachain-filter="+key+"]");return selectachain[0];},updateDisplay:function(selectachain,completeFunction){var state=this.getState(selectachain);var treeSettings=this.getTreeSettings(selectachain);var processedState=this.preProcessState(state,treeSettings);var self=this;this.renderer.renderTemplate("root",processedState,function(html){if(html.constructor==Error){}else{var tempContainer=new Element("div");tempContainer.insert(html);var newSelectachain=tempContainer.select(".selectachain")[0];self.setTreeSettings(newSelectachain,self.getTreeSettings(selectachain));self.setState(newSelectachain,state);selectachain.replace(newSelectachain);newSelectachain.childElements().each(function(liItem){this.initialiseLiItem(liItem);},self);if(typeof completeFunction=="function"){completeFunction(newSelectachain);}}},["items","item","selectbox"]);},updateDisplayItem:function(liItem,completeFunction){var selectachain=liItem.up(".selectachain");var state=this.getState(selectachain);var treeSettings=this.getTreeSettings(selectachain);var processedState=this.preProcessState(state,treeSettings);var level=liItem.previousSiblings().length-1;var newState=this.getStateItemAtLevel(processedState,level);var template="item";if(liItem.previousSiblings().length==0){template="root";}var self=this;this.renderer.renderTemplate(template,newState,function(html){if(html.constructor==Error){}else{var tempContainer=new Element("div");tempContainer.insert(html);var newLiItem=tempContainer.down("li");liItem.replace(newLiItem);if(newLiItem){self.initialiseLiItem(newLiItem);}if(typeof completeFunction=="function"){completeFunction(newLiItem);}}},["selectbox"]);},updateDisplayItems:function(liItems,completeFunction){var selectachain=liItems[0].up(".selectachain");var completedItems=0;liItems.each(function(liItem){this.updateDisplayItem(liItem,function(newLiItem){completedItems+=1;if(typeof completeFunction=="function"&&liItems.length==completedItems){completeFunction(selectachain);}});},this);},updateFollowingItems:function(liItem,completeFunction){var updateList=[];if(!liItem.next()){liItem.insert({after:new Element("li")});}while(liItem=liItem.next()){updateList.push(liItem);}if(updateList.length>0){this.updateDisplayItems(updateList,completeFunction);}},updateDisplayByPath:function(path,completeFunction){var keys=this.getPathAsKeys(path);var mainKey=keys.shift();var selectachain=this.getSelectachainByKey(mainKey);var state=this.getState(selectachain);this.updateStateByArray(state,keys);this.updateDisplay(selectachain,completeFunction);},getPathAsKeys:function(path){var keys=path.split("/");if(keys[0]==""){keys.shift();}keys.each(function(key,index){keys[index]=decodeURIComponent(key).replace(/\+/g," ");},this);return keys;},getStateItemAtLevel:function(state,index){if(!index){index=0;}if(index>0){if(state.selectedItem){return this.getStateItemAtLevel(state.selectedItem,index-1);}}else{return state;}},getStateItemForLi:function(liItem){var selectachain=liItem.up(".selectachain");var state=this.getState(selectachain);var level=liItem.previousSiblings().length-1;return this.getStateItemAtLevel(state,level);},getDepth:function(state){var depth=0;var stateItem=state;while(stateItem=stateItem.selectedItem){depth+=1;}return depth;},updateStateByArray:function(stateItem,keys){stateItem.selectedItem=false;while(keys.length>0){stateItem.selectedItem={"key":keys[0]};if(stateItem.options){stateItem.options.each(function(option){if(option.key==keys[0]){Object.extend(stateItem.selectedItem,option);}});}stateItem=stateItem.selectedItem;keys.shift();}},preProcessState:function(stateItem,treeSettings,index){if(!index||index<0){index=0;}if(!stateItem.selectedItem&&stateItem.options&&stateItem.isOpen&&!treeSettings[index].allowFreetext){stateItem.selectedItem=selectedItemInOptions=stateItem.options[0];}var processItem=Object.toJSON(stateItem).evalJSON();if(processItem.selectedItem){processItem.selectedItem=this.preProcessState(processItem.selectedItem,treeSettings,index+1);}if(treeSettings){Object.extend(processItem,Object.clone(treeSettings[index]));}if(index==0){processItem.showRootLink=!!(processItem.isOpen||processItem.selectedItem);}processItem.showBackLink=!!(processItem.selectedItem&&(processItem.selectedItem.isOpen||processItem.selectedItem.selectedItem));processItem.showField=!!(processItem.selectedItem||processItem.isOpen);processItem.showControl=!!(processItem.hasOptions||processItem.allowFreetext);var inOptions=false;if(processItem.options){var selectedKey=null;if(processItem.selectedItem){selectedKey=processItem.selectedItem.key;}processItem.options.each(function(option){if(selectedKey){option.isSelected=false;}if(selectedKey&&option.key==selectedKey){option.isSelected=true;inOptions=true;}});}if(!inOptions&&processItem.selectedItem){processItem.selectedItem.isFreetext=true;}else{if(processItem.selectedItem){processItem.selectedItem.isFreetext=false;}}return processItem;},openItem:function(liItem,completeFunction){var selectachain=liItem.up(".selectachain");var state=this.getState(selectachain);var level=liItem.previousSiblings().length;var stateItem=this.getStateItemAtLevel(state,level);if(stateItem.isOpen||stateItem.selectedItem){if(typeof completeFunction=="function"){completeFunction(false);}return;}stateItem.isOpen=true;stateItem.showAll=false;var self=this;this.updateDisplay(selectachain,function(newSelectachain){self.focusItemControl(newSelectachain.childElements()[level+1]);if(typeof completeFunction=="function"){completeFunction(newSelectachain.childElements()[level]);}});},closeItem:function(liItem,completeFunction){var selectachain=liItem.up(".selectachain");var state=this.getState(selectachain);var level=liItem.previousSiblings().length;var stateItem=this.getStateItemAtLevel(state,level);if(!stateItem.isOpen&&!stateItem.selectedItem){if(typeof completeFunction=="function"){completeFunction(false);}return;}var depth=this.getDepth(state);var index=level;while(depth>=index){var nextStateItem=this.getStateItemAtLevel(state,depth);nextStateItem.isOpen=false;nextStateItem.selectedItem=false;depth-=1;}if(level==0){state.showAll=true;}var self=this;this.updateDisplay(selectachain,function(selectachain){self.focusItemControl(selectachain.childElements()[level]);if(typeof completeFunction=="function"){completeFunction(selectachain.childElements()[level]);}});},changeItem:function(liItem,key,completeFunction){var stateItem=this.getStateItemForLi(liItem);this.updateStateByArray(stateItem,[key]);this.updateFollowingItems(liItem,completeFunction);},focusItemControl:function(liItem){if(liItem.previousSiblings().length==0){liItem.next().down("a").focus();}else{var selectElem=liItem.down("select");var inputElem=liItem.down("input");if(selectElem){selectElem.focus();}else{if(inputElem){inputElem.focus();}}}},clickHandler:function(e){var target=$(e.target);if(target.match("a")){if(target.parentNode.match(".selectachain li")){e.preventDefault();var liItem=target.parentNode;if(target.match(".selectachain-open-link")){this.openItem(liItem.previous());}else{this.closeItem(liItem);}}else{if(target.hasAttribute("data-selectachain-path")){e.preventDefault();var filterPath=target.readAttribute("data-selectachain-path");this.updateDisplayByPath(filterPath);}}}},optionChangeHandler:function(e){var target=$(e.target);var liItem=target.up(".selectachain li");var option=target.select("option")[target.selectedIndex];if(option.value!=="_"){this.changeItem(liItem,option.value);}this.clearFreetextControl(liItem);},freetextChangeHandler:function(e){var target=$(e.target);var liItem=target.up(".selectachain li");this.changeItem(liItem,target.value);this.clearOptionControl(liItem);},clearOptionControl:function(liItem){var select=liItem.down("select");if(select){select.selectedIndex=0;Event.fire(select,"CustomSelect:change");}},clearFreetextControl:function(liItem){var input=liItem.down("input");if(input){input.value="";}}})});LFM.set("Resource",{Shoutbox:Class.create(LFM.Observable,{initialize:function($super,shoutbox){this.shoutbox=shoutbox;this.shoutbox.container=$(this.shoutbox.container);this.textarea=$("shoutmsg");this.overCharLimit=false;if($("shoutPost")){$("shoutPost").observe("submit",this.submit.bindAsEventListener(this));this.textarea.observe("keyup",this.calculateCharCount.bindAsEventListener(this));}this.deleteButtons=this.shoutbox.container.select(".delete");this.deleteButtons.each(function(deleteButton){deleteButton.observe("click",this.bin.bindAsEventListener(this));}.bind(this));if($("shoutboxPopup")){$("shoutboxPopup").observe("click",this.popup.bindAsEventListener(this));}if($("shoutPostToggler")&&$("shoutPostToggler").down("a")){$("shoutPostToggler").down("a").observe("click",this.toggleInput.bindAsEventListener(this));}if($("shoutPostAgain")){$("shoutPostAgain").observe("click",this.toggleInput.bindAsEventListener(this));}$super();},submit:function(e){e.stop();if($F(this.textarea)==""){return;}var self=this;if(LFM.Page.Captcha){if(!LFM.Page.Captcha.isVisible()){LFM.Page.Captcha.show(function(){self.notifyObservers(new LFM.Event.ShoutCaptchaShown());});return;}}this.toggleInput(e);$("shoutPostWait").show();$("shoutboxError").hide();var url=this.shoutbox.destination;if(url.substr(-1)!="/"){url+="/";}url+="add";var pars=$("shoutPost").serialize()+"&restype="+this.shoutbox.restype+"&resid="+this.shoutbox.resid+"&lang="+this.shoutbox.lang+"&ajax=1";if($("captcha")){pars+="&recaptcha_challenge_field="+$("recaptcha_challenge_field").value+"&recaptcha_response_field="+$("recaptcha_response_field").value;}var that=this;var myAjax=new Ajax.Request(url,{method:"post",parameters:pars,onSuccess:this.addShout.bind(this),onFailure:function(){that.toggleInput();$("shoutPostWait").hide();$("shoutboxError").show();if(LFM.Page.Captcha){LFM.Page.Captcha.reload();}}});},addShout:function(originalRequest){if(this.shoutbox.restype==20){LFM.Page.Tracker.eventCommentPost();}else{LFM.Page.Tracker.eventShoutPost();}var shoutList=$("shoutList");$("shoutList").insert({before:originalRequest.responseText});if(this.shoutbox.order=="asc"){shoutList.innerHTML=shoutList.innerHTML+$("newShoutList").innerHTML;}else{shoutList.innerHTML=$("newShoutList").innerHTML+shoutList.innerHTML;}$("newShoutList").remove();$("shoutList").select("li").each(function(li){var newDeleteButton=li.down(".delete");if(newDeleteButton){newDeleteButton.observe("click",this.bin.bindAsEventListener(this));}}.bind(this));this.textarea.value="";$("shoutPostWait").hide();if($("noShouts")){$("noShouts").remove();}if($("shoutPostToggler")){$("shoutPostToggler").hide();}$("shoutPostAgain").show();if(LFM.Page.Captcha){$("captcha").remove();delete LFM.Page.Captcha;}this.updateCharCountDisplay(0);this.notifyObservers(new LFM.Event.ShoutComplete());},bin:function(event){event.stop();var shoutItem=event.findElement("li");var form=shoutItem.down("form");var action=this.shoutbox.destination;if(action.substr(-1)!="/"){action+="/";}action+="delete";form.action=action;var restype=this.shoutbox.restype;var resid=this.shoutbox.resid;var dialog=new LFM.Dialog({content:LFM.String.deleteMessagePrompt,confirmText:LFM.String.deleteButtonText,action:action,onConfirm:function(e){e.stop();this.hide();form.request({parameters:{restype:restype,resid:resid,ajax:1},onSuccess:function(req){if(req.responseText=="OK"){new Effect.Fade(shoutItem,{duration:0.2});}}});}});dialog.show();},toggleInput:function(e){if($("shoutPost").visible()){$("shoutPost").hide();}else{$("shoutPostAgain").hide();$("shoutPost").show();this.textarea.focus();}if(typeof e!=="undefined"){e.stop();}},calculateCharCount:function(){var charcount=this.textarea.value.length;this.updateCharLimit(charcount);this.updateCharCountDisplay(charcount);},updateCharCountDisplay:function(charcount){charCounter=$("sbCharCount");var charCounterText=this.shoutbox.charlimitMessage;if(charCounter){charCounterText=charCounterText.replace(/CURRENTCHARS/,charcount);charCounterText=charCounterText.replace(/MAXCHARS/,this.shoutbox.charlimit);charCounter.innerHTML=charCounterText;}},updateCharLimit:function(charcount){var overCharLimit=(charcount>this.shoutbox.charlimit);if(!this.overCharLimit&&overCharLimit){$("sbCharCount").up().addClassName("overCharLimit");$("sbPost").disable();this.textarea.focus();}if(this.overCharLimit&&!overCharLimit){$("sbCharCount").up().removeClassName("overCharLimit");$("sbPost").enable();}this.overCharLimit=overCharLimit;},hasShout:function(){if(this.textarea){return shout=$F(this.textarea).strip()!="";}else{return false;}}})});LFM.set("Social",{SocialNetwork:Class.create({readyEventName:"SocialNetworkAPI:Init",ready:false,API:null,initialize:function(){},setAPI:function(API){this.API=API;this.ready=true;Event.fire(document,this.readyEventName);},onReady:function(callback){if(this.ready){callback(this.API);}else{var self=this;$(document).observe(this.readyEventName,function(e){callback(self.API);});}}})});LFM.set("Social",{Facebook:Class.create(LFM.Social.SocialNetwork,{readyEventName:"FacebookAPI:Init",likeEventName:"FacebookAPI:Like",unlikeEventName:"FacebookAPI:Unlike",sendEventName:"FacebookAPI:Send",initialize:function(facebookLang,facebookChannelURL){var self=this;window.fbAsyncInit=function(){FB.init({channelUrl:facebookChannelURL,xfbml:true});self.setAPI(FB);self.bindEventListeners();};document.observe("dom:loaded",function(){LFM.getScript("//connect.facebook.net/"+facebookLang+"/all.js");});},bindEventListeners:function(){var self=this;this.API.Event.subscribe("edge.create",function(){document.fire(self.likeEventName,arguments);});this.API.Event.subscribe("edge.remove",function(){document.fire(self.unlikeEventName,arguments);});this.API.Event.subscribe("message.send",function(){document.fire(self.sendEventName,arguments);});},onLike:function(callback){$(document).observe(this.likeEventName,function(e){callback.apply(this,e.memo);});},onUnlike:function(callback){$(document).observe(this.unlikeEventName,function(e){callback.apply(this,e.memo);});},onSend:function(callback){$(document).observe(this.sendEventName,function(e){callback.apply(this,e.memo);});}}),Twitter:Class.create(LFM.Social.SocialNetwork,{readyEventName:"TwitterAPI:Init",tweetEventName:"TwitterAPI:Tweet",initialize:function(){window.twttr=window.twttr||(t={_e:[],ready:function(f){t._e.push(f);}});var self=this;window.twttr.ready(function(twttr){self.setAPI(twttr);self.bindEventListeners();});LFM.getScript("//platform.twitter.com/widgets.js");},bindEventListeners:function(){var self=this;this.API.events.bind("tweet",function(){document.fire(self.tweetEventName,arguments);});},onTweet:function(callback){$(document).observe(this.tweetEventName,function(e){callback.apply(this,e.memo);});}}),Plusone:Class.create(LFM.Social.SocialNetwork,{readyEventName:"PlusoneAPI:Init",plusoneEventName:"PlusoneAPI:Plusone",initialize:function(googleLang){window["___gcfg"]={google_analytics:false,lang:googleLang,parsetags:"explicit"};this.bindEventListeners();var self=this;LFM.getScript("https://apis.google.com/js/plusone.js",function(){self.setAPI(gapi);});},bindEventListeners:function(){var self=this;window["trackPlusone"]=function(){document.fire(self.plusoneEventName,arguments);};},onPlusone:function(callback){$(document).observe(this.plusoneEventName,function(e){if(e.memo[0]["state"]=="on"){callback.apply(this,e.memo);}});},onMinusone:function(callback){$(document).observe(this.plusoneEventName,function(e){if(e.memo[0]["state"]=="off"){callback.apply(this,e.memo);}});}})});LFM.set("SoundManager",Class.create({initialize:function(){}}));LFM.SoundManager.getInstance=function(){if(!window.soundManager){window.soundManager=new SoundManager();window.soundManager.url=LFM.Session.staticHost+"/flatness/soundmanager/297a-20110918/";if(LFM.get("useHTML5Audio")){window.soundManager.useHTML5Audio=true;window.soundManager.preferFlash=false;}window.soundManager.debugMode=true;window.soundManager.onready(function(){LFM.log("SoundManager2 Ready");});window.soundManager.ontimeout(function(){LFM.log("SoundManager2 not supported");});window.soundManager.beginDelayedInit();}return window.soundManager;};LFM.set("Util",{SpriteAnimation:Class.create({initialize:function(element,params){this.element=element;this.frameSize=params.frameSize||this.element.getHeight();this.startFrame=params.startFrame||0;this.endFrame=this.startFrame+params.length-1;this.loop=params.loop||false;this.positionX=params.positionX||0;this.positionY=params.positionY||0;this.axis=(params.axis||"y").toUpperCase();this.fps=params.fps||1;this.currentFrame=this.startFrame;this.timer=null;if(params.play){this.play();}},reset:function(){this.setFrame(this.startFrame);},getLength:function(){return this.endFrame-this.startFrame+1;},next:function(){if(this.currentFrame!=this.endFrame){this.setFrame(1+this.currentFrame);}else{if(this.loop){this.reset();}else{this.stop();}}},setFrame:function(frame){this.currentFrame=frame;this["position"+this.axis]=this.currentFrame*(this.frameSize*-1);var pos=this.positionX+"px "+this.positionY+"px";this.element.setStyle({backgroundPosition:pos});},play:function(start,end,loop){this.stop();this.reset();this.timer=setInterval(this.next.bind(this),1000/this.fps);},getFramePosition:function(){return this.currentFrame-this.startFrame;},stop:function(){clearTimeout(this.timer);this.timer=null;},isPlaying:function(){return !!this.timer;},cleanup:function(){this.element.setStyle({"backgroundPosition":""});}})});LFM.set("Display",{TableDragDrop:Class.create({initialize:function(table,options){this.draggedRow=null;this.rowWithBorderAndShit=null;this.mouseOffset=null;this.oldY=0;this.dragged=false;if(options&&options.dragHandle){this.dragHandle=options.dragHandle;}else{this.dragHandle=false;}this.table=$(table);this.table.addClassName("draggable");this.table.observe("mousedown",this.onMouseDown.bindAsEventListener(this));if(this.dragHandle){this.table.addClassName("withDragHandles");}else{this.table.addClassName("allDraggable");}this.table.down("tbody").observe("click",this.onClick.bindAsEventListener(this));},onClick:function(event){if(this.dragged){event.stop();this.dragged=false;}},getMouseOffset:function(target,event){var docPos=target.cumulativeOffset();return{x:event.pointerX()-docPos.left,y:event.pointerY()-docPos.top};},onMouseDown:function(event){if(!event.isLeftClick()){return;}if(this.dragHandle&&!event.element().hasClassName(this.dragHandle)){return;}if((tag_name=event.element().tagName.toUpperCase())&&(tag_name=="INPUT"||tag_name=="SELECT"||tag_name=="OPTION"||tag_name=="BUTTON"||tag_name=="TEXTAREA")){return;}this.draggedRow=event.findElement("tr");if(this.draggedRow.previous("tr")){this.rowWithBorderAndShit=this.draggedRow.previous("tr");this.rowWithBorderAndShit.addClassName("beforeDraggedRow");}else{if(this.draggedRow.next("tr")){this.rowWithBorderAndShit=this.draggedRow.next("tr");this.rowWithBorderAndShit.addClassName("afterDraggedRow");}}this.mouseOffset=this.getMouseOffset(this.draggedRow,event);event.stop();this.draggedRow.addClassName("dragging");this.documentOnMouseMove=this.onMouseMove.bindAsEventListener(this);this.documentOnMouseUp=this.onMouseUp.bindAsEventListener(this);document.observe("mousemove",this.documentOnMouseMove);document.observe("mouseup",this.documentOnMouseUp);this.rows=this.table.down("tbody").select("tr");},onMouseMove:function(event){var y=event.pointerY()-this.mouseOffset.y;event.stop();if(y!=this.oldY){var movingDown=y>this.oldY;this.oldY=y;var targetRow=this.findDropTargetRow(y);if(targetRow){this.dragged=true;if(movingDown&&this.draggedRow!=targetRow){this.draggedRow.parentNode.insertBefore(this.draggedRow,targetRow.nextSibling);}else{if(!movingDown&&this.draggedRow!=targetRow){this.draggedRow.parentNode.insertBefore(this.draggedRow,targetRow);}}}}},onMouseUp:function(event){event.stop();this.draggedRow.removeClassName("dragging");this.rowWithBorderAndShit.removeClassName("beforeDraggedRow");this.rowWithBorderAndShit.removeClassName("afterDraggedRow");if(this.onDrop){this.onDrop(this.table,this.draggedRow);}this.draggedRow=null;document.stopObserving("mousemove",this.documentOnMouseMove);document.stopObserving("mouseup",this.documentOnMouseUp);},findDropTargetRow:function(y){return this.rows.find(function(row){var rowY=row.cumulativeOffset().top;var rowHeight=row.getHeight()/2;if((y>rowY-rowHeight)&&(y<(rowY+rowHeight))){return true;}else{return false;}});return null;}})});LFM.set("Modules",{TrackPlaybackManager:function(soundManager,scrobbler){var playingSound,started,scrobbleTrack,hasScrobbled,currentPlayingType,currentPlayingId,idCount,showBufferingDelay=500,isBuffering,that=this;that.start=function(){if(started){LFM.log("TrackPlaybackManager module already started");return;}started=true;if(!soundManager){LFM.log("TrackPlaybackManager needs a soundManager instance");return;}that.soundManager=soundManager;that.scrobbler=scrobbler?scrobbler:null;playingSound=null;idCount=0;started=false;hasScrobbled=false;isBuffering=false;};that.stop=function(){if(!started){LFM.log("TrackPlaybackManager module already stopped");return;}started=false;};that.onReady=function(callback){that.soundManager.onready(callback);};that.newTrackId=function(){return"track"+idCount++;};that.playFLP=function(morphedUrl,trackToScrobble){that.enableScrobbling(trackToScrobble);that.currentPlayingType="Full length";that.currentPlayingId=that.newTrackId();var url=that.decodeMorphedURL(morphedUrl);that.playAudio(url);LFM.Page.Tracker.eventPlayTrack(that.currentPlayingType);return that.currentPlayingId;};that.playPreview=function(url){that.disableScrobbling();that.currentPlayingType="Preview";that.currentPlayingId=that.newTrackId();that.playAudio(url);LFM.Page.Tracker.eventPlayTrack(that.currentPlayingType);return that.currentPlayingId;};that.startPlayback=function(){that.playingSound.play();};that.stopPlayback=function(){if(that.playingSound){that.playingSound.stop();}};that.enableScrobbling=function(track){that.scrobbleTrack=track;that.hasScrobbled=false;};that.disableScrobbling=function(){that.scrobbleTrack=null;};that.decodeMorphedURL=function(encoded){return"http://"+encoded.split("").reverse().join("")+".mp3";};that.playAudio=function(audioURL){var id="sound_"+audioURL;that.soundManager.stopAll();that.hasSentNowPlaying=false;var soundFromCache=that.soundManager.getSoundById(id);if(soundFromCache){that.playingSound=soundFromCache;}else{that.playingSound=that.soundManager.createSound({id:id,url:audioURL,onfinish:that.onSMFinish,onstop:that.onSMStop,onplay:that.onSMPlay,ontimeout:that.onSMTimeout,whileloading:that.onSMWhileLoading,whileplaying:that.onSMWhilePlaying,autoPlay:false});}};that.onSMFinish=function(){that.bufferChange(false);that.clearBufferTimeout();LFM.Page.Tracker.eventPlayTrackFinished(that.currentPlayingType);jQuery(document).trigger("finish.trackPlaybackManager",that.currentPlayingId);Event.fire(document,"trackPlaybackManager:finish",that.currentPlayingId);};that.onSMStop=function(){that.bufferChange(false);that.clearBufferTimeout();jQuery(document).trigger("stop.trackPlaybackManager",that.currentPlayingId);Event.fire(document,"trackPlaybackManager:stop",that.currentPlayingId);};that.onSMTimeout=function(status){jQuery(document).trigger("timeout.trackPlaybackManager",[that.currentPlayingId,status]);Event.fire(document,"trackPlaybackManager:timeout",[that.currentPlayingId,status]);};that.onSMPlay=function(){that.bufferChange(false);that.setBufferTimeout();jQuery(document).trigger("play.trackPlaybackManager",that.currentPlayingId);Event.fire(document,"trackPlaybackManager:play",that.currentPlayingId);};that.bufferChange=function(buffering){if(buffering!=isBuffering){isBuffering=buffering;jQuery(document).trigger("bufferchange.trackPlaybackManager",[that.currentPlayingId,isBuffering]);Event.fire(document,"trackPlaybackManager:bufferchange",[that.currentPlayingId,isBuffering]);}};that.onSMWhileLoading=function(){var bytesLoaded=that.playingSound.bytesLoaded;var bytesTotal=that.playingSound.bytesTotal;jQuery(document).trigger("loading.trackPlaybackManager",[that.currentPlayingId,bytesLoaded,bytesTotal]);Event.fire(document,"trackPlaybackManager:loading",[that.currentPlayingId,bytesLoaded,bytesTotal]);};that.onSMWhilePlaying=function(){var position=that.playingSound.position;var duration=that.playingSound.duration;if(duration<that.playingSound.durationEstimate){duration=that.playingSound.durationEstimate;}if(that.scrobbleTrack){if(!that.hasSentNowPlaying){that.scrobbler.sendNowPlaying(that.scrobbleTrack,null,null,"flp");that.hasSentNowPlaying=true;}var positionInSeconds=position/1000;if(!that.hasScrobbled&&that.scrobbler.shouldScrobble(that.scrobbleTrack,positionInSeconds)){that.scrobbler.sendScrobble(that.scrobbleTrack,null,null,"flp");that.hasScrobbled=true;}}that.bufferChange(false);that.setBufferTimeout();jQuery(document).trigger("playback.trackPlaybackManager",[that.currentPlayingId,position,duration]);Event.fire(document,"trackPlaybackManager:playback",[that.currentPlayingId,position,duration]);};that.clearBufferTimeout=function(){clearTimeout(that.bufferingTimeout);};that.setBufferTimeout=function(){that.clearBufferTimeout();that.bufferingTimeout=setTimeout(function(){that.bufferChange(true);},showBufferingDelay);};}});LFM.set("Modules",{getTrackPlaybackManagerInstance:function(){if(!LFM.Modules.trackPlaybackManagerInstance){LFM.Modules.trackPlaybackManagerInstance=new LFM.Modules.TrackPlaybackManager(LFM.SoundManager.getInstance(),LFM.Scrobbler);LFM.Modules.trackPlaybackManagerInstance.start();}return LFM.Modules.trackPlaybackManagerInstance;}});LFM.set("Resource",{Users:Class.create({initialize:function(users){this.container=$("users");this.container.observe("click",function(event){log("clicked container");var element=event.element();if(element.match("a.delete img")){event.stop();var friend=element.up("li");if(friend){this.bin(friend);}}}.bind(this));},bin:function(friend){var dialog=new LFM.Dialog({resource:friend.getResource(),content:LFM.String.deleteFriendPrompt,confirmText:LFM.String.deleteButtonText,action:"friends/delete",onDone:function(response){var friend_item=response.getResourceElement();new Effect.Fade(friend_item,{duration:0.5});},showDone:false});dialog.show();}})});LFM.set("Video",{FullWidth:Class.create({initialize:function(id){this.container=$(id);this.wrapper=this.container.down("div.wrapper");this.originalDimensions=this.wrapper.getDimensions();this.aspectRatio=this.originalDimensions.height/this.originalDimensions.width;this.resize();Event.observe(document.onresize?document:window,"resize",function(event){this.resize();}.bind(this));},resize:function(){this.wrapper.setStyle({width:this.container.getWidth()+"px",height:Math.round(this.container.getWidth()*this.aspectRatio)+"px"});}})});LFM.set("Video",{YouTubeScrobbler:Class.create({YOUTUBE_STATE_PLAYING:1,initialize:function(id,track){this.id=id;this.track=track;this.hasSentNowPlaying=false;this.hasSentScrobble=false;that=this;window.onYouTubePlayerReady=function(playerid){that.onPlayerReady("onYouTubePlayerStateChange");};window.onYouTubePlayerStateChange=function(state){that.onStateChange(state);};},onPlayerReady:function(functionName){this.player=$(this.id);this.player.addEventListener("onStateChange",functionName);this.track.duration=this.player.getDuration();},onStateChange:function(state){if(state==this.YOUTUBE_STATE_PLAYING){if(!this.hasSentNowPlaying){LFM.Scrobbler.sendNowPlaying(this.track,null,null,"youtube");this.hasSentNowPlaying=true;}if(LFM.Scrobbler.isScrobblable(this.track)){var self=this;setTimeout(function(){self.checkForScrobblePoint(self);},1000);}}},checkForScrobblePoint:function(self){if(!self.hasSentScrobble){if(LFM.Scrobbler.shouldScrobble(self.track,self.player.getCurrentTime())){LFM.Scrobbler.sendScrobble(self.track,null,null,"youtube");self.hasSentScrobble=true;}else{setTimeout(function(){self.checkForScrobblePoint(self);},1000);}}}})});LFM.set("Input",{Weekpicker:Class.create({initialize:function(config){var weekpickers=$$(config.target);weekpickers.each(function(container){var target=container.select("select")[0];var label=container.select("label")[0];new LFM.Form.MasterSlaveSelectBox(target);var master=target.retrieve("MasterSlaveSelectBox.master");var masterLabel=new Element("label",{"for":master.getAttribute("id"),"class":"rm"}).update(config.yearLabel);var slave=target.retrieve("MasterSlaveSelectBox.slave");var slaveLabel=new Element("label",{"for":slave.getAttribute("id"),"class":"rm"}).update(config.weekLabel);target.insert({after:master});master.insert({before:masterLabel});master.insert({after:slave});slave.insert({before:slaveLabel});this.updateWeeknumberStore(slave);master.observe("change",this.masterChangeListener.bindAsEventListener(this));master.observe("keyup",this.masterChangeListener.bindAsEventListener(this));slave.observe("change",this.slaveChangeListener.bindAsEventListener(this));slave.observe("keyup",this.slaveChangeListener.bindAsEventListener(this));new LFM.Form.CustomSelect([slave,master]);},this);},masterChangeListener:function(e){var master=$(e.target);var slave=master.retrieve("MasterSlaveSelectBox.slave");var weeknumber=slave.retrieve("weekpicker-weeknumber");var options=slave.select("option");var optionsWeekRange=[options[0].readAttribute("data-weekpicker-weeknumber"),options[options.length-1].readAttribute("data-weekpicker-weeknumber")];if(weeknumber<optionsWeekRange[0]){slave.selectedIndex=0;}else{if(weeknumber>optionsWeekRange[1]){slave.selectedIndex=slave.options.length-1;}else{options.each(function(optElem,index){if(optElem.readAttribute("data-weekpicker-weeknumber")==weeknumber){slave.selectedIndex=index;}});}}this.updateWeeknumberStore(slave);Event.fire(slave,"CustomSelect:change");Event.fire(slave,"MasterSlaveSelectBox:change");},slaveChangeListener:function(e){var slave=$(e.target);this.updateWeeknumberStore(slave);},updateWeeknumberStore:function(slave){slave.store("weekpicker-weeknumber",slave.select("option")[slave.selectedIndex].readAttribute("data-weekpicker-weeknumber"));}})});LFM.set("Modules",{WikiAbstract:function(app,$wiki){var $=jQuery,$readMore,that={};function adaptForDoubleMpus(){var timer,i=0;if(LFM.Adserver&&LFM.Adserver.adPlacements.mpu){testForDoubleMpu();}function testForDoubleMpu(){if(LFM.Adserver.adPlacements.mpu.tested){if(LFM.Adserver.adPlacements.mpu.height>320){that.expand(null,true);}}else{if(i<20){i++;timer=setTimeout(testForDoubleMpu,50);}}}}that.start=function(){var self=this;if($wiki.length>0){$readMore=$(".wiki-read-more",$wiki);if($wiki.is(":hidden")){self.expand(null,true);}else{if($readMore.length>0){$readMore&&$readMore.on("click",that.expand);adaptForDoubleMpus();}}}};that.stop=function(){$readMore&&$readMore.off("click");$readMore=null;};that.expand=function(evt,suppressEventTracking){evt&&evt.preventDefault();$(".wiki-options",$wiki).addClass("memo");$(".wiki-ellipsis",$wiki).remove();$(".hide",$wiki).removeClass("hide");if(!suppressEventTracking){LFM.Page.Tracker.eventWikiReadMore();}if($("span",$readMore).data("read-all")){$readMore.text($("span",$readMore).data("read-all"));}else{$readMore.hide();}that.stop();};return that;}});jQuery(document).ready(function(){var $wiki=jQuery("#wikiAbstract");if($wiki){var wikiAbstract=new LFM.Modules.WikiAbstract(null,$wiki);wikiAbstract.start();}});LFM.Ajax.LazyRequest=Class.create({options:{laziness:2,beforeSend:false},_defaultAjaxOptions:{method:"post",parameters:{ajax:true,formtoken:LFM.get("Session","formtoken")}},_timeoutId:false,_ajaxUrl:false,_ajaxOptions:{},_lastTime:0,initialize:function(url,lazyOptions){Object.extend(this.options,lazyOptions);this._ajaxUrl=url;if(this.options.lazyness){this.options.laziness=this.options.lazyness;}},send:function(options){if(this._intervalId){clearTimeout(this._intervalId);}var now=new Date();this._lastTime=now.getTime()/1000;this._ajaxOptions=this._defaultAjaxOptions;if(options){if(options.parameters){Object.extend(this._ajaxOptions.parameters,options.parameters);options.paramaters=this._ajaxOptions.parameters;}Object.extend(this._ajaxOptions,options);}this._ajaxOptions.parameters.time=this._lastTime;this._intervalId=setTimeout(this._performSend.bind(this),this.options.laziness*1000);},_beforeSend:function(){if(!this.options.beforeSend){return;}Object.extend(this._ajaxOptions.parameters,this.options.beforeSend());},_performSend:function(){this._beforeSend();new Ajax.Request(this._ajaxUrl,this._ajaxOptions);}});if(Ajax.Request&&!Ajax.Request.prototype.abort){Ajax.Request.prototype.abort=function(){try{if(this.transport&&this.transport.abort){this.transport.onreadystatechange=function(){};this.transport.abort();}}catch(e){}};}LFM.Ajax.Response=Class.create({initialize:function(response){try{if(typeof response=="string"){this.ajaxResponse=response.evalJSON();}else{if(response.responseText){this.ajaxResponse=response.responseText.evalJSON();}else{this.ajaxResponse=response;}}}catch(err){this.ajaxResponse={errormessage:"Invalid JSON response"};}this.data=$H(this.ajaxResponse.data);if(this.isError()){this.printError();}},get:function(key){return this.data.get(key);},set:function(key,value){return this.data.set(key,value);},toObject:function(){return this.data.toObject();},isError:function(){return !this.ajaxResponse.success;},isSuccess:function(){return !this.isError();},getErrorCode:function(){return this.ajaxResponse.errorcode?this.ajaxResponse.errorcode:null;},getErrorMessage:function(){return this.ajaxResponse.errormessage?this.ajaxResponse.errormessage:null;},errorIs:function(code){return this.getErrorCode()===code;},isUnauthorised:function(){return this.errorIs(LFM.Ajax.Response.Errors.UNAUTHORISED);},printError:function(){if(LFM.get("config","DEVELOPMENT_SERVER")){if(!this.ajaxResponse){LFM.warn("Error [No response]");}else{LFM.warn("Error ["+this.getErrorCode()+"]: "+this.getErrorMessage());}}},getResource:function(){return this.ajaxResponse.resource?this.ajaxResponse.resource:null;},getResourceElement:function(){return LFM.getResourceElement(this.getResource());},buildResourceLink:function(){var resource=this.getResource();if(resource){var link=new Element("a",{"href":resource.url});if(resource.name){link.update(resource.name);}return link;}return false;},followRedirect:function(){if(this.ajaxResponse.redirect){window.location.href=this.ajaxResponse.redirect;return true;}else{return false;}}});LFM.Ajax.Response.Errors={UNAUTHORISED:401};LFM.Ajax.setUserPref=function(pref,value,callback){new Ajax.Request("/ajax/setUserPref",{parameters:{formtoken:LFM.Session.formtoken,pref:pref,value:value},onComplete:function(transport){var response=new LFM.Ajax.Response(transport);if(callback){callback(response);}}});};LFM.Ajax.saveOptinPreference=function(option,successCallback,errorCallback){var ajaxReq=new Ajax.Request("/ajax/settings/friendfinder",{method:"post",parameters:{choice:option,formtoken:LFM.Session.formtoken},onComplete:function(response){if(response&&response.responseJSON&&response.responseJSON.success){successCallback();}else{errorCallback();}}});};LFM.Ajax.StatusHolder=Class.create({initialize:function(element,options){this.status="idle";this.element=$(element);this.options={position:"after"};Object.extend(this.options,options);this.indicator=$(this.element.identify()+"_statusHolder");if(this.indicator){if(this.indicator.hasClassName("success")){this.status="success";}else{if(this.indicator.hasClassName("failure")){this.status="failure";}else{if(this.indicator.hasClassName("progress")){this.status="busy";}}}}else{this.indicator=document.createElement("img");this.indicator=Element.extend(this.indicator);this.indicator.src=LFM.Session.staticHost+"/tablestyles/pixel.gif";this.indicator.height=16;this.indicator.width=16;if(this.options.position=="after"){this.element.parentNode.insertBefore(this.indicator,this.element.nextSibling);}else{if(this.options.position=="before"){this.element.parentNode.insertBefore(this.indicator,this.element);}else{if(this.options.position=="top"){this.element.insertBefore(this.indicator,this.element.firstChild);}else{if(this.options.position=="bottom"){this.element.appendChild(this.indicator);}}}}this.indicator=this.indicator.wrap("SPAN");this.indicator.addClassName("statusHolder");this.indicator.id=this.element.identify()+"_statusHolder";}},remove:function(){this.indicator.remove();},busy:function(){this.idle();this.status="busy";this.indicator.addClassName("progress");this.indicator.down("img").src=LFM.Session.staticHost+"/depth/global/progress_new.gif";},isBusy:function(){return this.status=="busy";},success:function(){this.idle();this.status="success";this.indicator.addClassName("success");this.indicator.down("img").src=LFM.Session.staticHost+"/depth/forms/correct_new.gif";},isSuccess:function(){return this.status=="success";},failure:function(){this.idle();this.status="failure";this.indicator.addClassName("failure");this.indicator.down("img").src=LFM.Session.staticHost+"/depth/forms/incorrect_new.gif";},isFailure:function(){return this.status=="failure";},idle:function(){this.status="idle";this.indicator.removeClassName("progress");this.indicator.removeClassName("success");this.indicator.removeClassName("failure");this.indicator.down("img").src=LFM.Session.staticHost+"/tablestyles/pixel.gif";},isIdle:function(){return this.status=="idle";}});LFM.set("Util",{UndoQueue:Class.create({DEFAULT_DELAY:5,initialize:function(opts){this.delay=(opts&&opts.delay)||this.DEFAULT_DELAY;this.queue={};if(opts&&opts.window){Event.observe(opts.window,"beforeunload",this.flush.bind(this));}},add:function(work,manual){var id=+new Date()+$H(this.queue).size().toString(),timeoutId;this.queue[id]={"id":null,"work":work};if(!manual){this.start(id);}return id;},start:function(id){var timeoutId=this.execute.bind(this).delay(this.delay,id,true);this.queue[id].id=timeoutId;return timeoutId;},del:function(id){clearInterval(this.get(id).id);delete this.queue[id];},get:function(id){return this.queue[id];},flush:function(){var self=this;$H(this.queue).each(function(pair){clearInterval(pair.value["id"]);self.execute.call(self,pair.key,false);});},execute:function(id,async){this.get(id).work(async);this.del(id);}})});LFM.set("Ajax",{Autocompleter:Class.create(Ajax.Autocompleter,{setOptions:function(options){this.options=Object.extend({method:"get"},options||{});},buildItem:function(name){return new Element("a",{href:"#"}).update(name).wrap(new Element("li"));},onComplete:function(transport){try{var response=transport.responseText.evalJSON();}catch(err){return false;}if(response&&response.response.docs){var list=new Element("ul"),original_query=this.getToken(),that=this,name;list.insert(this.buildItem(original_query));response.response.docs.each(function(result){switch(that.options.type.toLowerCase()){case"artist":name=result.artist;break;case"tag":name=result.tag;break;default:return false;}if(name.toLowerCase()!=original_query.toLowerCase()){list.insert(this.buildItem(name));}}.bind(this));this.updateChoices(new Element("div").update(list).innerHTML);}}})});LFM.set("Ajax",{Multicompleter:Class.create(LFM.Ajax.Autocompleter,{initialize:function(element,update,url,options){this.baseInitialize(element,update,options);this.url=url;this.options.asynchronous=true;this.options.onComplete=this.onComplete.bind(this);this.options.onHide=function(element,update){window.status="";new Effect.Fade(update,{duration:0.15});};this.form=this.element.up("form");this.submit=this.form.down("input[type=submit]");var defaultParams={};if(this.options.enabled){defaultParams["force"]=1;}else{this.show=function(){return false;};this.startIndicator=function(){return false;};}if(LFM.Session.userName){defaultParams["username"]=LFM.Session.userName;}if(this.options.parameters){defaultParams=Object.extend(defaultParams,this.options.parameters);}this.options.defaultParams=defaultParams;(function(options){var original=options.onShow;options.onShow=function(element,update){update.style.display="block";original(element,update);};})(this.options);this.element.observe("keyup",this.onKeyUp.bindAsEventListener(this));this.update.observe("mouseup",this.onClick.bindAsEventListener(this));this.update.observe("mouseover",this.onHover.bindAsEventListener(this));this.element.observe("focus",this.onFocus.bindAsEventListener(this));this.init();},init:function(){},getUpdatedChoices:function(){this.startIndicator();var entry=encodeURIComponent(this.options.paramName)+"="+encodeURIComponent(this.getToken());this.options.parameters={};this.options.parameters[this.options.paramName]=this.getToken();if(this.options.defaultParams){Object.extend(this.options.parameters,this.options.defaultParams);}this.search();},search:function(){new Ajax.Request(this.url,this.options);this.personalMatches=this.matchPersonalData(this.getToken());},matchPersonalData:function(query){if(!query.length||!this.personalData){return false;}var match_regex=new RegExp(query.replace(/([\\\^\$*+[\]?{}.=!:(|)])/g,"\\$1"),"i");var matches=[];var friends=this.personalData.get("friends");if(friends){friends.each(function(friend,i){var is_match=friend.name.match(match_regex)||(friend.realname&&friend.realname.match(match_regex));if(is_match){matches.push(friend);}});}var groups=this.personalData.get("groups");if(groups){groups.each(function(group,i){var is_match=group.name.match(match_regex);if(is_match){matches.push(group);}});}var labels=this.personalData.get("labels");if(labels){labels.each(function(label,i){var is_match=label.name.match(match_regex)&&label.single_artist!="t";if(is_match){matches.push(label);}});}return matches;},buildEvent:function(result){var datetime_toks=result.date.split("T");var date_toks=datetime_toks[0].split("-");var event_name=result.event||result.artist;var calSheet='<span class="calSheet calSheetSmall">'+'<span title="'+result.date+'">'+'<span class="month">'+LFM.String.shortMonths[date_toks[1]-0]+"</span>"+'<span class="day">'+(date_toks[2]-0)+"</span>"+"</span>"+"</span>";var country=result["country_"+LFM.Session.language]||result["country_en"];return calSheet+"<strong>"+event_name.truncate(25)+"</strong><br>"+result.city.truncate(25)+", "+country.truncate(25);},buildEventTitle:function(result){var event_name=result.event||result.artist;var country=result["country_"+LFM.Session.language]||result["country_en"];return event_name+", "+result.venue+", "+result.city+", "+country;},buildEventURL:function(result){return"/event/"+encodeURIComponent(encodeURIComponent(result.resid));},buildArtist:function(result){var image_url=this.buildArtistImageURL(result);var image='<img src="'+image_url+'" width="34" height="34">';return image+this.buildName(result.artist);},buildArtistTitle:function(result){return result.artist;},buildArtistURL:function(result){return"/music/"+encodeURIComponent(encodeURIComponent(result.artist));},buildArtistImageURL:function(result){if(result.image){return LFM.Session.userserveHost+"/serve/34s/"+result.image;}else{var wsparams={api_key:LFM.Session.wsKey,artist:result.artist,method:"artist.getImageRedirect",size:"smallsquare"};return"http://"+LFM.Session.wsHost+"/2.0/?"+Object.toQueryString(wsparams);}},buildAlbum:function(result){var image_url=this.buildAlbumImageURL(result);var albumCover='<span class="albumCover coverSmall" />'+'<span class="art"><img src="'+image_url+'" width="34" height="34"></span>'+'<span class="jewelcase"></span>'+"</span>";return albumCover+this.buildName(result.album)+"<br>"+result.artist.truncate(25);},buildAlbumTitle:function(result){return result.album+" - "+result.artist;},buildAlbumURL:function(result){return"/music/"+encodeURIComponent(encodeURIComponent(result.artist))+"/"+encodeURIComponent(encodeURIComponent(result.album));},buildAlbumImageURL:function(result){if(result.image){return LFM.Session.userserveHost+"/serve/34s/"+result.image;}else{var wsparams={api_key:LFM.Session.wsKey,artist:result.artist,album:result.album,method:"album.getImageRedirect",size:"smallsquare"};return"http://"+LFM.Session.wsHost+"/2.0/?"+Object.toQueryString(wsparams);}},buildTrack:function(result){var image_url=this.buildArtistImageURL(result);var image='<img src="'+image_url+'" width="34" height="34">';var duration=result.duration?" <small> ("+LFM.timeFormat(result.duration)+")</small>":"";return image+this.buildName(result.track)+duration+"<br>"+result.artist.truncate(25);},buildTrackTitle:function(result){return result.track+" - "+result.artist;},buildTrackURL:function(result){return"/music/"+encodeURIComponent(encodeURIComponent(result.artist))+"/_/"+encodeURIComponent(encodeURIComponent(result.track));},buildTag:function(result){var icon='<img width="30" height="30" src="'+LFM.Session.staticHost+'/flatness/icons/tag/1/tag_30.png">';return icon+this.buildName(result.tag);},buildTagTitle:function(result){return result.tag;},buildTagURL:function(result){return"/tag/"+encodeURIComponent(encodeURIComponent(result.tag));},buildUser:function(result){var image=this.buildResImage(result,"/flatness/catalogue/noimage/2/default_user_small.png");var user=image+this.buildName(result.name);if(result.realname){user+="<br>"+result.realname.truncate(25);}return user;},buildUserTitle:function(result){var title=result.name;if(result.realname){title+=" - "+result.realname;}return title;},buildUserURL:function(result){return"/user/"+encodeURIComponent(encodeURIComponent(result.name));},buildGroup:function(result){var image=this.buildResImage(result,"/flatness/catalogue/noimage/2/default_group_small.png");var name;if(result.group){name=this.buildName(result.group);}else{name=this.buildName(result.name);}return image+name;},buildGroupTitle:function(result){return result.name||result.group;},buildGroupURL:function(result){var name=result.name||result.group;return"/group/"+encodeURIComponent(encodeURIComponent(name));},buildLabel:function(result){var image=this.buildResImage(result,"/flatness/catalogue/noimage/2/default_label_small.png");var name;if(result.label){name=this.buildName(result.label);}else{name=this.buildName(result.name);}return image+name;},buildLabelTitle:function(result){return result.name||result.label;},buildLabelURL:function(result){var root;var name=result.name||result.label;if(result.single_artist=="t"){root="/artist/";}else{root="/label/";}return root+encodeURIComponent(encodeURIComponent(name));},buildName:function(name){return"<strong>"+name.truncate(25)+"</strong>";},buildResTitle:function(result){return result.name;},buildResImage:function(result,defaultImage){var image_url=LFM.Session.staticHost+defaultImage;if(result.image_id){image_url=LFM.Session.userserveHost+"/serve/34s/"+result.image_id+".jpg";}else{if(result.image){image_url=LFM.Session.userserveHost+"/serve/34s/"+result.image;}}var image='<img src="'+image_url+'" width="34" height="34">';return image;},buildItemLink:function(result){var result_restype=result.res?result.res.type:result.restype;var restype=LFM.resTypeLookup[result_restype];if(!restype){LFM.warn("no restype found: "+result_restype);}else{try{var url=this["build"+restype+"URL"](result);if(!this.urls[url]){this.urls[url]=restype;var item=this["build"+restype](result);var title=this["build"+restype+"Title"](result);var link=new Element("a",{href:url+"?ac="+encodeURIComponent(this.getToken()),title:title}).addClassName(restype.toLowerCase()+"Item").update(item);return link;}}catch(e){LFM.warn(restype,e);}}},buildSearchLink:function(result){var search_url=this.form.action+"?"+this.form.serialize();var link=new Element("a",{href:search_url}).addClassName("viewAll");return new Element("span").addClassName("moduleOptions").update(result).wrap(link);},setOptions:function(options){options=options||{};this.options=Object.extend({method:"get",onShow:function(element,update){if(!update.style.position||update.style.position=="absolute"){update.style.position="absolute";Position.clone(element,update,{setHeight:false,setWidth:false,offsetTop:element.offsetHeight});}Effect.Appear(update,{duration:0.15});}},options);},markNext:function(){if(this.index===null){this.index=0;}else{if(this.index<this.entryCount-1){this.index++;}}var entry=this.getCurrentEntry();if(entry){window.status=entry.down("a").href;}else{window.status="";}},markPrevious:function(){if(this.index>0){this.index--;}else{this.index=null;}var entry=this.getCurrentEntry();if(entry){window.status=entry.down("a").href;}else{window.status="";}},getEntry:function(index){if(index!==null){return this.update.down("li.item",index);}},updateElement:function(item){if(item){var link=item.down("a");if(link){LFM.redirect(link.href);return true;}}},addLinkedItem:function(result,list){var link;var restype=result.res?result.res.type:result.restype;if(restype){link=this.buildItemLink(result);}else{link=this.buildSearchLink(result);}if(link){var item=link.wrap(new Element("li").addClassName("item"));list.insert(item);return item;}return false;},onBlur:function(e){this.blurTimeout=setTimeout(function(){this.hide();this.hasFocus=false;this.active=false;}.bind(this),250);},onFocus:function(e){if(this.options.enabled){this.loadPersonalData();}},loadPersonalData:function(){if(this.personalData||!LFM.Session.loggedIn||!LFM.Session.userURL||this.unauthorised){return false;}LFM.info("AC: Load personal data");new Ajax.Request(LFM.Session.userURL+"/acdata",{method:"get",parameters:{ajax:1},onSuccess:function(transport){response=new LFM.Ajax.Response(transport);if(response.isSuccess()){LFM.info("AC: Personal data loaded");this.personalData=response;}else{if(response.isUnauthorised()){this.unauthorised=true;}}}.bind(this)});},onHover:function(e){var link=e.findElement("a");if(link){if(this.index!=link.autocompleteIndex){this.index=link.autocompleteIndex;this.render();}}},onClick:function(e){this.element.focus();clearTimeout(this.blurTimeout);var link=e.findElement("a");},onKeyPress:function(e){if(this.active){switch(e.keyCode){case Event.KEY_TAB:case Event.KEY_RETURN:if(this.options.enabled&&this.getCurrentEntry()){this.selectEntry();e.stop();}break;case Event.KEY_ESC:if(this.options.enabled){this.hide();this.active=false;e.stop();}return;case Event.KEY_LEFT:case Event.KEY_RIGHT:return;case Event.KEY_UP:if(this.options.enabled){this.markPrevious();this.render();e.stop();}return;case Event.KEY_DOWN:if(this.options.enabled){this.markNext();this.render();e.stop();}return;}}else{if(e.keyCode==Event.KEY_TAB||e.keyCode==Event.KEY_RETURN||(Prototype.Browser.WebKit>0&&e.keyCode==0)){return;}}this.changed=true;this.hasFocus=true;if(this.observer){clearTimeout(this.observer);}this.observer=setTimeout(this.onObserverEvent.bind(this),this.options.frequency*1000);},onKeyUp:function(e){this.changed=false;var token=this.getToken();if(token.length>=this.options.minChars&&token!=this.lastToken){this.startIndicator();}},onObserverEvent:function(){this.changed=false;var token=this.getToken();if(token.length>=this.options.minChars){if(token!=this.lastToken&&token!=this.element.getAttribute("placeholder")){this.getUpdatedChoices();}else{this.render();}}else{this.active=false;this.hide();}this.lastToken=token;this.oldElementValue=this.element.value;},getToken:function(){return $F(this.element);},processResults:function(results){var list=new Element("ul");if(results){this.urls={};results.each(function(result,index){this.addLinkedItem(result,list);},this);}this.addViewAll(list,results.length);return list;},addViewAll:function(list,result_count){this.addLinkedItem(LFM.String.siteSearchViewAll.replace("QUERY",this.getToken().escapeHTML()),list);this.entryCount=result_count+1;},onComplete:function(transport){if(this.changed||!this.hasFocus){return false;}var results=new Array,result_count=0;try{var response=transport.responseText.evalJSON();results=response.response.docs;}catch(err){LFM.warn("JSON error: "+transport.responseText);}if(this.personalMatches&&this.personalMatches.length){var personal_slots=Math.min(this.personalMatches.length,3);results=this.personalMatches.slice(0,personal_slots).concat(results.slice(0,10-personal_slots));}result_count=results.length;var list=this.processResults(results);this.updateChoices(list,result_count);},updateChoices:function(list,length){this.update.update(list);var header=new Element("p",{"class":"header"});if(length){header.update(LFM.String.siteSearchSuggestions);}else{header.update(LFM.String.siteSearchNoSuggestions).addClassName("empty");}this.update.insert({"top":header});if(LFM.Session.loggedIn&&!this.personalData){var dataDownMessage=new Element("div").addClassName("message messageWarn").update(LFM.String.autocompletePersonalDataDown);this.update.insert({"bottom":dataDownMessage});}this.update.select("li.item a").each(function(link,index){link.autocompleteIndex=index;},this);this.stopIndicator();this.index=null;this.render();}})});LFM.set("Ajax",{GroupedMulticompleter:Class.create(LFM.Ajax.Multicompleter,{resTypeGroups:[LFM.resTypes.ARTIST,LFM.resTypes.ALBUM,LFM.resTypes.TRACK,LFM.resTypes.EVENT,LFM.resTypes.TAG,LFM.resTypes.USER,LFM.resTypes.GROUP,LFM.resTypes.LABEL],init:function(){this.update.addClassName("grouped");},buildArtist:function(result){var image_url=this.buildArtistImageURL(result);var image='<span class="img"><span><img src="'+image_url+'" width="34" height="34" /></span></span>';return image+'<strong class="artist">'+result.artist.truncate(25)+"</strong>";},buildTrack:function(result){var image_url=this.buildArtistImageURL(result);var image='<span class="img"><span><img src="'+image_url+'" width="34" height="34" /></span></span>';var duration=result.duration?' <small class="time"> ('+LFM.timeFormat(result.duration)+")</small>":"";return image+'<strong class="track">'+result.track.truncate(20)+"</strong>"+duration+"<br>"+result.artist.truncate(25);},buildTag:function(result){var icon='<img width="20" height="20" src="'+LFM.Session.staticHost+'/flatness/icons/activity/tagged.png">';return icon+'<strong class="tag">'+result.tag.truncate(25)+"</strong>";},processResults:function(results,list){var list=new Element("ul");if(results){this.urls={};var groupedResults=this.groupResults(results);var group,groupTitle,groupList,plural;this.resTypeGroups.each(function(restype,index){if(groupedResults[restype]){group=new Element("li");plural=(restype==LFM.resTypes.USER)?LFM.String.resTypePlural["friends"]:LFM.String.resTypePlural[restype];groupTitle=new Element("h3").update(plural).addClassName(LFM.resTypeLookup[restype].toLowerCase());groupList=new Element("ul");groupedResults[restype].each(function(result,index){this.addLinkedItem(result,groupList);},this);group.insert(groupTitle);group.insert(groupList);list.insert(group);}},this);}this.addViewAll(list,results.length);return list;},groupResults:function(results){var groups={},restype;results.each(function(result,index){restype=result.res?result.res.type:result.restype;if(!groups[restype]){groups[restype]=[];}groups[restype].push(result);},this);return groups;}})});LFM.set("Ajax",{SideGroupedMulticompleter:Class.create(LFM.Ajax.GroupedMulticompleter,{init:function(){this.update.addClassName("grouped sidegrouped");},processResults:function(results,list){var table=new Element("table",{cellspacing:0,cellpadding:0,border:0});var tbody=new Element("tbody");var group_count=0;if(results){this.urls={};var groupedResults=this.groupResults(results);var group,groupTitle,groupList,plural;this.resTypeGroups.each(function(restype,index){if(groupedResults[restype]){group_count++;group=new Element("tr");if(group_count%2==0){group.addClassName("alt");}plural=(restype==LFM.resTypes.USER)?LFM.String.resTypePlural["friends"]:LFM.String.resTypePlural[restype];groupTitle=new Element("h3").update(plural).addClassName(LFM.resTypeLookup[restype].toLowerCase());groupList=new Element("ul");groupedResults[restype].each(function(result,index){this.addLinkedItem(result,groupList);},this);group.insert(new Element("th").update(groupTitle));var group_cell=new Element("td").update(groupList);if(group_count==1){group_cell.addClassName("first");}group.insert(group_cell);tbody.insert(group);}},this);}var viewAllRow=new Element("tr");if(group_count%2==0){viewAllRow.addClassName("alt");}var viewAllList=new Element("ul");this.addViewAll(viewAllList,results.length);viewAllRow.insert(new Element("th"));viewAllRow.insert(new Element("td",{"class":"viewAll"}).update(viewAllList));tbody.insert(viewAllRow);table.update(tbody);return table;}})});LFM.set("Links",{setupPost:function(linkContainer){var link=$(linkContainer);var doPost=function(e){e.preventDefault();var token=new Element("input",{type:"hidden",name:"formtoken",value:LFM.Session.formtoken});var form=new Element("Form",{action:this.href,method:"post"});form.appendChild(token);$(this).appendChild(form).submit();};if(link){link.down("a").observe("click",doPost);}}});document.observe("dom:loaded",function(){LFM.Links.setupPost("userVerification");});