(function($){$.fn.extend({autocomplete:function(urlOrData,options){var isUrl=typeof urlOrData=="string";options=$.extend({},$.Autocompleter.defaults,{url:isUrl?urlOrData:null,data:isUrl?null:urlOrData,delay:isUrl&&options&&options.delay?options.delay:10},options);options.highlight=options.highlight||function(value){return value};options.formatMatch=options.formatMatch||options.formatItem;return this.each(function(){new $.Autocompleter(this,options)})},result:function(handler){return this.bind("result",handler)},search:function(handler){return this.trigger("search",[handler])},flushCache:function(){return this.trigger("flushCache")},setOptions:function(options){return this.trigger("setOptions",[options])},unautocomplete:function(){return this.trigger("unautocomplete")}});$.Autocompleter=function(input,options){var KEY={UP:38,DOWN:40,DEL:46,TAB:9,RETURN:13,ESC:27,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8},$input=$(input).attr("autocomplete","off").addClass(options.inputClass),timeout,previousValue="",cache=$.Autocompleter.Cache(options),hasFocus=0,lastKeyPressCode,config={mouseDownOnSelect:false},select=$.Autocompleter.Select(options,input,selectCurrent,config),blockSubmit;$.browser.opera&&$(input.form).bind("submit.autocomplete",function(){if(blockSubmit){blockSubmit=false;return false}});$input.bind(($.browser.opera?"keypress":"keydown")+".autocomplete",function(event){hasFocus=1;lastKeyPressCode=event.keyCode;switch(event.keyCode){case KEY.UP:event.preventDefault();if(select.visible())select.prev();else onChange(0,true);break;case KEY.DOWN:event.preventDefault();if(select.visible())select.next();else onChange(0,true);break;case KEY.PAGEUP:event.preventDefault();if(select.visible())select.pageUp();else onChange(0,true);break;case KEY.PAGEDOWN:event.preventDefault();if(select.visible())select.pageDown();else onChange(0,true);break;case KEY.TAB:case KEY.RETURN:if(selectCurrent()){event.preventDefault();blockSubmit=true;return false}break;case KEY.ESC:select.hide();break;default:clearTimeout(timeout);timeout=setTimeout(onChange,options.delay)}}).focus(function(){hasFocus++}).blur(function(){hasFocus=0;!config.mouseDownOnSelect&&hideResults()}).click(function(){hasFocus++>1&&!select.visible()&&onChange(0,true)}).bind("search",function(){var fn=arguments.length>1?arguments[1]:null;function findValueCallback(q,data){var result;if(data&&data.length)for(var i=0;i<data.length;i++)if(data[i].toLowerCase()==q.toLowerCase()){result=data[i];break}if(typeof fn=="function")fn(result);else $input.trigger("result",result&&[result.data,result.value])}$.each(trimWords($input.val()),function(i,value){request(value,findValueCallback,findValueCallback)})}).bind("flushCache",function(){cache.flush()}).bind("setOptions",function(){$.extend(options,arguments[1]);"data" in arguments[1]&&cache.populate()}).bind("unautocomplete",function(){select.unbind();$input.unbind();$(input.form).unbind(".autocomplete")});function selectCurrent(){var selected=select.selected();if(!selected)return false;previousValue=selected.entry;$input.val(previousValue);hideResultsNow();$input.trigger("result",selected);return true}function onChange(crap,skipPrevCheck){if(lastKeyPressCode==KEY.DEL){select.hide();return}var currentValue=$input.val();if(!skipPrevCheck&&currentValue==previousValue)return;previousValue=currentValue;if(currentValue.length>=options.minChars){if(!options.matchCase)currentValue=currentValue.toLowerCase();request(currentValue,receiveData,hideResultsNow)}else select.hide()}function trimWords(value){if(!value)return [""];return [$.trim(value)]}function hideResults(){clearTimeout(timeout);timeout=setTimeout(hideResultsNow,200)}function hideResultsNow(){select.hide();clearTimeout(timeout)}function receiveData(q,data){if(data&&data.length&&hasFocus){select.display(data,q);select.show()}else hideResultsNow()}function request(term,success,failure){if(!options.matchCase)term=term.toLowerCase();var data=cache.load(term);if(data&&data.length)success(term,data);else if(typeof options.url=="string"&&options.url.length>0)$.ajax({mode:"abort",port:"autocomplete"+input.name,dataType:options.dataType,url:options.url,data:$.extend({q:term,limit:options.nbMaxAutoSuggestResults},options.extraParams),success:function(data){var parsed=parse(data);cache.add(term,parsed);success(term,parsed)}});else{select.emptyList();failure(term)}}function parse(xml){var parsed=[];$(xml).find("SuggestXMLEntry").each(function(){var entry=$(this).attr("entry");if($(this).find("SuggestEntryExtraInformation ")&&$(this).find("SuggestEntryExtraInformation ").length>0)$(this).find("SuggestEntryExtraInformation ").each(function(){var data={entry:entry,department:$(this).attr("value")};parsed[parsed.length]=data});else{var data={entry:entry,department:null};parsed[parsed.length]=data}});return parsed}};$.Autocompleter.defaults={activeClass:"ac_over",cacheLength:10,dataType:"xml",extraParams:{timestamp:+new Date},formatItem:function(row){return row[0]},formatMatch:null,highlight:function(value,term){return value.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+term.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<span class='highlighted_text'>$1</span>")},inputClass:"ac_input",matchCase:false,matchSubset:false,matchContains:false,minChars:2,pattern_accent:["%E9","%E8","%EA","%EB","%E0","%E2","%E4","%EE","%EF","%F9","%FB","%F4","%F6","%E7"],pattern_replace_accent:["e","e","e","e","a","a","a","i","i","u","u","o","o","c"],resultsClass:"ac_results",selectFirst:false,scroll:false,scrollHeight:180,universe:[{department:"Musique",universe:5},{department:"Jeux video",universe:5},{department:"Electromenager",universe:4},{department:"DVD",universe:5},{department:"Image et Son",universe:2},{department:"Informatique",universe:1},{department:"Sport",universe:7},{department:"Librairie",universe:5},{department:"Maison",universe:4},{department:"Photo Camescope",universe:2},{department:"Pret-a-Porter",universe:6},{department:"Bagages",universe:6},{department:"Jeux - Jouets",universe:12},{department:"Bijouterie",universe:6},{department:"Destockage",universe:10},{department:"Vin",universe:8},{department:"Auto",universe:3},{department:"Chaussures",universe:6},{department:"Telephonie",universe:2}]};$.Autocompleter.Cache=function(options){var data={},length=0;function matchSubset(s,sub){if(!options.matchCase)s=s.toLowerCase();var i=s.indexOf(sub);if(options.matchContains=="word")i=s.toLowerCase().search("\\b"+sub.toLowerCase());if(i==-1)return false;return i==0||options.matchContains}function add(q,value){length>options.cacheLength&&flush();if(!data[q])length++;data[q]=value}function populate(){if(!options.data)return false;var stMatchSets={},nullData=0;if(!options.url)options.cacheLength=1;stMatchSets[""]=[];for(var i=0,ol=options.data.length;i<ol;i++){var rawValue=options.data[i];rawValue=typeof rawValue=="string"?[rawValue]:rawValue;var value=options.formatMatch(rawValue,i+1,options.data.length);if(value===false)continue;var firstChar=value.charAt(0).toLowerCase();if(!stMatchSets[firstChar])stMatchSets[firstChar]=[];var row={value:value,data:rawValue,result:options.formatResult&&options.formatResult(rawValue)||value};stMatchSets[firstChar].push(row);nullData++<options.nbMaxAutoSuggestResults&&stMatchSets[""].push(row)}$.each(stMatchSets,function(i,value){options.cacheLength++;add(i,value)})}setTimeout(populate,25);function flush(){data={};length=0}return {flush:flush,add:add,populate:populate,load:function(q){if(!options.cacheLength||!length)return null;if(!options.url&&options.matchContains){var csub=[];for(var k in data)if(k.length>0){var c=data[k];$.each(c,function(i,x){matchSubset(x.value,q)&&csub.push(x)})}return csub}else if(data[q])return data[q];else{if(options.matchSubset)for(var i=q.length-1;i>=options.minChars;i--){var c=data[q.substr(0,i)];if(c){var csub=[];$.each(c,function(i,x){if(matchSubset(x.value,q))csub[csub.length]=x});return csub}}return null}}}};$.Autocompleter.Select=function(options,input,select,config){var listItems,active=-1,data,term="",needsInit=true,element,list;function init(){if(!needsInit)return;element=$("<div/>").hide().addClass(options.resultsClass).css("position","absolute").css("border-bottom","none").appendTo(document.body);list=$("<ul/>").appendTo(element).mouseover(function(event){var element=target(event);if(element&&element.nodeName&&element.nodeName.toUpperCase()=="LI"&&element.className&&element.className!="ac_type_title"){active=removeActiveClass($("li",list)).index(target(event));addActiveClass(element)}else removeActiveClass($("li",list))}).click(function(event){var element=target(event);if(!element||element.className=="ac_type_title")return;addActiveClass(element);select();input.focus();return false}).mousedown(function(){config.mouseDownOnSelect=true}).mouseup(function(){config.mouseDownOnSelect=false});needsInit=false}function target(event){var element=event.target;while(element&&element.tagName!="LI")element=element.parentNode;if(!element)return [];return element}function moveSelect(step){removeActiveClass(listItems.slice(active,active+1));movePosition(step);while(listItems.slice(active,active+1).hasClass("ac_type_title"))if(step<0)movePosition(-1);else movePosition(1);var activeItem=addActiveClass(listItems.slice(active,active+1));if(options.scroll){var offset=0;listItems.slice(0,active).each(function(){offset+=this.offsetHeight});if(offset+activeItem[0].offsetHeight-list.scrollTop()>list[0].clientHeight)list.scrollTop(offset+activeItem[0].offsetHeight-list.innerHeight());else offset<list.scrollTop()&&list.scrollTop(offset)}}function movePosition(step){active+=step;if(active<0)active=listItems.size()-1;else if(active>=listItems.size())active=0}function limitNumberOfItems(available){return options.nbMaxAutoSuggestResults&&options.nbMaxAutoSuggestResults<available?options.nbMaxAutoSuggestResults:available}function fillList(){list.empty();for(var nbResultToDisplay=limitNumberOfItems(data.length),i=0;i<nbResultToDisplay;i++){if(data[i].department){for(var currentUniverse=1,j=0;j<options.universe.length;j++)if(options.universe[j].department==removeAccents(data[i].department)){currentUniverse=options.universe[j].universe;break}var html="<div><div class='ac_elementImg' />"+options.highlight(data[i].entry,term)+" <span class='ac_element_department txt_U"+currentUniverse+"'>dans "+data[i].department+"</span></div>"}else var html="<div><div class='ac_elementImg' />"+options.highlight(data[i].entry,term)+"</div>";var li=$("<li/>").html(html).addClass("ac_element").appendTo(list)[0];$.data(li,"ac_data",data[i])}listItems=list.find("li");if(options.selectFirst){addActiveClass(listItems.slice(0,1));active=0}$.fn.bgiframe&&list.bgiframe()}function removeAccents(string){var new_string=escape(string);if(new_string&&new_string!="")for(var i=0;i<options.pattern_accent.length;i++)new_string=new_string.replace(new RegExp(options.pattern_accent[i],"gi"),options.pattern_replace_accent[i]);return unescape(new_string)}function removeActiveClass(items){return $(items).find("div").removeClass(options.activeClass)}function addActiveClass(items){return $(items).find("div").addClass(options.activeClass)}function sortList(data,term){var returnList=[],firstElementIndex=getFirstElementForList(data,term);returnList[0]=data[firstElementIndex];data=data.slice(0,firstElementIndex).concat(data.slice(firstElementIndex+1));while(data.length>0){var minIndex=getMin(data,term);returnList[returnList.length]=data[minIndex];data=data.slice(0,minIndex).concat(data.slice(minIndex+1))}return returnList}function getFirstElementForList(data,term){for(var minIndexOfTerm=Number.MAX_VALUE,minIndexInList=0,i=0;i<data.length;i++){var indexOfTerm=removeAccents(data[i].entry).toLowerCase().indexOf(term.toLowerCase());if(indexOfTerm>-1&&indexOfTerm<minIndexOfTerm&&!data[i].department){minIndexInList=i;minIndexOfTerm=indexOfTerm;if(indexOfTerm==0)break}}return minIndexInList}function getMin(data,term){for(var minIndexOfTerm=Number.MAX_VALUE,minIndexInList=0,departmentOfMin=null,i=0;i<data.length;i++){var indexOfTerm=removeAccents(data[i].entry).toLowerCase().indexOf(term.toLowerCase());if(indexOfTerm>-1&&indexOfTerm<minIndexOfTerm&&(!departmentOfMin||data[i].department)||!departmentOfMin&&data[i].department){minIndexInList=i;if(indexOfTerm>-1)minIndexOfTerm=indexOfTerm;else minIndexOfTerm=Number.MAX_VALUE;departmentOfMin=data[i].department;if(indexOfTerm==0&&departmentOfMin)break}}return minIndexInList}return {display:function(d,q){init();term=removeAccents(q);data=sortList(d,term);fillList()},next:function(){moveSelect(1)},prev:function(){moveSelect(-1)},pageUp:function(){if(active!=0&&active-8<0)moveSelect(-active);else moveSelect(-8)},pageDown:function(){if(active!=listItems.size()-1&&active+8>listItems.size())moveSelect(listItems.size()-1-active);else moveSelect(8)},hide:function(){element&&element.hide();listItems&&removeActiveClass(listItems);active=-1},visible:function(){return element&&element.is(":visible")},current:function(){return this.visible()&&($(listItems).find("div").filter("."+options.activeClass)[0]||options.selectFirst&&listItems[0])},show:function(){var offset=$(input).offset();element.css({top:offset.top+input.offsetHeight-1,left:offset.left}).show();if(options.scroll){list.scrollTop(0);list.css({maxHeight:options.scrollHeight,overflow:"auto"});if($.browser.msie&&typeof document.body.style.maxHeight==="undefined"){var listHeight=0;listItems.each(function(){listHeight+=this.offsetHeight});var scrollbarsVisible=listHeight>options.scrollHeight;list.css("height",scrollbarsVisible?options.scrollHeight:listHeight);!scrollbarsVisible&&listItems.width(list.width()-parseInt(listItems.css("padding-left"))-parseInt(listItems.css("padding-right")))}}},selected:function(){var selected=listItems&&$(listItems).find("div").filter("."+options.activeClass).removeClass(options.activeClass);selected=$(selected).parent();return selected&&selected.length&&$.data(selected[0],"ac_data")},emptyList:function(){list&&list.empty()},unbind:function(){element&&element.remove()}}};$.fn.selection=function(start,end){if(start!==undefined)return this.each(function(){if(this.createTextRange){var selRange=this.createTextRange();if(end===undefined||start==end){selRange.move("character",start);selRange.select()}else{selRange.collapse(true);selRange.moveStart("character",start);selRange.moveEnd("character",end);selRange.select()}}else if(this.setSelectionRange)this.setSelectionRange(start,end);else if(this.selectionStart){this.selectionStart=start;this.selectionEnd=end}});var field=this[0];if(field.createTextRange){var range=document.selection.createRange(),orig=field.value,teststring="<->",textLength=range.text.length;range.text=teststring;var caretAt=field.value.indexOf(teststring);field.value=orig;this.selection(caretAt,caretAt+textLength);return {start:caretAt,end:caretAt+textLength}}else if(field.selectionStart!==undefined)return {start:field.selectionStart,end:field.selectionEnd}}})(jQuery); 