$.fn.initSearchV2=function(){var $blocSearch=$(this),$input=$("input:first",$blocSearch),$options=$.parseJSON($input.attr("data-options").replace(/'/g,'"')),$select=$("select:first",$blocSearch),$submit=$("button.jqSearchButton",$blocSearch),$resultBloc=$("#searchResult"),$universes={Musique:5,"Jeux video":5,Electromenager:4,DVD:5,"Image et Son":2,Informatique:1,Sport:7,Librairie:5,Maison:4,"Photo Camescope":2,"Pret-a-Porter":6,Bagages:6,"Jeux - Jouets":12,Bijouterie:6,Destockage:10,Vin:8,Auto:3,Chaussures:6,Telephonie:2},$pattern_accent=["%E9","%E8","%EA","%EB","%E0","%E2","%E4","%EE","%EF","%F9","%FB","%F4","%F6","%E7"],$pattern_replace_accent=["e","e","e","e","a","a","a","i","i","u","u","o","o","c"],bgColor="#EBEEF2",removeAccents=function(string){var new_string=escape(string);if(new_string&&new_string!="")for(var i=0;i<$pattern_accent.length;i++)new_string=new_string.replace(new RegExp($pattern_accent[i],"gi"),$pattern_replace_accent[i]);return unescape(new_string)},goToSearch=function(){$resultBloc.hide("fast");var queryStr=encodeURI($input.val().replace(/[+&<>^|:\?\.\/\*%#\"\\]/g," ").replace(/[\s+]/g," ").replace(/^(\s)+|(\s)+$/g,"").replace(/\s+/g,"+").replace(/[\']/g," "));queryStr.length>0&&queryStr!=$options.placeholder?(document.location.href=$options.front+$select.find("option[selected]").val()+queryStr+".html"):alert("Saisissez votre recherche");return false},updateSearch=function($resultEl){$resultEl.is("[data-value]")&&$input.val($resultEl.attr("data-value"));$resultEl.attr("[data-value]")&&$input.val($resultEl.attr("[data-value]"));if($resultEl.is("[data-dpt]"))$("option","#searchDepartements").filter(function(){return $(this).text()==$resultEl.attr("data-dpt")}).attr("selected","selected");else $("option","#searchDepartements").eq(0).attr("selected","selected")};$input.val($options.value).attr("placeholder",$options.placeholder);$resultBloc.click(function(e){var $target=$(e.target);!$target.is("[data-value]")&&($target=$target.parent());updateSearch($target);return goToSearch()}).mousemove(function(e){$(">div",$resultBloc).css("background-color","");$resultBloc.data("currentPos",-1);var $target=$(e.target);!$target.is("[data-value]")&&($target=$target.parent());$target.css("background-color",bgColor)});$input.blur(function(){setTimeout(function(){$resultBloc.hide("fast")},300)}).keydown(function(e){if(e.which==13){$resultBloc.data("currentPos")!=-1&&updateSearch($(">div",$resultBloc).eq($resultBloc.data("currentPos")));$submit.unbind("click");return goToSearch()}else if(e.which==40||e.which==38){var curPos=$resultBloc.data("currentPos"),results=$(">div",$resultBloc);results.css("background-color","");if(e.which==38)curPos>-1?--curPos:(curPos=results.length-1);else curPos<results.length-1?++curPos:(curPos=0);updateSearch($(">div",$resultBloc).eq(curPos));$resultBloc.data("currentPos",curPos);$(">div",$resultBloc).eq(curPos).css("background-color",bgColor)}else!(e.which!=9&&$input.val().length>1&&$input.val()!=$options.value)&&$resultBloc.hide("fast").html("")}).keyup(function(e){if(e.which!=40&&e.which!=38&&e.which!=13&&e.which!=9&&$input.val().length>1&&$input.val()!=$options.value){$resultBloc.html("");$.get($options.url+"?q="+$input.val(),function(response){var $firstEntry;$("SuggestXMLEntry:lt("+$options.limit+")",response).each(function(){var $e=$(this),$dpt=$("SuggestEntryExtraInformation:first",$e).attr("value")||"",$class="";if($dpt==""){$firstEntry=$e.attr("entry");$resultBloc.append('<div data-value="'+$e.attr("entry")+'">'+$e.attr("entry").replace($input.val(),$input.val().bold()));return false}});$("SuggestXMLEntry:lt("+$options.limit+")",response).each(function(){var $e=$(this),$dpt=$("SuggestEntryExtraInformation:first",$e).attr("value")||"",$dptA=removeAccents($dpt),$class="";if($dpt!=""||$e.attr("entry")!=$firstEntry){if($dptA in $universes)$class=" c_U"+$universes[$dptA];$resultBloc.append('<div data-value="'+$e.attr("entry")+'" data-dpt="'+$dpt+'">'+$e.attr("entry").replace($input.val(),$input.val().bold())+($dpt!=""?' <span class="italic smaller'+$class+'">dans '+$dpt:""))}});$resultBloc.show();$resultBloc.data("currentPos",-1)})}});$input.one("focus",function(){var $this=$(this);$resultBloc.css({top:Math.round($this.innerHeight()+$this.offset()["top"])+"px",left:Math.round($this.offset()["left"])+"px"})});$submit.bind("click",function(){return goToSearch()})};