/*1334135656,169776321*/

if (window.CavalryLogger) { CavalryLogger.start_js(["4zqoQ"]); }

__d("AvailableListConstants",[],function(a,b,c,d,e,f){var g={ON_AVAILABILITY_CHANGED:'buddylist/availability-changed',ON_UPDATE_ERROR:'buddylist/update-error',ON_UPDATED:'buddylist/updated',ON_CHAT_NOTIFICATION_CHANGED:'chat-notification-changed',OFFLINE:0,IDLE:1,ACTIVE:2,MOBILE:3,LEGACY_OVERLAY_OFFLINE:-1,LEGACY_OVERLAY_ONLINE:0,LEGACY_OVERLAY_IDLE:1,legacyStatusMap:{'0':2,'1':1,'-1':0,'2':3},reverseLegacyStatusMap:{0:-1,1:1,2:0,3:2}};window.AvailableListConstants=e.exports=g;},3);
__d("ChatConfig",["copyProperties","ChatConfigInitialData"],function(a,b,c,d,e,f){var g=c('ChatConfigInitialData'),h=b('copyProperties'),i={},j=e.exports={get:function(k,l){return k in i?i[k]:l;},set:function(k){if(arguments.length>1){var l={};l[k]=arguments[1];k=l;}h(i,k);},getDebugInfo:function(){return i;}};j.set(g);},3);
__d("PresenceUtil",["Cookie","Env","math-extensions","tx"],function(a,b,c,d,e,f){var g=b('Cookie'),h=b('Env'),i=b('math-extensions'),j=b('tx'),k=i.rand32()+1;a.PresenceUtil=e.exports={checkMaintenanceError:function(l){if(l.getError()==1356007)return true;return false;},getErrorDescription:function(l){var m=l.getError(),n=l.getErrorDescription();if(!n)n="An error occurred.";if(m==1357001)n="Your session has timed out. Please log in.";return n;},getSessionID:function(){return k;},hasUserCookie:function(){return h.user===g.get('c_user');}};},3);
__d("presence-cookie-manager",["Cookie","Dcode","ErrorUtils","Env","JSLogger","PresenceUtil","URI","PresenceInitialData"],function(a,b,c,d,e,f){a.CookieManager=function(){};var g=b('Cookie'),h=b('Dcode'),i=b('ErrorUtils'),j=b('Env'),k=b('JSLogger'),l=b('PresenceUtil'),m=b('URI'),n=c('PresenceInitialData'),o=n.cookieVersion,p=n.dictEncode,q='presence',r={},s=null,t=null,u=k.create('presence_cookie');function v(){try{var y=g.get(q);if(s!==y){s=y;t=null;if(y&&y.charAt(0)=='E')y=h.decode(y.substring(1));if(y)t=JSON.parse(y);}if(t&&(!t.user||t.user===j.user))return t;}catch(x){u.warn('getcookie_error');}return null;}function w(){return parseInt(new Date().getTime()/1000,10);}a.presenceCookieManager=e.exports={register:function(x,y){r[x]=y;},store:function(){var x=v();if(x&&x.v&&o<x.v)return;var y={v:o,time:w(),user:j.user};for(var z in r)y[z]=i.applyWithGuard(r[z],r,[x&&x[z]],function(da){da.presence_subcookie=z;});var aa=JSON.stringify(y);if(p)aa='E'+h.encode(aa);if(l.hasUserCookie()){var ba=aa.length;if(ba>1024)u.warn('big_cookie',ba);var ca=m.getRequestURI(false).isSecure()&&!!g.get('csm');g.set(q,aa,null,null,ca);}},clear:function(){g.clear(q);},getSubCookie:function(x){var y=v();if(!y)return null;return y[x];}};},3);
__d("PresenceState",["Arbiter","copyProperties","ErrorUtils","FunctionUtils","JSLogger","math-extensions","presence-cookie-manager","setIntervalAcrossTransitions","Util","PresenceInitialData"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('ErrorUtils'),j=b('FunctionUtils'),k=b('JSLogger'),l=b('math-extensions'),m=b('presence-cookie-manager'),n=b('setIntervalAcrossTransitions'),o=b('Util'),p=c('PresenceInitialData'),q=p.cookiePollInterval||2000,r=[],s=[],t=null,u=null,v=0,w=null,x=0,y=['sb2','t2','lm2','uct2','tr','tw','at'],z=k.create('presence_state');function aa(){return m.getSubCookie('state');}function ba(){v=Date.now();m.store();ea(u);}var ca=j.debounce(ba,0,false);function da(ia){var ja={};if(ia){y.forEach(function(ma){ja[ma]=ia[ma];});if(v<ia.ut)z.error('new_cookie',{cookie_time:ia.ut,local_time:v});}ja.ut=v;for(var ka=0,la=r.length;ka<la;ka++)i.applyWithGuard(r[ka],null,[ja]);u=ja;return u;}function ea(ia){x++;v=l.verifyNumber(ia.ut);if(!t)t=n(ha,q);u=ia;if(w===null)w=ia;for(var ja=0,ka=s.length;ja<ka;ja++)i.applyWithGuard(s[ja],null,[ia]);x--;}function fa(ia){if(ia&&ia.ut)if(v<ia.ut){return true;}else if(ia.ut<v)z.error('old_cookie',{cookie_time:ia.ut,local_time:v});return false;}function ga(){var ia=aa();if(fa(ia))u=ia;return u;}function ha(){var ia=aa();if(fa(ia))ea(ia);}m.register('state',da);g.subscribe(k.DUMP_EVENT,function(ia,ja){ja.presence_state={initial:h({},w),state:h({},u),update_time:v,sync_paused:x,poll_time:q};});(function(){var ia=ga();if(ia){ea(ia);}else{z.debug('no_cookie_initial');ea(da());return;}})();a.PresenceState=e.exports={doSync:function(ia){if(x)return;if(ia){ba();}else ca();},registerStateStorer:function(ia){r.push(ia);},registerStateLoader:function(ia){s.push(ia);},get:function(){return ga();},getInitial:function(){return w;}};},3);
__d("presence-arbiter-message",[],function(a,b,c,d,e,f){a.PresenceMessage=e.exports={WINDOW_RESIZED:'presence/window-resized',TAB_CLOSED:'presence/tab-closed',TAB_OPENED:'presence/tab-opened',PRESENCE_UPDATER_READY:'presence/updater-ready',getAppMessageType:function(g,h){return 'presence/app_message:'+g+':'+h;},getArbiterMessageType:function(g){return 'presence/message:'+g;}};},3);
__d("PresencePrivacy",["hasArrayNature","Arbiter","AsyncRequest","ChannelConstants","copyProperties","Env","JSLogger","presence-arbiter-message","PresenceUtil","PresencePrivacyInitialData"],function(a,b,c,d,e,f){var g=b('hasArrayNature'),h=b('Arbiter'),i=b('AsyncRequest'),j=b('ChannelConstants'),k=b('copyProperties'),l=b('Env'),m=b('JSLogger'),n=b('presence-arbiter-message'),o=b('PresenceUtil'),p=c('PresencePrivacyInitialData'),q='/ajax/chat/privacy/settings.php',r='/ajax/chat/privacy/online_policy.php',s='/ajax/chat/privacy/visibility.php',t='friend_visibility',u='visibility',v='online_policy',w=k({},p.privacyData),x=p.visibility,y=k({},p.privacyData),z=x,aa=p.onlinePolicy,ba=aa,ca=[],da=false;function ea(){return m.create('blackbird');}var fa=k(new h(),{WHITELISTED:1,BLACKLISTED:-1,UNLISTED:0,ONLINE:1,OFFLINE:0,ONLINE_TO_WHITELIST:0,ONLINE_TO_BLACKLIST:1});function ga(sa){var ta;for(ta in sa){var ua=sa[ta];if(ta==l.user){ea().error('set_viewer_visibility');throw new Error("Invalid to set current user's visibility");}switch(ua){case fa.WHITELISTED:case fa.BLACKLISTED:case fa.UNLISTED:break;default:ea().error('set_invalid_friend_visibility',{id:ta,value:ua});throw new Error("Invalid state: "+ua);}}for(ta in sa)w[ta]=sa[ta];fa.inform('privacy-changed');}function ha(sa,ta){var ua={};ua[sa]=ta;ga(ua);}function ia(sa){switch(sa){case fa.ONLINE:case fa.OFFLINE:break;default:ea().error('set_invalid_visibility',{value:sa});throw new Error("Invalid visibility: "+sa);}x=sa;fa.inform('privacy-changed');fa.inform('privacy-user-presence-changed');h.inform('chat/visibility-changed',{sender:this});}function ja(sa){switch(sa){case fa.ONLINE_TO_WHITELIST:case fa.ONLINE_TO_BLACKLIST:break;default:throw new Error("Invalid default online policy: "+sa);}aa=sa;fa.inform('privacy-user-presence-changed');fa.inform('privacy-changed');}function ka(sa,ta){da=true;sa.send();}function la(sa,ta){ca.push({request:sa,data:ta});if(!da){var ua=ca.shift();ka(ua.request,ua.data);}}function ma(sa,ta){var ua=sa.type;if(ua===t){var va=ta.payload.user_availabilities;if(!g(va)){fa.inform('privacy-availability-changed',{user_availabilities:va});for(var wa in sa.settings)y[wa]=sa.settings[wa];}}else{if(ua===u){z=sa.visibility;}else if(ua===v)ba=sa.online_policy;fa.inform('privacy-user-presence-response');}ea().log('set_update_response',{data:sa,response:ta});}function na(sa,ta){if(x!==z)ia(z);if(aa!==ba)ja(ba);k(w,y);fa.inform('privacy-changed');ca=[];ea().log('set_error_response',{data:sa,response:ta});}function oa(sa){da=false;if(ca.length>0){var ta=ca.shift();ka(ta.request,ta.data);}}function pa(sa,ta){if(o!=null){var ua=sa.getData();ua.window_id=o.getSessionID();sa.setData(ua);}sa.setHandler(ma.bind(this,ta)).setErrorHandler(na.bind(this,ta)).setTransportErrorHandler(na.bind(this,ta)).setFinallyHandler(oa.bind(this)).setAllowCrossPageTransition(true);return sa;}function qa(sa,ta,ua){return pa(new i(sa).setData(ta),ua);}function ra(sa,ta){var ua=ta.obj;if(ua.viewer_id!=l.user){ea().error('invalid_viewer_for_channel_message',{type:sa,data:ta});throw new Error("Viewer got from the channel is not the real viewer");}if(ua.window_id===o.getSessionID())return;var va=ua.data;if(ua.event=='access_control_entry'){va.target_ids.forEach(function(xa){ha(xa,va.setting);y[xa]=va.setting;});}else{if(ua.event=='visibility_update'){var wa=!!va.visibility?fa.ONLINE:fa.OFFLINE;ia(wa);z=wa;}else if(ua.event=='online_policy_update'){ja(va.online_policy);ba=va.online_policy;}fa.inform('privacy-user-presence-response');}ea().log('channel_message_received',{data:ta.obj});}k(fa,{WHITELISTED:1,BLACKLISTED:-1,UNLISTED:0,ONLINE:1,OFFLINE:0,ONLINE_TO_WHITELIST:0,ONLINE_TO_BLACKLIST:1,init:function(sa,ta,ua){},setVisibility:function(sa){z=x;ia(sa);var ta={visibility:sa},ua={type:u,visibility:sa},va=qa(s,ta,ua);la(va,ua);ea().log('set_visibility',{data:ta});return sa;},getVisibility:function(){return x;},setOnlinePolicy:function(sa){ba=aa;ja(sa);var ta={online_policy:sa},ua={type:v,online_policy:sa},va=qa(r,ta,ua);la(va,ua);ea().log('set_online_policy',{data:ta});return sa;},getOnlinePolicy:function(){return aa;},getFriendVisibility:function(sa){return w[sa]||fa.UNLISTED;},allows:function(sa){if(this.getVisibility()===fa.OFFLINE)return false;var ta=this.getOnlinePolicy();return ta===fa.ONLINE_TO_WHITELIST?w[sa]==fa.WHITELISTED:w[sa]!=fa.BLACKLISTED;},setFriendsVisibility:function(sa,ta){if(sa.length>0){var ua={};for(var va=0;va<sa.length;va++){var wa=sa[va];y[wa]=w[wa];ua[wa]=ta;}ga(ua);var xa=ta;if(xa==fa.UNLISTED)xa=y[sa[0]];var ya={users:sa,setting:ta,setting_type:xa},za={type:t,settings:ua},ab=qa(q,ya,za);la(ab,za);ea().log('set_friend_visibility',{data:ya});}return ta;},setFriendVisibilityMap:function(sa,ta){for(var ua in sa)y[ua]=w[ua];ga(sa);var va={type:t,settings:sa};la(pa(ta,va),va);ea().log('set_friend_visibility_from_map',{data:sa});},allow:function(sa){if(this.allows(sa)){ea().error('allow_already_allowed');throw new Error("allow() should only be called for users that "+"are not already allowed");}if(this.getVisibility()===fa.OFFLINE){ea().error('allow_called_while_offline');throw new Error("allow() should only be called when the user is already online");}var ta=this.getOnlinePolicy()===fa.ONLINE_TO_WHITELIST?fa.WHITELISTED:fa.UNLISTED;return this.setFriendsVisibility([sa],ta);},disallow:function(sa){if(!this.allows(sa)){ea().error('disallow_already_disallowed');throw new Error("disallow() should only be called for users that "+"are not already disallowed");}if(this.getVisibility()===fa.OFFLINE){ea().error('disallow_called_while_offline');throw new Error("disallow() should only be called when the user is already online");}var ta=this.getOnlinePolicy()===fa.ONLINE_TO_BLACKLIST?fa.BLACKLISTED:fa.UNLISTED;return this.setFriendsVisibility([sa],ta);},getBlacklist:function(){var sa=[];for(var ta in w)if(w[ta]===fa.BLACKLISTED)sa.push(ta);return sa;},getWhitelist:function(){var sa=[];for(var ta in w)if(w[ta]===fa.WHITELISTED)sa.push(ta);return sa;},getMapForTest:function(){return w;},setMapForTest:function(sa){w=sa;}});fa.inform('privacy-changed');fa.inform('privacy-user-presence-changed');ea().log('initialized',{visibility:x,policy:aa});h.subscribe(n.getArbiterMessageType('privacy_changed'),ra.bind(this));h.subscribe(j.ON_CONFIG,function(sa,ta){var ua=ta.getConfig('visibility',null);if(ua!==null&&typeof(ua)!=='undefined'){var va=ua?fa.ONLINE:fa.OFFLINE;ia(va);ea().log('config_visibility',{vis:va});}}.bind(this));a.PresencePrivacy=e.exports=fa;},3);
__d("Chat",["Arbiter","AsyncSignal","JSLogger","ObjectUtils","PresencePrivacy"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AsyncSignal'),i=b('JSLogger'),j=b('ObjectUtils'),k=b('PresencePrivacy');function l(p,q){if(q&&q=='ordered_list'||q=='more_online_friends'||q=='online_friends'||q=='typeahead'){var r={target:p,source:q};new h('/ajax/chat/ct.php',r).send();}}var m={buddyListNub:'buddylist-nub/initialized',sidebar:'sidebar/initialized'};function n(p,q){g.subscribe(m[p],function(event,r){q(r);});}var o={openTab:function(p,q,r,s){if(window.External&&window.External.Chat&&window.External.Chat.openWindow)window.External.Chat.openWindow(p);l(p,s);d(['MercuryThreads'],function(t){if(!r||r=='friend'){var u=t.getCanonicalThreadToUser(p);g.inform('chat/open-tab',{thread_id:u.thread_id});}});},loadTabFragile:function(p,q,r,s){d(['ChatController'],function(t){t.raiseFragileGroupTab(p);});},openBuddyList:function(){n('buddyListNub',function(p){p.show();n('sidebar',function(q){q.enable();});});},closeBuddyList:function(){n('buddyListNub',function(p){p.hide();});},toggleSidebar:function(){n('sidebar',function(p){p.toggle();});},goOnline:function(p){d(['ChatVisibility'],function(q){q.goOnline(p);});},isOnline:function(){var p=null;d(['ChatVisibility'],function(q){p=q;});return p&&p.isOnline();},squelchTab:function(p,q){},unsquelchTab:function(p){},hasFocusedChat:function(){return false;},getLogger:function(p){return i.create(p);}};a.Chat=e.exports=o;},3);
__d("ChatVisibility",["Arbiter","ChatConfig","JSLogger","PresencePrivacy"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ChatConfig'),i=b('JSLogger'),j=b('PresencePrivacy'),k={isOnline:function(){return j.getVisibility()===j.ONLINE;},goOnline:function(l){if(j.getVisibility()===j.OFFLINE){i.create('blackbird').log('chat_go_online');j.setVisibility(j.ONLINE);}l&&l();},canGoOffline:function(){var l=g.inform('live_listen_chat/go_offline');if(l===false){i.create('music_live_listen').log('can_go_offline',false);return false;}return true;},goOffline:function(l){if(!this.canGoOffline())return;if(j.getVisibility()===j.ONLINE){i.create('blackbird').log('chat_go_offline');j.setVisibility(j.OFFLINE);}l&&l();},toggleVisibility:function(){if(k.isOnline()){k.goOffline();}else k.goOnline();}};a.ChatVisibility=e.exports=k;},3);
__d("ServerTime",["PresenceInitialData"],function(a,b,c,d,e,f){var g=c('PresenceInitialData'),h;function i(j){h=Date.now()-j;}i(g.serverTime);a.ServerTime=e.exports={get:function(){return Date.now()-h;},getSkew:function(){return h;},update:function(j){i(j);}};},3);
__d("ShortProfiles",["Arbiter","ArrayUtils","JSLogger","ObjectUtils","AsyncRequest","Env","ErrorUtils","Util","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ArrayUtils'),i=b('JSLogger'),j=b('ObjectUtils'),k=b('AsyncRequest'),l=b('Env'),m=b('ErrorUtils'),n=b('Util'),o=b('copyProperties'),p={},q=new g(),r=[],s=false,t=false,u=i.create('short_profiles');function v(){if(!r.length||s)return;s=true;aa.defer();}function w(fa){var ga=[];h.createFrom(fa).forEach(function(ha){var ia={};for(var ja=0,ka=ha.ids.length;ja<ka;ja++){var la=ha.ids[ja];if(p[la]){ia[la]=p[la];}else{ia=null;break;}}if(ia){var ma={};for(var na in ia)ma[na]=o({},ia[na]);m.applyWithGuard(ha.fun,ha,[ma],function(oa){oa.profile_ids=ha.ids;});}else ga.push(ha);});return ga;}function x(){s=false;v();}var y='/ajax/chat/user_info.php',z='/ajax/chat/user_info_all.php';function aa(fa){q.inform('fetch');var ga=w(r);r=[];if(!ga.length){x();return;}var ha={};ga.forEach(function(ja){ja.ids.forEach(function(ka){if(!p[ka])ha[ka]=true;});});var ia=j.getKeys(ha);new k(y).setData({ids:ia}).setHandler(function(ja){ba(ja,ga);}).setErrorHandler(ca).setAllowCrossPageTransition(true).setMethod('GET').setReadOnly(true).send();}function ba(fa,ga){for(var ha in fa.payload){var ia=fa.payload[ha];if(!ia.type)ia.type='friend';p[ha]=ia;}if(ga)w(ga);r=w(r);x();q.inform('updated');var ja=fa.getRequest().uri.getPath();if(ja==y){u.log('fetch_response');}else if(ja==z)u.log('fetch_response_all');}function ca(){u.error('fetch_error');x();}function da(){if(!t){u.log('fetch_all');t=true;new k(z).setData({viewer:l.user}).setHandler(ba).setAllowCrossPageTransition(true).setMethod('GET').setReadOnly(true).send();}}var ea=o(q,{get:function(fa,ga){this.getMulti([fa],function(ha){ga(ha[fa],fa);});},getMulti:function(fa,ga){var ha={ids:fa,fun:ga},ia=w([ha]);if(ia.length){r.push(ha);v();}},getNow:function(fa){var ga=p[fa];if(ga)return o({},ga);return null;},getCachedProfileIDs:function(){return j.getKeys(p);},hasAll:function(){return t;},fetchAll:function(){da();},set:function(fa,ga){var ha=p[fa];if(ha&&(ha.name!=ga.name||ha.firstName!=ga.firstName||ha.thumbSrc!=ga.thumbSrc))u.warn('changed',{oldInfo:ha,newInfo:ga});p[fa]=o({},ga);},setMulti:function(fa){for(var ga in fa)this.set(ga,fa[ga]);}});d(['InitialChatUserInfosLoader'],function(fa){ea.setMulti(fa);});a.ShortProfiles=e.exports=ea;},3);
__d("AvailableList",["function-extensions","Arbiter","ArbiterMixin","AsyncRequest","AvailableListConstants","ChannelConnection","ChannelConstants","Chat","ChatConfig","ChatVisibility","Class","copyProperties","Env","JSLogger","ObjectUtils","Poller","presence-arbiter-message","PresencePrivacy","PresenceUtil","ServerTime","ShortProfiles","UserActivity","AvailableListInitialData"],function(a,b,c,d,e,f){b('function-extensions');var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('AsyncRequest'),j=b('AvailableListConstants'),k=b('ChannelConnection'),l=b('ChannelConstants'),m=b('Chat'),n=b('ChatConfig'),o=b('ChatVisibility'),p=b('Class'),q=b('copyProperties'),r=b('Env'),s=b('JSLogger'),t=b('ObjectUtils'),u=b('Poller'),v=b('presence-arbiter-message'),w=b('PresencePrivacy'),x=b('PresenceUtil'),y=b('ServerTime'),z=b('ShortProfiles'),aa=b('UserActivity'),ba=c('AvailableListInitialData'),ca=5,da=60000,ea='/ajax/chat/buddy_list.php',fa=5000,ga=1800000,ha=.005,ia=0,ja=0,ka=false,la=ba.pollInterval,ma=ba.lazyPollInterval,na=ba.lazyThreshold,oa=null,pa=new Date(),qa=0,ra={},sa=false,ta={},ua=null,va={},wa={},xa=s.create('available_list'),ya=q({},j);Function.mixin(ya,h);ya.subscribe([j.ON_AVAILABILITY_CHANGED,j.ON_UPDATE_ERROR,j.ON_UPDATED],function(qb,rb){g.inform(qb,rb);});function za(qb){var rb=qb||aa.isActive(na);return o.isOnline()?(rb?la:ma):null;}function ab(qb,rb){var sb=null;switch(qb){case j.OFFLINE:sb='offline';break;case j.IDLE:sb='idle';break;case j.ACTIVE:sb='active';break;case j.MOBILE:sb='mobile';break;}xa.rate(sb,rb);}function bb(){oa=null;ya.inform(j.ON_AVAILABILITY_CHANGED);}function cb(qb,rb,sb,tb){if(qb==r.user)return;switch(rb){case j.OFFLINE:case j.IDLE:case j.ACTIVE:case j.MOBILE:break;default:return;}var ub=ya.get(qb)!=rb;if(sb){va[qb]=y.get();wa[qb]=tb;}ra[qb]=rb;if(ub){ia++;if(!oa)oa=bb.defer();ab(rb,sb);}}function db(qb){qa=new Date();ta=t.createFrom(qb);}function eb(){if(ya.haveFullList)ya.inform(j.ON_UPDATED,ya);}function fb(qb){if(x.checkMaintenanceError(qb))return;ja++;ka=false;if(ja>=ca)ya.inform(j.ON_UPDATE_ERROR);}function gb(qb){var rb=qb.getPayload(),sb=rb.buddy_list;if(!sb){fb(qb);return;}y.update(rb.time);ya.updateTime=y.get();ja=0;ka=false;ya.haveFullList=true;if(sb.mobile_friends!=null)db(sb.mobile_friends);var tb=sb.userInfos;if(tb)z.setMulti(tb);var ub=sb.nowAvailableList,vb=[];for(var wb in ra)if(ya.get(wb)!==ya.OFFLINE)vb.push(wb);vb.forEach(function(xb){ab(ya.OFFLINE,false);ra[xb]=ya.OFFLINE;});sa=sb.userIsIdle;ub&&ya.addLegacyAvailableList(ub);va={};wa={};if(sb.newAvailableList){ya.presenceData=sb.newAvailableList;ya.haveFullList=true;}if(sb.chatNotif!==undefined){ua=sb.chatNotif;ya.inform(j.ON_CHAT_NOTIFICATION_CHANGED,ua);}lb();bb();eb();}function hb(qb){if(k.isShutdown()||!o.isOnline()){ya._poller.stop();return;}pa=new Date();var rb=false;if(new Date()-qa>ga)rb=true;ka=true;var sb=z.getCachedProfileIDs();qb.setHandler(gb).setErrorHandler(fb).setOption('suppressErrorAlerts',true).setOption('retries',1).setData({user:r.user,available_user_info_ids:sb,fetch_mobile:rb}).setURI(ea).setAllowCrossPageTransition(true);}function ib(qb){var rb=qb.payload.availability||{};for(var sb in rb)cb(sb,rb[sb],true,'mercury_tabs');}function jb(qb){var rb=ya.getDebugInfo(qb),sb=(rb.presence==j.ACTIVE),tb=new i('/ajax/mercury/tabs_presence.php').setData({target_id:qb,to_online:sb,presence_source:rb.overlaySource,presence_time:rb.overlayTime}).setHandler(ib).setErrorHandler(bagofholding).setAllowCrossPageTransition(true).send();}function kb(qb,rb){for(var sb in qb){var tb,ub;if(rb){tb=j.legacyStatusMap[qb[sb].ol];ub=qb[sb].s;}else if(!qb[sb]){tb=j.OFFLINE;}else if(qb[sb].i){tb=j.IDLE;}else if(qb[sb].m){tb=j.MOBILE;}else tb=j.ACTIVE;cb(sb,tb,rb,ub);}}function lb(qb){var rb=za(qb);xa.debug('update_poller',rb);ya._poller&&ya._poller.setTimePeriod(rb);}function mb(){ya.haveFullList=false;pa=0;qa=0;sa=false;ua=null;ra={};wa={};va={};ta={};ia++;bb();}function nb(){lb();if(o.isOnline()){ya.update();}else mb();}function ob(){lb();if(k.disconnected()){mb();}else if(!ya.haveFullList)ya.update();}function pb(qb,rb){rb.chat_config=n.getDebugInfo();rb.available_list_debug_info={};ya.getAvailableIDs().forEach(function(sb){rb.available_list_debug_info[sb]=ya.getDebugInfo(sb);});rb.available_list_poll_interval=ya._poller&&ya._poller.getTimePeriod();}q(ya,{haveFullList:false,get:function(qb){if(qb==r.user)return o.isOnline()?j.ACTIVE:j.OFFLINE;var rb=j.OFFLINE;if(qb in ra)rb=ra[qb];if(!w.allows(qb))rb=j.OFFLINE;if(rb==j.OFFLINE)if(ta[qb])rb=j.MOBILE;return rb;},updateForID:function(qb){jb(qb);},getWebChatNotification:function(){return ua;},isUserIdle:function(){return sa;},isReady:function(){return ya.haveFullList;},set:function(qb,rb,sb){cb(qb,rb,true,null,sb);},update:function(){if(new Date()-pa<fa){!ka&&eb.defer();return;}ya._poller&&ya._poller.requestNow();},getRev:function(){return ia;},isIdle:function(qb){return ya.get(qb)==j.IDLE;},getOnlineIDs:function(){var qb,rb=[];for(qb in ra)if(ya.get(qb)===j.ACTIVE)rb.push(qb);return rb;},getAvailableIDs:function(){var qb=ya.getOnlineIDs(),rb;for(rb in ta){if(rb in ra)continue;qb.push(rb);}return qb;},getOnlineCount:function(qb){if(qb&&!ya.haveFullList)return 0;return ya.getOnlineIDs().length;},addLegacyOverlay:function(qb){kb(qb,true);},addLegacyAvailableList:function(qb){kb(qb,false);},getDebugInfo:function(qb){var rb;if(window.ShortProfiles){var sb=z.getNow(qb);if(sb)rb=sb.name;}return {id:qb,presence:ra[qb],overlaySource:wa[qb],overlayTime:va[qb],overlaySource:wa[qb],mobile:ta[qb],name:rb};}});ya.updateTime=ba.updateTime;ya.addLegacyAvailableList(ba.availableList);ya.haveFullList=true;if(ba.mobileFriends)db(ba.mobileFriends);ua=ba.chatNotif;ya._poller=new u(za(),hb,true);lb(true);g.subscribe(s.DUMP_EVENT,pb);aa.subscribe(function(qb,rb){if(rb.idleness>la){xa.debug('update_activity');ya.update();}});w.subscribe('privacy-changed',bb);w.subscribe('privacy-availability-changed',function(qb,rb){for(var sb in rb.user_availabilities)this.set(sb,rb.user_availabilities[sb]);}.bind(ya));w.subscribe('privacy-user-presence-response',ya.update);if(n.get('channel_disconnect_warning')){k.subscribe([k.CONNECTED,k.RECONNECTING,k.SHUTDOWN,k.MUTE_WARNING,k.UNMUTE_WARNING],ob);}else{k.subscribe(k.CONNECTED,ya.update);g.subscribe(l.ON_INVALID_HISTORY,ya.update);}g.subscribe(v.getArbiterMessageType('buddylist_overlay'),function(qb,rb){var sb=rb.obj.overlay;for(var tb in sb)ya.set(tb,sb[tb].a,sb[tb].s||'channel');});a.AvailableList=e.exports=ya;});
__d("GroupChatController",["Arbiter","Chat","ChatController","ChatVisibility","css","DOM","PageTransitions"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('Chat'),i=b('ChatController'),j=b('ChatVisibility'),k=b('css'),l=b('DOM'),m=b('PageTransitions');function n(o,p,q){_goOnlineText=l.find(o,'.fbGroupChatGoOnline');_chatWithGroupText=l.find(o,'.fbGroupChatOpenTab');function r(){if(j.isOnline()){k.hide(_goOnlineText);k.show(_chatWithGroupText);}else{k.hide(_chatWithGroupText);k.show(_goOnlineText);}}_visibilitySubscription=g.subscribe('chat/visibility-changed',r);m.registerHandler(g.unsubscribe.bind(g,_visibilitySubscription));Event.listen(o,'click',function(){i.raiseGroupTab(p);});r();}e.exports=n;});
__d("InitialChatUserInfosLoader",["InitialChatUserInfos"],function(a,b,c,d,e,f){e.exports=c('InitialChatUserInfos');});
function PresenceIndicator(){}copy_properties(PresenceIndicator.prototype,{init:function(a,b,c){this._id=a;this._firstname=b;this._tooltip=c;this._image=DOM.scry(this._tooltip,'i')[0];this._previousAvail=null;this._jslog=JSLogger.create('presence_indicator');requireLazy(['ChatVisibility'],function(e){this._jslog.log('vis_init',e.isOnline());this._chatVisibility=e;this._updateVisibility();}.bind(this));this._subscriptions=[Arbiter.subscribe([AvailableListConstants.ON_AVAILABILITY_CHANGED],this._updateAvailability.bind(this)),Arbiter.subscribe(['chat/visibility-changed'],this._updateVisibility.bind(this))];this._updateAvailability.bind(this).defer();var d=Event.listen(this._tooltip,'click',function(){requireLazy(['AvailableList'],function(e){if(this._previousAvail!=AvailableListConstants.OFFLINE)Chat.openTab(this._id);}.bind(this));}.bind(this));onleaveRegister(function(){d.remove();while(this._subscriptions.length)Arbiter.unsubscribe(this._subscriptions.pop());}.bind(this));},_updateAvailability:function(){requireLazy(['AvailableList','ChatConfig'],function(a,b){if(!a.isReady())return;var c,d,e=a.get(this._id);if(e===this._previousAvail)return;this._previousAvail=e;switch(e){case AvailableListConstants.OFFLINE:c=tx._("{name} is offline",{name:this._firstname});d='offline';break;case AvailableListConstants.IDLE:c=tx._("{name} is idle",{name:this._firstname});d='idle';break;case AvailableListConstants.ACTIVE:c=tx._("{name} is online",{name:this._firstname});d='online';break;case AvailableListConstants.MOBILE:c=tx._("{name} is available on mobile",{name:this._firstname});d='mobile';break;default:throw new Error('Invalid availability');}TooltipLink.setTooltipText(this._tooltip,c);CSS.setClass(this._image,d);}.bind(this));},_updateVisibility:function(){if(this._chatVisibility.isOnline()){CSS.show(this._tooltip);}else CSS.hide(this._tooltip);}});