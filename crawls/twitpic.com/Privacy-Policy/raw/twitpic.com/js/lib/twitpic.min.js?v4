
(function(){var API,AccountUI,AdminUI,Broadcast,Cache,Config,EventUI,FacetagManager,HomeUI,LinkedListItem,LocationUI,Log,Logger,MiscUI,Modal,PhotoUI,Place,RealtimeUI,Routes,SearchUI,Template,Twitpic,UI,UIModule,Upload,UploadModal,UploadUI,UserUI,Util,__hasProp={}.hasOwnProperty,__slice=[].slice,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child;};Twitpic=(function(){Twitpic.name='Twitpic';Twitpic.DEV=function(){return true;};Twitpic.load=function(){return $(document).ready(function(){return window.TP=new Twitpic();});};function Twitpic(){this.ui=new UI();}
return Twitpic;})();window.Twitpic=Twitpic;API=(function(){API.name='API';API.base="/";API.get=function(endpoint,args,callback,error){var api;api=new API(endpoint);return api.request("GET",args,callback,error);};API.post=function(endpoint,args,callback,error){var api;api=new API(endpoint);return api.request("POST",args,callback,error);};API.cacheGet=function(endpoint,key,expire,args,callback,error){var api;api=new API(endpoint,true,key,expire);return api.request("GET",args,callback,error);};API.cachePost=function(endpoint,key,expire,args,callback,error){var api;api=new API(endpoint,true,key,expire);return api.request("POST",args,callback,error);};function API(endpoint,cache,key,expire){if(cache==null){cache=false;}
if(key==null){key="";}
if(expire==null){expire=0;}
this.endpoint=endpoint;this.url=this.formatUrl(endpoint);this.cache=cache;this.key=key;this.expire=expire!=null?expire:0;this.data={};}
API.prototype.request=function(method,args,callback,error){var data,_this=this;Log.debug(method,this.url,args);if(this.cache){data=Cache.get(this.key);if(data){return callback(data);}}
return $.ajax({type:method,url:this.url,data:args,dataType:"json",success:function(data){Log.debug("RESULT",data);if(_this.cache){Cache.set(_this.key,data,_this.expire);}
if(callback!=null){return callback(data);}},error:function(jqXHR,status,errorMsg){if(error!=null){return error(jqXHR,status,errorMsg);}}});};API.prototype.formatUrl=function(endpoint){if(endpoint.charAt(0)==="/"){endpoint=endpoint.substr(1,endpoint.length);}
if(endpoint.charAt(endpoint.length-1)==="/"){endpoint=endpoint.substr(-1);}
return endpoint=API.base+(""+endpoint+".json");};return API;})();Broadcast=(function(){var enqueueMessage,messageQueue,processQueue,queueLock,toggleNavbar;Broadcast.name='Broadcast';messageQueue=[];queueLock=false;Broadcast.error=function(msg,expire){if(expire==null){expire=5;}
return enqueueMessage(new Broadcast("error",msg,expire));};Broadcast.info=function(msg,expire){if(expire==null){expire=5;}
return enqueueMessage(new Broadcast("info",msg,expire));};Broadcast.warning=function(msg,expire){if(expire==null){expire=5;}
return enqueueMessage(new Broadcast("warning",msg,expire));};Broadcast.success=function(msg,expire){if(expire==null){expire=5;}
return enqueueMessage(new Broadcast("success",msg,expire));};enqueueMessage=function(broadcast){messageQueue.push(broadcast);if(queueLock){return true;}else{queueLock=true;}
return toggleNavbar(function(){return processQueue(function(){queueLock=false;return toggleNavbar();});});};processQueue=function(finished){var msg;if(messageQueue.length===0){return finished();}
msg=messageQueue.shift();return msg.show(function(){return processQueue(finished);});};toggleNavbar=function(finished){if(finished==null){finished=function(){};}
if($("#navbar").is(":visible")){return $("#navbar").fadeOut(1000,function(){$("#navbar-wrap").css('z-index',999);return finished();});}else{$("#navbar-wrap").css('z-index',2);return $("#navbar").fadeIn(1000,finished);}};function Broadcast(type,msg,expire){this.type=type;this.msg=msg;this.expire=expire;}
Broadcast.prototype.show=function(finished){var _this=this;this.div=$("<div />").addClass("broadcast-wrap").addClass("broadcast-"+this.type).html("<h3>"+this.msg+"</h3>").css('display','none').prependTo('#navbar-wrap');this.div.bind('click',function(){return _this.hide(finished);});if(this.expire){setTimeout(function(){return _this.hide(finished);},this.expire*1000);}
return this.div.fadeIn();};Broadcast.prototype.hide=function(finished){if(!this.div.is(":visible")){return;}
return this.div.fadeOut(function(){$(this).remove();return finished();});};return Broadcast;})();Twitpic.Broadcast=Broadcast;Cache=(function(){Cache.name='Cache';function Cache(){}
Cache.get=function(key){var cacheData,now;if(!(window.sessionStorage!=null)){return;}
now=this.getNow();cacheData=JSON.parse(sessionStorage.getItem(key));if(!cacheData||(cacheData.expire<now&&cacheData.expire!==0)){return false;}
Log.debug("CACHE","found "+key);Log.debug("RESULT",cacheData.data);return cacheData.data;};Cache.set=function(key,value,expire){var cacheData,now;if(expire==null){expire=0;}
if(!(window.sessionStorage!=null)){return;}
now=this.getNow();cacheData={expire:this.expire===0?0:now+expire,data:value};Log.debug("CACHE","store "+key);return sessionStorage.setItem(key,JSON.stringify(cacheData));};Cache.getNow=function(){return Math.floor((new Date()).getTime()/1000);};return Cache;})();Config=(function(){var data,dirty;Config.name='Config';function Config(){}
dirty=false;data={};Config.set=function(initData){if(dirty){return;}
data=initData;return dirty=true;};Config.get=function(key){return data[key];};return Config;})();Twitpic.Config=Config;FacetagManager=(function(){var facetagSize;FacetagManager.name='FacetagManager';facetagSize={width:100,height:100};function FacetagManager(div){var self,_ref;this.div=div;this.editEnabled=false;this.canEdit=((_ref=Config.get('activeUser'))!=null?_ref.id:void 0)===Config.get('user').id;if(typeof this.div==="string"){this.div=$(this.div);}
this.events={};this.tags={};this.newTags=[];this.on("enable",this.enableEditor);this.on("disable",this.saveChanges);this.injectTags();this.enableHover();self=this;$(".facetag-edit").live('click',function(){return self.editTag($(this).parents('.facetag'));});}
FacetagManager.prototype.on=function(event,cb){if(!(this.events[event]!=null)){this.events[event]=[];}
return this.events[event].push(cb);};FacetagManager.prototype.fire=function(event){var cb,_i,_len,_ref,_results;if(!(this.events[event]!=null)){return;}
_ref=this.events[event];_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){cb=_ref[_i];_results.push(cb.call(this));}
return _results;};FacetagManager.prototype.toggleEdit=function(){this.editEnabled=this.editEnabled===true?false:true;if(this.editEnabled){return this.fire("enable");}else{return this.fire("disable");}};FacetagManager.prototype.injectTags=function(){var tag,tags,_i,_len,_results;tags=Config.get('facetags');if(!tags){return;}
_results=[];for(_i=0,_len=tags.length;_i<_len;_i++){tag=tags[_i];tag.isNew=false;_results.push(this.injectTag(tag));}
return _results;};FacetagManager.prototype.injectTag=function(tag){var div,_ref,_ref1;_ref=this.getBoxCssCoords(tag.left,tag.top),tag.left=_ref[0],tag.top=_ref[1];tag.canEdit=this.canEdit;if(!tag.isNew){this.tags[tag.id]=tag;}
if(tag.isNew){tag.id="";}
if(((_ref1=tag.username)!=null?_ref1[0]:void 0)==="@"){tag.username=tag.username.substr(1);}
Log.debug("Injecting facetag: left="+tag.left+", top="+tag.top);div=$(Template.factory('facetag',tag).render());div.data('dirty',tag.isNew);if(tag.isNew){div.attr('id','facetag-new');}
if(this.editEnabled){div.find('.facetag-edit').css('display','block');}
div.appendTo(this.div);return div;};FacetagManager.prototype.enableEditor=function(){var _this=this;Log.debug("Facetag editor enabled");this.disableHover();this.showTags();this.showEdit();this.div.find("> img").bind('mousedown',function(e){return _this.openEditor.apply(_this,_this.findClickCoords(e));});return this.div.addClass("facetag-edit-enabled");};FacetagManager.prototype.editTag=function(tag){var id,left,top,_ref;id=tag.data('id');_ref=this.getCenterCoords(parseInt(tag.css('left'),10),parseInt(tag.css('top'),10)),left=_ref[0],top=_ref[1];this.activeTag=tag;this.openEditor(left,top,false);$("#facetag-editor [name=name]").attr('value',tag.data('name'));return $("#facetag-editor [name=username]").attr('value',"@"+tag.data('username'));};FacetagManager.prototype.saveChanges=function(){var apiData,args,page,_ref,_this=this;Log.debug("Facetag editor disabled");this.hideTags();this.enableHover();this.hideEdit();this.div.find("> img").unbind('mousedown');this.div.removeClass("facetag-edit-enabled");if(this.newTags.length===0){return;}
_ref=Routes.getPage(true),page=_ref[0],args=_ref[1];apiData={media_id:parseInt(args.id,36),jsondata:JSON.stringify(this.newTags)};return API.post('faces/save',apiData,function(data){_this.newTags=[];_this.updateNames();return _this.updateTagIDs(data);});};FacetagManager.prototype.openEditor=function(x,y,isNew){if(isNew==null){isNew=true;}
$("#facetag-new").remove();if(isNew){this.activeTag=this.injectTag({top:y,left:x,isNew:isNew});}
if($("#facetag-editor").length===0){this.injectEditor(x,y);}
this.moveEditor(x,y);this.showEditor();if(isNew){$("#facetag-editor [name=delete]").hide();$("#facetag-editor [type=text]").attr('value','');}else{$("#facetag-editor [name=delete]").show();}
return $("#facetag-editor [name=name]").focus();};FacetagManager.prototype.injectEditor=function(left,top){var editor,_this=this;editor=$(Template.factory('facetag_editor').render());editor.prependTo(this.div);$("#facetag-save [name=save]").bind('click',function(){return _this.saveTag();});$("#facetag-save [name=delete]").bind('click',function(){return _this.deleteTag();});$("#facetag-save [name=cancel]").bind('click',function(){_this.hideEditor();return $("#facetag-new").remove();});return $("#facetag-editor [name=username]").bind('keyup',function(){var val;val=$(this).attr('value');if(val.charAt(0)!=="@"){val="@"+val;return $(this).attr('value',val);}});};FacetagManager.prototype.moveEditor=function(x,y){var _ref;_ref=this.getBoxCssCoords(x,y),x=_ref[0],y=_ref[1];x+=110;Log.debug("Moving facetag editor to ["+x+", "+y+"]");return $("#facetag-editor").css({left:""+x+"px",top:""+y+"px"});};FacetagManager.prototype.hideEditor=function(){return $("#facetag-editor").hide();};FacetagManager.prototype.showEditor=function(){return $("#facetag-editor").show();};FacetagManager.prototype.enableHover=function(){var _this=this;return this.div.hover(function(){return _this.showTags();},function(){return _this.hideTags();});};FacetagManager.prototype.disableHover=function(){return this.div.unbind();};FacetagManager.prototype.showTags=function(){return this.div.find('.facetag').fadeIn();};FacetagManager.prototype.hideTags=function(){return this.div.find('.facetag').fadeOut();};FacetagManager.prototype.showEdit=function(){return $(".facetag-edit").show();};FacetagManager.prototype.hideEdit=function(){return $(".facetag-edit").hide();};FacetagManager.prototype.findClickCoords=function(e){if(e.layerX!=null){return[e.layerX,e.layerY];}else{return[e.offsetX,e.offsetY];}};FacetagManager.prototype.getBoxCssCoords=function(x,y){x=Math.round(x-(facetagSize.width/2));y=Math.round(y-(facetagSize.height/2));x=Math.max(0,x);x=Math.min($("#media").width()-100,x);y=Math.max(0,y);y=Math.min($("#media").height()-100,y);return[x,y];};FacetagManager.prototype.getCenterCoords=function(x,y){x=Math.round(x+(facetagSize.width/2));y=Math.round(y+(facetagSize.width/2));return[x,y];};FacetagManager.prototype.saveTag=function(){var data,tag,x,y,_ref,_ref1,_ref2,_ref3;tag=this.activeTag?this.activeTag:$("#facetag-new");_ref=this.getCenterCoords(parseInt(tag.css('left'),10),parseInt(tag.css('top'),10)),x=_ref[0],y=_ref[1];data={name:$.trim($("#facetag-editor [name=name]").attr('value')),username:$.trim($("#facetag-editor [name=username]").attr('value')),reply:$("#facetag-editor [name=reply]").prop('checked'),top_coord:y,left_coord:x};data.tag_id=((_ref1=this.activeTag)!=null?_ref1.data('id'):void 0)?tag.data('id'):"_"+(Util.uniqid.get());this.newTags.push(data);tag.remove();this.injectTag({id:((_ref2=this.activeTag)!=null?(_ref3=_ref2.data('id'))!=null?_ref3.toString().length:void 0:void 0)>0?tag.data('id'):data.tag_id,top:y,left:x,isNew:false,name:data.name,username:data.username});this.hideEditor();return this.activeTag=null;};FacetagManager.prototype.deleteTag=function(){var i,id,tag,_i,_len,_ref,_this=this;id=this.activeTag.data('id');if(!id){return;}
if(id.toString().charAt(0)==="_"){_ref=this.newTags;for(i=_i=0,_len=_ref.length;_i<_len;i=++_i){tag=_ref[i];if(tag.tag_id===id){this.newTags.splice(i,1);}}
this.activeTag.remove();this.hideEditor();}
return API.post('faces/delete',{tag_id:id},function(){delete _this.tags[id];_this.activeTag.remove();_this.hideEditor();return _this.updateNames();});};FacetagManager.prototype.updateNames=function(){var id,name,names,tag,_ref;names=[];_ref=this.tags;for(id in _ref){if(!__hasProp.call(_ref,id))continue;tag=_ref[id];name="";if(tag.name){name+=tag.name;}
if(tag.username){name+=" <a href=\"/photos/"+tag.username+"\">@"+tag.username+"</a>";}
names.push($.trim(name));}
return $("#facetag-names").html(names.join(", "));};FacetagManager.prototype.updateTagIDs=function(data){return $(".facetag").each(function(i){var facetag,name,username;facetag=$(this);if(facetag.data('id').toString().charAt(0)!=="_"){return true;}
name=facetag.data('name');username=facetag.data('username');if(!username&&data[name]){facetag.data('id',data[name]);}else{if(username.charAt(0)!=="@"){username="@"+username;}
if(data[username]){facetag.data('id',data[username]);}}
return true;});};return FacetagManager;})();Logger=(function(){var CMDS,isDev;Logger.name='Logger';CMDS=['log','info','warn','error'];isDev=function(){return Twitpic.DEV();};function Logger(){var name,_i,_len;for(_i=0,_len=CMDS.length;_i<_len;_i++){name=CMDS[_i];this[name]=(function(name){return function(){if(isDev()&&(window.console!=null)){return window.console[name](Array.prototype.slice.call(arguments));}};})(name);}
this.debug=this.log;}
return Logger;})();Log=new Logger();Modal=(function(){Modal.name='Modal';Modal.template='<div class="modal-border">\n  <div class="modal-wrap clear">\n   <div class="modal-title clear">\n    <h2 class="modal-title-text left"></h2>\n   <h2 class="modal-title-close right">Ã—</h2>\n  </div>\n   <div class="modal-content"></div>\n   <div class="modal-buttons"></div>\n  </div>\n</div>';Modal.modals={};Modal.defaults={name:"",title:"",autoOpen:true,width:500,height:"100%",closeable:true,background:{enabled:true,color:"rgba(0, 0, 0, 0.5)"},buttons:{},bindOpen:[],onOpen:function(){},onClose:function(){}};Modal.store=function(data){return Modal.modals[data.name]=data.content;};Modal.factory=function(content,opts){var modal;if(opts==null){opts={};}
modal=new Modal(opts);return modal.setContent(content);};function Modal(options){var callback,content,id,text,_i,_len,_ref,_ref1,_this=this;this.options=$.extend(true,{},Modal.defaults,options);this.div=$(Modal.template);this.div.css({'display':'none'});this.div.find('.modal-wrap').css({'width':this.options.width,'height':this.options.height});this.div.find(".modal-title-text").html(this.options.title);if((options.name!=null)&&Modal.modals[options.name]){content="<div>"+Modal.modals[options.name]+"</div>";}else{content="";}
this.setContent(content);_ref=this.options.buttons;for(text in _ref){if(!__hasProp.call(_ref,text))continue;callback=_ref[text];$("<input />").addClass('grey-button').attr('type','button').attr('value',text).bind('click',callback).appendTo(this.div.find('.modal-buttons'));}
if(this.options.closeable){this.div.find(".modal-title-close").bind('click',function(){return _this.hide();});}else{this.div.find(".modal-title-close").remove();}
_ref1=this.options.bindOpen;for(_i=0,_len=_ref1.length;_i<_len;_i++){id=_ref1[_i];$(id).bind('click',function(){return _this.show();});}
if(this.options.background.enabled){if($("#modal-bg").length===0){$("<div />").attr('id','modal-bg').prependTo('body');}
$("#modal-bg").css({backgroundColor:this.options.background.color,display:'none'});}
this.div.prependTo('body');Log.info("[MODAL] "+this.options.name+" loaded");this.initialize();if(this.options.autoOpen){this.show();}}
Modal.prototype.initialize=function(){};Modal.prototype.setContent=function(content){return this.div.find('.modal-content').html(content);};Modal.prototype.show=function(){var left,top,_this=this;top=($(window).height()/2)-(this.div.height()/2);left=($(window).width()/2)-(this.options.width/2)-parseInt(this.div.find('.modal-wrap').css('margin-left'),10);this.div.css({'top':top,'left':left});this.div.addClass('active-modal');this.div.fadeIn('normal',function(){return _this.options.onOpen();});if(this.options.background.enabled){return $("#modal-bg").fadeIn('normal');}};Modal.prototype.hide=function(){var _this=this;$("#modal-bg").fadeOut('normal');return $(".active-modal").removeClass('active-modal').fadeOut('normal',function(){return _this.options.onClose();});};return Modal;})();Twitpic.Modal=Modal;Place=(function(){var mapDefaults;Place.name='Place';mapDefaults={zoom:15,mapTypeId:google.maps.MapTypeId.ROADMAP,streetViewControl:false};function Place(place){this.place=place;if(!(this.place!=null)){this.place={type:"point"};}else{Log.debug("New place created, it's a "+this.place.type);}
this.mapOptions={};this.polys=[];}
Place.prototype.setOption=function(key,val){var options;options={};options[key]=val;return this.setOptions(options);};Place.prototype.setOptions=function(data){return $.extend(true,this.mapOptions,data);};Place.prototype.setLatLng=function(lat,long){this.place.lat=lat;return this.place.long=long;};Place.prototype.getLatLng=function(){if(this.place.lat&&this.place.long){return{lat:this.place.lat,long:this.place.long};}};Place.prototype.useGeoLocation=function(ready){var _this=this;return window.navigator.geolocation.getCurrentPosition(function(loc){_this.place.lat=loc.coords.latitude;_this.place.long=loc.coords.longitude;return ready();});};Place.prototype.inject=function(div){var options;if(typeof div==="string"){div=$(div).get(0);}else if(div.jquery){div=div.get(0);}
options=$.extend(true,{},mapDefaults,this.mapOptions);this.map=new google.maps.Map(div,options);switch(this.place.type){case"point":this.loadPoint();break;case"polygon":this.loadPolygon();break;case"multipolygon":this.loadMultiPoly();}
return this.map.setCenter(this.location);};Place.prototype.loadPoint=function(){var marker;this.location=new google.maps.LatLng(this.place.lat,this.place.long);return marker=new google.maps.Marker({map:this.map,position:this.location,clickable:true,draggable:false});};Place.prototype.loadPolygon=function(){this.location=new google.maps.LatLng(this.place.center.lat,this.place.center.long);this.map.setCenter(this.location);this.insertPolys(this.place.geometry);return this.setBounds();};Place.prototype.loadMultiPoly=function(){var i,_ref;this.location=new google.maps.LatLng(this.place.center.lat,this.place.center.long);this.map.setCenter(this.location);_ref=this.place.geometry;for(i in _ref){if(!__hasProp.call(_ref,i))continue;this.insertPolys(this.place.geometry[i][0]);}
return this.setBounds();};Place.prototype.insertPolys=function(coords){var box,i,val;box=[];for(i in coords){if(!__hasProp.call(coords,i))continue;val=coords[i];box.push(new google.maps.LatLng(val[1],val[0]));}
return this.polys.push(new google.maps.Polygon({map:this.map,fillColor:"#EF1D1D",fillOpacity:0.6,paths:box,strokeColor:"#8F0808",strokeOpacity:0.8,strokeWeight:1,zIndex:this.polys.length+1}));};Place.prototype.setBounds=function(){var i,j,latlngs,_i,_j,_ref,_ref1;this.bounds=new google.maps.LatLngBounds();for(i=_i=0,_ref=this.polys.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){latlngs=this.polys[i].latLngs.getAt(0).getArray();for(j=_j=0,_ref1=latlngs.length;0<=_ref1?_j<_ref1:_j>_ref1;j=0<=_ref1?++_j:--_j){this.bounds.extend(latlngs[j]);}}
return this.map.fitBounds(this.bounds);};return Place;})();Routes=(function(){Routes.name='Routes';function Routes(){}
Routes.paths={"index":"/","login":"login","upload":"upload","account":"account/settings","admin":["admin/:page","admin/:page/:section"],"search":"search","realtime":"tag/:tag/realtime","set_location":["upload/debug","media/setLocation","media/editLocation/:id"],"place":["place/:username/:place_id","place/:place_id","places/:username"],"profile":"photos/:username","event_index":"events/:username","event":"e/:id","photo":":id"};Routes.getPage=function(getArgs){var arg,argResults,args,i,page,regex,route,routes,url,urlArgs,_i,_j,_len,_len1,_ref,_ref1;if(getArgs==null){getArgs=false;}
url=window.location.pathname;_ref=Routes.paths;for(page in _ref){if(!__hasProp.call(_ref,page))continue;routes=_ref[page];if(typeof routes==="string"){routes=[routes];}
for(_i=0,_len=routes.length;_i<_len;_i++){route=routes[_i];_ref1=this.processRoute(route),regex=_ref1[0],args=_ref1[1];if(url.match(regex)){if(getArgs){urlArgs=url.match(regex);argResults={};i=0;for(_j=0,_len1=args.length;_j<_len1;_j++){arg=args[_j];argResults[args[i]]=urlArgs[i+1];i++;}
return[page,argResults];}
return page;}}}
return null;};Routes.processRoute=function(route){var args;if(route.charAt(0)!=="/"){route="/"+route;}
if(route.charAt(route.length-1)==="/"){route.substr(0,route.length-1);}
args=[];route=route.replace(/(:[A-Za-z0-9_]+)/g,function(match,contents,offset,s){args.push(s.substr(offset+1,match.length-1));return"([A-Za-z0-9_\.\-]+)";});route=new RegExp("^"+route.replace("/","\/")+"$");return[route,args];};Routes.getHashArgs=function(){var args,chunk,hash,key,val,_i,_len,_ref,_ref1;if(window.location.hash.length===0){return{};}
hash=window.location.hash.substr(1);args={};_ref=hash.split("&");for(_i=0,_len=_ref.length;_i<_len;_i++){chunk=_ref[_i];_ref1=chunk.split("="),key=_ref1[0],val=_ref1[1];args[key]=val;}
return args;};Routes.setHashArgs=function(opts,merge){var chunks,hash,key,val;if(merge==null){merge=true;}
if(merge){opts=$.extend({},this.getHashArgs(),opts);}
chunks=[];for(key in opts){if(!__hasProp.call(opts,key))continue;val=opts[key];chunks.push(""+(encodeURIComponent(key))+"="+(encodeURIComponent(val)));}
hash=chunks.join("&");window.location.hash="#"+hash;return hash;};return Routes;})();window.Routes=Routes;Template=(function(){var TEMPLATES;Template.name='Template';TEMPLATES={};Template.store=function(data){return TEMPLATES[data.name]=data.content;};Template.factory=function(name,data){if(data==null){data={};}
return new Template(TEMPLATES[name],data);};function Template(template,data){this.template=template;this.data=data;this.html=new EJS({text:template});}
Template.prototype.render=function(){return this.html.render(this.data);};return Template;})();Twitpic.Template=Template;UI=(function(){UI.name='UI';UI.registered={};UI.modules={};UI.register=function(module){return this.registered[module.moduleName]=module;};function UI(){var module,name,_ref;_ref=UI.registered;for(name in _ref){if(!__hasProp.call(_ref,name))continue;module=_ref[name];UI.modules[name]=new module();if(UI.modules[name].activate()){UI.modules[name].init();}}}
UI.prototype.get=function(module){return UI.modules[module];};return UI;})();UIModule=(function(){UIModule.name='UIModule';function UIModule(){}
UIModule.prototype.activate=function(){return true;};UIModule.prototype.init=function(name){return Log.info("[UI] "+name+" activated");};return UIModule;})();Upload=(function(){var swfupload;Upload.name='Upload';swfupload=null;Upload.settings={flash_url:"/js/swfupload/swfupload.swf",flash9_url:"/js/swfupload/swfupload_fp9.swf",upload_url:"/media/create.json",file_post_name:"media",file_size_limit:"300 MB",file_types:"*.*",file_types_description:"Images and Videos",file_upload_limit:1,file_queue_limit:1,debug:false,button_image_url:"/images/upload-sprite.png",button_width:"104",button_height:"29",button_text:""};function Upload(div){var settings;this.div=div;settings=Upload.settings;settings.post_params={PHPSESSID:Config.get('PHPSESSID')};settings.button_placeholder_id=this.div;settings.swfupload_load_failed_handler=this.loadFailed;settings.file_dialog_start_handler=this.fileDialog;settings.file_queued_handler=this.fileQueued;settings.upload_start_handler=this.uploadStart;settings.upload_progress_handler=this.uploadProgress;settings.upload_error_handler=this.uploadError;settings.upload_success_handler=this.uploadSuccess;swfupload=new SWFUpload(settings);this.success=function(){};Log.debug("SWFUpload loaded!");}
Upload.prototype.swfu=function(){return swfupload;};Upload.prototype.onSuccess=function(cb){return this.success=cb;};Upload.prototype.loadFailed=function(){};Upload.prototype.fileDialog=function(){if(this.currentFile!=null){return this.cancelUpload(this.currentFile.id);}};Upload.prototype.startUpload=function(){return swfupload.startUpload();};Upload.prototype.fileQueued=function(file){this.currentFile=file;$("#media-upload-name").html(file.name);$("#media-upload-size").html(Upload.getFuzzySize(file.size));$("#media-upload-type").html(Upload.getFileType(file.name));return $("#upload-meta").fadeIn();};Upload.prototype.uploadStart=function(file){return $("#upload-submit > .left").fadeIn();};Upload.prototype.uploadProgress=function(file,bytesLoaded,bytesTotal){var amtDone;amtDone=Math.round((bytesLoaded/bytesTotal)*100);$("#upload-progress").css('width',""+amtDone+"%");return $("#upload-progress-amount").html(""+amtDone+"%");};Upload.prototype.uploadError=function(file,errorCode,msg){var errorMsg;if(errorCode===SWFUpload.UPLOAD_ERROR.FILE_CANCELLED){return;}
errorMsg=(function(){switch(errorCode){case SWFUpload.UPLOAD_ERROR.HTTP_ERROR:return"Upload error.";case SWFUpload.UPLOAD_ERROR.UPLOAD_FAILED:return"Upload failed.";case SWFUpload.UPLOAD_ERROR.IO_ERROR:return"Server IO Error.";case SWFUpload.UPLOAD_ERROR.SECURITY_ERROR:return"Security error.";case SWFUpload.UPLOAD_ERROR.UPLOAD_LIMIT_EXCEEDED:return"Upload limit exceeded.";case SWFUpload.UPLOAD_ERROR.FILE_VALIDATION_FAILED:return"File failed validation.";default:return"Unknown upload error.";}})();errorMsg+=" The server said: "+msg;return Broadcast.error(errorMsg,5);};Upload.prototype.uploadSuccess=function(file,serverData){serverData=JSON.parse(serverData);return window.location.href="/"+serverData.short_id;};Upload.getFileType=function(filename){switch(Upload.getFileExt(filename)){case"jpg":case"jpeg":case"gif":case"png":case"bmp":return"an image";default:return"a video";}};Upload.getFileExt=function(filename){return filename.split(".").pop();};Upload.getFuzzySize=function(size){if(size<1024){return""+(Math.round(size))+"B";}
if(size/1024<1024){return""+(Math.round(size/1024))+"KB";}
return""+(Math.round(size/1024/1024))+"MB";};return Upload;})();Util=(function(){Util.name='Util';function Util(){}
Util.uniqid=(function(){var id;id=0;return{get:function(){return id++;}};})();Util.extend=function(){var extenders,key,object,other,val,_i,_len;object=arguments[0],extenders=2<=arguments.length?__slice.call(arguments,1):[];for(_i=0,_len=extenders.length;_i<_len;_i++){other=extenders[_i];for(key in other){if(!__hasProp.call(other,key))continue;val=other[key];object[key]=val;}}
return object;};Util.deepExtend=function(){var extenders,key,object,other,val,_i,_len;object=arguments[0],extenders=2<=arguments.length?__slice.call(arguments,1):[];if(!(object!=null)){return{};}
for(_i=0,_len=extenders.length;_i<_len;_i++){other=extenders[_i];for(key in other){if(!__hasProp.call(other,key))continue;val=other[key];if(!(object[key]!=null)||typeof val!=="object"){object[key]=val;}else{object[key]=this.deepExtend(object[key],val);}}}
return object;};Util.arrayUnique=function(arr){var item,key,result,store,val,_i,_len;store={};result=[];for(_i=0,_len=arr.length;_i<_len;_i++){item=arr[_i];store[item]=1;}
for(key in store){if(!__hasProp.call(store,key))continue;val=store[key];result.push(key);}
return result;};Util.jToHTML=function(jObj){return jObj.appendTo('<div />').parent().html();};Util.scrollBottom=function(){return $(document).height()-$(window).height()-$(window).scrollTop();};Util.rgbToHex=function(color){var blue,digits,green,hex,red;if(color.substr(0,1)==='#'){return color;}
digits=/(.*?)rgb\((\d+), (\d+), (\d+)\)/.exec(color);red=parseInt(digits[2]);green=parseInt(digits[3]);blue=parseInt(digits[4]);hex=(red<<16)|(green<<8)|blue;return""+digits[1]+"#"+(hex.toString(16));};Util.setSelectionRange=function(input,start,end){var range;if(input.jquery!=null){input=input.get(0);}
if(input.setSelectionRange!=null){input.focus();return input.setSelectionRange(start,end);}else if(input.createTextRange!=null){range=input.createTextRange();range.collapse(true);range.moveEnd('character',end);range.moveStart('character',start);return range.select();}};Util.getSelectionRange=function(el){var end,endRange,len,normalizedValue,range,start,textInputRange;if(el.jquery!=null){el=el.get(0);}
start=0;end=0;if(typeof el.selectionStart==="number"&&typeof el.selectionEnd==="number"){start=el.selectionStart;end=el.selectionEnd;}else{range=document.selection.createRange();if(range&&range.parentElement()===el){len=el.value.length;normalizedValue=el.value.replace(/\r\n/g,"\n");textInputRange=el.createTextRange();textInputRange.moveToBookmark(range.getBookmark());endRange=el.createTextRange();endRange.collapse(false);if(textInputRange.compareEndPoints("StartToEnd",endRange)>-1){start=end=len;}else{start=-textInputRange.moveStart("character",-len);start+=normalizedValue.slice(0,start).split("\n").length-1;if(textInputRange.compareEndPoints("EndToEnd",endRange)>-1){end=len;}else{end=-textInputRange.moveEnd("character",-len);end+=normalizedValue.slice(0,end).split("\n").length-1;}}}}
return[start,end];};Util.setCursorToPosition=function(input,pos){return this.setSelectionRange(input,pos,pos);};return Util;})();window.LinkedList=(function(){LinkedList.name='LinkedList';LinkedList.Types={Normal:1,Circular:2};LinkedList.factory=function(items,type){var item,ll,_i,_len;if(type==null){type=LinkedList.Types.Normal;}
if(typeof items!=="object"){return;}
ll=new LinkedList(type);for(_i=0,_len=items.length;_i<_len;_i++){item=items[_i];ll.push(item);}
return ll;};function LinkedList(type){this.type=type!=null?type:LinkedList.Types.Normal;this.items=[];}
LinkedList.prototype.length=function(){return this.items.length;};LinkedList.prototype.push=function(item){var lli;lli=new LinkedListItem(item);switch(this.type){case LinkedList.Types.Normal:if(!this.isEmpty()){lli.prev=this.items[this.lastIndex()];this.items[this.lastIndex()].next=lli;}
break;case LinkedList.Types.Circular:this.circularLink(lli);}
this.items.push(lli);return this;};LinkedList.prototype.unshift=function(item){var lli;lli=new LinkedListItem(item);switch(this.type){case LinkedList.Types.Normal:if(!this.isEmpty()){this.items[0].prev=lli;lli.next=this.items[0];}
break;case LinkedList.Types.Circular:this.circularLink(lli);}
this.items.unshift(lli);return this;};LinkedList.prototype.pop=function(){var lli;lli=this.items.pop();switch(this.type){case LinkedList.Types.Normal:if(!this.isEmpty()){this.items[this.lastIndex()].next=null;}
break;case LinkedList.Types.Circular:this.circularUnlink();}
return lli.data;};LinkedList.prototype.shift=function(){var lli;lli=this.items.shift();switch(this.type){case LinkedList.Types.Normal:if(!this.isEmpty()){this.items[0].prev=null;}
break;case LinkedList.Types.Circular:this.circularUnlink();}
return lli.data;};LinkedList.prototype.peek=function(data){if(data==null){data=false;}
if(this.isEmpty()){return null;}
return this.get(this.lastIndex(),data);};LinkedList.prototype.get=function(index,data){if(data==null){data=false;}
if(index<0||index>this.lastIndex()){throw"Index out of bounds";}
if(data){return this.items[index].data;}else{return this.items[index];}};LinkedList.prototype.set=function(index,item){if(index<0||index>this.lastIndex()+1){throw"Index out of bounds";}
if(index===this.lastIndex()+1){return this.push(item);}
this.items[index].data=item;return this;};LinkedList.prototype.injectBefore=function(index,item){var elli,nlli;nlli=new LinkedListItem(item);elli=this.get(index);if(elli.prev){elli.prev.next=nlli;}
nlli.prev=elli.prev;nlli.next=elli;elli.prev=nlli;this.items.splice(index,0,nlli);return this;};LinkedList.prototype.injectAfter=function(index,item){var elli,nlli;nlli=new LinkedListItem(item);elli=this.get(index);if(elli.next){elli.next.prev=nlli;}
nlli.prev=elli;nlli.next=elli.next;elli.next=nlli;this.items.splice(index+1,0,nlli);return this;};LinkedList.prototype.lastIndex=function(){return Math.max(this.items.length-1,0);};LinkedList.prototype.isEmpty=function(){return this.length()===0;};LinkedList.prototype.circularLink=function(lli){if(this.isEmpty()){lli.prev=lli;return lli.next=lli;}else{this.items[0].prev=lli;this.items[this.lastIndex()].next=lli;lli.prev=this.items[this.lastIndex()];return lli.next=this.items[0];}};LinkedList.prototype.circularUnlink=function(){if(this.isEmpty()){return;}
this.items[0].prev=this.items[this.lastIndex()];return this.items[this.lastIndex].next=this.items[0];};LinkedList.prototype.toString=function(){return this.items.toString();};return LinkedList;})();LinkedListItem=(function(){LinkedListItem.name='LinkedListItem';function LinkedListItem(data){this.data=data;this.next=null;this.prev=null;}
LinkedListItem.prototype.getNext=function(count){var ref;if(count==null){count=1;}
ref=this;while(count-->0){if(ref.next===null){throw"Walking out of bounds";}
ref=ref.next;}
return ref;};LinkedListItem.prototype.getPrev=function(count){var ref;if(count==null){count=1;}
ref=this;while(count-->0){if(ref.prev===null){throw"Walking out of bounds";}
ref=ref.prev;}
return ref;};LinkedListItem.prototype.toString=function(){return this.data.toString();};return LinkedListItem;})();AccountUI=(function(_super){__extends(AccountUI,_super);AccountUI.name='AccountUI';function AccountUI(){return AccountUI.__super__.constructor.apply(this,arguments);}
AccountUI.moduleName="account";AccountUI.prototype.activate=function(){return Routes.getPage()==="account";};AccountUI.prototype.init=function(){AccountUI.__super__.init.call(this,"account");return this.checkForStatus();};AccountUI.prototype.checkForStatus=function(){var args;args=Routes.getHashArgs();if(!(args.saved!=null)){return;}
if(args.saved==="0"){return Broadcast.error("There was an error saving your settings, please try again.",5);}else if(args.saved==="1"){return Broadcast.success("Your settings have been updated.",5);}};return AccountUI;})(UIModule);UI.register(AccountUI);AdminUI=(function(_super){__extends(AdminUI,_super);AdminUI.name='AdminUI';function AdminUI(){return AdminUI.__super__.constructor.apply(this,arguments);}
AdminUI.moduleName="admin";AdminUI.prototype.activate=function(){return Routes.getPage()==="admin";};AdminUI.prototype.init=function(){AdminUI.__super__.init.call(this,"admin");return this.tooltip();};AdminUI.prototype.tooltip=function(){var xOffset,yOffset;xOffset=10;yOffset=20;$("a.tooltip").hover(function(e){this.t=this.title;this.title="";$("body").append("<p id=\"tooltip\">"+this.t+"</p>");return $("#tooltip").css({top:""+(e.pageY-xOffset)+"px",left:""+(e.pageX+yOffset)+"px"}).fadeIn('fast');},function(){this.title=this.t;return $("#tooltip").remove();});return $("a.tooltip").mousemove(function(e){return $("#tooltip").css({top:""+(e.pageY-xOffset)+"px",left:""+(e.pageX+yOffset)+"px"});});};return AdminUI;})(UIModule);UI.register(AdminUI);EventUI=(function(_super){__extends(EventUI,_super);EventUI.name='EventUI';function EventUI(){return EventUI.__super__.constructor.apply(this,arguments);}
EventUI.moduleName="event";EventUI.confirmDelete="Are you sure you want to delete this event?\n\nThis will not delete any photos in the event.";EventUI.prototype.activate=function(){var _ref;return(_ref=Routes.getPage())==="event"||_ref==="event_index";};EventUI.prototype.init=function(){var args,page,_ref;EventUI.__super__.init.call(this,"event");_ref=Routes.getPage(true),page=_ref[0],args=_ref[1];this.eventID=parseInt(args.id,36);this.editMode=false;return this.bindEvents();};EventUI.prototype.bindEvents=function(){var self,_this=this;self=this;$("#edit-images").bind('click',function(){return _this.toggleEditMode();});$("#save-event").bind('click',function(){return _this.saveEvent();});$("#delete-event").bind('click',function(){return _this.deleteEvent();});$(".remove-media").live('click',function(){return self.removeFromEvent($(this));});return $("#create-event").bind('click',function(){return _this.createEvent();});};EventUI.prototype.toggleEditMode=function(){if(this.editMode){this.editMode=false;$(".remove-media").remove();return $("#edit-images").attr({value:"Enable Edit Mode"});}else{this.editMode=true;$("#edit-images").attr({value:"Disable Edit Mode"});return $("#photo-container .user-photo").each(function(i,val){$(this).css({position:"relative"});return $("<input />").attr({type:"button",value:"Remove"}).addClass("red-button remove-media").appendTo(this);});}};EventUI.prototype.saveEvent=function(){var apiArgs;apiArgs={event_id:this.eventID,name:$("#event_title").attr('value'),description:$("#event_description").attr('value'),trigger:$("#event_trigger").attr('value')};return API.post('events/edit',apiArgs,function(event){if(event.error){Broadcast.error("There was an error saving this event, pleast try again.",5);}
$("#event-name").html(event.name);$("#event-description").html(event.description);return Broadcast.success("Event updated!",5);});};EventUI.prototype.deleteEvent=function(){if(!confirm(EventUI.confirmDelete)){return;}
return API.post("events/delete",{event_id:this.eventID},function(data){return window.location.href="/events/"+(Config.get('activeUser').username);});};EventUI.prototype.removeFromEvent=function(image){var apiArgs;image=image.parent();apiArgs={media_id:image.data('id'),event_id:this.eventID};return API.post('events/remove',apiArgs,function(data){return image.parent().remove();});};EventUI.prototype.createEvent=function(){var apiArgs,desc,name,trigger;name=$.trim($("#event_title").attr('value'));desc=$.trim($("#event_description").attr('value'));trigger=$.trim($("#event_trigger").attr('value'));if(name.length===0){return Broadcast.error("You must give the event a name.",5);}
apiArgs={name:name,description:desc,trigger:trigger};return API.post("events/create",apiArgs,function(event){return window.location.reload();},function(){return Broadcast.error("There was an error creating the event. Try again?",5);});};return EventUI;})(UIModule);UI.register(EventUI);HomeUI=(function(_super){__extends(HomeUI,_super);HomeUI.name='HomeUI';function HomeUI(){return HomeUI.__super__.constructor.apply(this,arguments);}
HomeUI.prototype.activate=function(){return Routes.getPage()==="index";};HomeUI.prototype.init=function(){this.scrollerNext();return this.tagSearch();};HomeUI.prototype.scrollerNext=function(){var _this=this;return setTimeout(function(){return $(".verified-post.latest:first").prev().addClass('latest').slideDown('slow',function(){return _this.scrollerNext();});},5000);};HomeUI.prototype.tagSearch=function(){var _this=this;$("#homepage-search").find("[type=button]").bind('click',this.performSearch);return $("#homepage-search [name=tag_search]").bind('keydown',function(e){if(e.keyCode===13){return _this.performSearch();}});};HomeUI.prototype.performSearch=function(){var tag;tag=$.trim($("#homepage-search [name=tag_search]").attr('value'));tag=tag.replace(" ","+").replace("#","");return window.location.href="/tag/"+tag;};return HomeUI;})(UIModule);UI.register(HomeUI);LocationUI=(function(_super){__extends(LocationUI,_super);LocationUI.name='LocationUI';function LocationUI(){return LocationUI.__super__.constructor.apply(this,arguments);}
LocationUI.moduleName="location";LocationUI.prototype.activate=function(){var _ref;return(_ref=Routes.getPage())==="set_location"||_ref==="place";};LocationUI.prototype.init=function(){LocationUI.__super__.init.call(this,"location");this.media=Config.get('media');this.loadMap();return this.bindEvents();};LocationUI.prototype.loadMap=function(){var div,_this=this;div=(function(){switch(Routes.getPage()){case"set_location":return"#upload-location";case"place":return"#media-location";}})();if($(div).length===0){return;}
if(Config.get('place')){this.place=new Place(Config.get('place'));this.place.setOptions(this.options);return this.place.inject(div);}else if(Config.get('lat')){this.place=new Place();this.place.setLatLng(Config.get('lat'),Config.get('long'));this.place.setOptions(this.options);return this.place.inject(div);}else{this.place=new Place();this.place.setOptions(this.options);return this.place.useGeoLocation(function(){return _this.place.inject(div);});}};LocationUI.prototype.bindEvents=function(){var self,_this=this;self=this;$("#perform-search").bind('click',function(){return _this.locationSearch();});$(".location-result").live('click',function(){return self.setLocation(this);});$("#save").bind('click',function(){return _this.saveLocation();});$("#cancel").bind('click',function(){return window.location.href="/"+_this.media.short_id;});$("#delete").bind('click',function(){return window.location.href="/geo/delete/"+_this.media.short_id;});return $("#exact").bind('click',function(){return _this.saveLocation(-1);});};LocationUI.prototype.locationSearch=function(){var apiArgs,q,_this=this;q=$.trim($("#upload-location-search").attr('value'));if(q.length===0){return;}
apiArgs={query:q};$.extend(apiArgs,this.place.getLatLng());$("#location-ajax").fadeIn('fast');return API.post('geo/search',apiArgs,function(data){var div,place,place_id,_results;$("#location-ajax").fadeOut('slow');if(data.error){return _this.error(data.error);}
$("#location-results").empty();_results=[];for(place_id in data){if(!__hasProp.call(data,place_id))continue;place=data[place_id];place.id=place_id;div=$(Template.factory('location_result',place).render());_results.push(div.appendTo('#location-results'));}
return _results;});};LocationUI.prototype.error=function(error){$("#location-ajax").fadeOut('slow');if(error==="api_error"){return Broadcast.error("It looks like Twitter is currently having some issues. Please try again in a few minutes!",5);}else{return Broadcast.error(error,5);}};LocationUI.prototype.setLocation=function(item){$("#location-results .active").removeClass('active');$(item).addClass('active');if(!$("#save").is(":visible")){return $("#save").show();}};LocationUI.prototype.saveLocation=function(id){var apiArgs,endpoint;if(id==null){id=false;}
if(!id){id=$("#location-results .active").data('id');}
apiArgs={media_id:Config.get('media').short_id,place_id:id};endpoint=Config.get('update')?'geo/update':'geo/create';return API.post(endpoint,apiArgs,function(){return window.location.href="/"+apiArgs.media_id;},function(){return Broadcast.error("There was an error saving the location. Try again?",5);});};return LocationUI;})(UIModule);UI.register(LocationUI);MiscUI=(function(_super){__extends(MiscUI,_super);MiscUI.name='MiscUI';function MiscUI(){return MiscUI.__super__.constructor.apply(this,arguments);}
MiscUI.moduleName="misc";MiscUI.prototype.activate=function(){return true;};MiscUI.prototype.init=function(){MiscUI.__super__.init.call(this,"misc");if(Routes.getPage()!=="upload"){this.uploadModal=new UploadModal();if(Routes.getHashArgs().upload!=null){this.uploadModal.show();}}
this.messageWatch();this.anywhereHovercards();this.paginationHashFix();return this.uploadModalEvents();};MiscUI.prototype.anywhereHovercards=function(){return twttr.anywhere(function(T){return T("a").hovercards({infer:true});});};MiscUI.prototype.paginationHashFix=function(){return $(".pagination a").bind('click',function(){var href;href=$(this).attr('href');if($(this).parent().data('hash')){href+=window.location.hash;}
window.location.href=href;return false;});};MiscUI.prototype.uploadModalEvents=function(){var _this=this;return $("#nav-upload, #infobar-upload").bind('click',function(){_this.uploadModal.show();return false;});};MiscUI.prototype.messageWatch=function(){var hashArgs;hashArgs=Routes.getHashArgs();if(hashArgs.uploadError){return Broadcast.error("There was an error uploading your media. Try again?",5);}};return MiscUI;})(UIModule);UI.register(MiscUI);PhotoUI=(function(_super){__extends(PhotoUI,_super);PhotoUI.name='PhotoUI';function PhotoUI(){return PhotoUI.__super__.constructor.apply(this,arguments);}
PhotoUI.moduleName="photo";PhotoUI.prototype.activate=function(){return Routes.getPage()==="photo";};PhotoUI.prototype.init=function(){var args,page,_ref,_ref1;PhotoUI.__super__.init.call(this,"photo");_ref=Routes.getPage(true),page=_ref[0],args=_ref[1];this.mediaID=args.id;this.neighbors=LinkedList.factory(Config.get('neighbors'),LinkedList.Types.Circular);this.currentNeighbor=this.neighbors.get(0);if(Config.get('place')){this.loadPlace();}
this.areMoreComments=true;this.commentFirstSeen=$(".comment:first").data('id')||null;this.commentQueue=[];this.commentSkipRender={};this.realtimeEnabled=true;this.incomingCommentListener();this.incomingQueueWorker();this.scrollCommentListener(1000);this.ftManager=new FacetagManager("#media");this.facetagControls();if(Config.get('media').video!==null){if(parseInt(Config.get('media').video.status,10)===2){$("#twitpic-video").VideoJS();}
if((_ref1=parseInt(Config.get('media').video.status,10))===0||_ref1===1){this.pollForVideo();}}
return this.bindEvents();};PhotoUI.prototype.bindEvents=function(){var self,showHUD,_this=this;self=this;$('.neighbors-control').bind('click',function(){if($(this).hasClass('control-left')){return self.neighborControl('left');}else{return self.neighborControl('right');}});$("#realtime-toggle").bind('click',function(){return _this.toggleRealtimeComments();});$(".new-comment").bind('submit',function(){self.submitComment($(this));return false;});$("#comment-text").bind('keyup',function(e){var chars,left;chars=$(this).attr('value').length;left=112-chars;if(Config.get('user').id!==Config.get('activeUser').id){left-=Config.get('user').username.length+2;}
return $("#comment-chars-left").html(left);});this.enableHUD();showHUD=true;if(window.localStorage!=null){if(window.localStorage['twitpic_hud']){showHUD=false;}else{window.localStorage['twitpic_hud']=true;}}
if(showHUD){setTimeout(function(){return $("#media-overlay").fadeOut(1000);},2000);}else{$("#media-overlay").hide();}
$("#rotate-open").bind('click',function(){return _this.showRotateControls();});$(".rotate").live('click',function(){return self.doRotation($(this).data('dir'),"rotate-image");});$("#cancel-rotation").live('click',function(){return self.doRotation("r","rotate-image");});$("#save-rotation").live('click',function(){var photo,rotation;if(!$("#save-rotation").html==="Save Rotation"){return false;}
photo=$("#rotate-image > img");rotation=(photo.data("angle")===undefined?0:photo.data("angle"));$("#save-rotation").html("saving . . . . . .");$.post("/media/rotate.json","rotate="+rotation+"&media_id="+$(this).data('media_id')+"&auth_code="+$(this).data('auth_code'),(function(data){if(data===1){$("#save-rotation").html("Save Rotation");$("#rotate").fadeOut(function(){return $(this).remove();});return Modal.factory("<p>Your image has been rotated. However it may take up to 30 minutes to show as rotated on the site. If after 30 minutes it still doesn't show as rotated, please try again or contact us for further assistance.</p>").show();}else{$("#save-rotation").html("Save Rotation");return alert("Could not save changes");}}),"json");return false;});$("#add-tag").bind('click',function(){return _this.addTag();});$(".delete-tag").live('click',function(){return self.deleteTag($(this).parent());});$("#toggle-edit-tags").bind('click',function(){$("#edit-tags").toggle();return $(".delete-tag").toggle();});$("#addtoevent").bind('change',function(){switch($(this).attr('value')){case"-1":return $("#new-event-form").slideDown();case"-2":break;default:if($("#new-event-form").is(":visible")){return $("#new-event-form").slideUp();}}});$("#create-event").bind('click',function(){return _this.createEvent();});$("#add-event").bind('click',function(){return _this.addToEvent();});$(".toggle-event-edit").bind('click',function(){return $('.edit-events').toggle();});return $(".comment-delete").live('click',function(){var comment;comment=$(this).parents('.comment');return self.deleteComment(comment);});};PhotoUI.prototype.enableHUD=function(){return $("#media").hover(function(){return $("#media-overlay").fadeIn(500);},function(){return $("#media-overlay").fadeOut(500);});};PhotoUI.prototype.loadPlace=function(){if($("#media-location").length===0){return;}
this.place=new Place(Config.get('place'));return this.place.inject("#media-location");};PhotoUI.prototype.neighborControl=function(dir){var i,image,_i,_results;if(this.neighbors.length<=3){return;}
if(dir==='left'){this.currentNeighbor=this.currentNeighbor.getPrev(3);}else{this.currentNeighbor=this.currentNeighbor.getNext(3);}
$("#neighbor-images").empty();_results=[];for(i=_i=0;_i<3;i=++_i){image=this.currentNeighbor.getNext(i).data;_results.push($("<a />").attr('href',"/"+image.short_id).prepend($("<img />").attr('src',"/show/thumb/"+image.short_id)).appendTo("#neighbor-images"));}
return _results;};PhotoUI.prototype.incomingCommentListener=function(){var _this=this;return setTimeout(function(){var apiArgs;if(!_this.realtimeEnabled||_this.commentQueue.length>1){return _this.incomingCommentListener();}
apiArgs={media_id:_this.mediaID,first_seen:_this.commentFirstSeen||1};return API.get('comments/show',apiArgs,function(resp){var comment,commentCount,comments,_i,_len;if(!(resp.comments!=null)){return _this.incomingCommentListener();}
comments=resp.comments;_this.commentFirstSeen=comments[comments.length-1].id;commentCount=parseInt($("#comment-count").html(),10);commentCount+=comments.length;$("#comment-count").html(commentCount);for(_i=0,_len=comments.length;_i<_len;_i++){comment=comments[_i];if(!_this.commentSkipRender[comment.id]){_this.commentQueue.push(comment);}}
return _this.incomingCommentListener();},function(){return _this.incomingCommentListener();});},10000);};PhotoUI.prototype.incomingQueueWorker=function(){var timeout,_this=this;timeout=this.commentQueue.length>0?0:1000;return setTimeout(function(){var comment;if(_this.commentQueue.length===0||$(window).scrollTop()>1200){return _this.incomingQueueWorker();}
comment=_this.commentQueue.shift();if(_this.commentSkipRender[comment.id]){return _this.incomingQueueWorker();}
return _this.injectNewComment(comment,function(){return _this.incomingQueueWorker();});},timeout);};PhotoUI.prototype.scrollCommentListener=function(wait){var _this=this;return setTimeout(function(){var apiArgs,toBottom;if(!_this.areMoreComments){return true;}
toBottom=Util.scrollBottom();if(toBottom>500||$(".comment").length===0){return _this.scrollCommentListener(1000);}
apiArgs={media_id:_this.mediaID,last_seen:$(".comment:last").data('id')};return API.get('comments/show',apiArgs,function(resp){var comment,_i,_len,_ref;if(!(resp.comments!=null)){_this.areMoreComments=false;return;}
_ref=resp.comments;for(_i=0,_len=_ref.length;_i<_len;_i++){comment=_ref[_i];comment=$(Template.factory('comment',comment).render());comment.appendTo('#comment-wrap');}
return _this.scrollCommentListener(1000);},function(){return _this.scrollCommentListener(10000);});},wait);};PhotoUI.prototype.injectNewComment=function(comment,done){var commentHtml,num;if(done==null){done=function(){};}
num=parseInt($("#num-comments").html(),10);num+=1;$("#num-comments").html(num);commentHtml=$(Template.factory('comment',comment).render());commentHtml.css('display','none');if(comment.can_delete===false){commentHtml.find('.comment-delete').remove();}
return commentHtml.prependTo("#comment-wrap").slideDown(1000,done);};PhotoUI.prototype.toggleRealtimeComments=function(){var div;div=$("#realtime-toggle");if(div.hasClass('enabled')){this.realtimeEnabled=false;return div.removeClass('enabled').addClass('disabled').find('.state').html('disabled');}else{this.realtimeEnabled=true;return div.removeClass('disabled').addClass('enabled').find('.state').html('enabled');}};PhotoUI.prototype.submitComment=function(div){var args,_this=this;args={media_id:this.mediaID,comment_form_auth:div.find('[name=comment_form_auth]').attr('value'),message:div.find('[name=message]').attr('value')};return API.post('comments/create',args,function(comment){if(!(comment!=null)){return;}
_this.injectNewComment(comment);_this.commentSkipRender[comment.id]=true;return div.find('[name=message]').attr('value','');},function(){return Broadcast.Twitpic.error("There was an error submitting your comment. Please wait and try again.");});};PhotoUI.prototype.showRotateControls=function(){var args,div;args={short_id:this.mediaID};div=$(Template.factory('rotate',args).render());div.css('display','none');div.find('#rotate-background').bind('click',function(){return $(this).parent().fadeOut(function(){return $(this).remove();});});div.prependTo('body').fadeIn();return $(document).bind('keydown',function(e){if(e.keyCode===27){$("#rotate").fadeOut(function(){return $(this).remove();});return $(this).unbind('keydown');}});};PhotoUI.prototype.doRotation=function(dir,layer){var costheta,current,deg,height,ie_crap,new_deg,photo,rotation,sintheta,top_margin,width;photo=$("#"+layer+" > img");deg=dir==="c"?90:-90;deg=dir==="r"?photo.data('angle')*-1:deg;if(photo.data('angle')!=null){current=photo.data('angle');new_deg=(current+deg)%360;}else{current=0;new_deg=deg%360;}
photo.data('angle',new_deg);if(!(photo.data('old_margin')!=null)){photo.data('old_margin',parseInt(photo.css('margin-top'),10));}
if(deg>=0){rotation=Math.PI*new_deg/180;}else{rotation=Math.PI*(360+new_deg)/180;}
costheta=Math.cos(rotation);sintheta=Math.sin(rotation);ie_crap="progid:DXImageTransform.Microsoft.Matrix(M11="+costheta+",M12="+(-sintheta)+",M21="+sintheta+",M22="+costheta+",SizingMethod='auto expand')";width=photo.width();height=photo.height();if(Math.abs(new_deg)===90||Math.abs(new_deg)===270){top_margin=(width/2)-(height/2);}else{top_margin=photo.data('old_margin');}
return photo.css({'-moz-transform':"rotate("+new_deg+"deg)",'-webkit-transform':"rotate("+new_deg+"deg)",'-o-transform':"rotate("+new_deg+"deg)",'transform':"rotate("+new_deg+"deg)",'filter':ie_crap,'-ms-filter':ie_crap,'zoom':1,'margin-top':""+top_margin+"px"});};PhotoUI.prototype.addTag=function(){var apiArgs,name;name=$.trim($("#tag_name").attr('value'));if(name.length===0){Broadcast.error("Whoops, you must enter a tag name first!",5);}
if(name.charAt(0)==="#"){name=name.substr(1);}
apiArgs={media_id:this.mediaID,tags:name,tag_form_auth:$("#tag_form_auth").attr('value')};return API.post('tags/create',apiArgs,function(data){var a,span;a=$("<a />").attr('href',"/tag/"+(encodeURIComponent(name))).html("#"+name);span=$("<span />").addClass('tag').html(a).appendTo("#tags");$("#tag_name").attr('value','');return Broadcast.success("Tag #"+name+" added!",5);});};PhotoUI.prototype.deleteTag=function(tag){var apiArgs,id;id=tag.data('id');apiArgs={tag_id:id};return API.post('media/delete-tag',apiArgs,function(data){return tag.remove();});};PhotoUI.prototype.createEvent=function(){var apiArgs,desc,name,trigger,_this=this;name=$.trim($("#event_name").attr('value'));desc=$.trim($("#event_desc").attr('value'));trigger=$.trim($("#event_trigger").attr('value'));if(name.length===0){return Broadcast.error("You must give the event a name.",5);}
apiArgs={name:name,description:desc,trigger:trigger,media_id:parseInt(this.mediaID,36)};return API.post('events/createAndAdd',apiArgs,function(event){if(event.error){return Broadcast.error("There was an error creating the event. If there is a trigger, make sure it's unique.",5);}
Log.debug(event);_this.addEventToPage(event);$("#event_name").attr('value','');$("#event_desc").attr('value','');$("#event_trigger").attr('value','');return $("#new-event-form").slideUp();});};PhotoUI.prototype.addToEvent=function(){var apiArgs,id,_this=this;id=$("#addtoevent").attr('value');apiArgs={media_id:parseInt(this.mediaID,36),event_id:id};return API.post("events/add",apiArgs,function(event){_this.addEventToPage(event);return $("#addtoevent > option").each(function(i,val){if($(this).attr('value')===id){$(this).remove();return false;}});});};PhotoUI.prototype.addEventToPage=function(event){var t;t=$(Template.factory('event_tag',event).render());return t.appendTo("#events");};PhotoUI.prototype.facetagControls=function(){var _this=this;this.ftManager.on("enable",function(){return $("#faces-add").html("Done tagging");});this.ftManager.on("disable",function(){$("#faces-add").html("Add/edit faces");return _this.enableHUD();});return $("#faces-add").bind('click',function(){return _this.ftManager.toggleEdit();});};PhotoUI.prototype.pollForVideo=function(){var _this=this;return setTimeout(function(){return API.get(_this.mediaID,{owner:true},function(media){if(parseInt(media.video.status,10)===2){return window.location.reload();}else{return _this.pollForVideo();}});},10000);};PhotoUI.prototype.deleteComment=function(comment){var id;id=comment.data('id');return API.post("comments/delete",{comment_id:id},function(data){var num;if(data&&data.error){return Broadcast.error("Error deleting this comment. Try again?",5);}
num=parseInt($("#num-comments").html(),10);num-=1;$("#num-comments").html(num);return comment.slideUp('normal',function(){return comment.remove();});});};return PhotoUI;})(UIModule);UI.register(PhotoUI);RealtimeUI=(function(_super){__extends(RealtimeUI,_super);RealtimeUI.name='RealtimeUI';function RealtimeUI(){return RealtimeUI.__super__.constructor.apply(this,arguments);}
RealtimeUI.moduleName='realtime';RealtimeUI.prototype.checkInterval=10000;RealtimeUI.prototype.imageQueue=[];RealtimeUI.prototype.latestId=null;RealtimeUI.prototype.activate=function(){return Routes.getPage()==="realtime";};RealtimeUI.prototype.init=function(){var args,page,_ref;RealtimeUI.__super__.init.call(this,"realtime");_ref=Routes.getPage(true),page=_ref[0],args=_ref[1];this.tagName=args.tag;if(Config.get('images')){this.latestId=parseInt(Config.get('images')[0].id,10);this.imageQueue=this.imageQueue.concat(Config.get('images'));}else{this.latestId=0;}
this.checkForImages();return this.queueWatcher();};RealtimeUI.prototype.checkForImages=function(){var _this=this;return setTimeout(function(){return API.get("tag/"+_this.tagName,{},function(tagmap){var image,images,_i,_len;if(tagmap.id===null){return _this.checkForImages();}
images=tagmap.images;for(_i=0,_len=images.length;_i<_len;_i++){image=images[_i];if(parseInt(image.id,10)<=_this.latestId){return _this.checkForImages();}
_this.enqueueImage(image);}});},this.checkInterval);};RealtimeUI.prototype.enqueueImage=function(image){Log.debug("Enqueue image "+image.id);this.latestId=parseInt(image.id,10);return this.imageQueue.unshift(image);};RealtimeUI.prototype.queueWatcher=function(time){var _this=this;if(time==null){time=1000;}
return setTimeout(function(){var html,image;if(!(_this.imageQueue.length>0)){return _this.queueWatcher();}
$("#content .image-wrap:gt(49)").remove();image=_this.imageQueue.pop();if(!image.id){return _this.queueWatcher();}
html=$(Template.factory('realtime_image',image).render());html.css({'display':'none'});html.prependTo('#content');return html.fadeIn(function(){return _this.queueWatcher(4000);});},time);};return RealtimeUI;})(UIModule);UI.register(RealtimeUI);SearchUI=(function(_super){__extends(SearchUI,_super);SearchUI.name='SearchUI';function SearchUI(){return SearchUI.__super__.constructor.apply(this,arguments);}
SearchUI.moduleName='search';SearchUI.prototype.activate=function(){return Routes.getPage()==="search";};SearchUI.prototype.init=function(){var _this=this;SearchUI.__super__.init.call(this,"search");this.query="";this.page=1;if(Routes.getHashArgs().q!=null){this.query=Routes.getHashArgs().q;$("#search-form [name=q]").attr('value',this.query);this.executeSearch();}
$("#search-form").bind('submit',function(e){e.stopPropagation();_this.query=$("#search-form [name=q]").attr('value');_this.clearPage();_this.executeSearch();return false;});$("#to-top").bind('click',function(){return $("body,html").animate({scrollTop:0});});return $("#search-more").bind('click',function(){_this.page++;return _this.executeSearch();});};SearchUI.prototype.clearPage=function(){this.page=1;$("#photo-container").empty();return $("#search-more-wrap").hide();};SearchUI.prototype.executeSearch=function(){var apiArgs,_this=this;apiArgs={q:this.query,page:this.page};Routes.setHashArgs({q:this.query,page:this.page});return API.get('search/show',apiArgs,function(data){var div,photo,_i,_len;if(data.error){return _this.error();}
if(data.length===0){return _this.empty();}
for(_i=0,_len=data.length;_i<_len;_i++){photo=data[_i];div=$(Template.factory('search_photo',photo).render());div.appendTo("#photo-container");}
return $("#search-more-wrap").show();},function(){return _this.error();});};SearchUI.prototype.error=function(){return Broadcast.error("There was an error performing the search. Try again?",5);};SearchUI.prototype.empty=function(){return Broadcast.info("No results found.",5);};return SearchUI;})(UIModule);UI.register(SearchUI);UploadUI=(function(_super){__extends(UploadUI,_super);UploadUI.name='UploadUI';function UploadUI(){return UploadUI.__super__.constructor.apply(this,arguments);}
UploadUI.moduleName="upload";UploadUI.prototype.activate=function(){return Routes.getPage()==="upload";};UploadUI.prototype.init=function(){UploadUI.__super__.init.call(this,"upload");$("#nav-upload").hide();return $("[name=message]").bind('keyup',function(){var chars,div,left;chars=$.trim($(this).attr('value')).length;left=114-chars;div=$("#upload-chars-left");div.html(left);if(left<0){return div.addClass('error');}else{return div.removeClass('error');}});};return UploadUI;})(UIModule);UI.register(UploadUI);UserUI=(function(_super){__extends(UserUI,_super);UserUI.name='UserUI';function UserUI(){return UserUI.__super__.constructor.apply(this,arguments);}
UserUI.moduleName="user";UserUI.prototype.activate=function(){return Routes.getPage()==="profile";};UserUI.prototype.init=function(){var args,page,_ref;UserUI.__super__.init.call(this,"user");_ref=Routes.getPage(true),page=_ref[0],args=_ref[1];this.username=args.username;this.checkPageType();return this.bindEvents();};UserUI.prototype.checkPageType=function(){var args,_ref;args=Routes.getHashArgs();if((_ref=args.type)==="timeline"||_ref==="gallery"){return this.setPageType(args.type);}};UserUI.prototype.bindEvents=function(){var self;self=this;$(".page-type").bind('click',function(){return self.setPageType($(this).data('type'));});return $(".delete-image").bind('click',function(){return self.deleteImage($(this));});};UserUI.prototype.setPageType=function(type){Routes.setHashArgs({type:type});switch(type){case"timeline":$("#photo-container").removeClass('gallery').addClass('timeline');$("#page-type li:last-child").removeClass('active');return $("#page-type li:first-child").addClass('active');case"gallery":$("#photo-container").removeClass('timeline').addClass('gallery');$("#page-type li:last-child").addClass('active');return $("#page-type li:first-child").removeClass('active');}};UserUI.prototype.deleteImage=function(image){var apiArgs;if(!confirm('Are you sure you want to delete this image? THIS CANNOT BE UNDONE.')){return;}
apiArgs={media_id:image.data('id'),auth_code:image.data('auth')};return API.post('media/delete',apiArgs,function(){Broadcast.success("Image was successfully deleted",5);return image.parents('.user-photo-wrap').slideUp(function(){return $(this).remove();});});};return UserUI;})(UIModule);UI.register(UserUI);UploadModal=(function(_super){__extends(UploadModal,_super);UploadModal.name='UploadModal';function UploadModal(){var _this=this;UploadModal.__super__.constructor.call(this,{name:"upload",title:"Upload Photo or Video",autoOpen:false,width:620,background:{enabled:true},onOpen:function(){return _this.resetForm();}});}
UploadModal.prototype.initialize=function(){var _this=this;this.isSimple=false;if(Routes.getPage()!=="upload"){this.upload=new Upload("media-upload");}
this.div.find('[name=message]').bind('keyup',function(){var chars,div,left;chars=$.trim($(this).attr('value')).length;left=114-chars;div=$("#upload-chars-left");div.html(left);if(left<0){return div.addClass('error');}else{return div.removeClass('error');}});$("#upload-modal").bind('submit',function(e){if(!_this.isSimple){e.stopPropagation();_this.startUpload();return false;}});return $("#uploader-toggle").bind('click',function(){return _this.toggleUploader();});};UploadModal.prototype.toggleUploader=function(){var wrap;if(this.isSimple){$("#media-upload").empty();this.upload=new Upload("media-upload");$("#uploader-toggle").html("simple uploader");return this.isSimple=false;}else{window.location.href="/upload";$("#media-upload-wrap").remove();wrap=$("<div />").attr('id','media-upload-wrap');$("<div />").attr("id","media-upload").appendTo(wrap);wrap.insertAfter("#select-media > h4:first");$("<input />").attr('type','file').attr('name','media').appendTo("#media-upload");$("#uploader-toggle").html("flash uploader");return this.isSimple=true;}};UploadModal.prototype.resetForm=function(){$("#upload-meta").hide();return $("#upload-caption > textarea").attr('value','');};UploadModal.prototype.startUpload=function(){var location,twitter;twitter=this.div.find("[name=post_photo]").prop('checked')?1:0;location=this.div.find("[name=save_location]").prop('checked')?1:0;this.upload.swfu().addPostParam('form_auth',this.div.find("[name=form_auth]").attr('value'));this.upload.swfu().addPostParam('message',this.div.find("[name=message]").attr('value'));this.upload.swfu().addPostParam('post_photo',twitter);this.upload.swfu().addPostParam('save_location',location);this.upload.swfu().addPostParam('events',[]);return this.upload.startUpload();};return UploadModal;})(Modal);}).call(this);