window.Zendesk.NS("Ticket.ViewingStatus",window.jQuery,window.Zendesk,window.currentUser,function(e,f,c){var a=[15*1000,30*1000,45*1000,60*1000],k=0,b=false,l=0,j={},i=false,d=(window.Minilog?window.Minilog("collision"):function(){});function h(p,o){(function(){var r=0;function q(){if(++r>3){return}d("GET /api/v1/users/"+p+".json, attempt "+r);e.ajax("/api/v1/users/"+p+".json",{type:"GET",dataType:"json",cache:false,success:function(t,u,s){d("GET /api/v1/users/"+p+".json success",t,u);o(t)},error:function(u,t,s){if(r<3){d("Retrying GET /api/v1/users/"+p+".json due to #api_error",u.status,u.statusText,u.getAllResponseHeaders&&u.getAllResponseHeaders(),u.responseText)}q()}})}q()}())}function n(s,p){var r=[],o=s.length,t=0;for(var q=0;q<o;q++){(function(u,v){if(j[v]){r[u]=j[v];t++;if(t==o){p(r)}return}h(v,function(w){r[u]=j[v]=w;t++;if(t==o){p(r)}})})(q,s[q])}}function m(){}m.message="";m.type="";m.banner=false;m.updateViewers=function(r){var o=[];var q=parseInt(f.currentUser.id,10);for(var p in r){if(p==q){continue}if(!r.hasOwnProperty(p)){continue}o.push(p)}if(o.length===0){if(m.type!=="urgent"){m._hide()}return}m.type="normal";n(o.slice(0,3),function(t){var v=[],s=t.length;for(var u=0;u<s;u++){t[u]&&t[u].name&&v.push(t[u].name)}if(v.length===0){d("#api_error no responses contained names",v);return}switch(v.length){case 1:m.message=I18n.t("txt.ticket.collision.other_viewers.one",{person:v[0]});break;case 2:m.message=v.join(" and ")+" are also viewing this ticket.";break;default:m.message=v.slice(0,2).join(", ")+", and "+(v.length-2)+(o.length>3?" others":" other")+" are also viewing this ticket."}m._render()})};m.updateTicket=function(){m.type="urgent";m.message=I18n.t("txt.ticket.collision.updated");m._render();m.banner.reload().show()};m._hide=function(){if(!m.banner){m.banner=f.Banner.create()}if(m.banner.visible()){m.type="";m.banner.disappear()}};m._render=function(){if(!m.banner){m.banner=f.Banner.create()}m.banner.setContent(m.message).removeClass("normal urgent").addClass(m.type).reload().hide();if(m.banner.hidden()){m.banner.appear()}};function g(q){var o=this,p=false;this.viewers={};if(!b){b=true;RadarClient.alloc("collision").once("ready",function(){if(!p){RadarClient.presence("ticket/"+q).set("online")}RadarClient.presence("ticket/"+q).on(function(r){o.updatePresence(r)}).sync();RadarClient.status("ticket/"+q).on(function(r){o.updateTime(r)}).subscribe()})}}g.prototype.updatePresence=function(q){var s=!!(q.op==="online"),o=false;for(var p in q.value){if(!q.value.hasOwnProperty(p)){continue}p=parseInt(p,10);var r=!!(this.viewers[p]);if(s&&!r){this.viewers[p]=true;o=true}else{if(!s&&r){delete this.viewers[p];o=true}}}if(o){m.updateViewers(this.viewers)}};g.prototype.updateTime=function(o){var p={};if(/updated_at/.test(o.value)){p=JSON.parse(o.value)}else{p.updated_at=o.value;p.updated_by=null}if(o.key=="updated"&&p.updated_at!=i&&p.updated_by!=f.currentUser.id){i=p.updated_at;m.updateTicket()}};e(function(){if(e("#show_agent_collision_for_ticket").length==1){window.viewStatus=new g(window.ticket_id)}})});