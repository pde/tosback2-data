$z.defModule("access/index",{initialize:function(){$j("#password_help").data("originalURL",$j("#password_help").attr("href"));this.addEmailToPasswordHelpLink();$j("#user_email").change(function(){$z("access/index").addEmailToPasswordHelpLink();});},addEmailToPasswordHelpLink:function(){var b=$j("#password_help");var a=$j("#user_email").val();var c=$j("#password_help").data("originalURL");if($j.trim(a)===""){b.attr("href",c);}else{a=encodeURIComponent(a);b.attr("href",c+"?email="+a);}}});$z.defModule("account/business_hours_definitions/show",{initialize:function(){if($j("form#business_hours_form").attr("data-has-business-hours")==="false"){$j("#business_hours_definition_is_active_false").click();$j("form#business_hours_form :input").prop("disabled",true);$j("#sub_setting_is_active").show();}}});$z.defModule("account/dropboxes/edit",{initialize:function(){var b=$j("#dropbox_form"),d=b.find(".upgrade_field"),c=b.find("a.upgrade"),a=b.find(".current_version");c.click(function(){if(!confirm("Upgrade this Feedback Tab?")){return false;}$j.ajax({url:c.attr("href"),type:"POST",dataType:"JSON",data:{_method:"PUT"}}).done(function(e){showFlash("Upgraded","notice");a.html(e.version);d.removeClass("upgradeable").addClass("not_upgradeable");}).fail(function(e){var f=JSON.parse(e.responseText);f.error&&showFlash(f.error,"error");});return false;});}});$z.defModule("account/dropboxes/version1",{initialize:function(){this._hostName=$j("#zenboxForm").attr("data-zd-host-name");if(!this._hostName){console.warn("No host name found. Is there a #zenboxForm[data-zd-host-name] element?");}$j("#zenboxForm input").change(this.update.bind(this));Zenbox.init(this._settings());this.update({init:true});},update:function(a){var b=this._settings();this._applySettingsToDropbox(b);this._writeTemplate(b,a);},_settings:function(){return{url:this._hostName,tab_id:this._tabID(),tab_color:$j.trim($j("#zenbox_color").val()),title:$j.trim($j("#zenbox_title").val()).replace(/"/g,"'"),text:this._applyHTMLLineBreaks(($j("#zenbox_text").val())).replace(/"/g,"'"),tag:$j("#zenbox_tag").val()};},_applySettingsToDropbox:function(b){var a=$j("#zenbox_tab");a.css("backgroundColor",b.tab_color);a.css("borderColor",b.tab_color);$j("#overlay_zenbox_title").html(b.title);$j("#overlay_zenbox_text").html(b.text);$j("#zenbox_tab").css("backgroundImage","url(http://assets.zendesk.com/external/zenbox/images/tab_"+b.tab_id+".png)");},_writeTemplate:function(c,b){var a=$j("#zenbox_output");a.val($j.mustache(this._template,c));if(b&&!b.init){a.effect&&a.effect("highlight",{},2000);}},_template:'<script type="text/javascript" src="//assets.zendesk.com/external/zenbox/overlay.js"><\/script>\n<style type="text/css" media="screen, projection">\n  @import url(//assets.zendesk.com/external/zenbox/overlay.css);\n</style>\n<script type="text/javascript">\n  if (typeof(Zenbox) !== "undefined") {\n    Zenbox.init({\n      url:       "{{ url }}",\n      tab_id:    "{{ tab_id }}",\n      tab_color: "{{ tab_color }}",\n      title:     "{{ title }}",\n      text:      "{{ text }}",\n      tag:       "{{ tag }}"\n    });\n  }\n<\/script>\n',_applyHTMLLineBreaks:function(a){return $j.trim(a).replace(/\r\n|\n/g,"<br/>");},_tabID:function(){return $j('input:checked[type="radio"][name="zenbox_tab_id"]').val();}});$z.defModule("account/monitored_twitter_handles/index",{initialize:function(){var a=$j("p.add_monitor_handle a#add-twitter");if(arguments[0]==true){a.click(function(){$j("div.help-bubble").slideDown("200");});}else{a.click(this.addTwitterMonitorHandle());}MTH.initialize();},addTwitterMonitorHandle:function(){$j.colorbox({href:"/account/monitored_twitter_handles/new"});}});var MTH={initialize:function(){$j("input.handle_master").each(function(a,b){$j(b).click(MTH.setPrimary);});},setPrimary:function(b){var c=$j(b.target);var d=c.attr("id").split("_").last();var a=c.attr("checked");if(a){MTH.uncheckSiblings(c);}MTH.togglePrimaryFlag(d,a);MTH.requestUpdate(d,a);},showSpinner:function(a){$j("#spinner-"+a).show();},hideSpinner:function(a){$j("#spinner-"+a).hide();},uncheckSiblings:function(a){$j("input.handle_master").prop("checked",false);a.attr("checked",true);},togglePrimaryFlag:function(b,a){$j(".primary-selector").hide();if(a){$j("#primary-selector-"+b).show();}},requestUpdate:function(b,a){MTH.showSpinner(b);$j.ajax({type:"PUT",url:"/account/channels/"+b,data:{handle:{master:a}},success:function(){MTH.hideSpinner(b);}});}};$z.defModule("archived_tickets/index",{initialize:function(){this.updateUI();$j("select#filter_by").change(this.updateUI);},updateUI:function(){["requester","organization"].each(function(a){if(a==$j("select#filter_by").val()){$j("#"+a).show();}else{$j("#"+a).hide();}});}});$z.defModule("categories/form",{initialize:function(){$j("#category_name").focus();}});$z.defModule("categories/show",{initialize:function(){$z("forums/index").initialize();}});agentChatInit={init:function(){$j("#chat_availability").click(function(a){a.preventDefault();window.open("/chat","chatWindow","toolbar=0, menubar=0, width=620, height=594, location=0, status=0, directories=0");});}};$j(document).ready(function(){agentChatInit.init();});Zendesk.NS("CMS");Zendesk.CMS.Bootstrap=function(){if((typeof(currentAccount)=="undefined")||!currentAccount.hasFeature("ahab")){return;}$j("[data-placeholder-id]").each(function(a,d){var d=$j(d);if(!d.data("ahab")){var b=(d.find("textarea")||d.find("input[type=text]"));var e=d.find(".placeholder-info")||$j("<div></div>").insertAfter(b);var c=e.ahab(b);d.data("ahab",c);}});};Zendesk.CMS.Ahab=function(b,a){this.targetInput=a;this.linkElement=b;this.list=null;};Zendesk.CMS.Ahab.prototype={show:function(){if((typeof(this.list)=="undefined")||(this.list==null)){this._prepare();}var a=this;$j(this.list).iosMenu({title:"Insert Placeholder",slideDuration:50,click:function(c,d){var b=d.data("value");if(b){$j(a.targetInput).insertAtCaret("{{"+b+"}}");c.toggle();}},backTextFunction:function(b){return $j(b).parent().find("> a").html();}});return this;},_prepare:function(){var b=this._render(Zendesk.CMS.texts);var a=$j(this.linkElement).html(b);this.list=a.find("ul.root");},_render:function(b){var a=$j('<ul class="menu root" style="display: none;">');var c=_.reduce(this._renderLevel(b),function(d,e){return d.append(e);},a);return c;},_renderLevel:function(e){var b=this;var d=_.without(_.keys(e),"id","title");var c=_.sortBy(d,function(f){return f;});var a=_.map(c,function(f){return b._renderItem(f,e[f]);});return a;},_renderItem:function(b,c){var d=$j("<li></li>");d.append(b);var a=this._renderLevel(c);if(_.any(a)){subLevel=_.reduce(a,function(e,f){return e.append(f);},$j('<ul class="sd"></ul>'));d.append(subLevel).addClass("sub");}else{d.addClass("link");}d.data("full-title",c.title);d.data("value",c.id);return d;},_calculateTitles:_.memoize(function(){return _.map($j("li.ui-menu-item.link"),function(a){return $j(a).data("full-title");});}),_searchResultRenderer:function(a){var c=$j("input.ios-menu-search-field").val();var d=a.toLowerCase().split(c.toLowerCase());var b=_.reduce(d,function(e,f){return e+"<strong>"+c+"</strong>"+f;});return"<li><a>"+b+"</a></li>";}};jQuery.fn.extend({ahab:function(a){return new Zendesk.CMS.Ahab(this,a).show();}});$j("#cms_variant_is_fallback").change(function(){if($j("#cms_variant_is_fallback").attr("checked")=="checked"){$j("#cms_variant_active_true").attr("checked",true);$j("#cms_variant_active_false").attr("disabled",true);}else{$j("#cms_variant_active_false").attr("disabled",false);}});$j("#get_more_macros").click(function(){$j("#get_more_macros").hide();$j(".macros_reference").fadeIn();});$j("#get_more_triggers").click(function(){$j("#get_more_triggers").hide();$j(".triggers_reference").fadeIn();});$j("#get_more_automations").click(function(){$j("#get_more_automations").hide();$j(".automations_reference").fadeIn();});$j("#cms_texts_filter_form").change(function(){$j(this).closest("form").submit();});Zendesk.NS("CRM");Zendesk.CRM.Application=function(a){this.renderer=a;this.initialDelay=5000;this.backoff=0;};Zendesk.CRM.Application.prototype={renderData:function(b,a){if(a){this.renderer.render(b,a);}else{this.renderer.render(b,"ok");}},fetchAndRenderData:function(a){this.url=a;this._setupPoller();this.renderer.renderWaiting();this.poller.start();},_setupPoller:function(){var a=this;this.poller=new Zendesk.CRM.Poller(function(b){a._pollerCallback(a,b);},{initialDelay:this.initialDelay,backoff:this.backoff});},_pollerCallback:function(a,b){$j.ajax({type:"get",url:this.url,success:function(c){if(c.status==="ok"){a.poller.stop();a.renderData(c.records);}else{if(c.status=="errored"){a.poller.stop();a.renderData(c.records,c.status);}else{a.poller.resume();}}},error:function(){a.poller.stop();a.renderData([],"errored");}});}};Zendesk.NS("CRM");Zendesk.CRM.Poller=function(b,a){this.initialDelay=a.initialDelay||10000;this.backoff=a.backoff||5000;this.waitForCallback=a.waitForCallback||false;this.callback=b;this.state="stopped";this.currentDelay=this.initialDelay;this.waitDelay=a.waitDelay||2000;this.debug=!!a.debug;this.trace="";};Zendesk.CRM.Poller.prototype={start:function(){this.state="polling";this._schedulePoll(this.initialDelay);this._trace("[started]");},stop:function(){this.state="stopped";},reset:function(){this.state="resetting";},pause:function(){this.state="paused";this._trace("[paused]");},resume:function(){if(this.state=="paused"){this._trace("[resuming]");this.state="resuming";}},_schedulePoll:function(b){var a=this;setTimeout(function(){a._pollerCallback();},b);},_pollerCallback:function(){if(this.state=="polling"){this.currentDelay=this.currentDelay+this.backoff;var a=this.currentDelay;if(this.waitForCallback){this._trace("[pausing]");this.pause();a=this.waitDelay;}this._trace("[callback]");this.callback(this);this._schedulePoll(a);}else{if(this.state=="resetting"){this.state="polling";this.currentDelay=this.initialDelay;this._schedulePoll(this.initialDelay);}else{if(this.state=="paused"){this._trace(".");this._schedulePoll(this.waitDelay);}else{if(this.state=="resuming"){this._trace("[resumed]");this.state="polling";this._schedulePoll(this.currentDelay);}}}}},_trace:function(a){if(this.debug){this.trace=this.trace+a;}}};Zendesk.NS("CRM");Zendesk.CRM.ProfileRenderer=function(){this.element=$j("#crm_user_data");this.success_template=$j("#crm_template").html();this.error_template=$j("#crm_error_template").html();this.loading=$j("#crm_loading");};Zendesk.CRM.ProfileRenderer.prototype={renderWaiting:function(){this.loading.show();},render:function(b,a){if(a=="ok"){this._renderSuccess(b);}else{if(a=="pending"){this.renderWaiting();}else{this._renderError();}}},_renderSuccess:function(b){var a=this;_(b).each(function(d){d.fields=a._splitFields(d.fields);});var c=$j.mustache(this.success_template,{records:b});this.element.html(c);this.loading.hide();},_renderError:function(){this.element.html(this.error_template);this.loading.hide();},_splitFields:function(b){var a=[];var d,c;for(var e=0;e<b.length;e++){d=b[e];if(b[e+1]){c=b[e+1];e=e+1;}else{c={label:"&nbsp;",value:"&nbsp;",empty:true};}a.push({record1:d,record2:c});}return a;}};Zendesk.NS("CRM");Zendesk.CRM.SidebarRenderer=function(a){this.element=$j("#crm_user_data");this.success_template=$j("#crm_template").html();this.error_template=$j("#crm_error_template").html();this.loading=$j("#crm_loading");this.profile_url=a;this.fieldsToShow=10;};Zendesk.CRM.SidebarRenderer.prototype={renderWaiting:function(){this.loading.show();},render:function(b,a){if(a=="ok"){this._renderSuccess(b);}else{if(a=="pending"){this.renderWaiting();}else{this._renderError();}}},_renderSuccess:function(b){if(b.length>0){var d=this._addMoreLink(b[0]);var a=this;var f=_(b.slice(1)).map(function(g){return a._addMoreLink(g);});var e=f.length;}else{var d=null;var f=null;var e=null;}var c=$j.mustache(this.success_template,{mainRecord:d,subRecords:f,showMore:e});this.element.html(c);this.loading.hide();var a=this;$j(".crm-records-toggle",a.element).click(function(g){$j("#crm-sub-records",a.element).slideToggle(function(){$j(".crm-records-toggle",a.element).toggle();});g.stopPropagation();g.preventDefault();});},_addMoreLink:function(a){if(a.fields&&a.fields.length>this.fieldsToShow){a.fields=a.fields.slice(0,this.fieldsToShow);a.moreLink=this.profile_url;}return a;},_renderError:function(){this.element.html(this.error_template);this.loading.hide();}};$z.defModule("entries/_forums2_show",{initialize:function(b){var a=this;a.zd_label_answered=$j("div.frame > div.entry span.zd_label.answered");$j("div#history.frame > div.item").each(function(d,e){var c=$j(e).attr("data-post_id");if(b["is_moderator?"]===true){$j(e).find("div.user_formatted span.label_theanswer").click(a.set_the_answer_toggle_option(c));}});$j("a[property='is_locked']").click(function(c){$j("div.commenting-controls div.control").toggle();});},set_the_answer_toggle_option:function(b){var a=this;return(function(e){var d=$j(this);d.toggleClass("answered").addClass("ajax");var c=a.set_answered_label(d.hasClass("answered"));$j.post(d.attr("data-update_answer_path"),{is_answer:d.hasClass("answered")},function(){$j.ajax({url:d.attr("data-is_answered_path"),dataType:"json",type:"GET",success:c,complete:function(){d.removeClass("ajax");}});});});},set_answered_label:function(b){var a=this;if(b===true){a.zd_label_answered.addClass("selected");}else{return function(c){a.zd_label_answered.toggleClass("selected",c);};}this.zd_label_answered.toggleClass("selected",b);},set_moderator_toggle_option_for:function(b,a){$(b+"_option").children[0].className=(a?"selected":"deselected");$(b+"_option").children[0].className=(a?"deselected":"selected");},set_moderator_idea_label:function(a){$("flag_option").children[0].className=(a==1?"selected":"deselected");$("flag_option").children[1].className=(a==200?"selected":"deselected");$("flag_option").children[2].className=(a==201?"selected":"deselected");}});$z.defModule("entries/_sidebar_moderator",{initialize:function(b){var a=this;a.moderatorBox=$j("#moderator_box");a.actionDiv=$j("#contentcolumn > div.content > div.action");a.adminLabels=$j("#moderator_box > p.labels");a.zdLabels=$j("div.entry");a.setModeratorToggleOptionFor();a.renderModeratorIdeaLabelFor();},setModeratorToggleOptionFor:function(){var a=this;a.moderatorBox.find("ul.actions > li > a.mod_option").click(a.selectToggle());},renderModeratorIdeaLabelFor:function(){var a=this;a.moderatorBox.find("p.labels > a").click(a.selectToggle());},selectToggle:function(){var b=this;var a={url:$j(this).attr("data-deselected_entry_path"),data:{authenticity_token:Zendesk.currentUser.authenticityToken},dataType:"json",type:"put"};var c=function(e,d){return function(){b.updatePage(e,d);};};return function(d){if($j(this).hasClass("selected")){$j(this).removeClass("selected");a.success=c("deselected",$j(this).attr("property"));a.url=$j(this).attr("data-deselected_entry_path");}else{$j(this).addClass("selected");a.success=c("selected",$j(this).attr("property"));a.url=$j(this).attr("data-selected_entry_path");}$j.ajax(a);};},updatePage:function(c,b){var a=this;switch(b){case"planned":if(c==="selected"){a.adminLabels.find("a.topic_label_done").removeClass("selected");a.adminLabels.find("a.topic_label_not_planned").removeClass("selected");a.zdLabels.find("span.done").removeClass("selected");a.zdLabels.find("span.not_planned").removeClass("selected");a.zdLabels.find("span.planned").addClass("selected");}else{a.adminLabels.find("a.topic_label_planned").removeClass("selected");a.zdLabels.find("span.planned").removeClass("selected");a.zdLabels.find("span.planned").removeClass("selected");}break;case"done":if(c==="selected"){a.adminLabels.find("a.topic_label_planned").removeClass("selected");a.adminLabels.find("a.topic_label_not_planned").removeClass("selected");a.zdLabels.find("span.planned").removeClass("selected");a.zdLabels.find("span.not_planned").removeClass("selected");a.zdLabels.find("span.done").addClass("selected");}else{a.adminLabels.find("a.topic_label_done").removeClass("selected");a.adminLabels.find("span.done").removeClass("done");a.zdLabels.find("span.done").removeClass("selected");}break;case"not_planned":if(c==="selected"){a.adminLabels.find("a.topic_label_planned").removeClass("selected");a.adminLabels.find("a.topic_label_done").removeClass("selected");a.zdLabels.find("span.planned").removeClass("selected");a.zdLabels.find("span.done").removeClass("selected");a.zdLabels.find("span.not_planned").addClass("selected");}else{a.adminLabels.find("a.topic_label_not_planned").removeClass("selected");a.adminLabels.find("span.not_planned").removeClass("done");a.zdLabels.find("span.not_planned").removeClass("selected");}break;case"answered":if(c==="selected"){a.zdLabels.find("span.answered").addClass("selected");}else{a.zdLabels.find("span.answered").removeClass("selected");}break;}}});$z.defModule("entries/edit",{initialize:function(a){$("entry_title").focus();$j("form#entryform").submit(function(){if(typeof(entryTagField)!="undefined"){entryTagField.beforeFormSubmit();}});}});$z.defModule("entries",{});$z.defModule("entries/index",{initialize:function(){}});$z.defModule("entries/show",{initialize:function(a){if(typeof(currentUser)!=="undefined"){$j("input[name='authenticity_token']").each(function(){$j(this).attr("value",currentUser.authenticityToken);});}$z("forums/index").initialize();},showFormFor:function(a){$j("#view-post-"+a).hide();$j("#edit-post-"+a).show();tinyMCE.execCommand("mceAddControl",false,"post-edit-field-"+a);InputTracking.fixSubmit($("post-edit-form-"+a),"onsubmit");$j("#edit-link-for-"+a).removeAttr("onclick");$j("#edit-link-for-"+a).click(function(){$j("#view-post-"+a).hide();$j("#edit-post-"+a).show();return false;});},hideFormFor:function(a){$j("#edit-post-"+a).hide();$j("#view-post-"+a).show();InputTracking.trackedElements=[];}});Zendesk.NS("Facebook.integration",function(f){function c(i,g){var h=f("#to_colorbox");if(h.length==0){return;}data=h.html();h.html("");f.colorbox({html:data,onComplete:function(){var k=f("#active_facebook_pages .facebook-page").length;var j=f(".add_page").length;f("#available_facebook_pages").parent().addClass("colorbox-facebook");f("#available_facebook_pages").parent().css({height:"100%"});f(".setting").click(function(){if(f(this).hasClass("selected")){f(this).removeClass("selected");}else{f(this).addClass("selected");}});f(".add_page").click(function(){var m=this.id.split("-")[1];f("#pageframe-"+m).fadeOut();i++;var l=e(i,g);var n=b(m);f.colorbox.resize();f.post("/facebook/pages/select",{id:m,settings:n},function(o){f("#fbpages").show();l.html(l.html()+o);d(g);if(i-k==j){f.colorbox.close();}});});},onClosed:function(){f.get("/facebook/pages/close_pages",function(j){});window.location.replace("/facebook/settings#general_settings");}});}f(function(){pages=f("#facebook-page-limit-notify").html();box=f("#to_colorbox").html();if(pages!=null){pages=pages.replace("pages added","");pages=pages.replace(/[\(\)]/g,"").split(/\sof\s/);c(pages[0],pages[1]);}else{if(box!=null){c(0,0);}}});function b(g){var h=f("#settings_"+g);pages=h.find("#enable_wall_posts").hasClass("selected");messages=h.find("#enable_messages").hasClass("selected");activity=h.find("#import_acstivity").hasClass("selected");return[pages,messages,activity];}function e(h,g){if(h<=g){f("#facebook-page-limit-notify").html(I18n.t("txt.facebook_integration.views.colorbox.pages_added",{active_pages:h,page_limit:g}));}var i="#active_facebook_pages";if(h>g){i="#inactive_facebook_pages";f(i).show();}return f(i);}function d(g){var h=f(".facebook_page");f("#no_pages").hide();h.removeClass("nobottom");f(h[g-1]).addClass("nobottom");f(h[h.length-1]).addClass("nobottom");}var a=f("#comment_is_public");a.change(function(){if(a.is(":checked")===true){f("#facebook-controls").show();}else{f("#facebook-controls").hide();}});},jQuery);$z.defModule("feeds/index",{initialize:function(){},renderLatestComment:function(a){$j.ajax({url:"/tickets/"+a+"/events?for=feed&filter=latest",dataType:"html",context:$j("#"+a+"-reply"),success:function(b){$j("#"+a+"-ticket-form").hide();$j("#ticket-form").appendTo($j("#ticket-form-home"));this.replaceWith(b);}});},renderRemainingComments:function(a){this.remoteCall("/tickets/"+a+"/events?for=feed&filter=remaining","li#"+a+"-all");},renderCommentBody:function(a){this.remoteCall("/events/"+a+"?for=feed","span#"+a+"-comment-body");},remoteCall:function(a,b){$j.ajax({url:a,dataType:"html",context:$j(b),success:function(c){this.replaceWith(c);}});},renderTicketForm:function(e,a,d,b,c){$j(".fake-text-area").show();$j("#show-ticket-properties").show();$j("#ticket-properties").hide();$j("#ticket-status-new").prop("disabled",a!="0");$j("#"+e+"-fake-reply").hide();$j("#ticket-form").appendTo($j("#"+e+"-ticket-form"));$j("#ticket_status_id").val(a);$j("#ticket_priority_id").val(d);$j("#ticket_group_id").val(b);$j("#ticket_assignee_id").val("");$j("#comment_value").val("");$j("#comment_is_public").prop("checked",false);updateProperties(c);$j("#"+e+"-ticket-form").show();$j("#ticket-form").show();$j("#comment_value").focus();}});(function(b){function a(c){var d=b("<div/>").css({position:"absolute",left:c.left+"px",top:c.top+"px",width:(c.right-c.left)+"px",height:(c.bottom-c.top)+"px",outline:"red 1px solid"});b("body").append(d);window.setTimeout(function(){d.remove();},1000);}b.fn.bounds=function(d,c){d=d||c;var e={left:Number.POSITIVE_INFINITY,top:Number.POSITIVE_INFINITY,right:Number.NEGATIVE_INFINITY,bottom:Number.NEGATIVE_INFINITY,width:function(){return this.right-this.left;},height:function(){return this.bottom-this.top;},show:function(){a(this);return this;},toString:function(){return JSON.stringify(this);}};this.each(function(f,h){var g=b(h),j=g.offset();if(d){j.right=j.left+b(g).outerWidth(c);j.bottom=j.top+b(g).outerHeight(c);}else{j.right=j.left+b(g).width();j.bottom=j.top+b(g).height();}if(j.left<e.left){e.left=j.left;}if(j.top<e.top){e.top=j.top;}if(j.right>e.right){e.right=j.right;}if(j.bottom>e.bottom){e.bottom=j.bottom;}});return e;};})($j);(function(a){a.fn.filterOrFind=function(b){var c=a(this);return c.find(b).add(c.filter(b));};})($j);(function(){var c={ENTER:13,ESC:27,DOWN:40,UP:38};function h(i,j){return c[j]===i.keyCode;}function f(i){i.stopPropagation();i.preventDefault();return true;}var a={element:function(){return this.form().find("#query");},val:function(){return this.element().val();},form:function(){return $j("#searchform");},searchUrl:function(){return this.form().attr("action");},icon:function(){return this.form().find("#icon");},scopeSelector:function(){return this.form().find("div.search_scope_selector");},setup:function(){var i=this.element();i.keydown(this.onInputKeyDown.bind(this));i.keyup(this.onInputKeyUp.bind(this));i.attr("autocomplete","off");this.addIcon();if(this.searchScopes().length>0){this.addScopeSelector();}if(b.options.focusOnLoad){i.focus();}(function(){a.fixInputLayout();}).delay(0.2);(function(){a.fixInputLayout();}).delay(1);$j(window).resize(function(j){a.fixInputLayout();});},offset:function(){return 5;},addIcon:function(){var i=this.element(),j=$j('<div id="icon" title="Press <ESC> to clear input."/>');i.after(j);j.css({marginLeft:-j.width()+"px",left:-1*this.offset()+"px"}).addClass("clear_icon").hide();j.bind("click",this.resetInput.bind(this));},addScopeSelector:function(){var i=$j('<div class="search_scope_selector">  <span class="scope_text"></span>  <span class="arrow">â–¾</span>  <ul class="dropdown"/></div>');this.icon().after(i);i.attr("tabindex",0).keydown(this.onScopeSelectorKeyDown.bind(this)).keyup(this.onScopeSelectorKeyUp.bind(this)).click(function(j){a.openSearchScopeMenu("true");f(j);}).hover(function(){a.openSearchScopeMenu();},function(){a.closeSearchScopeMenu();}).focus(function(){a.openSearchScopeMenu();a.selectSearchScopeMenuItem(0);}).blur(function(){a.closeSearchScopeMenu();});i.find(".arrow").css({position:"absolute",right:"0px"});i.find("span").hover(function(){a.selectSearchScopeMenuItem(0);});this.populateScopeItems();},populateScopeItems:function(){var l=this.searchUrl(),k=this.searchScopes(),m=k.detect(function(n){return n.url===l;});var i=this.scopeSelector().find(".arrow").width()+3*this.offset(),j=k.inject(0,function(o,n){this.setScope(n);return Math.max(o,this.scopeSelector().find(".scope_text").width());},this);this.scopeSelector().css({width:j+i+"px"});if(!m){return;}this.setScope(m);this.setScopeList(k.without(m));},setScope:function(i){this.scopeSelector().find(".scope_text").text("in "+i.name).data("searchScope",i);},setScopeList:function(i){var j=this.scopeSelectorMenu();this.closeSearchScopeMenu();j.find("li").remove();i.forEach(function(l,k){$j("<li>in "+l.name+"</li>").appendTo(j).data("searchScope",i[k]).click(function(m){a.changeScope($j(this).data("searchScope"),true);j.hide();f(m);}).hover(function(){a.selectSearchScopeMenuItem(k+1);});});},scopeSelectorMenu:function(){return this.scopeSelector().find(".dropdown");},scopeSelectorMenuItems:function(){return this.scopeSelector().find(".scope_text, li");},hasSelectedSearchScopeMenuItem:function(){return this.getSelectedSearchScopeMenuItem().length>0;},getSelectedSearchScopeMenuItem:function(){return this.scopeSelectorMenuItems().filter(".selected");},openSearchScopeMenu:function(){this.scopeSelectorMenu().show();},closeSearchScopeMenu:function(){this.scopeSelectorMenu().hide();this.deselectAllSearchScopeMenuItems();},selectSearchScopeMenuItem:function(i){this.deselectAllSearchScopeMenuItems();var j=this.scopeSelectorMenuItems();i=Math.abs(i)%j.length;this.selectSearchScopeElement($j(j.get(i)));},selectSearchScopeElement:function(i){if(i.hasClass("scope_text")){i=i.add(i.parent());}i.addClass("selected");},selectNextSearchScopeMenuItem:function(j){var i=this.scopeSelectorMenuItems().index(this.getSelectedSearchScopeMenuItem());this.selectSearchScopeMenuItem(i+(j?1:-1));},deselectAllSearchScopeMenuItems:function(){this.form().find(".selected").removeClass("selected");},getSelectedSearchScope:function(){return this.getSelectedSearchScopeMenuItem().data("searchScope");},searchScopes:function(){return b.options.searchScopes;},changeScope:function(j,i){this.form().attr("action",j.url);this.populateScopeItems();this.fixInputLayout();this.element().focus();d.searchNow();},fixInputLayout:function(){var l=this.icon(),j=this.element(),m=this.form(),k=m.find("#buttonsubmit"),i=this.scopeSelector();if(i.length>0){this.layoutScopeSelector(i,j,l);}this.layoutInput(j,m,k);},layoutScopeSelector:function(j,k,m){var l=j.width();j.css({marginLeft:-1*l+"px",marginRight:-3*this.offset()+"px",left:-3*this.offset()+"px",paddingLeft:2*this.offset()+"px"});j.find(".arrow").css({marginRight:this.offset()+"px"});var i=j.bounds(true).width(),o=j.find(".dropdown");o.css({left:"0px",width:i+"px"});m.css({left:-1*(l+m.width()+this.offset())+"px"});var n=i+m.width()+2*this.offset();k.css({paddingRight:n+"px"});},layoutInput:function(k,n,l){k.css({width:"20px"});var p=k.add(l).bounds(true),j=n.bounds(true),o=n.parent().bounds(true),m=j.left-o.left,i=j.width()-p.width()-m;k.css({width:k.width()+i+"px"});},updateIcon:function(){if(!d.searchInitiated){this.toggleClearIconDisplay();return;}if(this.val().length>0){this.signalLoading();}else{this.stopSignalLoading();}},toggleClearIconDisplay:function(){var i=this.icon();i.removeClass("loading_icon");if(this.val()===""){i.removeClass("clear_icon");i.hide();}else{i.addClass("clear_icon");i.show();}},resetInput:function(i){this.element().val("");this.updateIcon();e.removeIncrementalSearchResults();},signalLoading:function(){a.icon().show().removeClass("clear_icon").addClass("loading_icon");},stopSignalLoading:function(){a.icon().addClass("clear_icon").removeClass("loading_icon");this.toggleClearIconDisplay();},onInputKeyDown:function(i){this.prevVal=this.val();if(!h(i,"ESC")){return undefined;}var j=this.element();if(this.val()===""){j.blur();}else{this.resetInput();if($j.browser.msie){window.setTimeout((function(){j.focus();}).bind(this),400);}}return f(i);},onInputKeyUp:function(i){if(h(i,"ENTER")){var k=e.selectedResultItem();if(k&&this.hasSelectedSearchScopeMenuItem()){e.visitResultItem(k);return f(i);}}if(h(i,"ESC")){return f(i);}if(!h(i,"UP")&&!h(i,"DOWN")){var j=this;_.delay(function(){if(j.prevVal===j.val()&&j.prevVal!==""){return;}d.initSearchRequest();});}return undefined;},onScopeSelectorKeyUp:function(i){if(h(i,"ESC")){this.element().focus(0);return f(i);}return undefined;},onScopeSelectorKeyDown:function(i){if(h(i,"ENTER")){this.changeScope(this.getSelectedSearchScope());this.closeSearchScopeMenu();return f(i);}if(h(i,"DOWN")||h(i,"UP")){this.selectNextSearchScopeMenuItem(h(i,"DOWN"));return f(i);}return undefined;}};var e={container:function(){return $j("#incremental_search");},notFoundElement:function(){return $j("#not_found_hint");},output:function(){return $j("#incremental_search_result");},hasResults:function(i){return i.find(".item-info").length>0;},resultItems:function(){return this.output().find(".item");},result_snippets:function(){return this.output().find(".item_search_snippet");},selectedResultItem:function(){return this.resultItems()[this.selectedResultItem_idx];},result_titles:function(i){return i.find("a[title]");},resultDataSelector:".item, #show_more",loadMoreScriptSelector:".search_results_data",resultSelector:function(){return this.resultDataSelector+". "+this.loadMoreScriptSelector;},notFoundText:"We could not find any results for your search.",setup:function(){this.showExistingResultsIfPresent();},visitResultItem:function(j,i){if(j){b.visitURL($j(j).find(".item-info a").attr("href"));}},prepareHtml:function(i,j){g.paginate(i);this.highlight(i,j);this.prepareResultItemsForSelection();},highlight:function(j,k){if(!k){return;}var l=e.result_titles(j),i=e.result_snippets(j);l.removeHighlight();i.removeHighlight();k.split(" ").forEach(function(m){l.highlight(m);i.highlight(m);});},processResult:function(k,j){this.container().show();var l=$j(j);if(!this.hasResults(l)){this.removeIncrementalSearchResults();this.showNotFoundHint();return;}this.notFoundElement().hide();this.output().show();var i=this.findElementsToAnimate(this.output(),l);i.slideDown.hide();if(i.slideUp.length>0){i.slideUp.slideUp("fast",this.embedNew.bind(this).curry(i,k));}else{this.embedNew(i,k);}},embedNew:function(j,l){var i=this.output();this.container().show();if(j.replaceOld.length===0){i.append(j.replaceNew);}else{j.replaceOld.replaceWith(j.replaceNew);}j.slideUp.remove();var m=i.find(".item").last(),k=i.find(":first-child").first();if(m.length>0){j.slideDown.insertAfter(m);}else{if(k.length>0){j.slideDown.insertBefore(k);}else{j.slideDown.appendTo(i);}}j.slideDown.slideDown("fast",this.prepareHtml.bind(this).curry(i,l));this.prepareHtml(i,l);},removeIncrementalSearchResults:function(){var i=this.output();i.hide("fast","swing",function(){i.html("");});},showExistingResultsIfPresent:function(){var i=$j(".hidden_incremental_search_results");if(i.length===0){return;}if(!this.hasResults(i)){this.showNotFoundHint();}var j=this.findElementsToAnimate(null,i,true);this.embedNew(j,this.getQuery());a.updateIcon();},showNotFoundHint:function(){var i=this.notFoundElement();if(i.length===0){i=$j('<div id="not_found_hint"><h2>'+this.notFoundText+"</h2></div>");this.container().find("#incremental_search_result").after(i);}return i.show();},getQuery:function(){return a.element().val();},parseResults:function(j){var i=$j(j);return{items:i.filterOrFind(".item"),moreButton:i.filterOrFind("#show_more"),paginatorScript:i.filterOrFind(".search_results_data")};},findElementsToAnimate:function(k,m,j){var i=this.parseResults(k),l=this.parseResults(m);if(j){return{remove:i.paginatorScript,slideUp:$j(),slideDown:$j(),replaceOld:i.items.add(i.moreButton),replaceNew:l.paginatorScript.add(l.items).add(l.moreButton)};}return{remove:i.paginatorScript,slideUp:i.items.slice(l.items.length),slideDown:l.items.slice(i.items.length),replaceOld:i.items.slice(0,l.items.length).add(i.moreButton),replaceNew:l.paginatorScript.add(l.items.slice(0,i.items.length)).add(l.moreButton)};},prepareResultItemsForSelection:function(){this.selectedResultItem_idx=-1;var i=this,j=this.resultItems();j.bind("mousemove",function(){var k=j.index(this);if(k!==-1){i.selectResultItem(k);}});j.bind("click",function(){i.visitResultItem(this,true);});},changeSelection:function(i){this.selectResultItem(this.selectedResultItem_idx+i);},selectResultItem:function(i){if(g.is_loading_more){return;}var m=this.resultItems(),k=m.length;m.removeClass("selected");if(k===0){return;}var l=i===k;if(l&&g.next_page()){g.load_next_page_select_idx=i;g.loadNextPage();return;}if(i<0){i=k-1;}else{if(i>=k){i=0;}}var j=m.get(i);if(j.scrollIntoViewIfNeeded){j.scrollIntoViewIfNeeded();}$j(j).addClass("selected");this.selectedResultItem_idx=i;}};var g={itemsPerPage:function(){return b.options.perPage;},paginator:function(){return e.output().data("resultsPaginator");},setup:function(){var i=Zendesk.ResultsPaginator.prototype;i.onContentRetrievedCallback=function(k,j){this.slide_in_paginator_content(k,j);this.on_paginator_page_load(k);e.prepareResultItemsForSelection();this.is_loading_more=false;if(this.load_next_page_select_idx){e.selectResultItem(this.load_next_page_select_idx);delete this.load_next_page_select_idx;}}.bind(this);},reset_paginator:function(){e.output().data("resultsPaginator",null);},paginate:function(i){this.reset_paginator();i.paginateResults();var j=this.paginator();if(j&&j.nextPage===2){j.nextPage=Zendesk.ResultsPaginator.parseNextPageFrom(i);}},slide_in_paginator_content:function(j,i){i=$j(i).hide();j.$container.append(i);i.each(function(k){$j(this).slideDown("fast");});},on_paginator_page_load:function(j){var i=d.last_query;if(i){e.highlight(j.$container,i);}},next_page:function(){var i=this.paginator();return i&&i.nextPage;},loadNextPage:function(){var i=this.paginator();if(i&&i.nextPage){this.is_loading_more=true;i.loadMore(true);}}};var d={searchDelay:370,initSearchRequest:function(){this.searchInitiated=true;a.updateIcon();if(!this.searchLater){this.searchLater=_.debounce(this.searchNow.bind(this),this.searchDelay);}this.searchLater();},searchNow:function(){var i=this.createSearchQuery(a.val());if(i&&i.length>0){this.searchInitiated=true;this.doIncrementalSearch(a.searchUrl(),i);}else{this.searchInitiated=false;e.removeIncrementalSearchResults();}a.updateIcon();},createSearchQuery:function(j){var i="[\\.,\\+]";return j.replace(new RegExp("^"+i+"|"+i+"$"),"").replace(new RegExp(i)," ").replace(/\s+/," ");},processResult:function(j,i){j=j||this.last_query;this.last_query=j;this.searchInitiated=false;a.updateIcon();return e.processResult(j,i);},doIncrementalSearch:function(i,j){$j.ajax({url:i,data:{query:j,incremental:true,format:"html",page:1,per_page:g.itemsPerPage(),xhr:true}}).done(this.processResult.bind(this).curry(j));}};var b;$z.defModule("forums/_search",{options:{perPage:5,focusOnLoad:false,searchScopes:[],tracking:true},searchController:function(){return d;},inputController:function(){return a;},paginatorController:function(){return g;},resultController:function(){return e;},initialize:function(i){b=this;if(i&&i.per_page){this.options.perPage=i.per_page;}if(i&&i.focus){this.options.focusOnLoad=i.focus;}if(i&&i.search_scopes){this.options.searchScopes=i.search_scopes;if(i.model_name){this.options.searchScopes.push({name:i.model_name,url:a.searchUrl()});}}if(i&&i.tracking!==undefined){this.options.tracking=i.tracking;}if(e.container().length===0){return;}$j(function(){g.setup();a.setup();e.setup();if(b.options.tracking){b.setupTracking();}});$j(window).bind("keydown",this.onWindowKeyDown.bind(this));},visitURL:function(i){document.location=i;},trackingModule:"Incremental Forum Search",track:function(i){Zendesk.Instrumentation.ToTango.track(i,this.trackingModule);},setupTracking:function(){var k=Zendesk.Instrumentation;k.on(d,"searchNow","search activated",this.trackingModule);k.on(e,"visitResultItem",function(n,i){return"topic selected by "+(i?"mouse":"key:enter");},this.trackingModule);k.on(a,"resetInput",function(i){return"clear search by "+(i?"mouse":"key:esc");},this.trackingModule);var m=a.form(),l="search submitted by mouse",j="search submitted by key:enter";m.addClass("tracked").data("tracking-activity",l).data("tracking-module",this.trackingModule).instrumentTracking().keydown(function(i){if(h(i,"ENTER")){a.form().data("tracking-activity",j);}}).keyup(function(i){if(h(i,"ENTER")){a.form().data("tracking-activity",l);}});$j(".deflect.tickets").add(".deflect.ideas").add(".deflect.questions").addClass("tracked").data("tracking-module",this.trackingModule).instrumentTracking();$j(".deflect.tickets").data("tracking-activity","'Get in touch' selected");$j(".deflect.ideas").data("tracking-activity","'Submit an idea' selected");$j(".deflect.questions").data("tracking-activity","'Ask a question' selected");k.on(a,"openSearchScopeMenu",function(i){return"scope selector: opened by "+(i?"mouse":"key:tab");},this.trackingModule);k.on(a,"changeScope",function(n,i){return"scope selector: new scope selected by "+(i?"mouse":"key:tab");},this.trackingModule);k.on(Zendesk.ResultsPaginator.prototype,"loadMore",function(i){return"see more button selected by "+(i?"key":"mouse");},this.trackingModule);k.on(e,"embedNew",function(i){var n=i.replaceNew.filterOrFind(".show_more_bar").add(i.slideDown.filterOrFind(".show_more_bar")).length>0;return n?"see more button visible":null;},this.trackingModule);if(this.options.searchScopes&&this.options.searchScopes.length>0){this.track("scope selector visible");}},onWindowKeyDown:function(i){if(a.hasSelectedSearchScopeMenuItem()){return undefined;}if(h(i,"UP")||h(i,"DOWN")){e.changeSelection(h(i,"DOWN")?1:-1);return f(i);}if(h(i,"ENTER")){var j=e.selectedResultItem();if(j){e.visitResultItem(j);return f(i);}}return undefined;}});})();$z.defModule("forums/form",{initialize:function(a){$j("input#forum_visibility_restriction_id_1, input#forum_visibility_restriction_id_2").click(function(){$j("#forum_is_locked_false").prop("disabled",false);$j(".forum-language-selector").show("slow");});$j("input#forum_visibility_restriction_id_3").click(function(){$j("#forum_is_locked_false").prop("disabled",true);$j("#forum_is_locked_true").prop("checked",true);$j(".forum-language-selector").hide();$j("#forum_translation_locale_id").val("");});$j("form.edit_forum").submit(function(){if(typeof(forumTagField)!="undefined"){forumTagField.beforeFormSubmit();}});}});(function(){function e(f){if(f!="stats"){$j(".sparkline").removeClass("active");}$j(".forum-nav a.active").removeClass("active");if(f){$j("#forum_nav_"+f).addClass("active");}else{$j(".forum-nav a:first").addClass("active");}}function d(){if($j(".category-header").attr("id")){$j(".category-header").map(function(f,g){categoryTopRightEdit($j(g).attr("id"));makeCategorizedForumsDraggable($j(g).parent().find(".category").attr("id"));});$j(".buttons-right .reorder").show();addCategoryReordering();categoryDescription();$j(".category-header").show();}else{return false;}}function c(f){$j(".buttons-right .reorder").hide();$j("#detailed_stats_graph_container").hide();$j("#content_entries .frame:first").html('<div id="topic_search_loading" class="loading"></div>');$j.ajax({url:$j("#forum_nav_"+f).attr("url"),data:{xhr:true}}).done(function(g){$j("#content_entries .frame:first").html(g);$j("#search-result").paginateResults();$j(".forum_tabs").trigger("events-loaded.entries.zendesk");if(f=="overview"){d();}});e(f);}function b(){$j("#comments_section").show();e("comments");}var a={initialize:function(f){f=f||{};f.scopeSammyTo=f.scopeSammyTo||".forum_tabs";$j(".category li span").truncateViaFade();this.sammy_app=$j.sammy(f.scopeSammyTo,function(){this.get("#stats/:statName",function(){$j(".buttons-right .reorder").hide();$j("#comments_section").hide();var g=this.params.statName;Zendesk.Stats.ForumUI.showDetailGraph(".sparkline#"+g);e("stats");});this.get("#stats",function(){$j(".buttons-right .reorder").hide();$j("#comments_section").hide();Zendesk.Stats.ForumUI.showDetailGraph(".sparkline:first");e("stats");});this.get("#overview",function(){c("overview");});this.get("#recent",function(){c("recent");});this.get("#popular",function(){c("popular");});this.get("#unanswered",function(){c("unanswered");});this.get("#answered",function(){c("answered");});this.get("#planned",function(){c("planned");});this.get("#not_planned",function(){c("not_planned");});this.get("#done",function(){c("done");});this.get("#comments",function(){b();});this.get("",function(){$j("#detailed_stats_graph_container").hide();var g=$j(".forum-nav a:first").attr("href");if(g){if(g=="#comments"){b();return false;}e(g.replace("#",""));d();$j(".forum_tabs").trigger("events-loaded.entries.zendesk");}});});Zendesk.Stats.ForumUI.setup(this.sammy_app);this.sammy_app.disable_push_state=true;this.sammy_app.run();}};$z.defModule("forums/index",a);$z.defModule("forums/show",a);$z.defModule("forums/forums1_index",a);$z.defModule("forums/forums2_index",a);}());function InvitationForm(a){this.container=$j(a);this.emails=[];this.fieldColor=this.field().css("color");this.fieldText=this.field().val();this.resetField();this.registerEvents();this.invite();}InvitationForm.prototype={container:null,emails:null,fieldText:null,fieldColor:null,registerEvents:function(){var a=this;a.form().submit(function(){$j.ajax({data:$j(this).serialize(),type:$j(this).attr("method"),url:$j(this).attr("action"),beforeSend:function(b){a.inviting();},success:function(b){a.add(b);a.invited();},error:function(b,d,c){a.error().html(b.responseText);a.error().show();a.enableButton();}});return false;});a.link().click(function(){a.invite();return false;});a.field().click(function(){if(a.field().val()===a.fieldText){a.field().css("color",a.fieldColor);a.field().val("");}});a.field().blur(function(){if($j.trim(a.field().val()).length===0){a.resetField();}});},add:function(b){var a=this;$j.each(b.split(", "),function(d,c){if(!a.emails.include(c)){a.emails.push(c);}});},present:function(){return this.emails.join(", ");},invite:function(){this.enableButton();this.form().show();this.link().hide();this.notice().hide();this.error().hide();},inviting:function(){this.button().val("Sending invitation...");this.button().prop("disabled",true);},invited:function(){this._trackInvitation(this.emails);this.notice().html("You have invited "+this.present()+" to your help desk.");this.form().hide();this.resetField();this.link().show();this.notice().show();this.error().hide();},enableButton:function(){this.button().val("Invite!");this.button().prop("disabled",false);},resetField:function(){this.field().val(this.fieldText);this.field().css("color","gray");},form:function(){return this.container.find("form");},link:function(){return this.container.find("a");},notice:function(){return this.container.find("div#notice");},error:function(){return this.container.find("div#error");},field:function(){return this.container.find("textarea#email");},button:function(){return this.container.find("input[type='submit']");},_trackInvitation:function(b){var a=this.form();_(b).each(function(c){a.trackEvent();});}};Zendesk.NS("GettingStartedLocalized",function(e){var c="Admin GS Localized";function d(){e("#getting_started_localized").attr("data-tracking-module",c);a("Load");}function a(f){Zendesk.Instrumentation.ToTango.track(f,c);}function b(){var f=e("#contact_us");if(!f.exists()){return;}Zenbox.init({dropboxID:f.data("feedback-tab-id"),url:"https://support.zendesk.com",tabID:"support",tabColor:"black",tabPosition:"Left",hide_tab:true});f.find("a").click(function(){Zenbox.show();a("Contact us link");});}e(document).ready(function(){if(!e("#getting_started_localized").exists()){return;}d();b();});},this.jQuery);function PhotoForm(){this.container=$j("#customize_photo");this.registerEvents();if(this.image().attr("src")===this.defaultImage){this.showForm();}else{this.showLinks();}this.error().hide();}PhotoForm.prototype={defaultImage:"/images/frame_user.png",container:null,registerEvents:function(){var a=this;a.field().change(function(){if($j.trim(a.field().val()).length!==0){a.processing(I18n.t("txt.admin.public.javascript.views.getting_started.uploading_image"));a.form().submit();}return false;});a.frame().load(function(){var c=$j("#upload_frame").contents().find("body").text();if($j.trim(c).length!==0){try{var b=$j.parseJSON(c);a.setPhoto(b.public_filename,b.id);a.form().trackEvent();a.error().hide();}catch(d){a.error().html(I18n.t("txt.admin.public.javascript.views.getting_started.error_while_uploading_image"));a.error().show();}a.showLinks();}});a.changeLink().click(function(){a.showForm();return false;});a.deleteLink().click(function(){if(!a.photoId()){a.error().html(I18n.t("txt.admin.public.javascript.views.getting_started.sorry_gravatars_cannot_be_deleted"));a.error().show();return false;}$j.ajax({type:"delete",url:"/photos/"+a.photoId()+"?format=js",beforeSend:function(b){a.processing(I18n.t("txt.admin.public.javascript.views.getting_started.deleting_image"));},success:function(b){a.setPhoto(a.defaultImage,"");a.showForm();a.error().hide();},error:function(b,d,c){a.error().html("There was an error deleting the image. Please try again or contact our support team.");a.error().show();a.showLinks();}});return false;});},showForm:function(){this.processingIndicator().hide();this.form().show();this.modifyLinks().hide();},processing:function(a){this.processingMessage().html(a);this.processingIndicator().show();this.form().hide();this.modifyLinks().hide();},showLinks:function(){this.field().val("");this.processingIndicator().hide();this.form().hide();this.modifyLinks().show();},photoId:function(){return this.image().attr("data-id");},setPhoto:function(a,b){this.image().attr("data-id",b);this.image().attr("src",a);},processingIndicator:function(){return this.container.find("div#processing_indicator");},processingMessage:function(){return this.container.find("span#processing_message");},modifyLinks:function(){return this.container.find("div#modify_photo");},changeLink:function(){return this.container.find("a#change_photo");},deleteLink:function(){return this.container.find("a#delete_photo");},error:function(){return this.container.find("div#error");},frame:function(){return this.container.find("#upload_frame");},image:function(){return this.container.find("img#user_photo");},field:function(){return this.container.find("input[type='file']");},form:function(){return this.container.find("form");}};Zendesk.NS("GettingStarted",function(v){var o=v("#invite_block");var b=v("#test_block");var c=v("#customize_block");var q=v(".block");var e=null;var p="Admin GS";function t(w){w.removeClass("closed").removeClass("shrunk").addClass("opened");q.not(w).addClass("closed").addClass("shrunk").removeClass("opened");}function h(w){w.addClass("done");}function s(){q.addClass("closed").removeClass("shrunk").removeClass("opened");}function u(){v(".opened .block_button").live("click",function(){h(v(this).closest(".block"));s();r();});v(".closed .block_button, .shrunk .block_button").live("click",function(){t(v(this).closest(".block"));r();});v(".block_button").mouseover(function(){v(this).closest(".block").addClass("highlighted");}).mouseout(function(){v(this).closest(".block").removeClass("highlighted");});v(".close_block_link").click(function(){s();r();return false;});}function l(){o.find("form").submit(function(){var x=v(this).find("input[type='submit']");var y=v(this).find("input[type='text']");var w=v("#invitation_result");v.each(y.val().split(/[\s,;]+/),function(A,z){j("Invite agent");});v.ajax({data:v(this).serialize(),type:v(this).attr("method"),url:v(this).attr("action"),beforeSend:function(z){x.prop("disabled",true).val("Inviting...");},success:function(z){w.html("Invite sent successfully!");y.val("");},error:function(z,B,A){w.html(z.responseText);},complete:function(){x.prop("disabled",false).val("Invite!");}});return false;});}function g(){b.find("form").submit(function(){var x=v(this).find("input[type='submit']");var w=v("#test_ticket_result");v.ajax({data:v(this).serialize(),type:v(this).attr("method"),url:v(this).attr("action"),beforeSend:function(y){x.prop("disabled",true).val("Sending Test Email...");},success:function(y){x.hide();w.html("Test email successfully sent!");},error:function(y,A,z){x.prop("disabled",false).val("Error. Try again...");}});return false;});}function i(){v("#test_macro_form").submit(function(){var w=v(this).find("input[type='submit']");v.ajax({data:v(this).serialize(),type:v(this).attr("method"),url:v(this).attr("action"),beforeSend:function(x){w.prop("disabled",true).val("Creating ticket and macro...");},success:function(x){w.val("Ticket and macro created");},error:function(x,z,y){w.prop("disabled",false).val("Error. Try again...");}});return false;});}function d(){v(".setup_item.closed").mouseover(function(){v(this).addClass("highlighted");}).mouseout(function(){v(this).removeClass("highlighted");});v(".setup_item.closed").click(function(){v(this).removeClass("closed").addClass("opened");v(this).find(".setup_item_content").slideDown();});v(".setup_item .close_setup_item").click(function(){v(this).siblings(".setup_item_content").hide();v(this).closest(".setup_item").removeClass("opened").addClass("closed");return false;});v("#macros_setup").trigger("click");}function f(){v(".show_unsolved_tickets").click(function(){return m("tab_views",null,"tickets_arrow");});v(".show_forums").click(function(){return m("tab_forums",null,"forums_arrow");});v(".show_customization").click(function(){return m("tab_settings","settings_account","customization_arrow");});v(".show_people_agents").click(function(){return m("tab_manage","manage_people","people_agents_arrow");});v(".show_people_groups").click(function(){return m("tab_manage","manage_people","people_groups_arrow");});v(".show_ticket_fields").click(function(){return m("tab_manage","ticket_fields","ticket_fields_arrow");});v(".show_triggers").click(function(){return m("tab_manage","triggers","triggers_arrow");});v(".show_macros").click(function(){return m("tab_manage","macros","macros_arrow");});v(".show_automations").click(function(){return m("tab_manage","automations","automations_arrow");});}function m(x,w,y){v("li.tab_manage, li.tab_settings").removeClass("over");v(".show_me_arrow").hide();clearTimeout(e);v("html,body").animate({scrollTop:0},"slow");x=v("li."+x);y=v("#"+y);var z="0 2";if(w){w=v("li[data-menu-item-name="+w+"]");x.addClass("over");z="-192 -33";}y.show();y.position({my:"top",at:"bottom",of:w||x,offset:z});e=setTimeout(function(){y.hide();x.removeClass("over");},5000);return false;}function k(){v("#getting_started_revamp").attr("data-tracking-module",p);v(".block_button").click(function(){var x=v(this).closest(".block");var w=x.attr("data-tracking-activity");if(x.hasClass("opened")){j(w+": Done");}else{if(x.hasClass("done")){j(w+": Revisit");}else{j(w+": Start");}}});j("Load");}function j(w){Zendesk.Instrumentation.ToTango.track(w,p);}function r(){q.each(function(){Cookie.set(n(v(this)),v(this).attr("class"),30);});}function a(){q.each(function(){var x=v(this);var w=Cookie.get(n(x));if(w&&w.include("done")){h(x);}if(w&&w.include("opened")){t(x);}});}function n(w){return"_zendesk_getting_started_"+w.prop("id");}v(document).ready(function(){if(!v("#getting_started_revamp").exists()){return;}u();l();g();d();i();f();a();k();});},this.jQuery);$z.defModule("getting_started/show",{initialize:function(a){if(!$j("#getting_started").exists()){return;}this.setInstrumentationModule();new InvitationForm("div#invite_agents");new InvitationForm("div#invite_testers");new SignatureForm();new PhotoForm();this.attachModalVideo();this.trackPageView();$j("#getting_started .adventure_set a, #getting_started .getting-started-steps a").instrumentTracking();},attachModalVideo:function(){$j(".aside_fixed a").instrumentTracking().click(function(a){a.preventDefault();$j.colorbox({inline:true,href:"#modal_content"});});},setInstrumentationModule:function(){var a;if(currentUser.isAdmin){a="Admin Getting Started";}else{a="Agent Getting Started";}$j("#getting_started").attr("data-tracking-module",a);this.instrumentationModule=a;},trackPageView:function(){Zendesk.Instrumentation.ToTango.track("Load",this.instrumentationModule);}});function SignatureForm(){this.container=$j("#customize_signature");this.registerEvents();this.send();}SignatureForm.prototype={container:null,registerEvents:function(){var a=this;a.form().submit(function(){$j.ajax({data:$j(this).serialize()+"&id="+Zendesk.currentUser.id+"&authenticity_token="+encodeURIComponent(Zendesk.currentUser.authenticityToken),type:"PUT",url:$j(this).attr("action")+"?format=js",beforeSend:function(b){a.sending();},success:function(c){var b=$j.parseJSON(c);a.text().html(b.value);a.sent();a.form().trackEvent();},error:function(b,d,c){a.error().html(b.responseText);a.error().show();a.enableButton();}});return false;});a.link().click(function(){a.send();return false;});},send:function(){this.enableButton();this.form().show();this.link().hide();this.notice().hide();this.error().hide();},sending:function(){this.button().val(I18n.t("txt.admin.public.javascript.views.getting_started.saving_signature"));this.button().prop("disabled",true);},sent:function(){this.notice().html(I18n.t("txt.admin.public.javascript.views.getting_started.signature_updated"));this.form().hide();this.link().show();this.notice().show();this.error().hide();},enableButton:function(){this.button().val(I18n.t("txt.admin.public.javascript.views.getting_started.save_signature"));this.button().prop("disabled",false);},form:function(){return this.container.find("form");},link:function(){return this.container.find("a");},notice:function(){return this.container.find("div#notice");},error:function(){return this.container.find("div#error");},text:function(){return this.form().find("textarea");},button:function(){return this.form().find("input[type='submit']");}};var HeaderRenderer={};HeaderRenderer.hasRenderedTopRight=false;HeaderRenderer.renderTopRight=function(){var d=$j("#top-right");if(!d||HeaderRenderer.hasRenderedTopRight){return;}HeaderRenderer.hasRenderedTopRight=true;var c=[];if(!currentUser.isAnonymous){var b=$j("<span/>",{id:"top-right-name",html:currentUser.name});if(currentAccount.isSandbox){b.append(" (SANDBOX)");}c.push(b);}if((currentUser.isAdmin||(currentAccount.isLotusVisibleToAgents&&currentUser.isAgent))&&currentAccount.hasFeature("lotus")){c.push('<span style="background-color: #62CFFC; padding: 2px 3px; font-size: 8px; font-weight: bold; color: white; text-transform: uppercase; -webkit-border-radius: 3px; -moz-border-radius: 3px; border-radius: 3px; margin: 0 3px;">beta</span><a href="/lotus">Try Lotus</a>');}if(currentUser.isAgent&&currentAccount.lastTrialDay){c.push(I18n.t("txt.admin.public.javascript.header_renderer.days_left_in_trial_label_with_params",{count:currentAccount.daysLeftInTrial}));jQuery("#expires_badge .count").text(currentAccount.daysLeftInTrial);}if(currentAccount.showUserProfile&&!currentUser.isAnonymous){c.push($j("<a/>",{href:"/users/"+currentUser.id,text:I18n.t("txt.layout.profile"),"data-tracking-module":"Top Menu","data-tracking-activity":"Show Profile"}).instrumentTracking());}else{if(currentAccount.showChangePassword&&!currentUser.isAnonymous){c.push($j("<a/>",{href:"/password",text:I18n.t("txt.layout.change_pwd")}));}}if(currentUser.isAdmin){c.push('<a href="http://support.zendesk.com">'+I18n.t("txt.admin.public.javascript.header_renderer.help")+"</a>");}if(currentUser.assumed){c.push('<a href="/users/revert">'+I18n.t("txt.javascript.views.agent_console.revert_identity")+"</a>");}if(currentUser.isAnonymous){c.push($j("<a/>",{href:"/login",text:I18n.t("txt.layout.login")}));if(currentAccount.isOpen&&!currentAccount.hasRemoteAuthentication){c.push($j("<a/>",{href:"/registration",text:I18n.t("txt.layout.signup")}));}}else{var a=currentAccount.secureUrlPrefix+"/access/logout";if(currentAccount.urlPrefix!=currentAccount.secureUrlPrefix){a=a+"?return_to="+escape(currentAccount.urlPrefix+"/access/logout");}c.push($j("<a/>",{href:a,text:I18n.t("txt.layout.logout")}));}if(c.length>0){d.append(c.shift());c.each(function(e){d.append(" | ");d.append(e);});}};HeaderRenderer.hasUpdatedTabs=false;HeaderRenderer.updateTabs=function(){var c=$j("#top-menu > ul#green").first();if(!c||HeaderRenderer.hasUpdatedTabs){return;}HeaderRenderer.hasUpdatedTabs=true;if(currentUser.isAnonymous){if(!currentAccount.isOpen){c.find("> li:not(.right, .tab_home)").remove();}else{if(!currentAccount.hasRemoteAuthentication&&!currentUser.hasEmail){c.find("> li.tab_new a").attr("href","/anonymous_requests/new");}}}if(currentUser.accessibleForums){var e=$j('<li class="main tab_forums"/>');e.append($j("<a/>",{"class":"tab",href:"/forums",text:currentAccount.forumsTitle}));c.find("> li.tab_home").after(e);}if(currentUser.isEndUser){if(currentUser.canViewOrganization){var d=c.find("> li:not(.right)").last();var b=$j('<li class="main tab_organization"/>');b.append($j("<a/>",{"class":"tab",href:"/organization_requests",text:currentUser.organization.name.truncate(35)}));d.after(b);}}c.find("> li.first").removeClass("first");c.find("> li.active").removeClass("active");c.find("> li").first().addClass("first");c.find("> li").addClass("main");var a=c.find("> li.tab_"+Zendesk.tab);a.removeClass("main").addClass("active");a.next().addClass("first");};if(typeof(currentUser)!=="undefined"){HeaderRenderer.renderTopRight();HeaderRenderer.updateTabs();}$z.defModule("home/index",{initialize:function(){if(currentUser.isAgent){$j("#dashboard").ready(function(){$j("#dashboard").show();$j.get("/home/dashboard",function(a){$j("#dashboard").html(a).show();});});}if(currentUser.isAdmin){new IntroductoryTextForm();$z("home/reorder_pinned_entries").initialize();}$z("forums/index").initialize();}});(function(b,c){var a=b.IntroductoryTextForm=function(){this.form=c("#introductory_text .introductory_text_form");this.display=c("#introductory_text .introductory_display_texts");this.editLink=this.display.find(".edit_this");this.cancelLink=this.form.find(".cancel_link");this.setup();};a.prototype={setup:function(){var d=this;this.form.hide();this.editLink.click(function(){d.display.hide();d.form.show();});this.cancelLink.click(function(){d.form.hide();d.display.show();});}};}(window,$j));(function(i,o){var e,b,d,l,q,f;function p(){document.location.href="/home";}function c(){alert("Sorry, there was an error saving your changes.");}function j(){var s=i(this);var r=q.find("ol").sortable("serialize",{key:"ids[]"});if(r=="ids[]="){r="";}else{r=r+"&";}i.ajax({url:s.attr("action"),type:s.attr("method"),data:r+s.serialize(),success:p,error:c});return false;}function m(){l.hide();d.show();q.remove();q=null;}function g(){q.find("a.cancel").click(function(){m();return false;}).end().find("form").submit(j);var r=q.find("ul,ol");r.each(function(){i(this).sortableWithEmptyTarget({emptyTargetText:I18n.t("txt.admin.views.home._reorder_pinned_entries.drag_topics_here_label"),emptyTargetClass:"item sortable",axis:"y",placeholder:"sortable item target",connectWith:r.not(this)});});}function k(r){return !!r.pinned_index;}function n(){if(q){return;}i.getJSON(b.attr("href"),null,function(r){r=o(r);q=i(i.mustache(e,{orderedEntries:r.select(k),unorderedEntries:r.reject(k)})).appendTo(l);f.hide();g();});}function a(){d.hide();l.show();n();}function h(){e=i("#reorder_pinned_entries_template").html();l=i('<div class="frame"></div>').hide().insertAfter(i("#pinned_topics_title"));f=i('<div class="loading">&nbsp;</div>').appendTo(l);b=i("#show_pinned_entries_reordering").click(function(){a();return false;});d=i("#pinned-entries-frame, #entries_pagination").add(b);}$z.defModule("home/reorder_pinned_entries",{initialize:h});}(this.jQuery,this._));jQuery(function(f){var c=f(".home #suggest_form");if(c.length===0){return;}var g=f("#topic_search"),b=f("#topic_search_result"),a=f("#topic_search_loading"),d=f("#show_more_results");function h(j){a.removeClass("loading");g.show();b.html(j);var i=Zendesk.ResultsPaginator.parseNextPageFrom(b);if(i==null){d.hide();if(b.is(":empty")){b.html('<h2 class="empty_suggestion_set">'+I18n.t("txt.entries.list.empty")+"</h2>");}}else{b.paginateResults();}}function e(i){g.hide();a.addClass("loading");b.html("");f.get("/categories/search_for_home_page_box?"+c.serialize(),{format:"html",for_search:1,page:1}).done(h);return false;}c.submit(e);});if(!this.Zendesk){this.Zendesk={};}(function(d,b,a,c){a.Banner={containerSelector:"#banners",container:function(){var f=a.Banner;var e=d(f.containerSelector);if(e.length<=0){b.error("Could not find a banner container. Do you have an "+f.containerSelector+" element?");}else{return f._bindIgnoreEventListenerIfNeeded(e);}},templateSelector:"#banner-item-template",template:function(){var e=a.Banner;if(!e._template){var f=d(e.templateSelector).first();if(f.length<=0){b.error("Could not find a Banner template. Do you have an "+e.templateSelector+" element?");}else{e._template=f.html();}}return e._template;},_ignoreEventListenerBound:false,_bindIgnoreEventListenerIfNeeded:function(e){var f=a.Banner;if(!f._ignoreEventListenerBound){e.bind("ignore.zd.banner",function(h,g){g.disappear();return true;});e.bind("reload.zd.banner",function(h,g){window.location.reload(true);return true;});f._ignoreEventListenerBound=true;}return e;},create:function(g){var f=a.Banner;var e=d.extend({},f._buildLI(g||{}),f._enhancements);d(e).find(".ignore").click(function(){d(e).trigger("ignore.zd.banner",[e]);});d(e).find(".reload a").click(function(){d(e).trigger("reload.zd.banner",[e]);return false;});return e.appendTo(f.container());},_buildLI:function(f){var e=d(d.mustache(a.Banner.template(),{text:(f.text||"")}));if(!(f.visible)){e.hide();}["icon","ignore","reload"].each(function(g){if(f[g]===false){e.find("."+g).hide();}});return e;},_enhancements:{toString:function(){return"<banner text="+this.content().text()+">";},setContent:function(e){this.content().html(e);return this;},appear:function(f){var e=this;e.slideDown(null,function(){e.trigger("appear.zd.banner",[e]);f&&f();});return e;},disappear:function(f){var e=this;e.slideUp(null,function(){e.trigger("disappear.zd.banner",[e]);f&&f();});return e;},visible:function(){return this.filter(":visible").length>0;},hidden:function(){return this.filter(":hidden").length>0;}}};c(["icon","content","ignore","reload"]).each(function(e){a.Banner._enhancements[e]=function(){return d(this).find("."+e);};});})(this.jQuery,this.console,this.Zendesk,this._);jQuery(function(a){a("#top-menu li.tab_getting_started").each(function(c,b){var e=a(b);var d=e.find("> a").text().strip();if(d.length>0){e.attr("data-tracking-activity",d);e.find("a").instrumentTracking();}});});$z.defModule("monitor/children/show",{initialize:function(a){$j("#subscription_payment_method_type").change(function(){if($j("#subscription_payment_method_type").val()==0){$j("#manual-discount-options").show();}else{$j("#manual-discount-options").hide();}});$j("#subscription_payment_method_type").change();$j("#account_settings_monitored_facebook_page_limit").change(function(){$j("#fb_page_limit").html($j(this).val());});}});$z.defModule("monitor/coupons/edit",{initialize:function(b){var a=this;a.radioButtons=$j('input[name="coupon[type]"]');a.radioButtons.click(function(){a._showFieldsForSelected(this);});$j(".optional").hide();a._showFieldsForSelected(a.radioButtons);},_showFieldsForSelected:function(a){$j(a).filter(":checked").each(function(){$j(".optional").hide();$j('.optional[data-show-if-selected="'+$j(this).attr("id")+'"]').show();});}});$z.defModule("monitor/coupons/index",{initialize:function(a){$j("#coupons tbody tr").hover(function(){$j(".edit a",$j(this)).css("visibility","visible");},function(){$j(".edit a",$j(this)).css("visibility","hidden");});}});$z.defModule("monitor/payments/show",{initialize:function(a){$j("#refund_button").click(function(){$j.colorbox({href:"#refund_form",inline:true});return false;});}});Zendesk.NS("Monitor");Zendesk.Monitor.PermissionsPage=function(){this.init();};Zendesk.Monitor.PermissionsPage.prototype={init:function(){var a=this;$j("#permission_email").change(function(){a.loadData(this.value);});},loadData:function(a){$j.ajax({url:"/monitor/permissions/permissions_for?user_id="+a,success:function(e){var c=$j("div.item-info").html("");if(e.length===0){return;}var b=e;var d=$j("<ul>");_.each(b,function(f){var g=f.permission_id.replace(/_/g," ");g=g.charAt(0).toUpperCase()+g.slice(1);var h="permissions/"+f.id;d.append($j("<li>").append(g).append($j("<a>").attr({rel:"no-follow",href:h,"data-method":"delete"}).html(" revoke")));});c.html(d);}});}};$z.defModule("monitor/search/index",{initialize:function(){this.checkIndexed();this.captureReindex();},checkIndexed:function(){var a=this;$j(".indexable").each(function(){a.updateIndexed($j(this));});},updateIndexed:function(a){var b=a.attr("data-indexable").split("-");$j.getJSON("/monitor/search/check_indexed",{id:b[0],account:b[1]},function(c){a.addClass("indexable indexed").toggleClass("not",!c).text(c?"indexed":"unindexed");});},captureReindex:function(){var a=this;$j(".reindexable").each(function(){$j(this).bind("submit",function(e){var b=$j(e.target);var c=b.attr("id");var g=c.split("-")[1].split("_");var h=g[0];var d=g[1];var f=g[2];$j.post(b.attr("action"),{id:h,type:d,account:f},function(){$j(b.find("button").first()).text("Reindexed");var i=h.split("@").reverse().join("_");a.updateIndexed($j("#check_indexed-"+h+"_"+d+"_"+f));});return false;});});}});$z.defModule("people/groups/show",{initialize:function(){$z("people/search/index").initialize();}});$z.defModule("people/organizations/edit",{initialize:function(a){$j("form#account-settings").submit(function(){if(typeof(organizationTagField)!="undefined"){organizationTagField.beforeFormSubmit();}});}});$z.defModule("people/organizations/show",{initialize:function(){$z("people/search/index").initialize();}});Zendesk.NS("People.Passwords",function(b){var a=function(c){var e=_(c.errors);var d=b("#password_requirements ul li");_(d).each(function(f){var f=b(f);if(e.contains(b.trim(f.text()))){f.addClass("invalid").removeClass("valid");}else{f.addClass("valid").removeClass("invalid");}});};b(document).ready(function(){b(".validate_password").keyup(function(d){var c=currentAccount.secureUrlPrefix+"/people/password/validate_password?callback=?";b.getJSON(c,{password:b(this).val()},a);});});},jQuery);Zendesk.NS("People.Roles",function(j){var f=j("#permission_set_permissions_ticket_access");var i=j("#permission_set_permissions_forum_access");var h=j("#permission_set_permissions_end_user_profile");var d=j("#permission_set_form");var a=d.data("light-agent");function e(n){var q=j("#ticket_access_message");var u=j("#permission_set_permissions_ticket_editing");var t=j("label[for='permission_set_permissions_ticket_editing']");var l=function(){var v="To deselect this option, you must change ticket access selection";u.prop("checked",true).prop("disabled",true).prop("title",v).change();t.prop("title",v);};var s=function(){u.prop("disabled",a).removeAttr("title");t.removeAttr("title");};var p=function(){q.html(I18n.t("txt.admin.javascrips.views.people.roles.user_belongs_group")).show();};var m=function(){q.html(I18n.t("txt.admin.javascrips.views.people.roles.user_belongs_organization")).show();};var r=function(){q.hide();};var o={"assigned-only":[r,l],"within-groups":[p,s],"within-organization":[m,s],all:[r,s]};if(u.exists()){n.selectInteraction(o);}}function c(q){var l=j("#permission_set_permissions_forum_access_restricted_content");var n=j("label[for='permission_set_permissions_forum_access_restricted_content']");var m=function(){var r="To deselect this option, you must change forums editing permission";l.prop("checked",true).prop("disabled",true).prop("title",r);n.prop("title",r);};var p=function(){l.prop("disabled",false).removeAttr("title");n.removeAttr("title");};var o={full:m,"default-interaction":p};if(l.exists()){q.selectInteraction(o);}}function b(q){var l=j("#people_editing_options");var n=j("#permission_set_permissions_edit_organizations");var m=function(){l.slideDown();n.prop("disabled",false);};var o=function(){l.slideUp();n.prop("disabled",true);};var p={edit:m,full:m,"default-interaction":o};j(q).selectInteraction(p);}function k(){if(f.exists()){e(f);}if(i.exists()){c(i);}if(h.exists()){b(h);}}function g(){d.find(":input:not(:submit, [name='_method'])").not(f).prop("disabled",true);}j(document).ready(function(){k();if(a){g();}});},this.jQuery);function UserMergeWizard(a){this.redirectToWinner=a;this.registerEvents();}UserMergeWizard.prototype={redirectToWinner:false,lookupUser:function(d,a,e){var b="/people/user_merge/autocomplete";var c={name:a,rand:(new Date()).getTime(),user_id:d};new Ajax.Request(b,{parameters:c,onSuccess:function(f){e(f.responseJSON);}});},registerEvents:function(){var a=this;$j("#merge_link").live("click",function(){$j.colorbox({href:$j(this).attr("href"),onComplete:function(){var c=a.winnerForm().attr("data-loser");var b=new Autocompleter.Cache(a.lookupUser.curry(c));new Autocompleter.Json("winner","winner_auto_complete",b.lookup.bind(b),{frequency:0.1,minChars:3});$j("input[placeholder]").placeholder();}});return false;});a.winnerLinks().live("click",function(){$j.colorbox({href:$j(this).attr("href")});return false;});a.winnerForm().live("submit",function(){$j.ajax({type:$j(this).attr("method"),data:$j(this).serialize(),url:$j(this).attr("action"),success:function(b){$j.colorbox({html:b});},error:function(b,d,c){$j.colorbox({html:b.responseText});}});return false;});if(!a.redirectToWinner){a.confirmForm().live("submit",function(){$j.ajax({data:$j(this).serialize(),type:"POST",url:$j(this).attr("action")+"?format=js",beforeSend:function(b){a.confirmButton().val("Merging users...");a.confirmButton().prop("disabled",true);},success:function(b){$j.colorbox.close();},error:function(b,d,c){$j.colorbox({html:b.responseText});a.confirmButton().val("Confirm and Merge");a.confirmButton().prop("disabled",false);}});return false;});}},winnerForm:function(){return $j("#winner_form");},winnerField:function(){return this.winnerForm().find("input[type='text']");},continueButton:function(){return this.winnerForm().find("input[type='submit']");},winnerLinks:function(){return $j(".winner_selector");},confirmForm:function(){return $j("#confirm_merge_form");},confirmButton:function(){return this.confirmForm().find("input[type='submit']");}};$z.defModule("people/users/edit",{initialize:function(b){var a=this;this.confirmationMessages={leavingLegacy:I18n.t("txt.admin.public.javascripts.views.people.users_edit.assigning_new_role")};if($j("#original_roles").exists()){this.setupNonEnterpriseRoles(b);$j("#user_default_group_id").live("change",function(){var d=$j(this).val();$j("#user_groups_"+d).prop("checked",true);});}else{$j("#user_default_group_id").change(function(){a.enableGroup($j("#group_"+$j(this).val()));});a.enableGroup($j("#group_"+$j("#user_default_group_id").val()));}if($j(".role_groups").exists()){$j(".user_type, #user_role_or_permission_set").change($j.proxy(this.manageRoleDisplay,this));this.manageRoleDisplay();$j("#group_tiles .tile").click(function(d){var e=$j(d.target).hasClass("tile")?$j(d.target):$j(d.target).parents(".tile");a.selectGroup(e);});var c=$j("#role_and_groups_form");this.formElm=c.exists()?c:$j("#user-form");this.formElm.submit($j.proxy(this.confirmSave,this));}$j("form#user-form [type=submit]").bind("click",function(d){if(typeof(userTagField)!="undefined"){userTagField.beforeFormSubmit();}});if($j("#identities").exists()){$j(".email.unverified_email .add_identity, .twitter .add_identity, .google .add_identity, .facebook .add_identity").colorbox({onComplete:function(){$j("#focus").focus();}});this.identitiesManager=new Zendesk.IdentitiesManager(b,$j.proxy(this.setupPrimary,this));this.renderIdentities(b);$j("#add_openid").live("click",function(){$j(this).hide();$j("#openid_identity_list").hide();$j("#add_openid_form").show();});}},setupNonEnterpriseRoles:function(a){if($j("#user_roles_4").is(":checked")){$j("#agent_groups").html($j("#group-block").html());}if($j("#user_roles_2").is(":checked")){$j("#admin_groups").html($j("#group-block").html());}$j("#user-radio").click(function(){$j("#agent_groups, #admin_groups").empty();$j("#end_user_block").show();$j("#agent_block, #admin_groups").hide();$j("#user_restriction_id_4").click();$j("#display_name").hide();});$j("#user_roles_4").click(function(){$j("#agent_groups").html($j("#group-block").html());$j("#admin_groups").empty();$j("#agent_block").show();$j("#admin_groups, #end_user_block").hide();$j("#user_restriction_id_0").click();$j("#display_name").show();});$j("#user_roles_2").click(function(){$j("#admin_groups").html($j("#group-block").html());$j("#agent_groups").empty();$j("#agent_block, #end_user_block").hide();$j("#admin_groups").show();$j("#display_name").show();});$j("form#user-form").submit($j.proxy(function(){var b=$j("#user_roles_4").is(":checked")?"Agent":($j("#user_roles_2").is(":checked")?"Admin":"End-User");Zendesk.Instrumentation.ToTango.track(b,"User - Save");$j("#submit-button").val(a?I18n.t("txt.users.edit.updating"):I18n.t("txt.users.edit.creating")).prop("disabled",true);},this));},manageRoleDisplay:function(h){this.roleData=this.roleData||$j.parseJSON($j("#role_data").html());var b=$j("#roles_agent"),a=$j("#agent_details"),f=a.find(".description"),g=a.find(".headcount"),k=$j("#enduser_details"),c=$j('#enduser_details input[name="user[restriction_id]"]'),i=$j("#roles_enduser").prop("checked"),d=$j("#user_role_or_permission_set"),j=_(this.roleData).find(function(e){return e.id==d.val();});d.prop("disabled",i);k.toggle(i);a.toggle(!i);if(!i){c.prop("disabled",true);b.val(j.id=="admin"?2:4);f.html(j.description);g.html(j.headcount);}else{c.prop("disabled",false);}this.displayGroups(i);},displayGroups:function(a){$j("#groups_unavailable").toggle(a);$j("#groups_available").toggle(!a);if(a){$j("#group_tiles input").prop("disabled",true);}else{$j("#group_tiles input.empty").prop("disabled",false);_($j("#group_tiles .tile")).each(function(b){b=$j(b);if(b.hasClass("selected")){$j(b.find("input")).prop("disabled",false);}});}},selectGroup:function(a){if(a.hasClass("selected")){this.disableGroup(a);}else{this.enableGroup(a);}},enableGroup:function(a){a.addClass("selected");$j("input",a).prop("disabled",false);},disableGroup:function(a){a.removeClass("selected");$j("input",a).prop("disabled",true);},confirmSave:function(d){if(d){d.stopPropagation();d.preventDefault();}var c=$j("#user_role_or_permission_set option:first-child").val()==="";var a=$j("#user_role_or_permission_set").val()!=="";var b=$j("#roles_agent").prop("checked");if(c&&b&&a){if(!confirm(this.confirmationMessages.leavingLegacy)){return false;}}this.formElm.unbind("submit");this.formElm.submit();},renderIdentities:function(c){var h,g,e,d,b,f;var a=this.identitiesManager.allPrimaryCandidates().length!==0;$j(this.identitiesManager.identities).each($j.proxy(function(k,j){h=$j("<a>",{href:"javascript: void(0);",html:I18n.t("txt.users.edit.delete_identity")}).click($j.proxy(this.deleteIdentity,this)).data("elmId",j.elmId).addClass("remove_link");g=$j("<span>",{html:j.name}).addClass("identity_name");e=$j("<span>",{html:"("+I18n.t("txt.users.edit.primary")+")",style:"display: none"}).addClass("primary_label");d=$j("<span>",{html:"("+I18n.t("txt.users.edit.email_not_verified")+")"}).addClass("status unverified");$j("<li>",{id:j.elmId}).append(g).append(j.isUnverified()?d:"").append((j.isPrimaryCandidate()&&!j.isUnverified())?e:"").append(h).appendTo($j(j.listElmId));if(this.identitiesManager.limitToSingleIdentity(j)){$j("."+j.identity_type+" .add_identity").hide();}if(!a&&j.isExternalIdentity){$j("#"+j.elmId).find(".remove_link").hide();}},this));b=this.identitiesManager.primary();if(typeof b!=="undefined"){f=$j("#"+b.elmId);f.find(".primary_label").show();f.find(".remove_link").hide();}this.setupPrimary();},setupPrimary:function(){if(this.identitiesManager.allPrimaryCandidates().length<=1){$j("#primary_section").hide();return;}else{$j("#primary_section").show();}var a=$j("#primary_identity");this.renderPrimary(this.identitiesManager.primary());a.unbind("change",$j.proxy(this.updatePrimary,this));a.bind("change",$j.proxy(this.updatePrimary,this));},renderPrimary:function(b){var a=$j("#primary_identity");a.html("");a.append($j("<option>",{value:b.elmId,html:b.name+" ("+I18n.t("txt.users.edit.primary")+")"}));_(this.identitiesManager.allPrimaryCandidates()).each(function(c){if(c!=b){a.append($j("<option>",{value:c.elmId,html:c.name}));}});},updatePrimary:function(c){if(c){c.stopPropagation();c.preventDefault();}if(this.identitiesManager.allPrimaryCandidates().length<=1){$j("#primary_section").hide();return;}var a=$j("#primary_identity");var b=this.identitiesManager.find(a.val());var d=$j("<div>").addClass("spinner small").insertAfter(a);this.identitiesManager.makePrimary(b).done(function(){d.remove();}).fail(function(){d.remove();}).done($j.proxy(function(){this.renderPrimary(b);$j(".remove_link").show();$j("#"+b.elmId).find(".remove_link").hide();$j(".primary_label").hide();$j("#"+b.elmId).find(".primary_label").show();clearFlash();},this)).fail($j.proxy(function(e){this.setupPrimary();showFlash(e,"error");},this));},deleteIdentity:function(c){if(c){c.stopPropagation();c.preventDefault();}var b=$j(c.target);var a=this.identitiesManager.find(b.data("elmId"));if(!confirm(I18n.t("txt.users.edit.remove_account_confirmation",{identityName:a.name}))){return false;}var d=$j("<div>").addClass("spinner small").insertAfter(b);b.hide();this.identitiesManager.remove(a).done(function(){d.remove();}).fail(function(){d.remove();}).done(function(){$j("."+a.identityType+" .add_identity").show();$j("#"+a.elmId).remove();clearFlash();}).fail(function(e){showFlash(e,"error");});}});$z.defModule("people/search/index",{initialize:function(){if($j("#bulk_update").exists()){this.setupBulkUpdate();}},setupBulkUpdate:function(){var a=$j(".individual_bulk_checkbox");this.activeCheckboxes=$j(_(a.find(".checkbox")).select(function(b){return !$j(b).prop("disabled");}));if(this.activeCheckboxes.length<1){$j("#bulk_update").hide();a.hide();}else{this.bulkSubmitElm=$j("#bulk_submit");this.toggleBulkSubmit();$j("#bulk_check").change($j.proxy(this.manageBulkUpdate,this));this.activeCheckboxes.change($j.proxy(this.toggleBulkSubmit,this));$j("#bulk_submit").click($j.proxy(this.submitBulkForm,this));}},manageBulkUpdate:function(b){var a=$j("#bulk_check").prop("checked");this.activeCheckboxes.not(".disabled").prop("checked",a);this.toggleBulkSubmit();},submitBulkForm:function(a){if(a){a.stopPropagation();a.preventDefault();}if(!this.anyChecked()){return;}$j("#bulk_check").hide();$j("#bulk_spinner").show();$j.ajax({type:"POST",url:"/people/users/select_bulk_action",data:($j("#bulk_form").serialize()),success:function(b){clearFlash();$j.colorbox({html:b});$j("#bulk_spinner").hide();$j("#bulk_check").show();},error:function(b){showFlash("Error:"+b,"error");$j("#bulk_spinner").hide();$j("#bulk_check").show();}});},toggleBulkSubmit:function(a){if(this.anyChecked()){this.bulkSubmitElm.prop("disabled",false);this.bulkSubmitElm.removeClass("button_disabled");this.bulkSubmitElm.addClass("button");}else{this.bulkSubmitElm.prop("disabled",true);this.bulkSubmitElm.removeClass("button");this.bulkSubmitElm.addClass("button_disabled");}},anyChecked:function(){return _(this.activeCheckboxes).any(function(a){return $j(a).prop("checked");});}});$z.defModule("people/users/merge",{initialize:function(){},switch_to_password_form:function(){$j("#user_merge_email_form").hide();$j("#user_merge_password_form").show();$j.colorbox.resize();$j("#user_merge_email_for_password_form").val($j("#user_merge_email").val());$j("#user_merge_password_email_display").html($j("#user_merge_email").val());},on_email_submit:function(){if(this.email_validate($j("#user_merge_email").val())){this.toggle_form("email");return false;}else{alert(I18n.t("txt.user.merge.enter_valid_email"));return true;}},on_password_submit:function(){if($j("#user_merge_password").val()!==""){this.toggle_form("password");return false;}else{alert(I18n.t("txt.user.merge.enter_valid_password"));return true;}},email_validate:function(a){var b=/^([A-Za-z0-9_\+\-\.])+(\+[0-9]+)?\@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,4})$/;return b.test(a);},password_does_not_match:function(a){this.toggle_form("password");alert(a);},toggle_form:function(a){$j("#user_merge_waiting_for_"+a).toggle();$j("#user_merge_submit_"+a).toggle();}});$z.defModule("people/users/new",{initialize:function(a){$z("people/users/edit").initialize(a);}});$z.defModule("people/users/show",{initialize:function(b){this.userId=b;var a=$j("#suspend_access");this.userSuspended=(a.attr("data-user-suspended")!=="false");if(this.userSuspended){$j("#suspended").show();}$j("a.toggle-twitter-data").click(function(){$j(this).closest("p.user-twitter").next(".twitter-properties").slideToggle(50);});$j(".visibility-controls").click(function(){$j("a.toggle-twitter-data",this).toggle();});$j("#make_direct_number_link").click(function(c){$j.colorbox({inline:true,href:"#make_direct_number_layer"});if(c){c.preventDefault();}});$j("#edit_number_link").click(function(c){$j.colorbox({inline:true,href:"#edit_number_layer"});if(c){c.preventDefault();}});new UserMergeWizard(true);this.setSuspensionActionText();a.click($j.proxy(this.setSuspensionStatus,this));},setSuspensionStatus:function(b){b.preventDefault();if(this.settingStatus===true){return;}this.settingSuspensionStatus=true;var a="/users/"+this.userId;$j.ajax({url:a,type:"PUT",dataType:"json",dataFilter:function(c){trimmed_data=$j.trim(c);if(trimmed_data==""){return"{}";}else{return c;}},data:{authenticity_token:currentUser.authenticityToken,user:{suspended:!this.userSuspended}},success:$j.proxy(function(){this.userSuspended=!this.userSuspended;this.setSuspensionActionText();$j("#suspended").toggle(this.userSuspended);showFlash((this.userSuspended?I18n.t("txt.admin.javascrips.users_show.user_suspended_label"):I18n.t("txt.admin.javascrips.users_show.user_unsuspended_label")),"notice");this.settingSuspensionStatus=false;},this),error:function(c){var d=this.userSuspended?"suspend":"unsuspend";if(d=="suspend"){message=I18n.t("txt.admin.javascrips.users_show.suspend_user_label");}else{message=I18n.t("txt.admin.javascrips.users_show.unsuspend_user_label");}showFlash(message,"error");this.settingSuspensionStatus=false;}});},setSuspensionActionText:function(){$j("#suspend_access").html(this.userSuspended?I18n.t("txt.admin.javascrips.users_show.unsusped_access_label"):I18n.t("txt.admin.javascrips.users_show.suspend_access_label"));}});$z.defModule("reports/edit",{initialize:function(a){$j("fieldset.conditions span select").autocompleteFromSelectIfLarge();}});Zendesk.NS("Reports");Zendesk.Reports.ForumAnalytics=function(a){a=a||{};this.container=a.container;this.sammyApp=this._extendSammyApp(a.app);this.routes={TAB:"#forum_analytics",STATS:"#forum_analytics/stats/:statName"};};Zendesk.Reports.ForumAnalytics.prototype={run:function(){this._initForumUI();},$:function(a){return $j(a,this.container);},_extendSammyApp:function(b){var a=this;return b.bind("tab-changed",function(d,c){if(c.tabID!=="forum_analytics"){return;}if(!a.$("#stats_summary_container").length){return;}var f;a._loadDefaultState();if(this.matchPath(c.path,a.routes.TAB)){a._getRouteTab();}else{if(f=this.matchPath(c.path,a.routes.STATS)){a._getRouteStats(f);}}});},_getRouteStats:function(b){var a=this.$(".sparkline#"+b.statName);if(a.hasClass("active")){return;}Zendesk.Stats.ForumUI.showDetailGraph(a,{container:this.container});},_getRouteTab:function(){this._getRouteStats({statName:this.$(".sparkline:first").attr("id")});},_loadDefaultState:function(){if(!this.$(".sparkline > div:not(:empty)").length){Zendesk.Stats.ForumUI._drawSparklines({container:this.container});}},_initForumUI:function(){Zendesk.Stats.ForumUI._bindSparklineHandlers(this.sammyApp,{statsURL:"#forum_analytics/stats",container:this.container});}};Zendesk.NS("Reports");Zendesk.Reports.Overview=function(a){a=a||{};this.container=a.container;this.sammyApp=this._extendSammyApp(a.app);};Zendesk.Reports.Overview.prototype={run:function(){this._bindSparklineHandlers();},$:function(a){return $j(a,this.container);},_bindSparklineHandlers:function(){var b=this,a;a=[{context:".ticket_stats .search_sparkline",path:"#reports"},{context:"#forum_views",path:"#forum_analytics"},{context:"#forum_topics",path:"#forum_analytics"},{context:"#search_total_searches",path:"#search_analytics"},{context:"#search_tickets_created",path:"#search_analytics"}];$j(a).each(function(c,d){$j(d.context).bind("click",function(){b.sammyApp.setLocation(d.path);});});},_drawAllSparklines:function(){var a=this,b;b=[{div:"#tickets_created_sparkline",statName:"created_count",draw:this._drawTicketSparklines},{div:"#tickets_solved_sparkline",statName:"solve_count",draw:this._drawTicketSparklines},{div:"#tickets_first_response_time_sparkline",statName:"first_response_time",draw:this._drawTicketSparklines},{div:"#tickets_satisfaction_sparkline",statName:"csr",draw:this._drawTicketSparklines},{div:"#forum_views_sparkline",statName:"entry_view",draw:this._drawForumSparklines},{div:"#forum_topics_sparkline",statName:"entry_create",draw:this._drawForumSparklines},{div:"#search_total_searches_sparkline",statName:"searches",draw:this._drawSearchSparklines},{div:"#search_tickets_created_sparkline",statName:"tickets",draw:this._drawSearchSparklines}];$j(b).each(function(c,d){d.draw.call(a,d);});},_drawForumSparklines:function(c){var b=this.$(c.div),a,d=Zendesk.Stats.ForumUI._statsInfo(this.$("#stats_object"));a=new Zendesk.Stats.Graph(b,{graphType:"sparkline",resource:"forum",objectType:d.objectType,objectId:d.objectId,statName:c.statName,start:d.windowStart,totalCountDiv:b.closest(".sparkline_container").find(".stat_total")});a.draw();},_drawSearchSparklines:function(c){var b=this.$(c.div),a;a=new Zendesk.Stats.Graph(b,{graphType:"sparkline",searchStatURL:"/account/search_account_stats",statName:c.statName,totalCountDiv:b.closest(".sparkline_container").find(".stat_total")});a.draw();},_drawTicketSparklines:function(c){var b=this.$(c.div),a;a=new Zendesk.Stats.Graph(b,{graphType:"sparkline",searchStatURL:"/account/0/ticket_stats",statName:c.statName,totalCountDiv:b.closest(".sparkline_container").find(".stat_total")});$j.getJSON(a.statsURL,{start:a.startTime,interval:86400}).done($j.proxy(this._drawSparkline,a,a.statsURL,this._calculateTotal));},_extendSammyApp:function(b){var a=this;return b.bind("tab-changed",function(f,d){if(!a.$(".stats_summary_container").length){return;}var c=a.$(".search_sparkline > div:not(:empty)");if(d.tabID!=="overview"||c.length){return;}a._drawAllSparklines();});},_drawSparkline:function(b,a,d){this.data=d.data;this.draw();var e="0,0",c=a(d.data,d.counts);if(this.statName==="csr"){e="0,0%",c*=100;}if(this.statName==="first_response_time"){c=c/3600;}$j(this.totalCountDiv).append(Zendesk.Stats.formatNumber(e,c));},_calculateTotal:function(e,b){var c=0,d=0;if(b&&b.length===e.length){for(var a=0;a<e.length;a++){if(b[a]===undefined){continue;}d+=e[a][1]*b[a];c+=b[a];}d/=c;}else{for(var a=0;a<e.length;a++){d+=e[a][1];}}return d;}};Zendesk.NS("Reports.Page");Zendesk.Reports.Page.init=function(a){a=a||{};var b=new Zendesk.TabbedContainer.SammyApp();new Zendesk.Reports.Overview({app:b.app,container:"#overview"}).run();new Zendesk.Reports.ForumAnalytics({app:b.app,container:"#forum_analytics"}).run();new Zendesk.Reports.SearchAnalytics({app:b.app,container:"#search_analytics"}).run();b.init();};Zendesk.NS("Reports");Zendesk.Reports.SearchAnalytics=function(a){a=a||{};this.container=a.container;this.searchStatsTable=this._initializeTable();this.sammyApp=this._extendSammyApp(a.app);this.routes={STATS:"#search_analytics/stats/:statName",TAB:"#search_analytics",TABLE:"#search_analytics/table/:orderField/:sortDirection/page/:page"};};Zendesk.Reports.SearchAnalytics.prototype={run:function(){this._bindTableHandlers();this._bindSparklineHandlers();this._bindSelectMenuHandler();},$:function(a){return $j(a,this.container);},_extendSammyApp:function(b){var a=this;return b.bind("tab-changed",function(d,c){if(c.tabID!=="search_analytics"){return;}if(!a.$(".stats_summary_container").length){return;}var f;a._loadDefaultState();if(this.matchPath(c.path,a.routes.TAB)){a._getRouteTab();}else{if(f=this.matchPath(c.path,a.routes.TABLE)){a._getRouteTable(f);}else{if(f=this.matchPath(c.path,a.routes.STATS)){a._getRouteStats(f);}}}});},_getRouteStats:function(c){var b=c.statName,a=this.$(".search_sparkline#"+b);if(a.hasClass("active")){return;}this._drawDetailGraph(a);this._setTableDescription(b);this._fetchTableForSparkline(b);this.$("#percentage_stats_graph").hide();this.$("#detailed_stats_graph").show();if(b!=="searches"){this._addPercentageSelectMenu(b);}else{this.$("#stats_graph_select_menu").empty();}},_getRouteTab:function(){this._getRouteStats({statName:this.$(".search_sparkline:first").attr("id")});},_getRouteTable:function(d){this._loadDefaultGraph();var c=d.orderField,a=parseInt(d.page,10),b=d.sortDirection;this.$("#search_string_stats table th img").hide();this._sortTopStats(this.$("#search_string_stats table th."+c),b,a);},_initializeTable:function(){if(!this.$(".stats_summary_container").length){return undefined;}var b={divTable:"#search_string_stats",statsType:"all",orderField:"searches",searchStatsTemplate:"#search_stats_template",divPaginationTotal:"#pagination_total",container:this.container};this.$("#search_string_feedback_checkbox").hide();this.$(b.divTable+" #show_more").hide();var a=new Zendesk.Stats.SearchStatsTable(b);this._displayFeedbackCheckbox(a);return a;},_loadDefaultGraph:function(){if(this.$("#detailed_stats_graph").is(":empty")){this._drawDetailGraph(this.$(".search_sparkline:first"));}},_loadDefaultState:function(){if(!this.$(".search_sparkline > div:not(:empty)").length){this._drawSparklines();}},_setFeedbackCheckbox:function(a){if(a===true){this.$("#search_string_feedback_checkbox").show();}},_displayFeedbackCheckbox:function(a){a.isFeedbackData(this,this._setFeedbackCheckbox);var b=this.$("#search_string_stats #feedback_tag");b.prop("checked",false);b.click(function(){var c=($j(this).is(":checked")?"feedback_tab":"all");a.modifyDisplayed({statsType:c});});},_bindSparklineHandlers:function(){var a=this;this.$(".search_sparkline").bind("click",function(){if(($j(this).hasClass("active"))){return false;}else{a.sammyApp.setLocation("#search_analytics/stats/"+$j(this).attr("id"));}});},_sortByColumn:function(){var a=this;var b=this.$("table.tickets th").slice(0,-1);b.css({cursor:"pointer"});b.click(function(){var e=$j(this).attr("class"),c=a.searchStatsTable.statOptions.page,d=a.searchStatsTable.getNextSortDirection(e);a.sammyApp.setLocation("#search_analytics/table/"+e+"/"+d+"/page/"+c);return false;});},_bindTableHandlers:function(){this._sortByColumn();var a=this;this.$("#search_string_stats #show_more a").click(function(){a.$("table.tickets tr:hidden").show();var b=a.sammyApp,c=a.searchStatsTable;var f=c.statOptions.orderField,d=c.nextPage(),e=c.getCurrentSortDirection(f);a.sammyApp.setLocation("#search_analytics/table/"+f+"/"+e+"/page/"+d);return false;});},_bindSelectMenuHandler:function(){var a=this;this.$("#stats_graph_select_menu select").live("change",function(){var b=$j(this).find("option:selected").val();if(b==="percentage"){a._showPercentageGraph();}else{a._showOriginal();}});},_showOriginal:function(){this.$("#percentage_stats_graph").hide();this.$("#detailed_stats_graph").show();},_showPercentageGraph:function(){var d=this.$("#searches_sparkline").data("graph_data").data;var f=this.$(".active").find("div").data("graph_data").data;var c=[];for(var b=0;b<d.length;b++){var a=parseInt((parseInt(f[b][1])*100)/parseInt(d[b][1]));c.push([d[b][0],(isNaN(a)?0:a)]);}this.$("#detailed_stats_graph").hide();this.$("#percentage_stats_graph").show();var e=new Zendesk.Stats.Graph(this.$("#percentage_stats_graph"),{graphType:"percentage",data:c});e.draw();},_drawSparklines:function(){var c=[{div:"#searches_sparkline",statName:"searches"},{div:"#no_results_sparkline",statName:"no_results"},{div:"#no_clicks_sparkline",statName:"no_clicks"},{div:"#tickets_sparkline",statName:"tickets"}];for(var b=0;b<c.length;b++){var a=new Zendesk.Stats.Graph(this.$(c[b].div),{graphType:"sparkline",searchStatURL:"/account/search_account_stats",statName:c[b].statName,totalCountDiv:this.$(c[b].div).parent().parent().find(".stat_total")});a.draw();}},_drawDetailGraph:function(a){this.$(".search_sparkline.active").removeClass("active");this.$(a).addClass("active");var b=this.$(a).prop("id");var c=new Zendesk.Stats.Graph(this.$("#detailed_stats_graph"),{graphType:"area",searchStatURL:"/account/search_account_stats",statName:b});c.draw();$j(window).resize(function(){c.draw();});},_setTableDescription:function(b){var a={searches:{title:I18n.t("txt.admin.public.javascript.views.reports.top_500_searches"),description:""},no_results:{title:I18n.t("txt.admin.public.javascript.views.reports.search.top_500_searches_no_results_label"),description:I18n.t("txt.admin.public.javascript.views.reports.search.search.top_500_searches_no_results_description")},no_clicks:{title:I18n.t("txt.admin.public.javascript.views.reports.search.top_500_searches_no_clicks_label"),description:I18n.t("txt.admin.public.javascript.views.reports.search.top_500_searches_no_clicks_description")},tickets:{title:I18n.t("txt.admin.public.javascript.views.reports.search.top_500_searches_tickets_created_label"),description:I18n.t("txt.admin.public.javascript.views.reports.search.top_500_searches_tickets_created_description")}}[b];this.$(".stats_summary_description").empty();this.$(".stats_summary_description").append(a.title);this.$(".stats_summary_extra_description").empty();this.$(".stats_summary_extra_description").append(a.description);},_fetchTableForSparkline:function(a){var b={searches:["searches","desc"],no_results:["avg_results","asc"],no_clicks:["ctr","asc"],tickets:["tickets","desc"]}[a];if(a!=="searches"){this.$("#search_string_feedback_checkbox input[type=checkbox]").prop("checked",false);this.searchStatsTable.statOptions.statsType="all";}this._sortTopStats(this.$("th."+b[0]),b[1],1,this._filterCallback);},_addPercentageSelectMenu:function(b){var d=this.$("#stats_graph_select_menu");var e=this.$("#"+b).parent().find(".stat_title").html().toLowerCase();var c=[];var a=this._getPercentageSelectMenuTranslation(e);c.push("<select>");c.push('<option value="original">'+a+"</option>");c.push('<option value="percentage">'+I18n.t("txt.admin.public.javascript.views.reports.search.percent_of_total_searches_option")+"</option>");c.push("</select>");d.empty();d.append(c.join());},_getPercentageSelectMenuTranslation:function(a){if(a==I18n.t("txt.admin.views.reports.tabs.search.with_no_results_label").toLowerCase()){return I18n.t("txt.admin.views.reports.tabs.search.number_with_no_results_label");}else{if(a==I18n.t("txt.admin.views.reports.tabs.search.with_no_clicks_label").toLowerCase()){return I18n.t("txt.admin.views.reports.tabs.search.number_with_no_clicks_label");}else{if(a==I18n.t("txt.admin.views.reports.tabs.search.tickets_created_label").toLowerCase()){return I18n.t("txt.admin.views.reports.tabs.search.number_tickets_created_label");}else{return"Number "+a;}}}},_filterCallback:function(b){this.$("table.tickets td."+b).each(function(){if(b=="ctr"||b=="avg_results"){if(parseFloat($j(this).html())>0.05){$j(this).parent().hide();}}if(b=="tickets"){if(parseFloat($j(this).html())<1){$j(this).parent().hide();}}});if(this.$(".active").attr("id")!=="searches"){var a=this.$("table.tickets tbody tr:visible").sort(function(d,c){return parseInt($j(c).find(".searches").html())-parseInt($j(d).find(".searches").html());});this.$("table.tickets tbody").empty();this.$("table.tickets tbody").append(a);this.$("#show_more").hide();this.$(".view_sort").remove();this.$("th.searches").children("div.title").append('<img alt="Table-arrow" class="view_sort" src="/images/table-arrow.png"/>');this.$("table.tickets th").css({cursor:"default"});this.$("table.tickets th").unbind("click");if(this.$("#search_string_feedback_checkbox").is(":visible")){this.$("#search_string_feedback_checkbox").hide();this.$("#search_string_feedback_checkbox").data("show_again",true);}}else{if(this.$("#search_string_feedback_checkbox").data("show_again")){this.$("#search_string_feedback_checkbox").show();this.$("#search_string_feedback_checkbox").data("show_again",false);}this._sortByColumn();}},_setSortImage:function(b,c){this.$(".view_sort").remove();var a=(c==="desc"?"/images/table-arrow.png":"/images/table-arrow1.png");b.children("div.title").append('<img alt="Table-arrow" class="view_sort" src="'+a+'"/>');},_sortTopStats:function(b,e,d,g){var f=b.prop("class"),c=this.searchStatsTable,a=(this.$(".active").attr("id")==="searches")?15:100;c.setSort(f,e);c.modifyDisplayed({page:d,pageSize:a},this,g);this._setSortImage(b,e);}};$z.defModule("rules/_bulk_update",{initialize:function(){var a=$j("#ticket-chat");a.submit(function(b){$j.ajax({url:a.attr("action"),type:"POST",data:a.serialize()+"&background=true",dataType:"json",success:function(c){var d=new Zendesk.JobStatus(c.status_url,{title:"Processing tickets...",renderResult:function(f){var e={title:""+f.results.length+" ticket(s) processed:",body:$j("<ul/>")};if(f.status==="completed"){document.location="/tickets/bulk_result?background="+f.job.id+"&return_to="+escape(document.location);}return e;}});}});$j("#bulk-update").hide();$j("table.tickets th.checkbox input").remove();$j("table.tickets input.tickets_to_bulk_update").remove();return false;});}});$z.defModule("rules/analysis/show",{initialize:function(a){$j("select#analysis-filter").change(function(d){var b=$j("select#analysis-filter option:selected").val();var c=jQuery.queryParameters();var e={filter:c.filter};if(typeof(b)!="undefined"){e.filter=b;}if(typeof(c.select)=="string"){e.select=c.select;}if(typeof(c.key)=="string"){e.key=c.key;}window.location.href=$j(location).attr("protocol")+"//"+$j(location).attr("host")+$j(location).attr("pathname")+"?"+$j.param(e);});}});$z.defModule("rules/edit",{initialize:function(){$j("fieldset.conditions span select").autocompleteFromSelectIfLarge();}});jQuery(function(b){var a=b("#view_output_columns").find(".sortablelist");if(!a.exists()){return;}a.each(function(){b(this).sortableWithEmptyTarget({emptyTargetClass:"item sortable",placeholder:"sortable target",connectWith:a.not(this)});});$j("#result_columns").bind("sortreceive",function(c,d){if($j(this).find("li").size()>11){$j(d.sender).sortable("cancel");}});});$z.defModule("rules/index",{initialize:function(b){var a=function(d,c){return($j(d).html()<$j(c).html())?-1:($j(d).html()>$j(c).html())?1:0;};$j("div#active-rules_sort input.sort_asc").click(function(d){var c=$j("ul#active-rules-sort-list li.item.sortable").sort(function(f,e){return a(f,e);});$j("ul#active-rules-sort-list li.item.sortable").remove();$j("ul#active-rules-sort-list").prepend(c);});$j("div#active-rules_sort input.sort_desc").click(function(d){var c=$j("ul#active-rules-sort-list li.item.sortable").sort(function(f,e){return a(e,f);});$j("ul#active-rules-sort-list li.item.sortable").remove();$j("ul#active-rules-sort-list").prepend(c);});$j("a.cancel-sorting").click(function(c){Ordering.cancelOrdering("div#active-rules");});$j("select#rule-select, select#rule-sort").change(function(f){var d=$j("select#rule-sort option:selected").val();var e=$j("select#rule-select option:selected").val();var g="/rules?";var c=jQuery.queryParameters();var h={filter:c.filter};if(typeof(d)!="undefined"){h.sort=d;}if(typeof(e)!="undefined"){h.select=e;}window.location.href=$j(location).attr("protocol")+"//"+$j(location).attr("host")+g+$j.param(h);});}});$z.defModule("rules/show",{initialize:function(){var a="textarea[id*='ticket_fields'], input[id*='ticket_fields']";var e=$j(a).css("color");$j(a).css("color","gray");$j(a).click(function(){$j(this).css("color",e);});$j(a).blur(function(){if($j(this).val()=="- No change -"){$j(this).css("color","gray");}});var b=$j("th:contains('Subject')");if(b.width()>50){b.css("width",b.width());}else{b.css("width","50px");}var c="textarea#comment_value";var d="p#placeholders_in_comment_notice";$(document).observe("macro:applied",function(){if(($j(c).val().indexOf("{{")>-1)||($j(c).val().indexOf("{%")>-1)){$j(d).show();}else{$j(d).hide();}});}});Zendesk.NS.extend("Satisfaction",{Score:{offered:1,poor:4,good:16},ScoreValue:{"1":"offered","4":"poor","5":"poor","16":"good","17":"good"},Input:{init:function(){if($j(this._rootSelector).length){this._satisfactionButtons=$j("#satisfaction_rating form .rating");this._currentRatingContainer=$j("#current_rating");this._currentRating=this._parseCurrentRating();this._ratingTemplate=$j("#current_rating_template").html();this._form=$j("#satisfaction_rating form");this._app=this._buildSammyApplication(jQuery,this._rootSelector);}},_scoreSpanTemplate:'<span class="rating selected {{scoreKey}}">{{scoreText}}</span>',_ensureVisible:function(){if($j(this._rootSelector).is(":hidden")){if(this._currentRating&&this._currentRating.score>1){this._form.hide();this._renderRating(this._currentRating).show();}else{this._currentRatingContainer.hide();this._form.show();}$j(this._rootSelector).show();}},_parseCurrentRating:function(){var a=$j("#current_rating_data").html();var b=$j("<div />").html(a).text();return JSON.parse(b);},_renderRating:function(c){var a=Zendesk.Satisfaction.ScoreValue[c.score];var b=$j.mustache(this._scoreSpanTemplate,{scoreKey:a,scoreText:I18n.t("txt.satisfaction.score."+a)});var d={header:I18n.t("txt.satisfaction.score.current",{score:b}),commentHeader:I18n.t("txt.satisfaction.header.comment"),showComment:I18n.t("txt.satisfaction.comment.show"),hideComment:I18n.t("txt.satisfaction.comment.hide"),modifyRating:I18n.t("txt.satisfaction.rating.modify"),comment:c.comment,canModify:c["can_modify?"]};return this._currentRatingContainer.html($j.mustache(this._ratingTemplate,d));},_rootSelector:"#satisfaction_rating",_buildSammyApplication:function(b,a){var c=b.sammy(a,function(){this.debug=true;this.before(function(){Zendesk.Satisfaction.Input._ensureVisible();return true;});this.get("#/satisfaction",function(){});this.post(/^\/requests\/.+\/satisfaction/,function(d){var e=Zendesk.Satisfaction.Input._form;jQuery.ajax({url:e.attr("action"),type:e.attr("method").toUpperCase(),data:e.serialize(),dataType:"json",error:function(f,h,g){d.redirect("#/satisfaction/error");},success:function(g,h,f){Zendesk.Satisfaction.Input._currentRating=g;d.trigger("ticket.satisfaction.created",g);d.redirect("#/satisfaction/success");}});});this.get("#/satisfaction/success",function(){Zendesk.Satisfaction.Input._form.hide();Zendesk.Satisfaction.Input._renderRating(Zendesk.Satisfaction.Input._currentRating).show();this.redirect("#/satisfaction");});this.get("#/satisfaction/error",function(){});this.get("#/satisfaction/cancel",function(){Zendesk.Satisfaction.Input._satisfactionButtons.removeClass("selected");if(Zendesk.Satisfaction.Input._currentRating){Zendesk.Satisfaction.Input._form.hide();Zendesk.Satisfaction.Input._currentRatingContainer.show();}else{$j("#satisfaction_form_body").slideUp(500);}});this.get("#/satisfaction/comment/hide",function(){Zendesk.Satisfaction.Input._currentRatingContainer.find(".comment").slideUp().end().find("a.hide_comment").hide().end().find("a.show_comment").show();});this.get("#/satisfaction/comment/show",function(){Zendesk.Satisfaction.Input._currentRatingContainer.find(".comment").slideDown().end().find("a.show_comment").hide().end().find("a.hide_comment").show();});this.before("#/satisfaction/new",function(){Zendesk.Satisfaction.Input._currentRatingContainer.hide();Zendesk.Satisfaction.Input._form.show();});this.get("#/satisfaction/new",function(){});this.get("#/satisfaction/new/:ratingName",function(){var e=this.params.ratingName;var d=Zendesk.Satisfaction.Input._satisfactionButtons.filter("."+e);if(!d.hasClass("selected")){Zendesk.Satisfaction.Input._satisfactionButtons.not(d).removeClass("selected");d.addClass("selected");$j("#satisfaction_form_body:hidden").slideDown(500);$j("#ticket_satisfaction_score").val(Zendesk.Satisfaction.Score[e]);}});});c.run("#/satisfaction");return c;}}});jQuery(function(){Zendesk.Satisfaction.Input.init();});$z.defModule("scheduled_csv_exports/_edit_form",{formIds:["edit_form","edit_form","test_form","delete_form"],initialize:function(){var a=this;$j("#submit_button").click(function(){if($j("#scheduled_csv_export_callback_url").val().include("gooddata.com")!=-1){Zendesk.Instrumentation.ToTango.track("Enabled","GoodData");}if(($j("#scheduled_csv_export_callback_url").val().include("gooddata.com")!=-1)&&($j("#scheduled_csv_export_show_metrics_false").is(":checked"))){alert("If you are using GoodData for Zendesk, please ensure that you have selected 'CSV Content > Full' to export all ticket metrics to your GoodData project.");}else{a.submit();}});$j("#test_form").submit(function(){a.preserveUserInput();});$j("#edit_form").submit(function(){a.handleFireNow();});if($j("#scheduled_csv_export_callback_url").val().include("gooddata.com")&&$j("#scheduled_csv_export_show_metrics_true").is(":checked")){$j("#scheduled_csv_export_show_metrics_false").change(function(){if(!confirm("If you are using GoodData for Zendesk, switching back to Basic CSV Content may delete your advanced reports and metrics. We recommend you use Full CSV Content. Are you sure you want to switch back to basic format?")){$j("#scheduled_csv_export_show_metrics_true").click();}});}a.callbackClick();},updateButtonColor:function(a){var b=(a==3)?"addClass":"removeClass";$j("#submit_button")[b]("negative");},submit:function(){var a=$j("#submit_type").val();var b=$j("#"+this.formIds[a]);b.submit();},preserveUserInput:function(){$j("#test_scheduled_at").val($j("#scheduled_csv_export_hour").val());$j("#test_callback_url").val($j("#scheduled_csv_export_callback_url").val());$j("#test_auth_type").val($j("#edit_form").find("input:checked").val());},handleFireNow:function(){var a=$j("#submit_type").val();if(a==1){this.addFireNow();}},addFireNow:function(){var a=$j("<input>",{type:"hidden",value:"1",name:"scheduled_csv_export[fire_after_save]"});$j("#edit_form").append(a);},callbackClick:function(){$j("#callback_code").click(function(){$j("#callback_pre").slideDown(200);$j("#callback_code").toggle();$j("#callback_show_text").toggle();});$j("#callback_pre").click(function(){$j("#callback_pre").slideUp(200);$j("#callback_code").toggle();$j("#callback_show_text").toggle();});}});Zendesk.NS("Zuora");Zendesk.Zuora.InvoicePage=function(){};Zendesk.Zuora.InvoicePage.prototype={show:function(){var a=this;$j("button[data-invoice-id]").click(function(){var c=$j(this);var d="invoice-items-for-"+c.data("invoice-id");var b=function(){return $j("#"+d).first();};c.find("span").html(b().is(":visible")?"Show":"Hide");if(_.any(b())){b().toggle();return;}$j(c).addClass("activity").prop("disabled",true);$j.ajax({url:"/zuora/invoice/invoice_items.json?invoice_id="+$j(c).data("invoice-id"),success:function(g){var h=a.prepareInvoiceItems(g);var f=$j('<table class="invoice-items">');f.append('<tr><th>Description</th><th class="count">Quantity</th><th class="money">Amount</th><th class="money">Discount</th><th class="money">Total</th></tr>');_.each(h,function(j){var k=j.discountAmount()+j.discountPercentage();var i=$j("<tr>").append($j("<td>").html(j.description()).append($j("<div>").html(j.serviceStartDate()+" to "+j.serviceEndDate()))).append($j("<td>").addClass("count").html(j.quantity()+" Agent(s)")).append($j("<td>").addClass("money").html("$"+j.chargeAmount())).append($j("<td>").addClass("money").html("$"+k)).append($j("<td>").addClass("money").html("$"+j.totalAmount()));f.append(i);});var e=$j(c).closest("tr");e.after($j("<tr>").attr("id",d).append($j("<td colspan=5>").css("background-color",e.find("td").first().css("background-color")).append(f)));$j(c).removeClass("activity").prop("disabled",false);}});});},prepareInvoiceItems:function(a){var c=_.uniq(_.pluck(a,"service_start_date"));var b=_.map(c,function(d){return _.filter(a,function(e){return e.service_start_date==d;});});return _.map(b,function(d){return new Zendesk.Zuora.InvoiceItemRow(d);});}};Zendesk.Zuora.InvoiceItemRow=function(a){this.rawInvoiceItems=a;};Zendesk.Zuora.InvoiceItemRow.prototype={description:function(){return this._charge().charge_name;},serviceStartDate:function(){return $j.datepicker.formatDate("mm-dd-yy",new Date(this.rawInvoiceItems[0].service_start_date));},serviceEndDate:function(){return $j.datepicker.formatDate("mm-dd-yy",new Date(this.rawInvoiceItems[0].service_end_date));},hasDiscount:function(){return _.any(this.rawInvoiceItems,function(a){return a.processing_type=="1";});},discountAmount:function(){if(!this.hasDiscount()){return 0;}return parseFloat(this._discount().charge_amount);},discountPercentage:function(){if(!this.hasDiscount()){return 0;}return" ("+this._discount().unit_price+"%)";},totalAmount:function(){return parseFloat(this.chargeAmount())+parseFloat(this.discountAmount());},chargeAmount:function(){return parseFloat(this._charge().charge_amount).toFixed(2);},perUnitCharge:function(){return parseFloat(this._charge().unit_price).toFixed(2);},quantity:function(){return this._charge().quantity;},_charge:function(){return _.find(this.rawInvoiceItems,function(a){return a.processing_type=="0";});},_discount:function(){return _.find(this.rawInvoiceItems,function(a){return a.processing_type=="1";});}};jQuery(function(D){var e=D("form#subscription_settings");if(e.length===0){return;}var a={1:"monthly",2:"quarterly",3:"biannually",4:"annually"};var P=[null,"small","medium","large","extra_large"];var u=JSON.parse(D("#plan_data").html());_(JSON.parse(D("#billing_cycle_labels").html())).each(function(U,T){u[T].billingCycleLabels=_(U);});_(u).each(function(T,U){U=parseInt(U,10);if(isNaN(U)){return;}T.id=U;T.className=P[U];u[U]=u[T.className]=T;});var O,Q;O=Q=u[e.data("plan-type")||3];var L=(currentAccount.isPayingCustomer);var I=e.find("#subscription_plan_type"),z=e.find("#subscription_max_agents"),o=e.find("#subscription_max_agents_error"),m=e.find("#subscription_billing_cycle_type"),t=e.find("#coupon_code"),p=e.find("#voice_optin"),r=e.find("#voice_transcription_optin"),M=e.find(".voice_option .pricing"),N=e.find(".voice_transcription_optin .pricing"),f=e.find(".voice_transcription_optin"),h=e.find("#coupon_code_error"),S=e.find("#coupon_expiry"),x=e.find("#subtotal"),j=e.find("#discount"),E=e.find("#coupon_discount"),B=e.find("#total"),w=e.find("#billing_period .period"),H=e.find("#after_coupon_expiry"),g=e.find(".button.save"),k=e.find("#cancel_warning"),R=e.find("#terms_agree");p.change(function(){var T=D(this);if(T.prop("checked")){M.addClass("active");r.attr("disabled",false);f.removeClass("disabled");}else{M.removeClass("active");r.attr("disabled",true);f.addClass("disabled");}});r.change(function(){var T=D(this);if(T.prop("checked")){N.addClass("active");}else{N.removeClass("active");}});if(!p.is(":checked")){r.attr("disabled",true);f.addClass("disabled");}function y(){return currentAccount.isPayingCustomer&&!currentAccount.isInTrial&&Q&&O&&Q.id<O.id;}function G(){return parseInt(z.val(),10);}function J(T){if(Q.restricted_to_annual_billing){m.val(4);$j(".billing_cycle_input").hide();return;}var U=m.val();m.find("option").remove();Q.billingCycleLabels.each(function(V,W){m.append('<option value="'+W+'">'+V+"</option>");});m.val(U);$j(".billing_cycle_input").show();}function C(T){return"$"+addCommas(T.toFixed(2));}function q(T){if(T.immutable_coupon_code){t.attr("disabled",true);}else{t.removeAttr("disabled");}t.val(T.coupon_code);x.html(C(T.cycle_undiscounted_price));j.html("-&nbsp;"+C(T.cycle_discount_no_coupon));E.html("-&nbsp;"+C(T.cycle_coupon_discount));B.html(C(T.cycle_discounted_price));h.toggle(T.coupon_error!=null).html(T.coupon_error);S.toggle(T.coupon_expires_on!=null).html("Through "+T.coupon_expires_on);H.toggle(T.coupon_expires_on!=null).find(".value").html(C(T.cycle_undiscounted_price-T.cycle_discount_no_coupon));}function K(){var U=G(),T;if(isNaN(U)){T=I18n.t("txt.admin.public.javascripts.views.settings.account.oops_number_of_agents_is_Required");}else{if(U<Q.max_agent_floor){T=I18n.t("txt.admin.public.javascripts.views.settings.account.oops_this_plan_requires_at_least",{number_of_agents:Q.max_agent_floor});}else{if(U>Q.max_agent_ceiling){T=I18n.t("txt.admin.public.javascripts.views.settings.account.oops_this_plan_allows_no_more_than",{number_of_agents:Q.max_agent_ceiling});}}}o.toggle(!!T).html(T);return !T;}function s(){return K();}function F(){if(isNaN(G())){return;}var T=false;setTimeout(function(){if(!T){e.addClass("recalculating");g.prop("disabled",true);}},200);D.getJSON("/account/subscription/calculate",e.serialize()).done(q).always(function(){T=true;e.removeClass("recalculating");g.prop("disabled",false);});}function l(){w.html(a[m.val()]);}function n(){return"/account/subscription/confirm?subscription[plan_type]="+I.val()+"&subscription[max_agents]="+G()+"&subscription[billing_cycle_type]="+m.val()+"&coupon_code="+t.val()+"&voice_optin="+(p.is(":checked")?"1":"0")+"&voice_transcription_optin="+(r.is(":checked")?"1":"0");}function b(){var T=this;D("#colorbox").find("#terms_agree").change(function(){var U=D(this).is(":checked");D(this).closest("form").find("footer input").prop("disabled",!U);R.val(U);}).end().find("#cboxClose,.close").click(function(){T.trigger("confirmation-dismissed");return false;}).end().find("form").submit(function(){T.trigger("update-confirmed");return false;});}function c(){this.redirect("#subscription","plan",Q.className);}function i(){if(Q.fixed_agent_count){D(".max_agent_input").hide();}else{D(".max_agent_input").show();}}function A(){z.val(Math.min(G(),Q.max_agent_ceiling));i();}function v(T){if(T=="small"){$j(".causeware").show();}else{$j(".causeware").hide();}}var d=D.sammy("#subscription_settings",function(){this.bind("update-confirmed",function(){D.colorbox.close();e.trigger("submit",{confirmed:true});});this.bind("confirmation-dismissed",function(){D.colorbox.close();this.redirect("#subscription","plan",Q.className);});this.get("#subscription/plan/:size",function(){var T=this.params.size;e.removeClass(P.join(" ")).addClass(T);v(T);Q=u[T];I.val(Q.id);A();s();J(T);l();F();});this.get("#subscription/cancel",function(){k.show();});this.get("#subscription/confirmUpdate",function(){D.colorbox({href:n(),width:"600px",maxWidth:"600px",onComplete:D.proxy(b,this),onCleanup:D.proxy(c,this)});});this.get(/#\/?subscription\/?$/,function(){this.redirect("#subscription","plan",Q.className);});});z.change(s);z.add(m).change(F);m.change(l);t.blur(F);e.submit(function(T,U){U=U||{};if(D(this).hasClass("recalculating")){return false;}if(!s()){return false;}if(y()){window.location=e.data("downgrade-url")+"?"+e.serialize();return false;}if(L&&!U.confirmed){d.setLocation("#subscription/confirmUpdate");return false;}});d.run("#/subscription");l();Zendesk.Instrumentation.ToTango.track("Subscription","Load");});$z.defModule("settings/extensions/show",{initialize:function(a){$j("#crm_integration").change(function(){var b=$j(this).val();if(b=="SalesforceIntegration"){$j("#sugar, #ms_dynamics").hide();$j("#salesforce").show();}else{if(b=="SugarCrmIntegration"){$j("#salesforce, #ms_dynamics").hide();$j("#sugar").show();}else{if(b=="MsDynamicsIntegration"){$j("#salesforce, #sugar").hide();$j("#ms_dynamics").show();}}}});$j("#ms_dynamics_integration_type_code").change(function(){$j(".ms_dynamics_on_premise").toggle();$j(".ms_dynamics_on_cloud").toggle();});if($j("#ms_dynamics_form").data("on-premise")){$j(".ms_dynamics_on_premise").show();$j(".ms_dynamics_on_cloud").hide();}else{$j(".ms_dynamics_on_premise").hide();$j(".ms_dynamics_on_cloud").show();}$j("#settings_extensions_ms_dynamics_save_button").click(function(){$j(this).val(I18n.t("txt.admin.public.javascript.views.settings.extensions.testing_connection_please_wait")).prop("disabled",true);$j("#ms_dynamics_form").submit();});$j("#settings_extensions_sugar_crm_save_button").click(function(){$j(this).val(I18n.t("txt.admin.public.javascript.views.settings.extensions.testing_connection_please_wait")).prop("disabled",true);$j("#sugar_crm_form").submit();});$j("#settings_extensions_salesforce_connect_button").click(function(){Zendesk.Instrumentation.ToTango.track("Enabling salesforce.com","CRM");document.location.href="/settings/extensions/connect_to_salesforce?salesforce_environment="+$j("select#salesforce_environment option:selected").val();});}});Zendesk.NS("Screenr");Zendesk.Screenr.Provisioning={init:function(b,c,a){Zendesk.Screenr.Provisioning.requestedDomain=b;Zendesk.Screenr.Provisioning.scope=a;this.bindCheckBox(c);this.bindProvisioningForm();},requestedDomain:"",triggeringCheckBoxId:"",scope:"",bindCheckBox:function(a){$j(a).click(function(b){this.showProvisioningModal();b.preventDefault();}.bind(this));Zendesk.Screenr.Provisioning.triggeringCheckBoxId=a;},showProvisioningModal:function(){$j.colorbox({inline:true,href:"#screenr_provisioning",width:"620px",onComplete:function(){$j("#screenr_provisioning  #domain").focus();},onClosed:function(){Zendesk.Screenr.Provisioning._removeError();}});},bindProvisioningForm:function(){$j("#screenr_provisioning form").submit(function(a){a.preventDefault();this.onSubmit();}.bind(this));},onSubmit:function(){Zendesk.Screenr.Provisioning._disableSubmitButton();Zendesk.Screenr.Provisioning._removeError();Zendesk.Screenr.Provisioning._enqueueProvisioning();},_enqueueProvisioning:function(){if(this.poller){this.poller.stop();}$j("#provisioning_spinner").show();$j.ajax({type:"POST",url:"/screenr_tenants",data:{domain:Zendesk.Screenr.Provisioning.requestedDomain,scope:Zendesk.Screenr.Provisioning.scope},success:this._startPoller.bind(this)});},_startPoller:function(a){var b={url:a.status_url,type:"GET",dataType:"json"};this.poller=new Zendesk.Utils.Poller(b,1000,20000,this._pollingCallback.bind(this),this._errorCallback.bind(this),this._timeoutCallback.bind(this));this.poller.start();},_pollingCallback:function(a){switch(a.status){case"completed":this._onCompletedPolling(a.results);break;case"failed":this._errorCallback(this);break;case"killed":this._errorCallback(this);break;default:return true;}},_onCompletedPolling:function(a){switch(a.api_status){case"provisioned":this._onSucessfulProvisioning();break;case"validation_failed":this._onValidationFailed(a.message,a.error_on);break;default:this._errorCallback(this);}},_onSucessfulProvisioning:function(){$j("#provisioning_spinner").hide();var e=I18n.t("public.javascripts.views.settings.screencasts.screenr_account_created"),a=I18n.t("public.javascripts.views.settings.screencasts.close_window_button"),f=I18n.t("public.javascripts.views.settings.screencasts.final_feedback"),g=$j('<div class="info">'),d=$j("<p>"),c=$j('<div class="submit">'),b=$j('<input class="button" name="commit" type="submit"/>');$j("#screenr_provisioning").html("");g.html("&#10004;&nbsp; "+e).appendTo($j("#screenr_provisioning"));d.html(f).appendTo($j("#screencasts_wrapper"));b.attr("value",a).appendTo(c).click(function(h){$j.colorbox.close();d.effect("highlight",{},3000);}.bind(this));c.appendTo($j("#screenr_provisioning"));Zendesk.Screenr.Provisioning._setTriggeringCheckboxAsChecked(Zendesk.Screenr.Provisioning.triggeringCheckBoxId);$j.colorbox.resize();_.defer(function(){$j.colorbox.resize();});},_setTriggeringCheckboxAsChecked:function(a){$j(a).attr("checked",true).unbind().click(function(b){b.preventDefault();});},_onValidationFailed:function(a,b){this._displayError(a);$j("#provisioning_spinner").hide();this._enableSubmitButton();},_errorCallback:function(a){this._displayError(I18n.t("public.javascripts.views.settings.screencasts.screenr_unavailable"));$j("#provisioning_spinner").hide();this._enableSubmitButton();},_timeoutCallback:function(a){this._displayError(I18n.t("public.javascripts.views.settings.screencasts.screenr_unavailable"));$j("#provisioning_spinner").hide();this._enableSubmitButton();},_displayError:function(a){$j(".error").html(a).show();$j.colorbox.resize();_.defer(function(){$j.colorbox.resize();});},_removeError:function(){$j(".error").hide();$j.colorbox.resize();_.defer(function(){$j.colorbox.resize();});},_disableSubmitButton:function(){$j("#screenr_provisioning .button").attr("disabled","disabled");},_enableSubmitButton:function(){$j("#screenr_provisioning .button").removeAttr("disabled");}};Zendesk.NS("Alerts");Zendesk.Alerts={showTwitterAuthorization:function(){var a="twitter_authorization_failure";var b=_.select(currentAccount.twitterAccounts,function(c){if(c.screen_name!=null){return c.authorized==false;}});if(_.size(b)>0){$j("#flash").append(this.renderTwitterAuthorization(b));new Zendesk.AlertManager("#"+a,this.cookieName(a)).show();}},showFacebookAuthorization:function(){var a="facebook_authorization_failure";var b=_.select(currentAccount.facebookPages,function(c){return c.unauthorized;});if(_.size(b)>0){$j("#flash").append(this.renderFacebookAuthorization(b));new Zendesk.AlertManager("#"+a,this.cookieName(a)).show();}},showPasswordExpiration:function(){var a="password_expiration";if(currentUser.isPasswordExpiring()){$j("#flash").append(this.renderPasswordExpiration(a));new Zendesk.AlertManager("#"+a,this.cookieName(a)).show();}},showSystemNotice:function(a){new Zendesk.AlertManager("#alert",a).show();},cookieName:function(a){return"accounts."+currentAccount.id+"."+a;},renderTwitterAuthorization:function(d){var b=I18n.t("txt.admin.public.javascripts.views.shared._alert.your_account_no_longer");var a=I18n.t("txt.admin.public.javascripts.views.shared._alert.reauthorize_twitter");var c='<div id="twitter_authorization_failure" style="display:none" class="alert">'+b+"<ul>        {{#accounts}}        <li>{{screen_name}}</li>        {{/accounts}}      </ul>"+a;return jQuery.mustache(c,{accounts:d});},renderFacebookAuthorization:function(b){var a='<div id="facebook_authorization_failure" style="display:none" class="alert">      Your account no longer has sufficient permissions to convert Facebook wall posts from:      <ul>        {{#pages}}        <li>{{name}} - <span class="facebook_authorization_failure_reason">{{reason_for_unauthorization}}</span></li>        {{/pages}}      </ul>      <a href="/facebook/settings">Reauthorize with Facebook</a> to continue converting wall posts.      Or <a class="close" href="#">hide this notice</a>.</div>';return jQuery.mustache(a,{pages:b});},renderPasswordExpiration:function(c){var a='<div id="password_expiration" style="display:none" class="alert">{{{message}}}      <a style="margin-left:10px" id="hide_expiration" class="close" href="#">hide this notice</a></div>';var b=I18n.t("txt.security_policy.expiration_alert",{count:i18n_distance_of_time_in_words(currentUser.passwordExpiresAt,new Date()),url:"/password"});return jQuery.mustache(a,{message:b});}};$z.defModule("shared/_help_container",{initialize:function(){$j("span.question-link").click(function(){$j(this).nextAll(".help-bubble").slideToggle(50);});$j("span.question-link img").hover(function(){$j(this).attr("src","/images/question-hover.png");},function(){$j(this).attr("src","/images/question.png");});}});zd.jsInitializers.push(["shared/_help_container",[]]);if(!Zendesk){Zendesk={};}if(!Zendesk.UI){Zendesk.UI={};}Zendesk.UI.MacroList={MAX_RESULTS:20,initialize:function(b,c,d){var a=this;a.root=$j(d);a.macro_search_enabled=c;$j(document).bind("keydown","ctrl+m",a.toggle_macro_menu_with_key_combo());$j("form#ticket-chat").find("input,textarea,select").bind("keydown","ctrl+m",a.toggle_macro_menu_with_key_combo());$j(document).keydown(a.escape_close());if(c){a.search_results=a.root.find("ul.search_results");a.nested_macros=a.root.find("ul.first-drop > li");a.root.data("cache",{"":{results:[],max_index:0}});a.root.data("full_results",$j.map(b,function(f,e){return(e);}));a.macros=b;a.root.data("macro_list",a.root.find("ul.search_results li.search_result"));a.add_apply_macro();a.root.data("input",$j(d+"_search"));a.root.find("ul.drop-list li ul.first-drop div.search img.clear").click(function(e){a.clear();});a.root.find("ul.drop-list li ul.first-drop ul.search_results li.no_results div.explain p.try_again a.clear_search").click(function(e){a.clear();});a.root.data("input").bind("keydown",a.escape_clear()).bind("keyup change",a.on_text_changed(d,a.root.data("cache"),a.root.data("full_results"),b,a.root.data("macro_list")));a.root.find("ul.drop-list > li").click(function(e){a.root.data("input").focus();});a.root.data("input").keydown(a.advance_on_key(38,-1)).keydown(a.advance_on_key(40,1)).keydown(a.select_with_enter());}},select_with_enter:function(){var a=this;return(function(c){var b=a.search_results.data("selection");if(c.keyCode===13&&(b!==undefined)){c.preventDefault();c.stopPropagation();a.root.data("macro_list").eq(b).click();}});},advance_on_key:function(c,b){var a=this;return(function(d){if(d.keyCode===c){d.stopPropagation();d.preventDefault();a.advance_selection(b);}});},advance_selection:function(c){var b=this;var e=(typeof(b.root.data("search_term"))!=="undefined")?b.root.data("search_term"):"";var a=b.root.data("cache")[e];if(a.results.length>0){c%=a.max_index;var d=((typeof(b.search_results.data("selection_index"))==="undefined")?0:b.search_results.data("selection_index")+c+a.max_index)%a.max_index;b.select(d);}},select:function(d){var b=this;var c=b.search_results.data("selection");var e=(typeof(b.root.data("search_term"))!=="undefined")?b.root.data("search_term"):"";var a=b.root.data("cache")[e].results;if(typeof(c)!=="undefined"){b.root.data("macro_list").eq(c).removeClass("selected");}if(typeof(d)==="number"&&d>=0){b.search_results.data("selection_index",d);b.search_results.data("selection",a[d]);b.root.data("macro_list").eq(a[d]).addClass("selected");}else{b.search_results.data("selection",null);}},toggle_macro_menu_with_key_combo:function(){var a=this;var b=a.root.find("ul.first-drop");return(function(c){c.stopPropagation();c.preventDefault();if(b.css("display")==="none"){a.open_macro_menu();}else{a.close_macro_menu();}});},close_macro_menu:function(){var a=this;a.root.find("ul.first-drop").hide();if(a.macro_search_enabled){a.clear();}},open_macro_menu:function(){var a=this;a.root.find("ul.first-drop").show();if(a.macro_search_enabled){a.root.data("input").focus();}},clear:function(){var a=this;a.root.data("input").val("");a.root.data("input").change();},escape_close:function(){var a=this;return(function(b){if(b.keyCode===27){a.close_macro_menu();}});},escape_clear:function(){var a=this;return(function(b){if(b.keyCode===27){b.preventDefault();if($j.trim($j(this).val())!==""){b.stopPropagation();a.clear();}}});},on_text_changed:function(c,a,f,h,e){var l=this;var j=l.root.find("ul.search_results li.no_results");var b=j.find("span.search_term");var g=l.root.find("ul.drop-list li ul.first-drop div.search img.search");var k=l.root.find("ul.drop-list li ul.first-drop div.search img.clear");var d=function(m,n){return(h[m].label.replace(n,'<span class="highlight">$1</span>'));};var i=function(m,n){e.eq(m).find(" > a").html(n);};return(function(o){var m=(typeof(l.root.data("search_term"))!=="undefined")?l.root.data("search_term"):"";var q=a[m];var p=$j.trim($j(this).val());l.root.data("search_term",p);var s=function(B,y){if(typeof(y)==="undefined"){y=false;}var z=$j.ui.autocomplete.escapeRegex(p);var D=RegExp(z,"i");var u=RegExp("("+z+")","gi");var w;var C=0;var v=[];var A=[];if(y){for(var x=0;x<q.max_index;x++){e.eq(q.results[x]).hide();}for(;v.length<l.MAX_RESULTS&&C<B.length;C++){if(h[B[C]].label!==(w=d(B[C],u))){v.push(B[C]);A.push(w);i(B[C],w);e.eq(B[C]).show();}}}else{for(;v.length<l.MAX_RESULTS&&C<B.length;C++){if(h[B[C]].label===(w=d(B[C],u))){e.eq(B[C]).hide();}else{v.push(B[C]);A.push(w);i(B[C],w);e.eq(B[C]).show();}}for(;B[C]<q.results[q.max_index];C++){e.eq(B[C]).hide();if(D.test(h[B[C]].label)){v.push(B[C]);}}}for(;C<B.length;C++){if(D.test(h[B[C]].label)){v.push(B[C]);}}a[p]={max_index:Math.min.apply(Math,[v.length,l.MAX_RESULTS]),regex:D,results:v,highlights:A};};if(p!==m){if(p.length===0){k.hide();g.show();l.search_results.hide();l.nested_macros.show();for(var n=0;n<q.max_index;n++){e.eq(q.results[n]).hide();}}else{if(m.length===0){g.hide();k.show();l.nested_macros.hide();l.search_results.show();}var r=0,t=0;if(m.length>0&&p.length>m.length&&q.regex.test(p)){if(typeof(a[p])==="object"&&a[p].max_index>0){if(q.results[q.max_index-1]<a[p].results[a[p].max_index-1]){for(;r<q.max_index;r++){if(q.results[r]<a[p].results[t]){e.eq(q.results[r]).hide();}else{i(a[p].results[t],a[p].highlights[t]);t++;}}for(;t<a[p].max_index;t++){i(a[p].results[t],a[p].highlights[t]);e.eq(a[p].results[t]).show();}}else{for(;a[p].results[t]<=q.results[q.max_index-1];t++){i(a[p].results[t],a[p].highlights[t]);for(;q.results[r]<a[p].results[t];r++){e.eq(q.results[r]).hide();}if(q.results[r]===a[p].results[t]){r++;}}for(;r<q.max_index;r++){e.eq(q.results[r]).hide();}}}else{s(q.results,false);}}else{if(typeof(a[p])==="object"){for(r=0,t=0;r<q.max_index&&t<a[p].max_index;){if(q.results[r]<a[p].results[t]){e.eq(q.results[r]).hide();r++;}else{if(q.results[r]>a[p].results[t]){i(a[p].results[t],a[p].highlights[t]);e.eq(a[p].results[t]).show();t++;}else{i(a[p].results[t],a[p].highlights[t]);t++;r++;}}}if(r===q.max_index){for(;t<a[p].max_index;t++){i(a[p].results[t],a[p].highlights[t]);e.eq(a[p].results[t]).show();}}if(t===a[p].max_index){for(;r<q.max_index;r++){e.eq(q.results[r]).hide();}}}else{s(f,true);}}if(a[p].results.length>0){l.select(0);if(q.results.length===0){j.hide();}}else{l.select();b.html(p);if(q.results.length>0||m.length===0){j.show();}}}}});},add_apply_macro:function(b){var a=this;a.root.find("ul.search_results li.search_result").each(function(c,e){var d=a.macros[c].value;if(Number(d)>=0){$j(e).click(function(f){var g=$j("#ticket-chat");if(typeof(ticket_id)==="undefined"){var h=0;}else{var h=ticket_id;}if(jQuery("#tickets_to_bulk_update",g).length>0){new Zendesk.API.Macro(d).applyToTicket(null,g);}else{new Zendesk.API.Macro(d).applyToTicket(h,g);}$j(this).fadeOut("fast").fadeIn("fast",function(){a.clear();a.root.find("ul.drop-list li ul.first-drop").hide();});});}});}};$z.defModule("shared/_macro_list",{initialize:function(a,b,c){Zendesk.UI.MacroList.initialize(a,b,c);}});(function(f,g){var a,j,d,b,e;function h(o){var p=j.not(o);var n=o.attr("href");var l=b.filter(n);var m=b.not(l);p.removeClass("current");m.hide();o.addClass("current");l.show();e.forceRedraw();}function c(){f.history.init(function(m){var l=j.filter('[href="#'+m+'"]');if(l.length===0){l=j.first();}h(l);});}function i(){f(window).bind("popstate:tabs",function(l){c();});j.click(function(l){var m=f(this).attr("href").replace(/^.*#/,"");f.history.load(m);l.preventDefault();});}function k(l){a=f(l||".tabbed_container");j=f(".tab_links a",a);d=f(".tab_links",a);b=f(".tabs_content .tabs_canvas > div",a);e=f(".tabs_content .tabs_canvas",a).siblings();i();c();}g.NS.extend("TabbedContainer",{init:function(l){k(l);},destroy:function(){f(window).unbind("popstate:tabs");}});f(document).ready(function(){if(f("div.tabbed_container[mode!='static']").length>0){g.TabbedContainer.init();}});}(window.jQuery,window.Zendesk));Zendesk.TabbedContainer.SammyApp=function(a){a=a||{};this.container=a.root||".sammy_tabbed_container";this.links=$j(".tab_links a",this.container);this.contentContainers=$j(".tabs_content .tabs_canvas > div",this.container);this.app=this._createSammyApp();this.PATH_NAME_MATCHER=/:([\w\d]+)/g;this.PATH_REPLACER="([^/]+)";};Zendesk.TabbedContainer.SammyApp.prototype={init:function(){this.app.disable_push_state=true;this.app.run();},extractParams:function(c,b,f){var a=this,e,d={};$j.each(b,function(g,h){if(f[g]){d[f[g].slice(1)]=a._decode(h);}else{if(!d.splat){d.splat=[];}d.splat.push(a._decode(h));}});return d;},selectTab:function(a){var c="#"+a,b=this.links.filter('[href="'+c+'"]');if(b.length===0||b.hasClass("current")){return;}this.links.removeClass("current");b.addClass("current");this.contentContainers.hide().filter(c).show();},_createSammyApp:function(){var a=this;return $j.sammy(this.container,function(b){this.helpers({matchPath:function(e,c){var f=c.match(a.PATH_NAME_MATCHER)||[],d;c=new RegExp(c.replace(a.PATH_NAME_MATCHER,a.PATH_REPLACER)+"$");if(!(d=e.match(c))){return;}return a.extractParams(e,d.slice(1),f);}});this.get(/\#([\w\d]*)[\/]?(.*)/,function(){var c=this.params.splat[1],d=this.params.splat[0];a.selectTab(d);this.trigger("tab-changed",{tabID:d,path:this.path,subPath:c});});this.get("",function(){b.setLocation(a.links.first().attr("href"));});});},_decode:function(a){return decodeURIComponent((a||"").replace(/\+/g," "));}};$z.defModule("shared/_tickets_table",{initialize:function(){$j("input.tickets_to_bulk_update").enableCheckboxRangeSelection();}});(function(a){a.fn.enableCheckboxRangeSelection=function(){var c=null;var b=this;b.unbind("click.checkboxrange");b.bind("click.checkboxrange",function(d){if(c!=null&&(d.shiftKey||d.metaKey)){b.slice(Math.min(b.index(c),b.index(d.target)),Math.max(b.index(c),b.index(d.target))+1).attr({checked:d.target.checked?"checked":""});}c=d.target;});};})(jQuery);zd.jsInitializers.push(["shared/_tickets_table",[]]);$z.defModule("tabindex",{addtabindexes:function(){var a=Array.prototype.slice.call(arguments);var b=a.slice(-1)[0];if(typeof(b)==="number"){a.pop();}else{b=1;}$j(a).each(function(d,c){$j(c).each(function(e,f){$j(f).attr({tabindex:b++});});});}});$z.defModule("tags/show",{initialize:function(){},showTagJobStatus:function(a){var b=a.responseJSON;var c=new Zendesk.JobStatus(b.status_url,{title:"Processing tags...",renderResult:function(e){var d={title:""+e.results.total+" tag(s) processed:",body:$j("<ul/>")};if(e.status==="completed"){document.location="/tags/bulk_result?background="+e.job.id;}return d;}});}});$z.defModule("ticket_fields/_list_for_index",{initialize:function(a){$j("a.cancel-sorting").click(function(b){Ordering.cancelOrdering("div#fields");});}});$z.defModule("ticket_fields/_field_tagger",{initialize:function(b){var a=$z("ticket_fields/_field_tagger");$j("fieldset.conditions a").live("click",function(c){c.preventDefault();$j(this).closest("fieldset.conditions").hide().append("<input type='hidden' name='ticket_field[custom_field_options_attributes][][_destroy]' value='1' />");return false;});$j(".customFieldName").live("blur",function(){var d=$j(this).closest("fieldset.conditions").find(".customFieldValue");if(d.val()===""){var c=$j(this).val().replace(/[^A-Za-z0-9]+/g,"_").toLowerCase();d.val(c);}});$j("fieldset.conditions.add").click(function(c){c.preventDefault();a.insertOptionRow("","","");return false;});b&&b.each(function(c){a.insertOptionRow(c);});},insertOptionRow:function(c){var a=$z("ticket_fields/_field_tagger");c.markedForDeletion=c.markedForDeletion||false;c.index=a._nextIndex();var b=$j.mustache(a.optionRowTemplate(),c);if(c.markedForDeletion){b.hide();}a.optionsContainer().append(b);},optionsContainer:function(){return $j("#optionsContainer");},optionRowTemplate:function(){var a=$z("ticket_fields/_field_tagger");if(a._optionRowTemplate){return a._optionRowTemplate;}a._optionRowTemplate=$j("#custom-field-fieldset-template").html();return a._optionRowTemplate;},_nextIndex:function(){this._nextFieldsetIndex=(this._nextFieldsetIndex||-1)+1;return this._nextFieldsetIndex;}});$z.defModule("tickets/_editable_notes",{initialize:function(b,a){button=$j("#"+b+"-submit");button.click(function(c){data=$j("#"+b+"-form").serialize();data._method="put";jQuery.post(a,data);InputTracking.trackedElements=[];});$j("#"+b+"-link-show").click(function(){$j("div#"+b+"-edit").toggle();$j("div#"+b+"-show").toggle();});}});Zendesk.NS("Screenr");Zendesk.Screenr.TicketRecorder={recorder:null,screencasts:null,counter:0,domainUrl:null,removeI18n:"",screencastI18nName:"",SCREENCAST_IFRAME_WIDTH:570,SCREENCAST_IFRAME_HEIGHT:340,COLORBOX_WIDTH:620,COLORBOX_HEIGHT:425,COMMENT_HEIGHT:115,init:function(d,b){this.domainUrl=b;this.screencasts=[];this.removeI18n=I18n.t("txt.user.public.javascripts.views.tickets._screencast.remove");this.screencastI18nName=I18n.t("txt.user.public.javascripts.views.tickets._screencast.screencast_name");$j.getScript(this._urlToScreenrLibray()).done(this._onScreenrLoadedFunction(d));$j("a[href='javascript:void']").click(function(e){e.preventDefault();e.returnValue=false;});var a=submitTicketForm;submitTicketForm=function(){Zendesk.Screenr.TicketRecorder._injectScreencasts($j("#ticket-chat"));a();};var c=submitRequestForm;submitRequestForm=function(){Zendesk.Screenr.TicketRecorder._injectScreencasts($j("#ticketform"));c();};if($j("#latest_comment").length>0){this.populateScreencastLastestComment();}if($j("#history .item").length>0){Zendesk.Screenr.TicketRecorder.populateScreencastsInEventList();}},populateScreencastsInEventList:function(){$j("#history .item").each(function(){var a=$j(this),b,c;b=a.attr("id").replace(/^event_/g,"");c=$j("#screencasts_for_"+b);Zendesk.Screenr.TicketRecorder._transformLinkIntoStyledList(a,c);});},_onScreenrLoadedFunction:function(b){var a=this;return function(c,d){a.setUpScreenr(b);};},setUpScreenr:function(b){var a=Screenr.Recorder({id:b,hideAllFields:true});a.attachTo("screenr_link");a.setUserName("",false);a.setUserEmail("",false);a.setSubject("",false);a.setDescription("",false);a.setOnCancel(function(c){});a.setOnComplete(function(c){this._onRecordingCompleted(c);}.bind(this));this.recorder=a;},populateScreencastLastestComment:function(){var a=$j("#latest_comment"),b=a.find(".recorded_screencasts_list").first();Zendesk.Screenr.TicketRecorder._transformLinkIntoStyledList(a,b);},_transformLinkIntoStyledList:function(a,d){var e=[],c,b;a.find("a").each(function(){if(Zendesk.Screenr.TicketRecorder._isLinkToScreencast(this)){var g=this.href,h=this.href.match(/([^\/]+)$/g).first(),f=this.previousSibling.wholeText.match(/\d+/g).first();e.push({id:h,url:g,position:f});$j(this.previousSibling).remove();$j(this).prev().remove();$j(this).remove();}});c=this._fectchCommentNode(a);$j.each(e,function(){b=Zendesk.Screenr.TicketRecorder._UIstyledListItemButton(this,c);b.appendTo(d);});},_fectchCommentNode:function(a){if(a.find("#comment_full").size()!==0){var b=a.find("#comment_full").first().clone();b.show();b.find(".link").last().hide();return b;}if(a.find(".say").size()!==0){return a.find(".say").first().clone();}return $j(a.first().html());},_isLinkToScreencast:function(c){var b=Zendesk.Screenr.TicketRecorder.screencastI18nName,a=(c.previousSibling!=null)&&(typeof(c.previousSibling.wholeText)!="undefined")&&(c.previousSibling.wholeText.match(b)!=null),d=(c.href.match(Zendesk.Screenr.TicketRecorder._screenrBaseDomain())!=null);return d&&a;},_UIstyledListItemButton:function(a,g,e){var f=a.id,e=e||false,c=$j("<li/>"),b=$j('<a href="javascript:void"/>'),d=$j('<a href="javascript:void" class="remove"/>');c.attr("id","screencast-"+f);c.append(b);b.text(Zendesk.Screenr.TicketRecorder.screencastI18nName+a.position).click(function(h){Zendesk.Screenr.TicketRecorder.showScreencast(a.url,g);});if(e){d.html(Zendesk.Screenr.TicketRecorder.removeI18n).click(function(h){Zendesk.Screenr.TicketRecorder.removeScreencast(f);});c.append(d);}return c;},removeScreencast:function(a){this.screencasts=this.screencasts.reject(function(b){return b.id==a;});$j("#screencast-"+a).remove();},showScreencast:function(b,h){var c=$j('<iframe frameborder="0"/>'),f=$j('<div id="screencast_preview" />'),g=$j('<div id="screencast_preview_wrapper" style="display:none"/>'),d=$j('<div id="comment_wrapper" />'),a=$j('<div id="video_wrapper" />'),e;c.attr("src",b);c.attr("width",Zendesk.Screenr.TicketRecorder.SCREENCAST_IFRAME_WIDTH);c.attr("height",Zendesk.Screenr.TicketRecorder.SCREENCAST_IFRAME_HEIGHT);c.attr("style","width:"+Zendesk.Screenr.TicketRecorder.SCREENCAST_IFRAME_WIDTH+"px;height:"+Zendesk.Screenr.TicketRecorder.SCREENCAST_IFRAME_HEIGHT+"px;");c.appendTo(a);a.appendTo(f);if(h==null){e=Zendesk.Screenr.TicketRecorder.COLORBOX_HEIGHT;}else{e=Zendesk.Screenr.TicketRecorder.COLORBOX_HEIGHT+Zendesk.Screenr.TicketRecorder.COMMENT_HEIGHT;h.appendTo(d);d.appendTo(f);}f.appendTo(g);g.appendTo($j("#screencasts"));$j.colorbox({inline:true,href:"#screencast_preview",width:Zendesk.Screenr.TicketRecorder.COLORBOX_WIDTH+"px",height:e+"px",onClosed:function(){$j("#screencast_preview_wrapper").remove();}});},_publicUrlToScreencast:function(a){return(this._host_with_protocol(Zendesk.Screenr.TicketRecorder.domainUrl)+"/embed/"+a);},_injectScreencasts:function(b){var c="",a=$j('<input type="hidden" name="screencasts_as_text"/>');$j.each(Zendesk.Screenr.TicketRecorder.screencasts,function(){c+=Zendesk.Screenr.TicketRecorder.screencastI18nName+this.position+": "+this.url+"\n";});a.attr("value",c);a.appendTo(b);},_onRecordingCompleted:function(b){var d,c,a;this.counter++;d=b.id;a={id:d,url:Zendesk.Screenr.TicketRecorder._publicUrlToScreencast(d),position:this.counter};this.screencasts.push(a);c=Zendesk.Screenr.TicketRecorder._UIstyledListItemButton(a,null,true);c.appendTo($j("#screencasts_list"));c.effect("highlight",{},800);},_urlToScreenrLibray:function(){return(this._host_with_protocol(this.domainUrl)+"/api/recorder");},_screenrBaseDomain:function(){return(this.domainUrl.replace(/^[^.]+./g,""));},_host_with_protocol:function(b){var a=b.replace(/.*?:\/\//g,""),c=(("https:"==this._protocol())?"https://":"http://");return(c+a);},_protocol:function(){return(document.location.protocol);}};$z.defModule("tickets/_user_details",{initialize:function(a){$j.ajax({url:"/monitor/children/find_for_user?user_id="+a,dataType:"json",success:$j.proxy(function(b){if(b.length>0){this.buildAccountList(b);}},this)});},buildAccountList:function(d){var a=$j("#account-stats");var e=$j("#account-stats-list");var c,b;d.each($j.proxy(function(f){b=$j("<li>").addClass("link");c=$j("<a>",{href:"/monitor/children/show/"+f.id,html:"<b>"+f.name+"</b> ("+f.max_agents+" agents on "+f.plan+")"});c.appendTo(b);b.appendTo(e);},this));a.show();}});Zendesk.NS("Ticket",function(){this.CommentDrafts=function(d,b,a,c){this.niceID=d;this.userID=b;this.key="drafts/"+this.niceID+"/"+this.userID;this.timestampKey=this.key+"/ts";this.privacyKey=this.key+"/privacy";this.commentSelector=a;this.commentPrivacySelector=c;this._keyHandler=_.debounce(this._keyHandler,300);};this.CommentDrafts.STALE_TIMEOUT_SECONDS=8*60*60;this.CommentDrafts.prototype={clear:function(){if(!Zendesk.Storage.isSupported()){return;}this.localStorage=Zendesk.Storage.handle();return this._clear();},startWatching:function(){if(!Zendesk.Storage.isSupported()){return;}this.localStorage=Zendesk.Storage.handle();this.commentInput=$j(this.commentSelector);this.commentPrivacyInput=$j(this.commentPrivacySelector);if(this._isStale()){this._clear();}var a=this._load();if(a.comment){this.comment=a.comment;this.commentInput.val(this.comment);this._renderDraftNotification("Recovered a comment from draft");}else{this.comment=this.commentInput.val();}if(a.commentPrivacy){this.commentPrivacy=a.commentPrivacy;this.commentPrivacyInput.prop("checked",this.commentPrivacy==="public").change();}else{this.commentPrivacy=this.commentPrivacyInput.prop("checked")?"public":"private";}this._bindEvents();},_bindEvents:function(){$j(this.commentInput).keyup($j.proxy(function(b){this._keyHandler(b);},this));var a=$j.proxy(function(b){this._updateDraftFromDom(b);},this);$j(this.commentInput).change(a);$j(document).bind("applied.macro.zendesk",a);$j(this.commentPrivacyInput).change(a);},_keyHandler:function(a){this._updateDraftFromDom(a);},_updateDraftFromDom:function(b){var a=(this.commentPrivacyInput.prop("checked")?"public":"private");if((this.comment!=this.commentInput.val())||(this.commentPrivacy!=a)){if(!$j(b.target).is(this.commentPrivacyInput)){this._renderDraftSaveNotification();}this._store(this.commentInput.val(),a);}},_renderDraftSaveNotification:function(){var b="Comment draft saved";var a=b+' (<abbr id="draft_timestamp" title="'+this._iso8601Timestamp(new Date())+'"></abbr>)';this._renderDraftNotification(a);$j("#draft_timestamp").timeago();},_store:function(b,a){this.comment=b;this.commentPrivacy=a;this.localStorage.setItem(this.timestampKey,(new Date()).toString());this.localStorage.setItem(this.key,this.comment);this.localStorage.setItem(this.privacyKey,this.commentPrivacy);},_renderDraftNotification:function(a){this.commentInput.css({backgroundPosition:"bottom center"});if($j("#draft_status").length===0){this.commentInput.after('<div id="draft_status"></div>');}$j("#draft_status").html(a);},_zeropad:function(a){return((a<10)?"0":"")+a;},_iso8601Timestamp:function(a){return a.getUTCFullYear()+"-"+this._zeropad(a.getUTCMonth()+1)+"-"+this._zeropad(a.getUTCDate())+"T"+this._zeropad(a.getUTCHours())+":"+this._zeropad(a.getUTCMinutes())+":"+this._zeropad(a.getUTCSeconds())+"Z";},_load:function(){return{comment:this.localStorage.getItem(this.key),commentPrivacy:this.localStorage.getItem(this.privacyKey)};},_clear:function(){this.localStorage.removeItem(this.key);this.localStorage.removeItem(this.timestampKey);this.localStorage.removeItem(this.privacyKey);},_isStale:function(){var b=this.localStorage.getItem(this.timestampKey);if(!b){return false;}var a=(new Date()).getTime();b=new Date(b).getTime();return(a-b)>Zendesk.Ticket.CommentDrafts.STALE_TIMEOUT_SECONDS*1000;}};});(function(a){a.widget("zd.ticketTagger",{_create:function(){var b=this.element.data("field-id");this.$input=this.element.parent().find("#ticket_fields_"+b);this.$output=this.element.find("#title-tagger-"+b);this._addBindings();},val:function(b){if(arguments.length===1){this.$input.val(b).change();return this;}else{return this.$input.val();}},_addBindings:function(){var b=this;this.element.delegate("li.link","click.ticketTagger",function(){b.$input.val(a(this).data("value")).trigger("change.ticketTagger");selection_feedback($(this));return false;});this.$input.bind("change.ticketTagger",function(c,d){var e=b._findLIByValue(a(this).val());b.$output.html(e.data("full-title"));});},_findLIByValue:function(b){return this.element.find('li.link[data-value="'+b+'"]');}});a(".field-tagger").ticketTagger();}(jQuery));function IncidentsWarning(){this._registerEvents();}IncidentsWarning.instance=null;IncidentsWarning.getInstance=function(){if(IncidentsWarning.instance==null){IncidentsWarning.instance=new IncidentsWarning();}return IncidentsWarning.instance;};IncidentsWarning.prototype={confirmed:false,isShowingWarning:function(){var a=this;if($j("#associated_incidents_warning").length!=0&&a._updating()&&a._solving()&&a._addingPublicComment()&&!a.confirmed){$j.colorbox({inline:true,href:"#associated_incidents_warning"});return true;}else{return false;}},_registerEvents:function(){var a=this;$j("#confirm_incidents_warning").click(function(b){$j.colorbox.close();a.confirmed=true;submitTicketForm();});$j("#cancel_incidents_warning").click(function(b){$j.colorbox.close();});},_updating:function(){var a=$j("#submit_type").val();return a==""||a=="macro"||a=="entry";},_solving:function(){return $j("#ticket_status_id").val()=="3";},_addingPublicComment:function(){return $j.trim($j("#comment_value").val()).length!=0&&$j("#comment_is_public").is(":checked");}};$j(function(){var a=$j("#jira_details");if(a.length){var b=a.data("ticketid");$j.ajax({url:"/tickets/"+b+"/jira_ticket_details"}).done(function(f){f=$j.makeArray(f)[0];var e=(f.RESOLUTION||" - ");var c=(f.ASSIGNEE||" - ");var d="<ul>";d=d+"<li><strong>Issue ID</strong>: <a href="+f.URL+">"+f.KEY+"</a></li>";d=d+"<li><strong>Resolution</strong>: "+e+"</li>";d=d+"<li><strong>Assignee</strong>: "+c+"</li>";d=d+"</ul>";$j("#jira_ticket #jira_details").html(d);}).fail(function(){$j("#jira_ticket #jira_details").html("Unable to retrieve issue details from JIRA.");});}});jQuery(function(h){var b,i,u,r,c,e,f;var s,l,q;var d=h("#ticket_agreement_id");if(!d.length){return;}b=h("#jira_project_id");r=h("#issue_type_id");f={};function m(v){l=d.data("jira-agreement-ids");return(h.inArray(v,l)!==-1);}function a(){if(!f){return;}i=h("#jira_project_id option:selected").val();if(!i){return;}c="";e=f[i].issueTypes;for(var v in e){if(e.hasOwnProperty(v)){c+='<option value="'+e[v].id+'">'+e[v].name+"</option>";}}r.html(c);}function n(){u="";for(var v in f){if(f.hasOwnProperty(v)){u+='<option value="'+v+'">'+f[v].name+"</option>";}}b.html(u);}function j(){if(!f){return;}h.ajax({url:"/sharing_agreements/"+q+"/jira_projects"}).done(function(v){v.each(function(w){f[w.id]=w;});n();a();}).fail(function(){h("#jira_projects").html("Unable to load projects from JIRA");h("#jira_issues").html("Unable to load issues types from JIRA");});}function k(){h.colorbox({width:"550px",inline:true,href:"#jira_sharing_options",onComplete:j,onLoad:function(){h("#cboxClose").remove();},overlayClose:false,escKey:false});}function p(){h.colorbox.close();}function t(){b.val("");r.val("");h("#jira_issue_key").val("");}function o(v){q=parseInt(v.target.value,10);if(m(q)){k();}else{t();}}function g(){t();h.colorbox.close();}h("#jira_sharing_options a").click(function(v){v.preventDefault();});h("#cancel_jira_sharing_options").click(g);h("#save_jira_sharing_options").click(p);d.change(o);b.change(a);});function NewUserFromTicket(){this.registerEvents();}NewUserFromTicket.prototype={type:null,registerEvents:function(){var a=this;a.link().click(function(){a.type=$j(this).attr("data-type");$j.colorbox({href:$j(this).attr("href"),onComplete:function(){a.emailField().focus();}});return false;});a.form().live("submit",function(){var b=$j.trim(a.emailField().val());if(b===""){alert(I18n.t("txt.public.javascripts.views.tickets.new_user_from_ticket.please_enter_an_email_address_new_user"));a.emailField().focus();}else{$j.ajax({type:$j(this).attr("method"),data:$j(this).serialize(),url:$j(this).attr("action"),beforeSend:function(c){a.submitButton().val(I18n.t("txt.public.javascripts.views.tickets.new_user_from_ticket.creating")).prop("disabled",true);},success:function(c){var d=null;if(c.email!=null&&c.email!==""){d=c.name+" <"+c.email+">";}if(a.type==="requester"){$j("#ticket_requester_name").val(d);$j("#ticket_requester_name").effect("highlight",{},3000);}else{collaboratorsInput.addEntry(c.id,d);$j("div#edit_cc li[choice_id="+c.id+"]").effect("highlight",{},3000);}$j.colorbox.close();},error:function(c,e,d){a.submitButton().val(I18n.t("txt.public.javascripts.views.tickets.new_user_from_ticket.create")).prop("disabled",false);if(c.responseText.include("The organization")){a.organizationField().focus();new Effect.Highlight(a.organizationField().attr("id"),{duration:3});}else{a.emailField().focus();new Effect.Highlight(a.emailField().attr("id"),{duration:3});}}});}return false;});},link:function(){return $j("a.new_user_from_ticket");},form:function(){return $j("#new_user_form");},emailField:function(){return this.form().find("#user_email");},organizationField:function(){return this.form().find("#user_organization_name");},submitButton:function(){return this.form().find("input[type='submit']");}};var TicketForm=function(){};TicketForm.prototype={_cacheFollowing:function(e,b,c){TicketForm.twitterFollowingCache=TicketForm.twitterFollowingCache||{};var a=TicketForm.twitterFollowingCache;var d=[e.screenName,b.screenName].join(",");if(c!==undefined){return a[d]=c;}else{return a[d];}},isFollowing:function(d,c){var a=this;var b=this._cacheFollowing(d,c);if(b!==undefined){jQuery("#comment_channel_back option[value='dm']").prop("disabled",(b!==true));return;}jQuery.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+d.id+"/1/friendships/exists.json",data:{screen_name_a:c.screenName,screen_name_b:d.screenName},type:"GET",success:function(e){a.isFollowingCallback(e,d,c);}});},isFollowingCallback:function(c,d,b){var a=c;this._cacheFollowing(d,b,a);jQuery("#comment_channel_back option[value='dm']").prop("disabled",a!==true);},updateBalloon:function(){var b=jQuery("#comment_is_public");var a=jQuery("#comment_type");if(b.attr("checked")){a.removeClass("private");a.addClass("public");}else{a.removeClass("public");a.addClass("private");}},updateTwitterControls:function(){var b=jQuery("#comment_is_public");var a=jQuery("#twitter_controls");(b.attr("checked"))?a.show():a.hide();},updateTwitterCounter:function(){var d=jQuery("#comment_is_public");var a=jQuery("#charcounter");var c=jQuery("#comment_channel_back").val();var b=jQuery("#comment_channel_back_dm");a.toggle(d.is(":checked")&&(c=="1"||c=="dm"));},updateMthSelector:function(){var b=jQuery("#comment_is_public");var a=jQuery("#monitored_twitter_handle_selection");(b.attr("checked"))?a.show():a.hide();},bindEditRequesterLink:function(){$j("#edit_requester_link a").bind("click",function(a){$j("#edit_requester").show();$j("#dynamic_requester").hide();$j("#static_requester").show();$j("#edit_requester_link").hide();return false;});},bindCheckbox:function(){var a=this;jQuery("#comment_is_public").change(function(){a.updateBalloon();a.updateMthSelector();a.updateTwitterControls();a.updateTwitterCounter();});},bindRadioButtons:function(){var a=this;jQuery('#twitter_controls input[type="radio"]').click(function(){a.updateTwitterCounter();});}};function TicketMergeWizard(){this.url="/merge/new?source_ids="+this.sources()+"&unchecked="+this.unchecked();this.registerEvents();this.show();}TicketMergeWizard.prototype={url:null,registerEvents:function(){var a=this;a.winnerLinks().live("click",function(b){$j("#target_id").val($j(this).data("target-id"));a.winnerForm().submit();return false;});$j(document).bind("cbox_closed",function(){$j("#submit-button").val("Submit").prop("disabled",false);});},show:function(){var a=this;$j.colorbox({href:this.url,onComplete:function(){if(a.loaded){return;}a.winnerForm().submit(function(){var b=$j.trim($j("#target_id").val());if(b===""){alert("Please enter a ticket ID");}else{$j.ajax({type:$j(this).attr("method"),data:$j(this).serialize(),url:$j(this).attr("action"),success:function(c){$j.colorbox({html:c});a.appendComment();},error:function(c,e,d){$j.colorbox({html:c.responseText});}});}return false;});}});},appendComment:function(){if($j.trim($j("#comment_value").val())!==""){var a="\n\nComment during merge: "+$j("#comment_value").val();$j("#target_comment").append(a);$j("#source_comment").append(a);}},sources:function(){if($j("#ticket-chat").attr("data-ticket")!==undefined){return $j("#ticket-chat").attr("data-ticket");}else{return this.checked();}},checked:function(){return this.values("input.tickets_to_bulk_update:checked");},unchecked:function(){return this.values("input.tickets_to_bulk_update:not(:checked)");},values:function(a){var b=[];$j(a).each(function(){b.push($j(this).val());});return b.join(",");},winnerForm:function(){return $j("#merge_form");},winnerField:function(){return this.winnerForm().find("input[type='text']");},continueButton:function(){return this.winnerForm().find("input[type='submit']");},winnerLinks:function(){return $j(".winner_selector");}};$z.defModule("tickets/new",{initialize:function(){$j("input#ticket_requester_name").focus();$z("tabindex").addtabindexes("input#ticket_requester_name","#edit_cc input","form#ticket-chat div.selects div.select > input[readonly != readonly][attribute_name != additional_tags],form#ticket-chat div.selects div.select > select[readonly != readonly],form#ticket-chat div.selects div.select > textarea[readonly != readonly]","textarea#comment_value","#ticket_tags",".selects .multi_value_field .search_field_item input","select#submit_type","input#submit_type","input#submit-button");$z("tickets").addSubmitBindings();$z("tickets").monitorRequesterChange();$z("tickets").autoselectAssigneesIfManyAgents();if($j("#ticket_linked_id").attr("auto-complete")){$j("#ticket_linked_id").autocompleteFromSelect();}new NewUserFromTicket();if(currentUser&&currentUser.isAgent){Zendesk.Instrumentation.ToTango.trackOperatingSystem();}}});$z.defModule("tickets/show",{initialize:function(){$j("textarea#comment_value").focus();$z("tabindex").addtabindexes("#edit_cc input","form#ticket-chat div.selects div.select > input[readonly != readonly][attribute_name != additional_tags], form#ticket-chat div.selects div.select > select[readonly != readonly], form#ticket-chat div.selects div.select > textarea[readonly != readonly]","#ticket_tags",".selects .multi_value_field .search_field_item input","textarea#comment_value","input#comment_is_public","select#submit_type","input#submit_type","input#submit-button");$z("tickets").addSubmitBindings();$z("tickets").monitorRequesterChange();$z("tickets").autoselectAssigneesIfManyAgents();if($j("#ticket_linked_id").attr("auto-complete")){$j("#ticket_linked_id").autocompleteFromSelect();}$j(".visibility-controls").click(function(){$j("a.toggle-twitter-data",this).toggle();});$j("a.toggle-twitter-data").click(function(){$j(".twitter-properties").toggle();return false;});$j("#comment_full .link, #comment_partial .link").click(function(){$j("#comment_full, #comment_partial, #comment_up, #comment_down").toggle();return false;});$j("#sharing_with :first-child").hover(function(){$j("#shared_tickets_list").fadeIn(300);},function(){$j("#shared_tickets_list").fadeOut(100);});if($j("body.tickets-show").length&&currentAccount.daysLeftInTrial){Zendesk.Instrumentation.ToTango.track("View Ticket","Trial");}new UserMergeWizard(false);new NewUserFromTicket();$j("input, select, textarea","#ticket_properties.read_only").prop("disabled",true);if(currentUser&&currentUser.isAgent){Zendesk.Instrumentation.ToTango.trackOperatingSystem();}Zendesk.Ticket.commentDrafts=new Zendesk.Ticket.CommentDrafts(ticket_id,currentUser.id,"#comment_value","#comment_is_public");Zendesk.Ticket.commentDrafts.startWatching();new Zendesk.Twitter.TicketCreationForm()._updateCounter();},setupCommentCharacterCounter:function(a){a=a||{};a.ticketPage=true;new Zendesk.Twitter.TicketCreationForm().setupTweetCounter(a);}});$z.defModule("tickets",{addSubmitBindings:function(){function b(c){c.preventDefault();if($j("input#submit-button").is(":disabled")){return;}$j("input#submit-button").click();}function a(c){$j("form#submit_form select#submit_type option[value='next']").prop("selected",true);b(c);}(function(e){var d=83;function c(f){if(f.ctrlKey&&f.which===d){if(f.shiftKey){a(f);}else{b(f);}}}e(document).bind("keydown.zendesk.keyboard-shortcut",c);})(jQuery);},autoselectAssigneesIfManyAgents:function(){if(typeof(agents)!=="undefined"&&agents.length>LARGE_SELECT_LENGTH){$j("select.assignee").autocompleteFromSelect();}},monitorRequesterChange:function(){var a=new RegExp(/<(.*)>/);$j("#ticket_requester_name").observe_field(3,function(){if(a.test($j(this).val())){$z("tickets").requesterChanged($j(this));}});},requesterChanged:function(a){$j.ajax({url:"/tickets/requester_change",data:a.serialize(),beforeSend:function(){$j("#user_details").fadeOut("fast");$j("#add_widget_button").hide();},success:function(){$j("#user_details").fadeIn("fast");$j("#add_widget_button").show();}});}});Zendesk.NS("Twitter");Zendesk.Twitter.SearchApplication=function(f,j){j=j||{};var a=j.savedSearches,d=j.shortenedUrlFrequency,c=a[0];var i=function(m,l){var k=null;$j.each(m,function(n,o){if(l(o)){k=o;return;}});return k;};var h=function(l,k){g();this.poller=new TwitterSearchPoller(c.monitored_twitter_handle,l,k);this.poller.start();};var g=function(){if(this.poller){this.poller.stop();this.poller=null;}};var b=function(){if($j("#monitored_twitter_handle_selection #monitored_twitter_handle_id").length){$j("#monitored_twitter_handle_selection #monitored_twitter_handle_id").val(self.currentSearch.monitored_twitter_handle.id);}};var e=f.sammy(function(){this.element_selector="#twitter_search";this.any("#/",function(l){var k=this;var m=this.params.q;var n=this.params.id;g();this.currentSearch=i(a,function(o){return(o.id==n);});k.currentMonitoredAccount=this.currentSearch.monitored_twitter_handle;Sammy.apps["#twitter_search"].trigger("search-configuration-changed",{search:this.currentSearch,query:m});k.currentSearchStream=new TwitterSearchStream(k.currentMonitoredAccount).searchFor(m,1,function(o){Sammy.apps["#twitter_search"].trigger("search-configuration-changed",{search:this.currentSearch,query:m});h(m,o[0].id_str);});return false;});this.bind("on-error",function(l,k){$j("#twitter_search_loading_indicator").html(Zendesk.Twitter.Templates.twitter_is_down_template);$j("#twitter_search_loading_indicator").show();});this.bind("twitter-search-started",function(l){var k=Zendesk.Twitter.Templates.tweet_downloading_template;var m=$j.mustache(k);$j("#twitter_search_loading_indicator").html(m);$j("#twitter_search_loading_indicator").show();$j("#no_results").empty();$j("#twitter_new_result_count").empty();});this.bind("twitter-search-completed",function(m,l){new Zendesk.Twitter.TicketCreationForm()._cancelForm();$j("#twitter_search_loading_indicator").slideUp("slow",function(){$j("#twitter_search_loading_indicator").empty();});if(l&&l.results&&l.results.length>0){new Zendesk.Twitter.SearchRenderer(l).render();var n=self.currentSearch.id;var k=l.results[0].id_str;if((typeof(Zendesk.Twitter._notifier)!="undefined")&&Zendesk.Twitter._notifier){Zendesk.Twitter._notifier.recordView(n,k);}Sammy.apps["#twitter_search"].trigger("update-timestamps");}else{if(typeof(Zendesk.Twitter._notifier)!="undefined"){Zendesk.Twitter._notifier.recordView(n,"0");}$j("#twitter_search_results").html("Your search returned no results.");}});this.bind("search-configuration-changed",function(l,k){self.currentSearch=k.search;self.currentMonitoredAccount=self.currentSearch.monitored_twitter_handle;$j("#twitter_search_name").html(k.search.safe_name);if(k.search.editable){$j("#twitter_edit_search_link").show();$j("#twitter_edit_search_link").attr("href","/twitter/search/"+k.search.id+"/edit");}else{$j("#twitter_edit_search_link").hide();}$j('#twitter_search_bar input[type="text"]').val(f("<div/>").html(k.query).text());$j('#twitter_search_bar input[type="hidden"]').val(k.search.id);});this.bind("convert-status-to-ticket",function(l,m){var k=$j("#tweet_"+m.id_str+" .drawer");b();new Zendesk.Twitter.TweetActivation().activate(m.id_str);new Zendesk.Twitter.TicketCreationForm().showSingleTicketForm(m,k,self.currentSearch.monitored_twitter_handle,d);k.find("#new_ticket #ticket_subject").val(m.text);});this.bind("drawer-cancel-btn-clicked",function(){new Zendesk.Twitter.TweetActivation().makeInactive();});this.bind("retweet-button-clicked",function(k,l){new Zendesk.Twitter.Retweet().show(l,self.currentMonitoredAccount);new Zendesk.Twitter.TweetActivation().activate(l.id_str);});this.bind("show-bulk-ticket-form-link-clicked",function(m,l){var k=[];$j(".tweet_checkbox:checked").map(function(n,o){k.push($j(o).val());});if(k.length>0){g();b();new Zendesk.Twitter.TweetActivation().activateBulkAction();new Zendesk.Twitter.TicketCreationForm().showBulkTicketForm(k,$j("#twitter_bulk_ticket_form"),d);}else{alert("Please select at least one tweet.");}});this.bind("mark-as-reviewed",function(k,l){new TwitterSearchActions().markAsReviewed(l);});this.bind("follow-button-clicked",function(k,l){new Zendesk.Twitter.FollowActions(self.currentMonitoredAccount).displayConfirmationMessage(l);new Zendesk.Twitter.TweetActivation().activate(l.searchObj["id_str"]);});this.bind("follow-success",function(k){new Zendesk.Twitter.FollowActions(self.currentMonitoredAccount).successfulFollow();});this.bind("retweet-success",function(k){new Zendesk.Twitter.FollowActions(self.currentMonitoredAccount).successfulFollow();});this.bind("next-page-btn-clicked",function(k,l){$j("#twitter_search #show_more").html('<img src="/images/loader.gif" />').css("background","none");new TwitterMultiRequest(self.currentMonitoredAccount).nextPage(l,function(m){new Zendesk.Twitter.SearchRenderer(m,false).render();Sammy.apps["#twitter_search"].trigger("update-timestamps");});});this.bind("update-timestamps",function(k){$j("a.timeago").attr("title",function(m,l){return new Date(l).toISOString();});$j("a.timeago").timeago();});this.bind("ticket-creation-success",function(k,l){var m=$j("#tweet_"+l.statusMessageId);m.find("input.tweet_checkbox").attr("checked",false).prop("disabled",true).addClass("inactive");m.find("a.convert_to_ticket").replaceWith('<span class="converted">'+I18n.t("txt.admin.views.twitter.search._ticket_form.Convert_to_Ticket")+"</span>");m.find(".review_status").html('<a href="/tickets/'+l.ticketId+'" class="ticket_badge" target="_blank">#'+l.ticketId+"</a>");if(self.bulkTicketWatcher){self.bulkTicketWatcher.markCompleted(l.statusMessageId);}else{new Zendesk.Twitter.TicketCreationForm()._cancelForm();$j("#submit_button").val(I18n.t("txt.admin.views.twitter.search._ticket_form.Create_Ticket")).prop("disabled",false);new Zendesk.Twitter.TweetActivation().makeInactive();}});this.bind("ticket-creation-failure",function(k,l){if(self.bulkTicketWatcher){self.bulkTicketWatcher.markFailed(l.statusMessageId);}else{new Zendesk.Twitter.TicketCreationForm()._showError(l);$j("#submit_button").val(I18n.t("txt.admin.views.twitter.search._ticket_form.Create_Ticket")).prop("disabled",false);}});this.bind("bulk-ticket-creation-started",function(k,l){self.bulkTicketWatcher=new Zendesk.Twitter.BulkTicketWatcher(l);});this.bind("bulk-ticket-request-completed",function(l,k){$j("#bulk_creation_counter span").html(k);new Zendesk.Twitter.BulkActions().checkForBulkActivation();});this.bind("bulk-ticket-creation-complete",function(k,l){self.bulkTicketWatcher=null;new Zendesk.Twitter.TicketCreationForm()._cancelForm();$j("#submit_button").val(I18n.t("txt.admin.views.twitter.search._ticket_form.Create_Ticket")).prop("disabled",false);new Zendesk.Twitter.TweetActivation().makeInactive();});this.bindToAllEvents(function(){setTimeout(function(){new Zendesk.UI.NestedMenu("div.frame_header ul.drop-list").collapse();},50);});});f(function(){e.run("#/?q="+encodeURIComponent(c.query)+"&id="+c.id);});return e;};Zendesk.NS("Twitter");Zendesk.Twitter.BulkActions=function(){};Zendesk.Twitter.BulkActions.prototype={setup:function(){$j("#bulk_review").click(function(a){a.preventDefault();var b=[];$j("#twitter_search_results input:checked").each(function(c,d){b.push($j(d).val());});Sammy.apps["#twitter_search"].trigger("mark-as-reviewed",b);return false;});$j("#bulk_select").click(function(a){if($j("#bulk_select:checked").size()>0){$j(".tweet_checkbox:not(.inactive)").each(function(b,c){c.checked=true;});}else{$j(".tweet_checkbox:checked").each(function(b,c){c.checked=false;});}new Zendesk.Twitter.BulkActions().checkForBulkActivation();});},checkForBulkActivation:function(){if($j(".tweet_checkbox:checked").length>0){$j(".bulk_convert_button").prop("disabled",false);}else{$j(".bulk_convert_button").prop("disabled",true);}}};Zendesk.NS("Twitter");Zendesk.Twitter.BulkTicketWatcher=function(a){this.messageIds=a;this.requestCounter=0;};Zendesk.Twitter.BulkTicketWatcher.prototype={markCompleted:function(a){this._observeRequestCompleted();},markFailed:function(a){this._observeRequestCompleted();},_observeRequestCompleted:function(){this.requestCounter+=1;Sammy.apps["#twitter_search"].trigger("bulk-ticket-request-completed",this.requestCounter);if(this.requestCounter>=this.messageIds.length){Sammy.apps["#twitter_search"].trigger("bulk-ticket-creation-complete",this.requestCounter);}}};Zendesk.NS("Twitter");Zendesk.Twitter.FollowActions=function(a){this.twitterAccount=a;};Zendesk.Twitter.FollowActions.prototype={displayConfirmationMessage:function(d){var a=this;var e=$j(d.tweetElement);var b=Zendesk.Twitter.Templates.follow_confirmation_template;var c=$j.mustache(b,d.searchObj);e.find(".drawer").first().html(c).show();e.find(".drawer .confirm").first().click(function(){$j(".drawer .confirm").html(I18n.t("txt.admin.javascript.views.twitter.please_wait_label")+' <img src="/images/indicator2.gif" />').css({backgroundColor:"#fff"});a.follow(d.searchObj.from_user);return false;});e.find(".drawer .cancel").click(function(f){Sammy.apps["#twitter_search"].trigger("drawer-cancel-btn-clicked");f.preventDefault();return false;});},follow:function(a){$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+this.twitterAccount.id+"/1/friendships/create.json",type:"POST",data:{screen_name:a,follow:"true"},success:function(){Sammy.apps["#twitter_search"].trigger("follow-success");}});},successfulFollow:function(){$j(".activated a.follow").replaceWith('<span class="following">Following</span>');new Zendesk.Twitter.TweetActivation().makeInactive();}};Zendesk.NS("Twitter");Zendesk.Twitter.Notifier=function(a){this.searches=_(a);this.sleepTime=60;this.tweetsPerPage=100;this.searchTTL=3600;};Zendesk.Twitter.Notifier.cookieName="zendesk.twitter.notifier";Zendesk.Twitter.Notifier.prototype={start:function(){var a=this;var b=1000;this.searches.each(function(c){setTimeout(function(){Zendesk.Pubsub.subscribe("savedsearch."+c.id,a._searchResultNotification.bind(a));},b);b+=2000;});},init:function(){this._readCookie();this._rebuildNotificationData();this._drawMenu();},recordView:function(c,a){var b=this._lookupNotificationData(c);if(b){b.sinceId=a;b.on=false;this._drawMenu();this._writeCookie();}},_searchResultNotification:function(c){var a;if(this.notificationFormat==="json"){a=c.twitter_search_id;}else{a=$j(c).find("tweet").attr("twitter_search_id");}var b=this._lookupNotificationData(a);if(b){b.on=true;b.updatedAt=this._now();this._writeCookie();this._drawMenu();}},_readCookie:function(c){var b=jQuery.cookie(Zendesk.Twitter.Notifier.cookieName);if((typeof(b)!="undefined")&&b){var a=this._deserializeCookie(b);this.notificationData=a.notificationData;}else{this.notificationData=[];}},_rebuildNotificationData:function(){var b=[];var a=this;this.searches.each(function(c){var d=a._lookupNotificationData(c.id);if(d){b.push(d);}else{b.push({id:c.id,sinceId:"0",on:false,updatedAt:0});}});this.notificationData=b;},_lookupNotificationData:function(b){var a=_(this.notificationData).find(function(c){return c.id==b;});return a;},_drawMenu:function(){var a=false;_(this.notificationData).each(function(c){var b=jQuery("#twitter_menu #twitter_menu_item_"+c.id);if(c.on){a=true;b.addClass("on");}else{b.removeClass("on");}});if(a){jQuery("#twitter_menu #twitter_menu_item").addClass("on");}else{jQuery("#twitter_menu #twitter_menu_item").removeClass("on");}},_writeCookie:function(){var a={notificationData:this.notificationData};jQuery.cookie(Zendesk.Twitter.Notifier.cookieName,this._serializeCookie(a),{path:"/"});},_serializeCookie:function(b){var a=_(b.notificationData).map(function(c){return[c.id,c.sinceId,c.on,c.updatedAt].join(",");});return a.join("|");},_deserializeCookie:function(a){var b=_(a.split("|"));return{notificationData:b.map(function(c){var d=c.split(",");return{id:parseInt(d[0]),sinceId:d[1],on:(d[2]==="true"),updatedAt:parseInt(d[3]||"0")};})};},_now:function(){return Math.floor(new Date().getTime()/1000);}};Zendesk.NS("Proxy");Zendesk.Proxy={domain:function(){var a=window.location.protocol+"//"+window.location.hostname;if(a.indexOf("localhost")!=-1){a+=":3000";}return a+"/proxy";}};Zendesk.NS("Twitter");Zendesk.Twitter.Retweet=function(){};Zendesk.Twitter.Retweet.prototype={show:function(d,c){var a=Zendesk.Twitter.Templates.retweet_template;var b=$j($j.mustache(a,{screen_name:c.screen_name}));b.find(".confirm").first().click(function(){$j("#tweet_"+d.id_str+" .confirm").html(I18n.t("txt.admin.javascript.views.twitter.please_wait_label")+' <img src="/images/indicator2.gif" />').css({backgroundColor:"#fff"});$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+c.id+"/1/statuses/retweet/"+d.id_str+".json",type:"POST",success:function(e){$j("#tweet_"+d.id_str+" .retweet").replaceWith('<span class="retweeted">Retweeted</span>');var f=c.screen_name.substring(1);$j("#tweet_"+d.id_str+" .meta").append('<span class="retweeted_by">Retweeted by <a href="http://twitter.com/'+f+'">'+f+"</a>");new Zendesk.Twitter.TweetActivation().makeInactive();}});});$j("#tweet_"+d.id_str+" .drawer").html(b).show();$j("#tweet_"+d.id_str+" .drawer .cancel").click(function(e){Sammy.apps["#twitter_search"].trigger("drawer-cancel-btn-clicked");e.preventDefault();return false;});}};Zendesk.NS("Twitter");Zendesk.Twitter.RoundRobin=function(a,b){this.index=a;this.array=b;};Zendesk.Twitter.RoundRobin.prototype={next:function(){if(this.array.length==0){return null;}this.index++;if(this.index>=this.array.length){this.index=0;}return{index:this.index,item:this.array[this.index]};}};Zendesk.NS("Twitter");Zendesk.Twitter.TicketCreationForm=function(){};Zendesk.Twitter.TicketCreationForm.prototype={_updateFollowing:function(b,c){var a={id:b.profile.id,screenName:b.profile.screen_name.replace(/@/,"")};new TicketForm().isFollowing(c,a);},showSingleTicketForm:function(f,e,a,c){var d={statusMessageIds:[f.id_str],targetContainer:e,shortenedUrlFrequency:c};this._showForm(d);if(f.follower){e.find("#comment_channel_back option[value='dm']").prop("disabled",false);}else{e.find("#comment_channel_back option[value='dm']").prop("disabled",true);}if(a){e.find("#ticket_monitored_twitter_handle_id").val(a.id);var g={id:a.id,screenName:a.screen_name.replace(/@/,"")};this._updateFollowing(f,g);}var b=this;e.find("#ticket_monitored_twitter_handle_id").change(function(){var h=e.find("#ticket_monitored_twitter_handle_id");var i={id:h.val(),screenName:h.find("option:selected").html().replace(/@/,"")};b._updateFollowing(f,i);});},showBulkTicketForm:function(b,e,a){var c={statusMessageIds:b,targetContainer:e,statusMessageSelector:this._getSelectedTweets,shortenedUrlFrequency:a};this._showForm(c);$j(".cancel_link.bottom").show();e.find("#channel_back_dm").show();e.find("#submit_button").click(function(){Sammy.apps["#twitter_search"].trigger("bulk-ticket-creation-started",b);});var d=function(){var f="tweets";var g="tickets";if($j(".tweet input:checked").length==1){f="tweet";g="ticket";}$j("#twitter_convert_to_ticket h3:first").html("Convert <span>"+$j(".tweet input:checked").length+"</span> tweet to "+g);};d();$j(".tweet input:not(.inactive)").bind("click.updateCount",function(){d();});e.find("#submit_button").bind("click.updateCount",function(){var f=$j(".tweet input:checked").length;$j(".cancel_link.bottom").hide();$j(this).after('<span id="bulk_creation_counter">Created <span>0</span> of '+f+"</span>");});},_getSelectedTweets:function(){var a=[];$j(".tweet_checkbox:checked").map(function(b,c){a.push($j(c).val());});return a;},_updateCounter:function(){if($j("textarea#comment_value").length===0){return;}$j("div#charcounter > div").html(140-($j("#charcounter").data("offset")+$j("textarea#comment_value").val().length));},_setupCharCounter:function(){var a=this;if($j("#charcounter").length===0){$j("div#comment_type").prepend('<div id="charcounter"><div title="Remaining Character Count: Characters past this limit will be truncated on Twitter but appear in their entirety in Zendesk. A shortened link to this ticket will be appended to the tweet, depending on the setup of your zendesk."></div></div>');$j("textarea#comment_value").keyup(function(){a._updateCounter();});}},_setOffset:function(b){b=b||{};var d,c,a;c=(b.ticketPage)?$j(".options .twitter a").html():$j("#tweet_"+b.statusMessageIds[0]+" .screen_name").html();a=b.shortenedUrlFrequency;d=a&&a==="always"?21:0;if(b.ticketPage){d+=c.length+1;}else{if(b.statusMessageIds.length===1){d+=c.length+2;}}this._setupCharCounter();$j("#charcounter").data("offset",d);$j("div#charcounter > div").html(140-d);},_handleReplyOrNot:function(){var a=$j("#comment_channel_back_optional_add_url");$j("#comment_channel_back").change(function(){a.toggle($j(this).val()!="no_action");new TicketForm().updateTwitterCounter();});},_handleAppendTicketUrl:function(){var a=this;$j("#comment_add_short_url").change(function(){var b=$j("#charcounter").data("offset");if($j(this).is(":checked")){$j("#charcounter").data("offset",b+21);}else{$j("#charcounter").data("offset",b-21);}a._updateCounter();});},setupTweetCounter:function(a){a=a||{};this._setOffset(a);this._handleReplyOrNot();this._handleAppendTicketUrl();},_showForm:function(e){e=e||{};var d=this,c=e.statusMessageIds,f=e.targetContainer,a=e.statusMessageSelector,b=e.shortenedUrlFrequency;this._addFormToContainer(f);f.slideDown(200);$j(".cancel_link.bottom").show();this.setupTweetCounter({ticketPage:false,statusMessageIds:c,shortenedUrlFrequency:b});f.find(".cancel_link").click(function(g){d._cancelForm();new Zendesk.Twitter.TweetActivation().makeInactive();return false;});this._fillFormWithTweetInfo(d,c,f,a,b);},showSuccess:function(a){var b=a.location.match(/[0-9]+.json/ig)[0];var c=b.split(".")[0];Sammy.apps["#twitter_search"].trigger("ticket-creation-success",{statusMessageId:a.statusMessageId,ticketId:c,url:a.location});},apply_macro:function(c,b){var d=$j("#twitter_convert_to_ticket #new_ticket");new Zendesk.API.Macro(c).applyToTicket(0,d);var f=(b)?b:window.event;Event.stop(f);var a=f.findElement();selection_feedback(a);return(false);},_addFormToContainer:function(a){a.children().remove();$j("#twitter_convert_to_ticket").appendTo(a);a.find(".cancel_link").unbind("click");a.find("#comment_add_short_url").unbind("change");a.find("#submit_button").unbind("click");},_fillFormWithTweetInfo:function(d,c,e,a,b){e.find("select.assignee").autocompleteFromSelectIfLarge();e.find("#submit_button").click(function(g){e.find("#submit_button").val(I18n.t("txt.admin.javascript.views.twitter.please_wait_label")).prop("disabled",true);var f=new Zendesk.API.TicketForm("#new_ticket");var h=(typeof(a)=="undefined")?c:a();$j.each(h,function(l,k){var i={"ticket[twitter_status_message_id]":k,"comment[is_public]":"1"};var m=jQuery("#tweet_"+k);if(c.length>1&&m.attr("data-follower")!="1"){i["ticket[skip_dm]"]="1";}var j=function(n,p,o){Sammy.apps["#twitter_search"].trigger("ticket-creation-failure",{statusMessageId:k,response:n.responseText});};f.createTicket([i]).done(function(q,r,p){var o=p.getResponseHeader("Location").match(/\/tickets\/[0-9]+\.json$/)[0];var n=function(){d.showSuccess({statusMessageId:k,location:o});};if(f.hasComment()){var q={"comment[value]":f.ticketForm.find('[name="comment[value]"]').val(),"comment[is_public]":f.ticketForm.find('[name="comment[is_public]"][type="checkbox"]').is(":checked"),"comment[channel_back]":f.ticketForm.find('[name="comment[channel_back]"]').val()};if(b==="optional"){q["comment[add_short_url]"]=f.ticketForm.find('[name="comment[add_short_url]"][type="checkbox"]').is(":checked");}$j.ajax({url:o,dataType:"text",type:"PUT",data:q}).done(n).fail(j);}else{n.call(this);}}).fail(j);Zendesk.Instrumentation.ToTango.track("Created","Twicket");});g.preventDefault();return false;});},_cancelForm:function(){$j(".ticket_errors").hide();$j("#twitter_convert_to_ticket").appendTo($j("#ticket-conversion-template"));var a=$j("#twitter_convert_to_ticket form");a[0].reset();$j("input, select",a).css("color","");if(typeof(ticketTagField)!="undefined"){ticketTagField.clear();}a.find("#ticket_monitored_twitter_handle_id").unbind("change");a=new TicketForm();a.updateBalloon();a.updateTwitterControls();a.updateMthSelector();},_showError:function(a){var d=Zendesk.Twitter.Templates.ticket_conversion_error_template;var c={messageId:a.statusMessageId,errorMessages:this._errorMessages(a)};var b=$j($j.mustache(d,c));$j("#twitter_convert_to_ticket .cancel_link.top").after(b);$j("#submit_button").val(I18n.t("txt.admin.views.twitter.search._ticket_form.Create_Ticket")).prop("disabled",false);},_errorMessages:function(a){var d=null;try{d=$j.parseJSON(a.response);}catch(b){return[{message:"An error has occurred. Please try again."}];}var c=[];$j.each(d,function(e,f){if(f[0]=="base"){c.push({message:f[1]});}else{c.push({message:f[0]+" "+f[1]});}});return c;}};Zendesk.NS("Twitter");Zendesk.Twitter.TweetActivation=function(){};Zendesk.Twitter.TweetActivation.prototype={makeInactive:function(a){$j("#twitter_convert_to_ticket h3:first").html(I18n.t("txt.admin.views.twitter.search._ticket_form.Convert_to_Ticket"));$j(".tweet input:not(.inactive)").unbind("click.updateCount");$j("#submit_button").unbind("click.updateCount");$j("#bulk_creation_counter").remove();if($j(".activated").length>0){if($j("html, body").scrollTop()>$j(".activated:first").offset().top){$j("html, body").animate({scrollTop:$j(".activated:first").offset().top},500);}$j(".activated:first").effect("highlight",{},1200);}new TwitterSearchActions().dropDrawers();},activate:function(a){$j(".tweet_actions").removeClass("enabled");$j("#tweet_"+a).addClass("activated");$j(".tweet input").prop("disabled",true);},activateBulkAction:function(){$j(".tweet_actions").removeClass("enabled");}};var TwitterMultiRequest=function(a){this.mthId=a.id;this.twitterAccount=a;this.tweetsPerPage=30;};TwitterMultiRequest.prototype={searchFor:function(a,b){this.callback=b;this.searchType="query";this.fireRequests(a);},nextPage:function(b,a){this.callback=a;this.searchType="nextPage";this.fireRequests(b);},fireRequests:function(a){this.reset();this.search(a);this.getRetweets();this.getFriends();this.getFollowers();},reset:function(){this.metaData=null;this.searchData=null;this.retweetData=null;this.friendsData=null;this.followerData=null;this.lookupData=null;this.reviewedData=null;},search:function(b){var a=this.searchOptions();if(this.searchType==="query"){a.data={rpp:this.tweetsPerPage,q:b};}else{a.url=a.url+b;}$j.ajax(a);},searchOptions:function(){var a=this;return{url:Zendesk.Proxy.domain()+"/twitter/api/"+this.twitterAccount.id+"/search.json",type:"GET",dataType:"jsonp",success:function(b){a.searchCallback(b);},error:function(c,b){Sammy.apps["#twitter_search"].trigger("on-error",b);}};},getMetaData:function(a){var b=this;$j.ajax({url:"/twitter/tickets/exist.json",data:{q:a.join(",")},type:"GET",success:function(c){b.metaDataCallback(c);},error:function(d,c){Sammy.apps["#twitter_search"].trigger("on-error",c);}});},getRetweets:function(){var a=this;$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+this.mthId+"/1/statuses/retweeted_by_me.json",type:"GET",dataType:"jsonp",success:function(b){a.retweetCallback(b);},error:function(c,b){Sammy.apps["#twitter_search"].trigger("on-error",b);}});},getFriends:function(){var a=this;$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+this.mthId+"/1/friends/ids.json",data:{screen_name:this.twitterAccount.screen_name},type:"GET",dataType:"jsonp",success:function(b){a.friendsCallback(b);},error:function(c,b){Sammy.apps["#twitter_search"].trigger("on-error",b);}});},getFollowers:function(){var a=this;$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+this.mthId+"/1/followers/ids.json",data:{screen_name:this.twitterAccount.screen_name},type:"GET",dataType:"jsonp",success:function(b){a.followersCallback(b);},error:function(c,b){Sammy.apps["#twitter_search"].trigger("on-error",b);}});},getReviewed:function(a){var b=this;$j.ajax({url:"/twitter/reviewed_tweets.json",data:{tweet_ids:a.join(",")},type:"GET",success:function(c){b.reviewedCallback(c);},error:function(d,c){Sammy.apps["#twitter_search"].trigger("on-error",c);}});},lookupUsers:function(b){var a=this;$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+this.mthId+"/1/users/lookup.json",data:{screen_name:b.join(",")},type:"GET",dataType:"jsonp",success:function(c){a.lookupCallback(c);},error:function(d,c){Sammy.apps["#twitter_search"].trigger("on-error",c);}});},searchCallback:function(d){var a=[];var e=[];var b={};this.searchData=d;if(!this.searchData.results){Sammy.apps["#twitter_search"].trigger("on-error");return;}$j.each(this.searchData.results,function(f,g){a.push(g.id_str);b[g.from_user]=1;});for(var c in b){e.push(c);}if(a.length===0||e.length===0){$j("#show_more").empty();$j("#twitter_search_loading_indicator").empty();$j("#twitter_search_results").html('<div id="no_results" class="message">'+I18n.t("txt.admin.public.javascript.views.twitter.search.application.your_search_returned_no_results_twitter")+"</div>");}else{this.getMetaData(a);this.lookupUsers(e);this.getReviewed(a);}},metaDataCallback:function(a){this.metaData=a;this.synchronizeCallbacks();},retweetCallback:function(a){this.retweetData=a;this.synchronizeCallbacks();},friendsCallback:function(a){this.friendsData=a;this.synchronizeCallbacks();},followersCallback:function(a){this.followersData=a;this.synchronizeCallbacks();},lookupCallback:function(a){this.lookupData=a;this.synchronizeCallbacks();},reviewedCallback:function(a){this.reviewedData=a;this.synchronizeCallbacks();},synchronizeCallbacks:function(){if(this.metaData&&this.retweetData&&this.friendsData&&this.lookupData&&this.followersData&&this.reviewedData){this.passThroughGate();this.working=false;}},passThroughGate:function(){if(typeof(this.callback)!=="undefined"){var a=this.compileData();this.callback(a);}},compileData:function(){var b={results:[],nextPage:this.searchData.next_page};var a=this;$j.each(this.searchData.results,function(d,c){$j.each(a.metaData.tickets,function(e,f){if(f.status_id_str===c.id_str){c.ticketId=f.ticket_id;return false;}});$j.each(a.retweetData,function(f,e){if(e&&e.retweeted&&e.retweeted_status&&e.retweeted_status.id_str==c.id_str){c.retweeted=true;c.retweeted_by=e.user.screen_name;return false;}});$j.each(a.lookupData,function(e,f){if(f.screen_name.toLowerCase()===c.from_user.toLowerCase()){c.profile=f;return false;}});$j.each(a.friendsData,function(f,e){if(c.profile&&e==c.profile.id){c.friend=true;c.profile.friend=true;return false;}});$j.each(a.followersData,function(e,f){if(c.profile&&f==c.profile.id){c.follower=true;return false;}});b.results.push(c);});if(b.results.length===this.tweetsPerPage){b.displayMoreLink=true;}return b;}};var TwitterSearchActions=function(a){this.mthId=a;};TwitterSearchActions.prototype={dropDrawers:function(){$j(".tweet_actions").addClass("enabled");$j(".tweet input:not(.inactive)").prop("disabled",false);$j(".tweet .drawer").hide();$j(".tweet.activated").removeClass("activated");},showLoading:function(b,a){var d=$j("#tweet_"+b);var c=$j('<span><img src="/images/ajax_small_bar.gif" /></span>');d.find(a).html(c);},markAsReviewed:function(b){this.dropDrawers();var a=this;$j.each(b,function(d,c){a.showLoading(c,"span.review_status");});$j.ajax({url:"/twitter/reviewed_tweets.json",data:{tweet_ids:b.join(",")},type:"POST",success:function(c){a.reviewedCallback(c);}});},reviewedCallback:function(a){$j.each(a,function(c,b){var d=$j("#tweet_"+b);d.find(".review_status").first().html('<span class="reviewed">Reviewed</span>');});}};var TwitterSearchPoller=function(a,c,b){this.twitterAccount=a;this.query=c;this.mostRecentTweetId=b;this.tweetsPerPage=30;this.sleepTime=15000;this.killed=false;};TwitterSearchPoller.prototype={start:function(){this.sleepThenPoll();},stop:function(){this.killed=true;$j("#twitter_new_result_count").empty();},sleepThenPoll:function(){var a=this;var b=setTimeout(function(){a.poll();},this.sleepTime);},poll:function(){var a=this;$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+this.twitterAccount.id+"/search.json",type:"GET",dataType:"jsonp",data:{rpp:this.tweetsPerPage,q:this.query,since_id:this.mostRecentTweetId},success:function(b){a.callback(b);}});},callback:function(b){if(this.killed){return;}var a=this.calculateNewTweetCount(b);if(a>0&&a<this.tweetsPerPage){this.renderNewTweetMessage(a);}if(a>=this.tweetsPerPage){this.renderMaxTweetsMessage();}else{this.sleepThenPoll();}},calculateNewTweetCount:function(a){if(a&&a.results&&a.results.length){return a.results.length;}else{return 0;}},renderNewTweetMessage:function(c){var a={count:c,tweets:Zd.Util.pluralize("tweet",c)};var b=$j.mustache(Zendesk.Twitter.Templates.more_tweets_template,a);$j("#twitter_new_result_count").html(b);$j("a.twitter_search_refresh").click(function(d){Sammy.apps["#twitter_search"].refresh();return false;});},renderMaxTweetsMessage:function(){var a=$j.mustache(Zendesk.Twitter.Templates.max_tweets_template,{max:this.tweetsPerPage});$j("#twitter_new_result_count").html(a);$j("a.twitter_search_refresh").click(function(b){Sammy.apps["#twitter_search"].refresh();return false;});}};var TwitterSearchPreview=function(){};TwitterSearchPreview.prototype={startQuery:function(b){var a=this;$j.ajax({url:"https://search.twitter.com/search.json",type:"GET",dataType:"jsonp",data:{rpp:"5",q:b},success:function(c){a.queryCallback(c);}});},queryCallback:function(c){var a=Zendesk.Twitter.Templates.tweet_preview_template;var b=$j.mustache(a,c);$j("#tweet_preview_container").empty();$j("#tweet_preview_container").append(b);$j("a.timeago").attr("title",function(e,d){return new Date(d).toISOString();});$j("a.timeago").timeago();}};Zendesk.NS("Twitter");Zendesk.Twitter.SearchRenderer=function(b,a){this.data=b;if(typeof(a)=="undefined"){this.removeExistingStatuses=true;}else{this.removeExistingStatuses=a;}};Zendesk.Twitter.SearchRenderer.prototype={render:function(){var a=this;this.removeTemporaryElements();$j.each(this.data.results,function(c,e){var d=a.buildTweet(e);var b=a.buildTweetControls(e);d.find(".tweet_body").append(b);if(typeof(e.ticket_id)==="undefined"){a.attachEventsTo(d,e);}a.attachProfileMouseOver(d,e);$j("#twitter_search_results").append(d);});$j(".tweet_checkbox").unbind("change").change(function(b){new Zendesk.Twitter.BulkActions().checkForBulkActivation();});if(this.data.displayMoreLink){this.appendMoreLink();}},removeTemporaryElements:function(){$j("#twitter_search_results .temp").remove();if(this.removeExistingStatuses){$j("#twitter_search_results").empty();}},buildTweet:function(a){a.html=Zendesk.Text.autoLink(a.text);return $j($j.mustache(Zendesk.Twitter.Templates.tweet_template,a));},buildTweetControls:function(a){return $j.mustache(Zendesk.Twitter.Templates.tweet_controls_template,a);},attachEventsTo:function(b,c){var a=this;b.find("a.convert_to_ticket").first().click(function(d){d.preventDefault();Sammy.apps["#twitter_search"].trigger("convert-status-to-ticket",c);});b.find("a.retweet").first().click(function(d){d.preventDefault();Sammy.apps["#twitter_search"].trigger("retweet-button-clicked",c);});b.find("a.follow").first().click(function(d){d.preventDefault();Sammy.apps["#twitter_search"].trigger("follow-button-clicked",{tweetElement:b,searchObj:c});});b.find("a.review").first().click(function(d){d.preventDefault();Sammy.apps["#twitter_search"].trigger("mark-as-reviewed",[c.id_str]);});},attachProfileMouseOver:function(a,f){if(f.profile){var e=a.find("img.profile_image").first();var c=a.find(".profile_details").first();var b=Zendesk.Twitter.Templates.tweet_profile_hover;var d=$j.mustache(b,f.profile);c.html(d);e.mouseenter(function(){$j("#twitter_search_results .tweet").css("z-index","1");a.css("z-index","2");jQuery(".profile_details").hide();c.show();});c.mouseleave(function(){$j("#twitter_search_results .tweet").css("z-index","");c.hide();});}},appendMoreLink:function(){var a=this;more_link=$j("<a>"+I18n.t("txt.admin.javascript.views.twitter.twitter_search_renderer.show_more_results_label")+"</a>").click(function(b){Sammy.apps["#twitter_search"].trigger("next-page-btn-clicked",a.data.nextPage);});$j("#twitter_search #show_more").html(more_link);}};var TwitterSearchStream=function(a){this.twitterAccount=a;this.multiRequest=new TwitterMultiRequest(this.twitterAccount);};TwitterSearchStream.prototype={searchFor:function(d,c,a){Sammy.apps["#twitter_search"].trigger("twitter-search-started");var b=this;this.streamData=null;this.multiRequest.searchFor(d,function(e){Sammy.apps["#twitter_search"].trigger("twitter-search-completed",e);if(typeof(a)!="undefined"){a(e.results);}});},data:function(){return this.streamData;},client:function(){return new TwitterSearchActions(this.twitterAccount.id);}};var TwitterSearchSorter=function(a){this.rootElement=a.first();};TwitterSearchSorter.prototype={init:function(){var a=this;this.reorderButton=this.rootElement.parent().find("a.reorder").first();this.reorderButton.click(function(c){a.rootElement.sortable();var b=jQuery("<a class='cancel-sorting'>"+I18n.t("txt.admin.javascript.views.twitter.cancel_label")+"</a>").click(function(){a.cancelSort();});var d=jQuery('<button class="button">'+I18n.t("txt.admin.javascript.views.twitter.done_label")+"</button>").click(function(){a.updatePositions();});a.rootElement.parent().find(".temp").append(d).append("&nbsp;").append(b);a.rootElement.parent().find(".edit_this").hide();a.reorderButton.parent().removeClass("item");a.reorderButton.hide();});},cancelSort:function(){try{this.rootElement.sortable("cancel");}catch(a){}this.rootElement.sortable("destroy");this.reset();},updatePositions:function(){var a=this;var b="/twitter/search/update_positions";this.rootElement.sortable("disable");jQuery.ajax({url:b+"?"+a.rootElement.sortable("serialize"),type:"POST",success:function(){a.updatePositionsCallback();}});},updatePositionsCallback:function(){this.rootElement.sortable("enable").sortable("destroy");this.reset();},reset:function(){var a=this.rootElement.parent();a.find(".temp").empty();a.find(".edit_this").show();this.reorderButton.parent().addClass("item");this.reorderButton.show();}};Zendesk.NS("Twitter");Zendesk.Twitter.Menu={init:function(){this.bindDismissTwitterMenu();},bindDismissTwitterMenu:function(){var a=this;jQuery(".hide_twitter_menu").click(function(b){b.preventDefault();a.dismissTwitterMenu();});},dismissTwitterMenu:function(){var a=this;jQuery.ajax({type:"PUT",url:"/twitter/settings.json",data:{account:{settings:{twitter_search_stream:0}}},success:function(){a.hideTwitterMenu();}});},hideTwitterMenu:function(){$j("#twitter_menu").remove();}};Zendesk.NS("Twitter");Zendesk.Twitter.Settings={init:function(){this.bindSettingsToggle();this.bindAddHandleLink();this.bindMakePrimary();this.bindRemovePrimary();this.bindChangeURLShortener();this.bindTestURLShortener();},bindSettingsToggle:function(){var a=jQuery("#monitored_accounts_frame .twitter_profile_card .toggle");a.toggle(function(){jQuery(this).html("Close settings").parents(".twitter_profile_card").addClass("activated");},function(){jQuery(this).html("Settings").parents(".twitter_profile_card").removeClass("activated");});},bindAddHandleLink:function(){var a=jQuery("a#add_twitter_account");a.click(function(){$z("account/monitored_twitter_handles/index").addTwitterMonitorHandle()();});},bindMakePrimary:function(){var a=this;jQuery("#monitored_accounts .make_primary").click(function(b){b.preventDefault();var c=jQuery(b.target).attr("id").split("_").last();a.makePrimary(c);});},makePrimary:function(b){var a=this;jQuery.ajax({type:"PUT",url:"/account/channels/"+b,data:{monitored_twitter_handle:{master:true}},success:function(){a.displayPrimary(b);}});},displayPrimary:function(a){jQuery("#monitored_accounts .twitter_profile").removeClass("is_primary");jQuery("#monitored_accounts #twitter_profile_"+a).addClass("is_primary");},hidePrimary:function(a){jQuery("#monitored_accounts .twitter_profile").removeClass("is_primary");jQuery("#monitored_accounts #twitter_profile_"+a).removeClass("is_primary");},bindRemovePrimary:function(){var a=this;jQuery("#monitored_accounts .remove_primary").click(function(b){b.preventDefault();var c=jQuery(b.target).attr("id").split("_").last();a.removePrimary(c);});},removePrimary:function(b){var a=this;jQuery.ajax({type:"PUT",url:"/account/channels/"+b,data:{monitored_twitter_handle:{master:false}},success:function(){a.hidePrimary(b);}});},bindChangeURLShortener:function(){$j("#url_shortener_name").change(function(){$j("#test_url_results").hide();var a=$j(this).val();$j(this).siblings("[data-if-shortener]").each(function(b,c){c=$j(c);if(c.attr("data-if-shortener")===a){$j("input, textarea, select",c).prop("disabled",false);c.show();}else{c.hide();$j("input, textarea, select",c).prop("disabled",true);}});$j("#test_url_shortener").show();}).change();},bindTestURLShortener:function(){$j("#test_url_shortener_link").click(function(){$j.ajax({url:"/twitter/settings/test_shorten",data:{name:$j("#url_shortener_name").val(),username:$j("#url_shortener_username:enabled").val(),api_key:$j("#url_shortener_api_key:enabled").val(),url:$j("#url_shortener_url:enabled").val()},dataType:"json",beforeSend:function(a){$j("#test_in_process").show();$j("#test_url_shortener").hide();},success:function(a){$j("#test_url_results").css("color","#333");$j("#test_url_results").html(I18n.t("txt.public.javascripts.twitter.settings.zendesk_twitter_settings.successfully_shortened_long_to_short",{long_url:"<a href="+a.long_url+">"+a.long_url+"</a>",short_url:"<a href="+a.short_url+">"+a.short_url+"</a>"})).show();$j("#test_in_process").hide();},error:function(){$j("#test_url_results").css("color","red");$j("#test_url_results").html(I18n.t("txt.admin.public.javascript.views.twitter.settings.zendesk_twitter_settings.check_your_settings")).show();$j("#test_in_process").hide();$j("#test_url_shortener").show();}});return false;});}};(function(c,a){function b(f,e){var g=new Voice.Timer(e);g._lastReset=f;this._job=function(){g.update();};this.start();}b.prototype={start:function(){var e=b.worker();e.jobs.push(this._job);e.start();return this;},stop:function(){var e=b.worker();e.jobs=_(e.job).without(this._job);if(e.jobs.length===0){e.stop();}return this;}};b.worker=function(){if(!this._worker){var e=5;this._worker=new PeriodicWorker(1000/e);}return this._worker;};var d=c.sammy("#call-console",function(){this.use("Mustache");this.use("ActiveTemplate");this.call=null;this.state="idle";this.restoring=false;this.maxDisplayStringLength=30;this.init=function(e,f){this.switchBoard=e;this.capabilityToken=f;this.clientAvailable=false;this.name="CallConsole";if(a.currentUser.voice.logging){a.Voice.logger.enableLogging();}c(window).load(function(){_.delay(function(){c.getScript("//static.twilio.com/libs/twiliojs/1.0/twilio.min.js",function(h,j,i){if(j==="success"){if(!window.Twilio){a.voiceMenu&&a.voiceMenu.updateAvailability("off","twilio");alert(I18n.t("txt.voice.error.ec5"));return;}c("#__soundFlash__").css("visibility","hidden");if(a.voiceMenu){var g=a.voiceMenu.backOff([1,2,4,8],function(){return Twilio&&Twilio.MediaStream;});g.done(function(){c("#__soundFlash__").css("visibility","hidden");});}d.hookUpTwilioDevice();}else{a.voiceMenu&&a.voiceMenu.updateAvailability("off","twilio-asset");alert(I18n.t("txt.voice.error.ec10"));}});},100);});c(window).unload(function(){window.voiceUnloading=true;});this.setupVoiceInMaintenance();this.callOverlay=new a.CallOverlay();this.switchBoard.bind("Zendesk.CallConsoleApp.call",function(g){d.safeTrigger(g.status,g);});if(a.currentUser.voice.current_call){d.setCurrentCall(a.currentUser.voice.current_call);}};this.showConsoleIfNeeded=function(){if(!this.$element().is(":visible")){this.trigger("show-console");}};this.hideConsoleIfNeeded=function(){if(this.$element().is(":visible")){this.trigger("close-console");}};this.logTrigger=function(e,f){a.Voice.logger.log(d,e,JSON.stringify(f));this.trigger.apply(this,[e,f]);};this.safeTrigger=_.debounce(this.logTrigger,300);this.retrigger=function(){if(this.lastTrigger){this.safeTrigger(this.lastTrigger);}};this.getCallInfo=function(f,j,i,e){var g=this;if(!e){e=new jQuery.Deferred();}if(this.callInfoDeferred){this.callInfoDeferred.reject();this.callInfoDeferred=e;}var h={};if(d.call&&d.call.id){h.call_id=d.call.id;}else{h.outgoing_sid=f;}c.ajax({url:"/voice/calls/incoming_info",type:"GET",data:h,dataType:"json"}).always(function(k){if(i&&!i(k)&&!e.isResolved()){if(j<1){g.setCurrentCall({outgoing_sid:f,human_calling_number:"Unknown"});e.reject();}else{var l=_.bind(g.getCallInfo,g);_.delay(l,1000,f,j-1,i,e);}}else{g.setCurrentCall(k);e.resolveWith(k);}});return e.promise();};this.waitForAfterSetup=function(){if(!Twilio.Device.__afterSetup){setTimeout(this.waitForAfterSetup.bind(this),100);}else{if(this.afterSetupCallback){this.afterSetupCallback();}}};this.hookUpTwilioDevice=function(){var e=this;if(!window.Twilio){return;}this.switchBoard.bind("Zendesk.currentUser.availableForVoiceOn",function(f){e._acceptCalls=(f!=="off");if(f==="client"&&!e.clientAvailable&&!e.clientReadying){e.clientReadying=true;a.voiceMenu.catchFlash(function(){e.afterSetupCallback=function(){if(Twilio.Device.__afterSetup){Twilio.Device.__afterSetup(function(){Twilio.Device.instance.log.handler=function(g){if(typeof g==="string"){a.Voice.logger.log(e,g);}else{a.Voice.logger.log(e,JSON.stringify(g));}};});}if(window.WebSocket&&!window.WebSocket.__flash&&window.WebSocket.__initialize){WebSocket.__initialize();}Twilio.Device.setup(e.capabilityToken,{debug:a.currentUser.voice.logging});};if(a.currentUser.voice.logging){e.waitForAfterSetup();}else{e.afterSetupCallback();}});}});a.switchBoard.triggerInternal("Zendesk.currentUser.availableForVoiceOn",a.currentUser.availableForVoiceOn);Twilio.Device.ready(function(f){a.Voice.logger.log(d,"Twilio: ready",arguments);e.clientAvailable=true;e.clientReadying=false;if(!e.fightStaged){e.fight=new a.Fight("ringer",{win:function(){Twilio.Device.sounds.incoming(true);},lose:function(){Twilio.Device.sounds.incoming(false);},check:function(){return Twilio.Device.sounds.incoming();}});}e.fightStaged=true;if(a.voiceMenu.flashPermissionsDeferred){Twilio.MediaStream.__queue(function(){a.voiceMenu.showFlashPermissions();});a.voiceMenu.flashPermissionsDeferred=null;}});Twilio.Device.incoming(function(f){a.Voice.logger.log(d,"Twilio: incoming",JSON.stringify(f.parameters));e.connection=f;if(!e._acceptCalls&&f){f.disconnect();}f.error(function(g){a.Voice.logger.log(d,"Twilio connection: error",g.message,g.code,JSON.stringify(f.parameters));});e.getCallInfo(f.parameters.CallSid,3,function(g){return g&&g.status=="routing";}).always(function(){e.gotCallInfo=true;e.trigger("routing");e.gotCallInfo=false;});});Twilio.Device.connect(function(f){a.Voice.logger.log(d,"Twilio: connect",JSON.stringify(f.parameters));e.connection=f;e.getCallInfo(f.parameters.CallSid,3,function(g){return g&&g.connected_at;}).always(function(){e.trigger("in_conference");e.lastTrigger="in_conference";e.callOverlay.show();e.getCallInfo(f.parameters.CallSid,5,function(g){return g&&g.ticket&&g.ticket.nice_id;}).done(function(g){e.retrigger();});}).fail(function(){e.call.connected_at=new Date();e.retrigger();});});Twilio.Device.disconnect(function(f){a.Voice.logger.log(d,"Twilio: disconnect",JSON.stringify(f.parameters));e.connection=null;e.getCallInfo(f.parameters.CallSid,3,function(g){return g&&g.recording_url&&g.is_recording_url_ready;}).always(function(){e.trigger("completed");e.switchBoard.triggerExternal("Zendesk.CallConsoleApp.call",e.call);e.lastTrigger="completed";e.callOverlay.hide();e.getCallInfo(f.parameters.CallSid,3,function(g){return g&&g.ticket&&g.ticket.nice_id;}).always(function(g){e.retrigger();});});});Twilio.Device.cancel(function(f){a.Voice.logger.log(d,"Twilio: cancel",JSON.stringify(f.parameters));e.connection=null;e.trigger("close-console");});Twilio.Device.offline(function(){a.Voice.logger.log(d,"Twilio: offline",arguments);e.connection=null;e.clientAvailable=false;e.clientReadying=false;if(e.checkingOffline||a.currentUser.availableForVoiceOn!=="client"){return;}var f=a.voiceMenu.backOff([2,4,8,16],function(){if(Twilio.Device.status()!=="ready"){Twilio.Device.setup(e.capabilityToken,{debug:a.currentUser.voice.logging});return false;}else{return true;}});f.fail(function(){e.knockOfflineIfNotUnloading();}).always(function(){e.checkingOffline=false;});e.checkingOffline=true;});Twilio.Device.error(function(f){a.Voice.logger.log(d,"Twilio: error",f.message,f.code);e.connection=null;if(a.currentUser.availableForVoiceOn!=="client"){return;}if(e.fight&&e.fight.check()){a.voiceMenu.updateAvailability("off","offline");if(f.message==="No microphone is available"){alert(I18n.t("txt.voice.error.ec2"));}else{alert(I18n.t("txt.voice.error.ec3"));}}});};this.knockOfflineIfNotUnloading=function(){var e=this;var f=a.voiceMenu.backOff([1,2,3],function(){return window.voiceUnloading;});f.fail(function(){if(e.fight&&e.fight.check()){a.voiceMenu.updateAvailability("off","offline");alert(I18n.t("txt.voice.error.ec1"));}});};this.setupVoiceInMaintenance=function(){if(!a.currentUser.voice.in_maintenance){return;}c(".console-title-bar").addClass("notice");c(".console-title-notice").css("display","block");};this._muteCall=function(e){if(this.connection){if(e){this.connection.mute();}else{this.connection.unmute();}}};this.restoreState=function(){if(!this.call){return;}else{if(this.call.outgoing_kind!=="client"||this.call.status==="completed"){this.state=this.call.status;this.trigger(this.state,this.call);}}};this.clearState=function(){this.call=null;};this.setCurrentCall=function(e){if(!e){return this.call;}if(e.caller){e.caller.name=this.truncateString(e.caller.name,this.maxDisplayStringLength);if(e.caller.organization){e.caller.organization.name=this.truncateString(e.caller.organization.name,15);}}this.call=e;this.call.calling_number_encoded=encodeURIComponent(e.calling_number);return this.call;};this.bind("run",function(f){this.app.restoreState();});this.bind("show-console",function(f){this.$element().show();});this.bind("unanswered",function(f){this.trigger("close-console");});this.bind("close-console",function(f){this.$element().hide();this.app.clearState();});this.bind("accept-call",function(g,f){if(a.currentUser.availableForVoiceOn==="client"&&this.app.connection){this.app.connection.accept();}else{this.app.updateCall("agent_accepts");}this.$element().find(".console-title-text").html(I18n.t("txt.admin.public.javascripts.views.voice.call_console.waiting"));this.renderTemplate(c("#action_bar_accepted_call_template"));});this.bind("deny-call",function(g,f){if(a.currentUser.availableForVoiceOn==="client"&&this.app.connection){this.app.connection.disconnect();}this.app.updateCall("agent_declines");this.trigger("close-console");});this.bind("end-call",function(g,f){if(a.currentUser.availableForVoiceOn==="client"&&this.app.connection){this.app.connection.disconnect();}else{this.app.updateCall("agent_end_call");}this.renderTemplate(c("#action_bar_ending_call_template"));this.$element().find(".console-number").slideUp("slow");});this.bind("mute-call",function(g,f){if(this.app.clientAvailable){if(this.$element().find(".mute_call").hasClass("muted")){this.app._muteCall(false);}else{this.app._muteCall(true);}this.$element().find(".mute_call").toggleClass("muted");}});this.bind("finish-call",function(g,f){if(!this.app.call){return;}if(this.app.audioPlayer){this.app.audioPlayer.pause();}this.app.updateCall("finish");this.trigger("close-console");});this.setCall=function(e){this.call=e;this.call.calling_number_encoded=encodeURIComponent(e.calling_number);};this.updateCall=function(g){var f=this;var e=f.$element().is(":visible");c.ajax({url:"/voice/calls/update_status?call_id="+this.call.id+"&outgoing_sid="+this.call.outgoing_sid,type:"POST",data:{event:g},success:function(h){f.switchBoard.triggerExternal("Zendesk.CallConsoleApp.call",h,h.transaction_uuid);},error:function(){alert(I18n.t("txt.voice.error.ec4"));if(e){f.showConsoleIfNeeded();}else{f.hideConsoleIfNeeded();}}});};this.startTimer=function(){if(this.call&&this.call.connected_at&&!this.timer){this.timer=new b(new Date(this.call.connected_at),this.$element().find(".console-title-text"));}else{this.timer=new b(new Date(),this.$element().find(".console-title-text"));}};this.stopTimer=function(){if(this.timer){this.timer.stop();delete this.timer;}};this.bind("routing",function(h,f){if(a.currentUser.availableForVoiceOn==="client"&&!this.app.gotCallInfo){return;}f=this.app.setCurrentCall(f);var g=this;this.$element().find(".console-title-text").html(I18n.t("txt.admin.public.javascripts.views.voice.call_console.incoming_call"));this.renderTemplate(c("#number_template"),f);this.$element().find(".console-number").show();this.renderTemplate(c("#call_console_user_card"),f);this.renderTemplate(c("#action_bar_user_calling_template"),f);this.app.showConsoleIfNeeded();});this.bind("in_conference",function(h,f){if(a.currentUser.availableForVoiceOn==="client"&&!this.app.clientAvailable){return;}f=this.app.setCurrentCall(f);var g=this;this.app.startTimer();this.renderTemplate(c("#action_bar_in_call_template"));this.renderTemplate(c("#number_template"),f);this.$element().find(".console-number").show();this.renderTemplate(c("#call_console_user_card"),f);this.renderTemplate(c("#title_bar_in_call_template")).then(function(){g.$element().find(".mute_call").show();g.$element().find(".mute_call").unbind("click");g.$element().find(".mute_call").click(function(){g.app.trigger("mute-call");});});this.app.showConsoleIfNeeded();});this.bind("completed",function(h,f){f=this.app.setCurrentCall(f);var g=this;this.app.stopTimer();this.$element().find(".mute_call").hide();this.$element().find(".console-number").hide();this.$element().find(".console-title-text").html(I18n.t("txt.admin.public.javascripts.views.voice.call_console.call_ended"));this.renderTemplate(c("#action_bar_completed_call_template"));this.renderTemplate(c("#call_console_user_card"),f).then(function(){g.app.setupAudioPlayer();});this.app.showConsoleIfNeeded();});this.bind("voicemail",function(){this.trigger("close-console");});this.bind("voicemail_transcription_completed",function(){this.trigger("close-console");});this.bind("cancelled",function(){this.trigger("close-console");});this.bind("queued",function(){this.trigger("close-console");});this.bind("ended",function(){this.trigger("close-console");});this.truncateString=function(f,e){if(f.length>e){f=f.slice(0,e-f.length)+"...";}return f;};this.notFound=function(){};this.messageHandler=_.bind(function(g){g=g.message;var e=g.name;var h=g.data;var f=g.triggers;this.switchBoard.record(h.transaction_uuid);if(_.isUndefined(e)){return;}if(!f){return;}if(h.outgoing_kind!=="client"||h.status==="completed"||h.status==="ended"){d.safeTrigger(e,h);}},this);this.subscribeForMessages=function(){if(a.currentUser.voice.in_maintenance){return;}a.Voice.logger.log(this,"Subscribe","call_console."+a.currentUser.id);a.Pubsub.subscribe("call_console."+a.currentUser.id,this.messageHandler.bind(this));};this.pubsubChannel="call_console."+a.currentUser.id;this.initAudioPlayer=function(){var e=this;var f=new a.Sound("recording_"+e.call.id,e.call.player_recording_urls);f.load(function(){e.audioPlayer=new a.AudioPlayer(f,c("#audio_player_console_"+e.call.id));e.audioPlayer.init();});};this.setupAudioPlayer=function(){var e=this;if(this.call.recording_url&&this.call.is_recording_url_ready){e.initAudioPlayer();}else{if(this.call.outgoing_sid){this.getCallInfo(this.call.outgoing_sid,3,function(f){return f&&f.recording_url&&f.is_recording_url_ready;}).done(function(){e.initAudioPlayer();});}}};});a.CallConsoleApp=d;}(jQuery,Zendesk));(function(b,a){a.CallOverlay=(function(){var f,c;var d=function(){if(!c){b("#call-console a, #cboxWrapper a").live("click",function(g){if(!f){return;}g.preventDefault();g.stopPropagation();window.open(this.href,"_blank");});c=true;}};function e(){this.show=function(){f=true;b("#voice-blocking-banner").slideDown(1000);b("#voice-blocking-overlay").show();d();};this.hide=function(){f=false;b("#voice-blocking-banner").slideUp(1000);b("#voice-blocking-overlay").hide();};}return e;})();}(jQuery,Zendesk));(function(b,a){a.Fight=(function(){function c(e,d){this.name="Fight: "+e;this.options=d||{};this.check=d.check||function(){};this.win=d.win||function(){};this.lose=d.lose||function(){};this.channelName=e;this.localSwitchBoard=a.switchBoard._localStorage;this.stageFight();}c.prototype.commenceFight=function(){if(this.check()){this.localSwitchBoard.publish(this.channelName,{kind:"start_fight",uuid:uuid()});}};c.prototype.turnOn=function(){a.Voice.logger.log(this,"on");this.win();};c.prototype.turnOff=function(){a.Voice.logger.log(this,"off");this.lose();};c.prototype.punch=function(){this.stillFighting=true;this.turnOn();this.fightStrength=uuid();this.localSwitchBoard.publish(this.channelName,{kind:"punch",uuid:this.fightStrength});};c.prototype.receivePunch=function(d){this.stillFighting=(d>=this.fightStrength)&&this.stillFighting;if(!this.stillFighting){this.turnOff();}};c.prototype.knockout=function(){this.turnOn();this.localSwitchBoard.publish(this.channelName,{kind:"knockout",uuid:uuid()});};c.prototype.receiveKnockout=function(d){if(d===this.fightStrength){return;}this.turnOff();};c.prototype.stageFight=function(){var d=this;this.localSwitchBoard.subscribe(this.channelName,function(e){switch(e.kind){case"knockout":d.receiveKnockout(e.uuid);break;case"start_fight":d.punch();break;case"punch":d.receivePunch(e.uuid);break;}});b(window).bind("beforeunload",function(){d.commenceFight();});this.knockout();};return c;})();}(jQuery,Zendesk));(function($){var msOldDiv="";var dd=function(element,options){var sElement=element;var $this=this;var options=$.extend({height:120,visibleRows:7,rowHeight:23,showIcon:true,zIndex:9999,mainCSS:"dd",useSprite:false,animStyle:"slideDown",onInit:"",style:""},options);this.ddProp=new Object;var oldSelectedValue="";var actionSettings={};actionSettings.insideWindow=true;actionSettings.keyboardAction=false;actionSettings.currentKey=null;var ddList=false;var config={postElementHolder:"_msddHolder",postID:"_msdd",postTitleID:"_title",postTitleTextID:"_titletext",postChildID:"_child",postAID:"_msa",postOPTAID:"_msopta",postInputID:"_msinput",postArrowID:"_arrow",postInputhidden:"_inp"};var styles={dd:options.mainCSS,ddTitle:"ddTitle",arrow:"arrow",ddChild:"ddChild",ddTitleText:"ddTitleText",disabled:0.3,ddOutOfVision:"ddOutOfVision",borderTop:"borderTop",noBorderTop:"noBorderTop",selected:"selected"};var attributes={actions:"focus,blur,change,click,dblclick,mousedown,mouseup,mouseover,mousemove,mouseout,keypress,keydown,keyup",prop:"size,multiple,disabled,tabindex"};this.onActions=new Object;var elementid=$(sElement).prop("id");if(typeof elementid=="undefined"||elementid.length<=0){elementid="msdrpdd"+$.msDropDown.counter++;$(sElement).attr("id",elementid);}var inlineCSS=$(sElement).prop("style");options.style+=inlineCSS==undefined?"":inlineCSS;var allOptions=$(sElement).children();ddList=$(sElement).prop("size")>1||$(sElement).prop("multiple")==true?true:false;if(ddList){options.visibleRows=$(sElement).prop("size");}var a_array={};var currentP=0;var isFilter=false;var oldHeight;var cacheElement={};var getElement=function(a){if(typeof cacheElement[a]=="undefined"){cacheElement[a]=document.getElementById(a);}return cacheElement[a];};var getPostID=function(a){return elementid+config[a];};var getOptionsProperties=function(a){var b=a;var c=$(b).prop("style");return c;};var matchIndex=function(a){var b=$("#"+elementid+" option:selected");if(b.length>1){for(var c=0;c<b.length;c++){if(a==b[c].index){return true;}}}else{if(b.length==1){if(b[0].index==a){return true;}}}return false;};var createA=function(a,b,c,d){var e="";var f=d=="opt"?getPostID("postOPTAID"):getPostID("postAID");var g=d=="opt"?f+"_"+b+"_"+c:f+"_"+b;var h="";var i="";if(options.useSprite!=false){i=" "+options.useSprite+" "+a.className;}else{h=$(a).prop("title");h=h.length==0?"":'<img src="'+h+'" align="absmiddle" /> ';}var j=$(a).text();var k=$(a).val();var l=$(a).prop("disabled")==true?"disabled":"enabled";a_array[g]={html:h+j,value:k,text:j,index:a.index,id:g};var m=getOptionsProperties(a);if(matchIndex(a.index)==true){e+='<a href="javascript:void(0);" class="'+styles.selected+" "+l+i+'"';}else{e+='<a  href="javascript:void(0);" class="'+l+i+'"';}if(m!==false&&m!==undefined){e+=" style='"+m+"'";}e+=' id="'+g+'">';e+=h+'<span class="'+styles.ddTitleText+'">'+j+"</span></a>";return e;};var in_array=function(a){var b=a.toLowerCase();if(b.length==0){return -1;}var c="";for(var d in a_array){var e=a_array[d].text.toLowerCase();if(e.substr(0,b.length)==b){c+="#"+a_array[d].id+", ";}}return c==""?-1:c;};var createATags=function(){var a=allOptions;if(a.length==0){return"";}var b="";var c=getPostID("postAID");var d=getPostID("postOPTAID");a.each(function(c){var d=a[c];if(d.nodeName=="OPTGROUP"){b+="<div class='opta'>";b+="<span style='font-weight:bold;font-style:italic; clear:both;'>"+$(d).prop("label")+"</span>";var e=$(d).children();e.each(function(a){var d=e[a];b+=createA(d,c,a,"opt");});b+="</div>";}else{b+=createA(d,c,"","");}});return b;};var createChildDiv=function(){var a=getPostID("postID");var b=getPostID("postChildID");var c=options.style;sDiv="";sDiv+='<div id="'+b+'" class="'+styles.ddChild+'"';if(!ddList){sDiv+=c!=""?' style="'+c+'"':"";}else{sDiv+=c!=""?' style="border-top:1px solid #c3c3c3;display:block;position:relative;'+c+'"':"";}sDiv+=">";return sDiv;};var createTitleDiv=function(){var a=getPostID("postTitleID");var b=getPostID("postArrowID");var c=getPostID("postTitleTextID");var d=getPostID("postInputhidden");var e="";var f="";if(getElement(elementid).options.length>0){e=$("#"+elementid+" option:selected").text();f=$("#"+elementid+" option:selected").prop("title");}f=f.length==0||f==undefined||options.showIcon==false||options.useSprite!=false?"":'<img src="'+f+'" align="absmiddle" /> ';var g='<div id="'+a+'" class="'+styles.ddTitle+'"';g+=">";g+='<span id="'+b+'" class="'+styles.arrow+'"></span><span class="'+styles.ddTitleText+'" id="'+c+'">'+f+'<span class="'+styles.ddTitleText+'">'+e+"</span></span></div>";return g;};var applyEventsOnA=function(){var a=getPostID("postChildID");$("#"+a+" a.enabled").unbind("click");$("#"+a+" a.enabled").bind("click",function(b){b.preventDefault();manageSelection(this);setValue();if(!ddList){$("#"+a).unbind("mouseover");setInsideWindow(false);var c=options.showIcon==false?$(this).text():$(this).html();setTitleText(c);$this.close();}});};var createDropDown=function(){var a=false;var b=getPostID("postID");var c=getPostID("postTitleID");var d=getPostID("postTitleTextID");var e=getPostID("postChildID");var f=getPostID("postArrowID");var g=$("#"+elementid).outerWidth()+20;g=g+2;var h=options.style;if($("#"+b).length>0){$("#"+b).remove();a=true;}var i='<div id="'+b+'" class="'+styles.dd+'"';i+=h!=""?' style="'+h+'"':"";i+=">";i+=createTitleDiv();i+=createChildDiv();i+=createATags();i+="</div>";i+="</div>";if(a==true){var j=getPostID("postElementHolder");$("#"+j).after(i);}else{$("#"+elementid).after(i);}if(ddList){var c=getPostID("postTitleID");$("#"+c).hide();}$("#"+b).css("width",g+"px");$("#"+e).css("width",g-2+"px");if(allOptions.length>options.visibleRows){var k=parseInt($("#"+e+" a:first").css("padding-bottom"))+parseInt($("#"+e+" a:first").css("padding-top"));var l=options.rowHeight*options.visibleRows-k;$("#"+e).css("height",l+"px");}else{if(ddList){var l=$("#"+elementid).height();$("#"+e).css("height",l+"px");}}if(a==false){setOutOfVision();addRefreshMethods(elementid);}if($("#"+elementid).prop("disabled")==true){$("#"+b).css("opacity",styles.disabled);}applyEvents();$("#"+c).bind("mouseover",function(a){hightlightArrow(1);});$("#"+c).bind("mouseout",function(a){hightlightArrow(0);});applyEventsOnA();$("#"+e+" a.disabled").css("opacity",styles.disabled);if(ddList){$("#"+e).bind("mouseover",function(a){if(!actionSettings.keyboardAction){actionSettings.keyboardAction=true;$(document).bind("keydown",function(a){var b=a.keyCode;actionSettings.currentKey=b;if(b==39||b==40){a.preventDefault();a.stopPropagation();next();setValue();}if(b==37||b==38){a.preventDefault();a.stopPropagation();previous();setValue();}});}});}$("#"+e).bind("mouseout",function(a){setInsideWindow(false);$(document).unbind("keydown");actionSettings.keyboardAction=false;actionSettings.currentKey=null;});$("#"+c).bind("click",function(a){setInsideWindow(false);if($("#"+e+":visible").length==1){$("#"+e).unbind("mouseover");}else{$("#"+e).bind("mouseover",function(a){setInsideWindow(true);});$this.open();}});$("#"+c).bind("mouseout",function(a){setInsideWindow(false);});if(options.showIcon&&options.useSprite!=false){setTitleImageSprite();}};var getByIndex=function(a){for(var b in a_array){if(a_array[b].index==a){return a_array[b];}}return -1;};var manageSelection=function(a){var b=getPostID("postChildID");if($("#"+b+" a."+styles.selected).length==1){oldSelectedValue=$("#"+b+" a."+styles.selected).text();}if(!ddList){$("#"+b+" a."+styles.selected).removeClass(styles.selected);}var c=$("#"+b+" a."+styles.selected).prop("id");if(c!=undefined){var d=actionSettings.oldIndex==undefined||actionSettings.oldIndex==null?a_array[c].index:actionSettings.oldIndex;}if(a&&!ddList){$(a).addClass(styles.selected);}if(ddList){var e=actionSettings.currentKey;if($("#"+elementid).prop("multiple")==true){if(e==17){actionSettings.oldIndex=a_array[$(a).prop("id")].index;$(a).toggleClass(styles.selected);}else{if(e==16){$("#"+b+" a."+styles.selected).removeClass(styles.selected);$(a).addClass(styles.selected);var f=$(a).prop("id");var g=a_array[f].index;for(var h=Math.min(d,g);h<=Math.max(d,g);h++){$("#"+getByIndex(h).id).addClass(styles.selected);}}else{$("#"+b+" a."+styles.selected).removeClass(styles.selected);$(a).addClass(styles.selected);actionSettings.oldIndex=a_array[$(a).prop("id")].index;}}}else{$("#"+b+" a."+styles.selected).removeClass(styles.selected);$(a).addClass(styles.selected);actionSettings.oldIndex=a_array[$(a).prop("id")].index;}}};var addRefreshMethods=function(a){var b=a;getElement(b).refresh=function(a){$("#"+b).msDropDown(options);};};var setInsideWindow=function(a){actionSettings.insideWindow=a;};var getInsideWindow=function(){return actionSettings.insideWindow;};var applyEvents=function(){var a=getPostID("postID");var b=attributes.actions.split(",");for(var c=0;c<b.length;c++){var d=b[c];var e=has_handler(d);if(e==true){switch(d){case"focus":$("#"+a).bind("mouseenter",function(a){getElement(elementid).focus();});break;case"click":$("#"+a).bind("click",function(a){$("#"+elementid).trigger("click");});break;case"dblclick":$("#"+a).bind("dblclick",function(a){$("#"+elementid).trigger("dblclick");});break;case"mousedown":$("#"+a).bind("mousedown",function(a){$("#"+elementid).trigger("mousedown");});break;case"mouseup":$("#"+a).bind("mouseup",function(a){$("#"+elementid).trigger("mouseup");});break;case"mouseover":$("#"+a).bind("mouseover",function(a){$("#"+elementid).trigger("mouseover");});break;case"mousemove":$("#"+a).bind("mousemove",function(a){$("#"+elementid).trigger("mousemove");});break;case"mouseout":$("#"+a).bind("mouseout",function(a){$("#"+elementid).trigger("mouseout");});break;}}}};var setOutOfVision=function(){var a=getPostID("postElementHolder");$("#"+elementid).after("<div class='"+styles.ddOutOfVision+"' style='height:0px;overflow:hidden;position:absolute;' id='"+a+"'></div>");$("#"+elementid).appendTo($("#"+a));};var setTitleText=function(a){var b=getPostID("postTitleTextID");$("#"+b).html(a);};var navigateA=function(a){var b=a;var c=getPostID("postChildID");var d=$("#"+c+" a:visible");var e=d.length;var f=$("#"+c+" a:visible").index($("#"+c+" a.selected:visible"));var g;switch(b){case"next":if(f<e-1){f++;g=d[f];}break;case"previous":if(f<e&&f>0){f--;g=d[f];}break;}if(typeof g=="undefined"){return false;}$("#"+c+" a."+styles.selected).removeClass(styles.selected);$(g).addClass(styles.selected);var h=g.id;if(!ddList){var i=options.showIcon==false?a_array[h].text:$("#"+h).html();setTitleText(i);setTitleImageSprite(a_array[h].index);}if(b=="next"){if(parseInt($("#"+h).position().top+$("#"+h).height())>=parseInt($("#"+c).height())){$("#"+c).scrollTop($("#"+c).scrollTop()+$("#"+h).height()+$("#"+h).height());}}else{if(parseInt($("#"+h).position().top+$("#"+h).height())<=0){$("#"+c).scrollTop($("#"+c).scrollTop()-$("#"+c).height()-$("#"+h).height());}}};var next=function(){navigateA("next");};var previous=function(){navigateA("previous");};var setTitleImageSprite=function(a){if(options.useSprite!=false){var b=getPostID("postTitleTextID");var c=typeof a=="undefined"?getElement(elementid).selectedIndex:a;var d=getElement(elementid).options[c].className;if(d.length>0){var e=getPostID("postChildID");var f=$("#"+e+" a."+d).prop("id");var g=$("#"+f).css("background-image");var h=$("#"+f).css("background-position");var i=$("#"+f).css("padding-left");if(g!=undefined){$("#"+b).find("."+styles.ddTitleText).attr("style","background:"+g);}if(h!=undefined){$("#"+b).find("."+styles.ddTitleText).css("background-position",h);}if(i!=undefined){$("#"+b).find("."+styles.ddTitleText).css("padding-left",i);}$("#"+b).find("."+styles.ddTitleText).css("background-repeat","no-repeat");$("#"+b).find("."+styles.ddTitleText).css("padding-bottom","2px");}}};var setValue=function(){var a=getPostID("postChildID");var b=$("#"+a+" a."+styles.selected);if(b.length==1){var c=$("#"+a+" a."+styles.selected).text();var d=$("#"+a+" a."+styles.selected).prop("id");if(d!=undefined){var e=a_array[d].value;getElement(elementid).selectedIndex=a_array[d].index;}if(options.showIcon&&options.useSprite!=false){setTitleImageSprite();}}else{if(b.length>1){for(var f=0;f<b.length;f++){var d=$(b[f]).prop("id");var g=a_array[d].index;getElement(elementid).options[g].selected="selected";}}}var h=getElement(elementid).selectedIndex;$this.ddProp.selectedIndex=h;};var has_handler=function(a){if($("#"+elementid).prop("on"+a)!=undefined){return true;}var b=$("#"+elementid).data("events");if(b&&b[a]){return true;}return false;};var checkMethodAndApply=function(){var a=getPostID("postChildID");if(has_handler("change")==true){var b=a_array[$("#"+a+" a.selected").prop("id")].text;if($.trim(oldSelectedValue)!==$.trim(b)&&oldSelectedValue!==""){$("#"+elementid).trigger("change");}}if(has_handler("mouseup")==true){$("#"+elementid).trigger("mouseup");}if(has_handler("blur")==true){$(document).bind("mouseup",function(a){$("#"+elementid).focus();$("#"+elementid)[0].blur();setValue();$(document).unbind("mouseup");});}};var hightlightArrow=function(a){var b=getPostID("postArrowID");if(a==1){$("#"+b).css({backgroundPosition:"0 100%"});}else{$("#"+b).css({backgroundPosition:"0 0"});}};var setOriginalProperties=function(){for(var a in getElement(elementid)){if(typeof getElement(elementid)[a]!="function"&&getElement(elementid)[a]!==undefined&&getElement(elementid)[a]!==null){$this.set(a,getElement(elementid)[a],true);}}};var setValueByIndex=function(a,b){if(getByIndex(b)!=-1){getElement(elementid)[a]=b;var c=getPostID("postChildID");$("#"+c+" a."+styles.selected).removeClass(styles.selected);$("#"+getByIndex(b).id).addClass(styles.selected);var d=getByIndex(getElement(elementid).selectedIndex).html;setTitleText(d);}};var addRemoveFromIndex=function(a,b){if(b=="d"){for(var c in a_array){if(a_array[c].index==a){delete a_array[c];break;}}}var d=0;for(var c in a_array){a_array[c].index=d;d++;}};var shouldOpenOpposite=function(){var a=getPostID("postChildID");var b=getPostID("postID");var c=$("#"+b).position();var d=$("#"+b).height();var e=$(window).height();var f=$(window).scrollTop();var g=$("#"+a).height();var h={zIndex:options.zIndex,top:c.top+d+"px",display:"none"};var i=options.animStyle;var j=false;var k=styles.noBorderTop;$("#"+a).removeClass(styles.noBorderTop);$("#"+a).removeClass(styles.borderTop);if(e+f<Math.floor(g+d+c.top)){var l=c.top-g;if(c.top-g<0){l=10;}h={zIndex:options.zIndex,top:l+"px",display:"none"};i="show";j=true;k=styles.borderTop;}return{opp:j,ani:i,css:h,border:k};};var fireOpenEvent=function(){if($this.onActions.onOpen!=null){eval($this.onActions.onOpen)($this);}};var fireCloseEvent=function(){checkMethodAndApply();if($this.onActions.onClose!=null){eval($this.onActions.onClose)($this);}};this.open=function(){if($this.get("disabled",true)==true||$this.get("options",true).length==0){return;}var a=getPostID("postChildID");if(msOldDiv!=""&&a!=msOldDiv){$("#"+msOldDiv).slideUp("fast");$("#"+msOldDiv).css({zIndex:"0"});}if($("#"+a).css("display")=="none"){oldSelectedValue=a_array[$("#"+a+" a.selected").prop("id")].text;var b="";oldHeight=$("#"+a).height();$("#"+a+" a").show();$(document).bind("keydown",function(c){var d=c.keyCode;if(d==8){c.preventDefault();c.stopPropagation();b=b.length==0?"":b.substr(0,b.length-1);}switch(d){case 39:case 40:c.preventDefault();c.stopPropagation();next();break;case 37:case 38:c.preventDefault();c.stopPropagation();previous();break;case 27:case 13:$this.close();setValue();break;default:if(d>46){b+=String.fromCharCode(d);}var e=in_array(b);if(e!=-1){$("#"+a).css({height:"auto"});$("#"+a+" a").hide();$(e).show();var f=shouldOpenOpposite();$("#"+a).css(f.css);$("#"+a).css({display:"block"});}else{$("#"+a+" a").show();$("#"+a).css({height:oldHeight+"px"});}break;}if(has_handler("keydown")==true){getElement(elementid).onkeydown();}});$(document).bind("keyup",function(a){if($("#"+elementid).prop("onkeyup")!=undefined){getElement(elementid).onkeyup();}});$(document).bind("mouseup",function(a){if(getInsideWindow()==false){$this.close();}});var c=shouldOpenOpposite();$("#"+a).css(c.css);if(c.opp==true){$("#"+a).css({display:"block"});$("#"+a).addClass(c.border);fireOpenEvent();}else{$("#"+a)[c.ani]("fast",function(){$("#"+a).addClass(c.border);fireOpenEvent();});}if(a!=msOldDiv){msOldDiv=a;}}};this.close=function(){var a=getPostID("postChildID");var b=$("#"+getPostID("postTitleID")).position().top;var c=shouldOpenOpposite();isFilter=false;if(c.opp==true){$("#"+a).animate({height:0,top:b},function(){$("#"+a).css({height:oldHeight+"px",display:"none"});fireCloseEvent();});}else{$("#"+a).slideUp("fast",function(b){fireCloseEvent();$("#"+a).css({zIndex:"0"});$("#"+a).css({height:oldHeight+"px"});});}setTitleImageSprite();$(document).unbind("keydown");$(document).unbind("keyup");$(document).unbind("mouseup");};this.selectedIndex=function(a){if(typeof a=="undefined"){return $this.get("selectedIndex");}else{$this.set("selectedIndex",a);}};this.debug=function(a){if(typeof a=="undefined"||a==true){$("."+styles.ddOutOfVision).removeAttr("style");}else{$("."+styles.ddOutOfVision).attr("style","height:0px;overflow:hidden;position:absolute");}};this.set=function(a,b,c){if(a==undefined||b==undefined){throw {message:"set to what?"};}$this.ddProp[a]=b;if(c!=true){switch(a){case"selectedIndex":setValueByIndex(a,b);break;case"disabled":$this.disabled(b,true);break;case"multiple":getElement(elementid)[a]=b;ddList=$(sElement).prop("size")>0||$(sElement).prop("multiple")==true?true:false;if(ddList){var d=$("#"+elementid).height();var e=getPostID("postChildID");$("#"+e).css("height",d+"px");var f=getPostID("postTitleID");$("#"+f).hide();var e=getPostID("postChildID");$("#"+e).css({display:"block",position:"relative"});applyEventsOnA();}break;case"size":getElement(elementid)[a]=b;if(b==0){getElement(elementid).multiple=false;}ddList=$(sElement).prop("size")>0||$(sElement).prop("multiple")==true?true:false;if(b==0){var f=getPostID("postTitleID");$("#"+f).show();var e=getPostID("postChildID");$("#"+e).css({display:"none",position:"absolute"});var g="";if(getElement(elementid).selectedIndex>=0){var h=getByIndex(getElement(elementid).selectedIndex);g=h.html;manageSelection($("#"+h.id));}setTitleText(g);}else{var f=getPostID("postTitleID");$("#"+f).hide();var e=getPostID("postChildID");$("#"+e).css({display:"block",position:"relative"});}break;default:try{getElement(elementid)[a]=b;}catch(i){}break;}}};this.get=function(a,b){if(a==undefined&&b==undefined){return $this.ddProp;}if(a!=undefined&&b==undefined){return $this.ddProp[a]!=undefined?$this.ddProp[a]:null;}if(a!=undefined&&b!=undefined){return getElement(elementid)[a];}};this.visible=function(a){var b=getPostID("postID");if(a==true){$("#"+b).show();}else{if(a==false){$("#"+b).hide();}else{return $("#"+b).css("display");}}};this.add=function(a,b){var c=a;var d=c.text;var e=c.value==undefined||c.value==null?d:c.value;var f=c.title==undefined||c.title==null?"":c.title;var g=b==undefined||b==null?getElement(elementid).options.length:b;getElement(elementid).options[g]=new Option(d,e);if(f!=""){getElement(elementid).options[g]["title"]=f;}var h=getByIndex(g);if(h!=-1){var i=createA(getElement(elementid).options[g],g,"","");$("#"+h.id).html(i);}else{var i=createA(getElement(elementid).options[g],g,"","");var j=getPostID("postChildID");$("#"+j).append(i);applyEventsOnA();}};this.remove=function(a){getElement(elementid).remove(a);if(getByIndex(a)!=-1){$("#"+getByIndex(a).id).remove();addRemoveFromIndex(a,"d");}if(getElement(elementid).length==0){setTitleText("");}else{var b=getByIndex(getElement(elementid).selectedIndex).html;setTitleText(b);}$this.set("selectedIndex",getElement(elementid).selectedIndex);};this.disabled=function(a,b){getElement(elementid).disabled=a;var c=getPostID("postID");if(a==true){$("#"+c).css("opacity",styles.disabled);$this.close();}else{if(a==false){$("#"+c).css("opacity",1);}}if(b!=true){$this.set("disabled",a);}};this.form=function(){return getElement(elementid).form==undefined?null:getElement(elementid).form;};this.item=function(){if(arguments.length==1){return getElement(elementid).item(arguments[0]);}else{if(arguments.length==2){return getElement(elementid).item(arguments[0],arguments[1]);}else{throw {message:"An index is required!"};}}};this.namedItem=function(a){return getElement(elementid).namedItem(a);};this.multiple=function(a){if(typeof a=="undefined"){return $this.get("multiple");}else{$this.set("multiple",a);}};this.size=function(a){if(typeof a=="undefined"){return $this.get("size");}else{$this.set("size",a);}};this.addMyEvent=function(a,b){$this.onActions[a]=b;};this.fireEvent=function(nm){eval($this.onActions[nm])($this);};var updateCommonVars=function(){$this.set("version",$.msDropDown.version);$this.set("author",$.msDropDown.author);};var init=function(){createDropDown();setOriginalProperties();updateCommonVars();if(options.onInit!=""){eval(options.onInit)($this);}};init();};$.msDropDown={version:2.37,author:"Marghoob Suleman",counter:20,create:function(a,b){return $(a).msDropDown(b).data("dd");}};$.fn.extend({msDropDown:function(a){return this.each(function(){var b=new dd(this,a);$(this).data("dd",b);});}});if(typeof $.fn.prop=="undefined"){$.fn.prop=function(a){return $(this).attr(a);};}})(jQuery);Zendesk.NS("Voice");(function(b,a){a.Voice.Logger=(function(){var e,f=false,c=[];if(a.Storage.isSupported()){e=a.Storage.handle();}else{e=a.SwitchBoard.fakeStorage;}function d(){this.uuid=uuid().split("-")[0];this.log=function(){var j=Array.prototype.slice.call(arguments);var i=j.shift();var h=new Date();j.unshift("[Voice: "+this.uuid+" "+h.valueOf()+"] ("+i.name+")");this.write(j);};this.print=function(){if(typeof window.console!="undefined"){window.console.log(this.storedLog());}else{if(typeof console!="undefined"){console.log(this.storedLog());}}};var g=this;b(window).load(function(){f=true;b.each(c,function(h,i){g.commit(i);});c=[];});}d.prototype.storedLog=function(){return e.getItem("Zendesk.Voice.Logger")||"";};d.prototype.write=function(g){if(a.Voice.Logger.debug){if(typeof window.console!="undefined"){if($j.isFunction(window.console.log.apply)){window.console.log.apply(window.console,g);}else{window.console.log(g.join("; "));}}else{if(typeof console!="undefined"){console.log.apply(console,g);}}}if(a.Voice.Logger.debug||this.enabled){var h=g.join(" ");this.commit(h);}};d.prototype.commit=function(h){var g=this;if(f){_.defer(function(){h=g.storedLog()+"\n"+h;e.setItem("Zendesk.Voice.Logger",h);});}else{c.commit(h);}};d.prototype.enableLogging=function(){this.enabled=true;var g=false;var i=16;b(document).keydown(function(j){if(j.keyCode==i){g=true;}}).keyup(function(j){if(j.keyCode==i){g=false;}});var h=this;b("#phone_menu_item").dblclick(function(j){b.colorbox({html:"<pre style='height: 90%;'>"+h.storedLog()+"</pre><div class='border'></div><a href='mailto:support@zendesk.com?subject=Problem%20with%20Zendesk%20Voice&body=Describe the problem:%0D%0A%0D%0A"+h.storedLog().replace(/\n/g,"%0D%0A")+"'>Report Problem</a>",initialWidth:500,initialHeight:100,width:"80%",height:"80%",opacity:0.82,onLoad:function(){b("#colorbox, #cboxWrapper, #cboxOverlay").addClass("voiceBlocked");},onCleanup:function(){b("#colorbox, #cboxWrapper, #cboxOverlay").removeClass("voiceBlocked");}});j.preventDefault();});};return d;})();a.Voice.logger=new a.Voice.Logger();}(jQuery,Zendesk));Zendesk.NS("Voice");(function(b,a){b(".call-history-container a.sortable, .call-history-container .pagination a").live("click",function(){b.getScript(this.href);return false;});b("#call_history a.more").live("click",function(){var c=b(this).attr("data-call-id");b("#call_history .breakdown[data-call-id="+c+"]").toggle();b(this).toggleClass("expanded");if(b(this).hasClass("expanded")){b(this).html("(less)");}else{b(this).html("(more)");}});a.Voice.History={filter:function(){b.ajax({url:"/voice/settings?period="+b("#call_billing_period").val(),type:"GET",dataType:"script",beforeSend:function(){b("#call_history .loading-placeholder").addClass("loading");}});}};}(jQuery,Zendesk));Zendesk.NS("Voice");Zendesk.Voice.GreetingsPicker=function(a){this.formContainer=$j(a);};Zendesk.Voice.GreetingsPicker.prototype={init:function(){this.waitContainer=this.formContainer.find("#wait_greeting_audio");this.voicemailContainer=this.formContainer.find("#voicemail_greeting_audio");this.holdContainer=this.formContainer.find("#hold_greeting_audio");_(["wait_greeting","voicemail_greeting","hold_greeting"]).each(function(a){this.setupAudioPlayer(a);this.bindGreetingsSelect(a);},this);},containerForKind:function(a){switch(a){case"wait_greeting":return this.waitContainer;case"voicemail_greeting":return this.voicemailContainer;case"hold_greeting":return this.holdContainer;}},setupAudioPlayer:function(b){var a=this.containerForKind(b);a.find(".audio").each(function(g,d){d=$j(d);var c=d.attr("data-audio-id");var f=d.attr("data-audio-src");var e=new Zendesk.Sound(c,f);e.load(function(h){d.click(function(){if(d.hasClass("playing")){d.val(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.play"));d.removeClass("playing");h.pause();}else{d.val(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.pause"));d.addClass("playing");h.play({onfinish:function(){d.val(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.play"));d.removeClass("playing");}});}});});});},bindGreetingsSelect:function(c){var a=this.containerForKind(c);var b=this;a.find(".greeting_options").change(function(f){var d=this;if($j(this).val()=="default"){b.resetGreeting(c);}else{if($j(this).val()=="new_custom"){b.showCustomGreetingFormMainPage(c);}else{if($j(this).val()=="none"){b.emptyGreeting(c);}}}if(f){f.preventDefault();}});},showCustomGreetingFormMainPage:function(d){var a=this.containerForKind(d);var c=a.find(".greeting_options");if(d==="hold_greeting"){$j("#custom_greeting_form").html($j("#custom_greeting_form_upload_page").html());}else{$j("#custom_greeting_form").html($j("#custom_greeting_form_main_page").html());}$j("#custom_greeting_form #greeting_upload").attr("name",d);$j("#custom_greeting_form h2.title").hide();switch(d){case"wait_greeting":$j("#custom_greeting_available_agents_title").show();break;case"voicemail_greeting":$j("#custom_greeting_voicemail_title").show();break;}$j.colorbox.resize();var b=this;$j("#voice_custom_greeting_form #record_custom_greeting_button").click(function(f){b.showCustomGreetingFormRecordPage(d);if(f){f.preventDefault();}});$j("#voice_custom_greeting_form #greeting_upload").change(this.submitCustomGreetingForm);$j.colorbox({inline:true,href:"#custom_greeting_form",scrolling:false,onClosed:function(){$j(c).val($j(c).attr("data-audio-type"));},onComplete:function(){var f=$j("#greeting_upload");var e=$j("#upload_custom_greeting_button");f.mouseover(function(){e.addClass("hover");});f.mouseout(function(){e.removeClass("hover");});f.mousedown(function(){e.addClass("active");});f.mouseup(function(){e.removeClass("active");});}});},showCustomGreetingFormRecordPage:function(b){var a=this;$j("#custom_greeting_form").html($j("#custom_greeting_form_record_page").html());$j("#voice_custom_greeting_form h2.title").hide();switch(b){case"wait_greeting":$j("#custom_greeting_available_agents_title").show();break;case"voicemail_greeting":$j("#custom_greeting_voicemail_title").show();break;}$j.colorbox.resize();$j("#custom_greeting_form #call_phone_number").focus();$j("#custom_greeting_form #call_phone_number_button").click(function(c){a.startRecordingFlow(b);if(c){c.preventDefault();}});},startRecordingFlow:function(a){this.callingNumber=$j("#custom_greeting_form #call_phone_number").val();this.recordingKind=a;if(!this.callingNumber.match(/\d+/)){return;}$j.ajax({url:"/voice/calls/greetings/call_number",type:"post",data:{call_phone_number:this.callingNumber,kind:a}});var b=I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.calling_you_at",{number:this.callingNumber});$j("#custom_greeting_form").html($j.mustache($j("#custom_greeting_form_record_wait_page").html(),{message:b}));$j("#custom_greeting_form h2.title").hide();switch(a){case"wait_greeting":$j("#custom_greeting_available_agents_title").show();break;case"voicemail_greeting":$j("#custom_greeting_voicemail_title").show();break;}_.defer($j.colorbox.resize);Zendesk.Pubsub.subscribe("call_recording."+Zendesk.currentAccount.id,this.recordingUpdateHandler.bind(this));},recordingUpdateHandler:function(b){var a=b.message.status;switch(a){case"complete":this.reloadGreeting(this.recordingKind,function(){$j.colorbox.close();window.location.reload(true);});break;case"incomplete":$j("#custom_greeting_form #record_wait_message").html(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.couldnt_complete_recording"));_.defer($j.colorbox.resize);_.delay($j.colorbox.close,2000);break;}},reloadGreeting:function(b,c){var a=this;$j.ajax({url:"/voice/settings/greeting",type:"get",data:{kind:b},success:function(d){a.renderGreeting(b,d);if(_.isFunction(c)){c();}},error:function(){alert("Error fetching greeting");if(_.isFunction(c)){c();}}});},resetGreeting:function(d){var a=this.containerForKind(d);var c=a.find(".greeting_options");if(!confirm(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.this_will_reset"))){$j(c).val($j(c).attr("data-audio-type"));return;}var b=this;$j.ajax({url:"/voice/settings/reset_greeting",type:"delete",data:{kind:d},success:function(e){b.renderGreeting(d,e);},error:function(){alert(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.error_resetting_greeting"));}});},emptyGreeting:function(d){var a=this.containerForKind(d);var c=a.find(".greeting_options");if(!confirm(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.empty_greeting_confirm"))){$j(c).val($j(c).attr("data-audio-type"));return;}var b=this;$j.ajax({url:"/voice/settings",type:"put",data:{kind:d,blank:true},success:function(e){b.renderGreeting(d,e);},error:function(){alert(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.error_updating_greeting"));}});},renderGreeting:function(b,a){$j("#"+b+"_audio").html(a).effect("highlight",{},1000);switch(b){case"wait_greeting":this.waitContainer=this.formContainer.find("#wait_greeting_audio");break;case"voicemail_greeting":this.voicemailContainer=this.formContainer.find("#voicemail_greeting_audio");break;case"hold_greeting":this.holdContainer=this.formContainer.find("#hold_greeting_audio");break;}this.bindGreetingsSelect(b);this.setupAudioPlayer(b);},submitCustomGreetingForm:function(){$j("#voice_custom_greeting_form").submit();}};Zendesk.NS("Voice");Zendesk.Voice.NumberPicker=function(a){this.elem=a;this.pickedNumber=null;};Zendesk.Voice.NumberPicker.prototype={fetchAvailableNumbers:function(){var b=this._getQuery();var a=this;this.elem.find(".area_code_loading_spinner").show();$j.colorbox.resize();$j.get("/voice/phone_numbers/available",{country:b.country,area_code:b.areaCode,contains:b.search,mode:b.mode},function(d){$j("#pre_results").hide();$j(".area_code_loading_spinner").hide();$j("#number_results").html(d);$j("#available_number_list input:radio:first").prop("checked",true);var c=$j("#number_picker");c.find("#number_info").hide();c.find("#number_form .submit input").val("Search again");c.find("#number_results form").submit(function(f){f.preventDefault();picked=c.find(".number_list input:radio:checked");a.showConfirmation(picked.attr("friendly"),picked.attr("region"),picked.attr("price"),b);return false;});new Zendesk.Pager(c.find("#available_number_list"),c.find(".pagination_links .previous"),c.find(".pagination_links .next")).paginate(function(){$j.colorbox.resize();});_.defer(function(){$j.colorbox.resize();});});},changeAreaCode:function(){var a=$j("#number_picker");var c=a.find("#country").val();var b=Zendesk.Voice.NumberResources;if(b[c]["area_code"]){a.find("#area_code_field, .area_code_parens").show();}else{a.find("#area_code_field, .area_code_parens").hide();}a.find("#country_code .code").html("+"+b[c]["code"]);this._setPrefix(c,a,b);$j.colorbox.resize();},_setPrefix:function(d,a,b){a.find("#fixed_prefix").html("");a.find("#toll_free_dropdown").hide();if(b[d]["toll_free"]){a.find("#local_picker").show();var c=a.find("#local").val();if(c==="TollFree"){this._setTollFreePrefix(d,a);this._lastAreaCode=a.find("#area_code").val();}else{if(c==="Local"){a.find("#area_code").val(this._lastAreaCode||"");}}}else{a.find("#local_picker").hide();this._setCountryPrefix(d,a,b);}},_setTollFreePrefix:function(b,a){a.find("#area_code_field").hide();if(b=="US"||b=="CA"){a.find(".area_code_parens").show();a.find("#toll_free_dropdown").show();a.find("#toll_prefix").msDropDown();a.find("#toll_prefix_msdd").width("48px");}else{if(b=="GB"){a.find("#area_code_field, .area_code_parens").hide();a.find("#fixed_prefix").html("800");a.find("#area_code").val("");}}},_setCountryPrefix:function(d,a,c){var b=c[d]["prefix"];if(!b){b="";}a.find("#fixed_prefix").html(b);},_getQuery:function(){var b=Zendesk.Voice.NumberResources;var c=$j("#number_picker");var a=c.find("#country").val();var f=c.find("#area_code").val();var i=c.find("#number").val();var d=b[a]["code"];var e=c.find("#local").val();if(!b[a]["toll_free"]||e==null){e="Local";}if(a=="US"||a=="CA"){if(e=="TollFree"){f=c.find("#toll_prefix").val();c.find("#area_code").val(f);if(f=="Any"){f="";}}}var g=this._searchByPrefix(f,a,b);var h=(i!="");return{country:a,areaCode:f,search:i,countryCode:d,mode:e,searchByPrefix:g,customSearch:h};},_searchByPrefix:function(a,c,b){if(a==""){return false;}return b[c]["area_code"];},showConfirmation:function(d,g,c,f){var a=this;var e={friendlynumber:d,FriendlyName:d,price:c};var b=$j.mustache($j("#confirmation").html(),e);this.elem.find("#number_info").html(b).show();this.elem.find("#number_form").hide();this.elem.find("#number_results").hide();this.elem.find(".number_select_loading_spinner").hide();$j.colorbox.resize();_.defer(function(){$j.colorbox.resize();});this.elem.find("#number_info form").submit(function(h){h.preventDefault();a.addNumber(a.elem.find(".number_list input:radio:checked").val(),f.country,g,f.mode);return false;});this.elem.find(".back a").click(function(h){h.preventDefault();a.elem.find("#number_info").hide();a.elem.find("#number_form").show();a.elem.find("#number_results").show();$j.colorbox.resize();_.defer(function(){$j.colorbox.resize();});});},addNumber:function(a,d,b,c){this.elem.find(".number_select_loading_spinner").show();this.pickedNumber=a;$j.ajax({url:"/voice/phone_numbers/create",type:"POST",data:{phone_number:a,country:d,location:b,mode:c},success:function(e){$j("#number_info").html(e);$j("#number_info a#finished").click(function(f){f.preventDefault();document.location.href="/voice/settings?number_added="+a;});$j.colorbox.resize();},error:function(){$j(".error").html("<p>Error occurred when adding number. Please try again.</p>");$j(".number_select_loading_spinner").hide();$j(".error").show();$j.colorbox.resize();}});Zendesk.Instrumentation.ToTango.track("Enabled Trial","Voice");}};Zendesk.NS("Voice");Zendesk.Voice.Settings={init:function(){this.bindAddNumberLink();this.numberPicker=new Zendesk.Voice.NumberPicker($j("#number_picker"));this.greetingsPicker=new Zendesk.Voice.GreetingsPicker("#greetings_form");this.greetingsPicker.init();},bindAddNumberLink:function(){var a=this;$j("#add_number_link").click(function(b){a.showNumberPicker();if(b){b.preventDefault();}});},showNumberPicker:function(){var a=this;$j("#number_form").html($j.mustache($j("#area_code_search_form").html()));$j("#number_results").html("");$j("#number_picker #country").change(function(b){a.numberPicker.changeAreaCode();});$j("#number_picker #local").change(function(b){a.numberPicker.changeAreaCode();});$j("#number_picker form").submit(function(b){b.preventDefault();a.numberPicker.fetchAvailableNumbers();return false;});$j.colorbox({inline:true,href:"#number_picker",width:"400px",onComplete:function(){var b=$j("#number_picker");b.find("#country").msDropDown();b.find("#local").msDropDown();b.find("#prefix").msDropDown();b.find("#country").focus();}});}};Zendesk.Voice.LiveStats={init:function(){setTimeout(this.refreshLiveStats,2500);setTimeout(this.refreshLast24Stats,15000);},refreshLiveStats:function(){$j.ajax({url:"/voice/calls/current_queue_activity",type:"GET",dataType:"json",success:function(d){var c=parseInt($j(".stat.current_calls_waiting .val").html());if(d.current_calls_waiting!=c){if(d.current_calls_waiting>c){$j(".stat.current_calls_waiting .indicator").addClass("up");$j(".stat.current_calls_waiting .indicator").removeClass("down");}else{$j(".stat.current_calls_waiting .indicator").removeClass("up");$j(".stat.current_calls_waiting .indicator").addClass("down");}$j(".stat.current_calls_waiting .indicator").fadeIn();}else{$j(".stat.current_calls_waiting .indicator").fadeOut();}$j(".stat.current_calls_waiting .val").html(d.current_calls_waiting);$j(".stat.current_avg_wait_time").html(d.current_avg_wait_time);$j(".stat.current_longest_wait_time").html(d.current_longest_wait_time);for(var b=0;b<d.agents.length;b++){var e=d.agents[b][0];var a=d.agents[b][1];$j(".agent-status.agent-"+e).html("<span class='status-"+a+"'>"+d.statuses[a]+"</span>");}}});setTimeout(Zendesk.Voice.LiveStats.refreshLiveStats,5000);},refreshLast24Stats:function(){$j.ajax({url:"/voice/calls/queue_activity_last_24",type:"GET",dataType:"json",success:function(b){$j(".stat.total_calls").html(b.total_calls);$j(".stat.most_calls_waiting").html(b.most_calls_waiting);$j(".stat.avg_wait_time").html(b.avg_wait_time);$j(".stat.longest_wait_time").html(b.longest_wait_time);$j(".stat.avg_talk_time").html(b.avg_talk_time);for(var a=0;a<b.agents.length;a++){var c=b.agents[a];var d=c.id;$j(".agent-stat.available_time.agent-"+d).html(c.available_time);$j(".agent-stat.calls_accepted.agent-"+d).html(c.calls_accepted);$j(".agent-stat.calls_denied.agent-"+d).html(c.calls_denied);$j(".agent-stat.calls_missed.agent-"+d).html(c.calls_missed);$j(".agent-stat.avg_talk_time.agent-"+d).html(c.avg_talk_time);}}});setTimeout(Zendesk.Voice.LiveStats.refreshLast24Stats,30000);}};(function(b,a){a.VoiceMenu=function(){this.name="VoiceMenu";};a.VoiceMenu.prototype={initialize:function(){var d=this;var e=function(g){var f=b(g).attr("data-available");d.updateAvailability(f,"user");};var c=_.throttle(e,100);b("#phone_menu .pick_availability").click(function(f){c(this);f.preventDefault();});if(b.browser.msie&&b.browser.version<8){b("#phone_menu li[data-available='client']").remove();}b("a.audio_settings").click(function(f){f.preventDefault();d.showFlashPermissions(true);});b(window).load(function(){_.defer(function(){a.switchBoard._localStorage.init();a.Voice.logger.log(d,"localStorage init");a.switchBoard.bind("Zendesk.currentUser.availableForVoiceOn",d.updateMenu.bind(d));});});},updateAvailability:function(d,f){var c=this;var e={available:d,reason:f,from:window.location.toString()};a.Voice.logger.log(this,"availability",a.currentUser.availableForVoiceOn,"=>",d,f);b.ajax({url:"/voice/settings/availability",type:"POST",data:e,dataType:"json",success:function(g){a.Voice.logger.log(c,"availability:success",g.available);c.lastReason=f;a.switchBoard.trigger("Zendesk.currentUser.availableForVoiceOn",g.available);},error:function(i,g,h){a.Voice.logger.log(c,"availability:error",g);}});},updateMenu:function(c){var e=this.lastReason;this.lastReason=null;a.Voice.logger.log(this,"menu",a.currentUser.availableForVoiceOn,"=>",c);a.currentUser.availableForVoiceOn=c;b("#phone_menu .pick_availability a").removeClass("on");b("#phone_menu li[data-available='client'] a").toggleClass("on",c==="client");b("#phone_menu li[data-available='phone'] a").toggleClass("on",c==="phone");b("#phone_menu li[data-available='off'] a").toggleClass("on",c==="off");b("#phone_menu #phone_menu_item").toggleClass("on",c!="off");if(c!=="off"&&!this._pubsubEnabled){a.Voice.logger.log(this,"pubsub init");a.switchBoard._pubsub.init();a.CallConsoleApp.subscribeForMessages();this._pubsubEnabled=true;}if(c==="client"){if(e==="user"){var d=this;var f=this.backOff([1,2,4,8],function(){return Twilio.MediaStream&&Twilio.MediaStream.initialized;});f.done(function(){Twilio.MediaStream.__queue(function(){d.showFlashPermissions();});}).fail(function(){a.voiceMenu.updateAvailability("off","twilio-mediastream");alert(I18n.t("txt.voice.error.ec6"));});}}},backOff:function(g,d){var c=b.Deferred(),f=[],e=this;b.each(g,function(j,i){var h=(j==g.length-1);var k=setTimeout(function(){a.Voice.logger.log(e,"twilio-mediastream",i);if(d&&d()){c.resolve(i);}else{if(h){c.reject(i);}}},i*1000);f.push(k);});c.done(function(h){a.Voice.logger.log(e,"twilio-mediastream:done",h);b.each(f,function(j,k){clearTimeout(k);});}).fail(function(h){a.Voice.logger.log(e,"twilio-mediastream:fail",h);});return c.promise();},safeIsMicMuted:function(c){try{return Twilio.MediaStream.isMicMuted();}catch(d){a.Voice.logger.log(this,"mic:failed",d.message);if(c){alert(I18n.t("txt.voice.error.ec7"));}return true;}},catchFlash:function(d){try{d.call(this);}catch(c){if(c.message&&c.message.match("Flash")){a.voiceMenu.updateAvailability("off","flash. "+c.message);alert(I18n.t("txt.voice.error.ec8",{error:c.message}));}throw (c);}},showFlashPermissions:function(d){var c=this;c.catchFlash(function(){if(!Twilio.Device.instance){Twilio.Device.setup(a.CallConsoleApp.capabilityToken);a.Voice.logger.log(c,"flash:setup");}if(c.safeIsMicMuted(true)||d){a.Voice.logger.log(c,"flash:show");Twilio.MediaStream.__queue(function(){Twilio.Device.instance.showSettings(function(){if(c.safeIsMicMuted(false)){if(a.currentUser.availableForVoiceOn==="client"){a.Voice.logger.log(c,"flash:denied");a.voiceMenu.updateAvailability("off","microphone");alert(I18n.t("txt.voice.error.ec9"));}}});});}});}};}(jQuery,Zendesk));if(typeof(Voice)==="undefined"){Voice={};}Voice.Timer=function(a){this.element=$j(a);this.turnOff();};Voice.Timer.prototype={off:function(){return this._lastReset===null;},reset:function(){this._lastReset=new Date();return this;},turnOff:function(){this._lastReset=null;return this;},update:function(){this.element.html(this._toHTML());return this;},_toHTML:function(){if(this._lastReset){var a=this._sinceLastReset();return""+a[0]+"m "+a[1]+"s";}else{return"--";}},_sinceLastReset:function(){var a=((new Date())-this._lastReset)/1000;return[Math.floor(a/60),Math.floor(a%60)];}};(function(a,c,b){b.AlertManager=function(d,e){this._selector=""+d;this._key=""+e;c(d+" a.close").click(this.hide.bind(this));};b.AlertManager.prototype={show:function(){if(a.get(this._key)==null){c(this._selector).show();}},hide:function(d){d&&d.preventDefault&&d.preventDefault();a.set(this._key,"1",14);c(this._selector).hide();return false;}};}(this.Cookie,this.jQuery,this.Zendesk));