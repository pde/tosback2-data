
var bach={version:"1.1"};
jQuery.Controller("bach.ChooseSource",{defaults:{srcs:"",playOn:"",errorOn:"error",onDone:jQuery.noop,onFail:jQuery.noop}},{init:function(){this.sourceCache={};this.defer(this.options);this.setSrc();this._opt_bindings();},_opt_bindings:function(){this.bind(this.options.playOn,this.callback("play"));this.bind(this.options.errorOn,this.callback("errored"));},update:function(options){this.defer(options);this._super(options);this.setSrc();this._opt_bindings();},getSrc:function(){var currSrc=String(this.options.srcs);var parsed;if(currSrc){var cache=this.sourceCache[currSrc];if(typeof cache!="undefined"){return cache;}
parsed=this.parseSource(currSrc);}else{parsed=[];}
return this.sourceCache[currSrc]=parsed;},parseSource:function(src){return src.match(/[^\s]+/g);},setSrc:function(){var sources=this.getSrc();if(sources&&sources.length){this.element.prop("src",this.getSrc()[0]);this.element.get(0).load();}else{this.deferred.reject(this.makePromise(sources));}},fallBack:function(){var srcList=this.getSrc();var rejected=srcList.shift();if(!srcList.length){this.deferred.reject(this.makePromise(rejected));}else{this.setSrc();}},errored:function(){var err=this.element.prop("error");if(err&&err.code==err.MEDIA_ERR_SRC_NOT_SUPPORTED){this.fallBack();}else{this.deferred.reject(this.makePromise(this.getSrc()[0]));}}," loadeddata":function(){this.loaded();},makePromise:function(src){srcList=[].concat(src);return{srcs:function(){return srcList.concat([]);}}},loaded:function(){var loadedSrc=this.getSrc()[0];this.deferred.resolve(this.makePromise(loadedSrc));},defer:function(options){if(bach.fn.isPending(this.deferred)){this.deferred.reject(this.makePromise(this.getSrc()));delete this.deferred;}
this.deferred=jQuery.Deferred();this.deferred.then(options.onDone,options.onFail);},play:function(){if(this.element.prop("paused")){this.element.currentTime=0.1;this.element.get(0).play();}}});
jQuery.Controller("bach.ControlOverVideo",{events:{blocked:"bachcontrolovervideoblocked",unblocked:"bachcontrolovervideounblocked"},defaults:{touchEnd:('ontouchend'in window)?'touchend':'mouseup',touchStart:('ontouchstart'in window)?'touchstart':'mousedown',enableOn:"pause",disableOn:"playing webkitfullscreenchange"}},{init:function(){this.element.data("controls",Boolean(this.element.prop("controls")));this.setControls(this.element.data("controls"),0);this.bind(this.options.enableOn,"enable");this.bind(this.options.disableOn,"disable");},destroy:function(){this.deleteUIState();this.disable();this._super();},saveUIState:function(){if(this.element){this.element.data("saveduistate",{currentTime:this.element.prop("currentTime"),volume:this.element.prop("volume"),muted:this.element.prop("muted"),paused:this.element.prop("paused")});}},deleteUIState:function(){this.element.removeData("saveduistate");},hasUIChanged:function(){if(!this.element){return false;}
var previousState=this.element.data("saveduistate");return(previousState&&(previousState.paused!==this.element.prop("paused")||previousState.currentTime!==this.element.prop("currentTime")||previousState.volume!==this.element.prop("volume")||previousState.muted!==this.element.prop("muted")));},setControls:function(yes,delay){yes=Boolean(yes);if(this.delayer){this.delayer.reject();delete this.delayer;}
if(delay){this.delayer=jQuery.Deferred(function(dfr){var tmr=window.setTimeout(doControls,delay);function doControls(){dfr.resolve(tmr);}
dfr.fail(function(){window.clearTimeout(tmr);});});this.delayer.done(this.callback("setControls",yes,0));}else{if(this.hasUIChanged()){this.saveUIState();this.setControls(yes,1500);}else{if(this.element){this.element.prop("controls",yes);this.element.trigger((yes)?this.constructor.events.blocked:this.constructor.events.unblocked);}}}},enable:function(){if(this.element.prop("webkitDisplayingFullscreen")){return;}
this.saveUIState();this.setControls(false,0);},disable:function(){this.setControls(Boolean(this.element.data("controls")),0);this.deleteUIState();},"{touchStart}":function(){if(!this.element.prop("paused")){return;}
if(typeof this.delayer!="undefined"){this.delayer.reject();delete this.delayer;}
this.saveUIState();},"{touchEnd}":function(){if(!this.element.prop("paused")){return;}
if(this.element.prop("controls")){this.setControls(false,500);}else{this.saveUIState();this.setControls(true,0);this.setControls(false,1500);}}});
bach.fn={getStyleName:function(style,name){name=String(name);if(name in style){return name;}
var apis=['Moz','ms','O','Webkit'];for(var i=0,n=name.charAt(0).toUpperCase().concat(name.substring(1)),l=apis.length;i<l;i++){var cssName=apis[i].concat(n);if(cssName in style){return cssName;}}
return name;},isPending:function(deferred){if(!deferred){return false;}
if('state'in deferred){return(deferred.state()=='pending');}else if('isRejected'in deferred&&'isResolved'in deferred){return(!deferred.isRejected()&&!deferred.isResolved());}},parseNeroliCaptions:function(data){this.data=[];return $(data).find("caption").filter(notEmpty).map(createDataObject);function createDataObject(i,el){el=$(el);return{i:i,r:[parseFloat(el.attr("time")),parseFloat(el.next().attr("time"))],t:el.text()};}
function notEmpty(){return $(this).text().trim().length;}}};
jQuery.Controller('bach.Fullscreen',{defaults:{id:'w3c',cancel:'cancelFullScreen',change:'fullscreenchange',element:'fullScreenElement',enabled:'fullScreenEnabled',error:'fullscreenerror',request:'requestFullScreen'},getInterface:function(el){if('fullScreenElement'in document){return{};}
if('webkitCurrentFullScreenElement'in document){return{id:'wk',cancel:'webkitCancelFullScreen',change:'webkitfullscreenchange',element:'webkitCurrentFullScreenElement',enabled:'webkitIsFullScreen',error:'webkitfullscreenerror',request:'webkitRequestFullScreen'};}
if('webkitExitFullscreen'in el){return{id:'ios4',cancel:'webkitExitFullscreen',fullscreen:'webkitDisplayingFullscreen',request:'webkitEnterFullscreen',enabled:'webkitSupportsFullscreen'};}
if('mozFullScreenElement'in document){return{id:'moz',cancel:'mozCancelFullScreen',change:'mozfullscreenchange',fullscreen:'mozFullScreen',element:'mozFullScreenElement',enabled:'mozFullScreenEnabled',error:'mozfullscreenerror',request:'mozRequestFullScreen'};}
return null;}},{init:function(){this.interfaceId=this.options.id;var on_event='on'.concat(this.options.change);if(on_event in this.element.get(0)){this.bind(this.options.change,this.callback('displaying'));if(on_event in document){$(document).bind(this.options.change,this.callback('displaying'));}}else if('duration'in this.element.get(0)&&this.options.enabled in this.element.get(0)){this.bind('timeupdate playing ended pause',this.callback('displaying'));}
this.bind(this.options.error,this.callback('errored'));this.displaying();},setup:function(el,options){if(typeof options=='undefined'){options=this.constructor.getInterface(el);}
this._super(el,options);},destroy:function(){$(document).unbind(this.options.change,this.callback('displaying'));this._super();},isDisplaying:function(){var el=this.element.get(0);if(this.options.element in document){var e=document[this.options.element];return(e!==null&&e===el);}
if(this.options.fullscreen in el){return Boolean(el[this.options.fullscreen]);}
return false;},displaying:function(){if(typeof this.displayingFullscreen=='undefined'){this.displayingFullscreen=false;this.element.data("bachIsFullScreen",this.displayingFullscreen);}
var curr=this.displayingFullscreen;this.displayingFullscreen=this.isDisplaying();if(curr!=this.displayingFullscreen){this.element.data("bachIsFullScreen",this.displayingFullscreen);this.element.trigger('bachfullscreenchange');}},errored:function(el,ev){this.displaying();this.element.trigger('bachfullscreenerror');},changed:function(el,ev){this.displaying();},timeupdated:function(el,ev){this.displaying();},request:function(){if(this.displayingFullscreen){return;}
var el=this.element.get(0);if(this.options.request in el){try{el[this.options.request].call(el);}catch(e){this.errored();}}},cancel:function(){if(!this.displayingFullscreen){return;}
var el=this.element.get(0);if(this.options.cancel in el){el[this.options.cancel].call(el);}else if(this.options.cancel in document){document[this.options.cancel].call(document);}},toggle:function(){if(this.displayingFullscreen){this.cancel();}else{this.request();}}});
(function($){if(!$||!$.Controller){return;}
var processors=['loadeddata','loadedmetadata','ended','pause','play','playing','progress','timeupdate','volumechange'],shifter=function(context,name){var slice=Array.prototype.slice,method=typeof name=="string"?context[name]:name;return function(){context.called=name;return method.apply(context,[this.nodeName?$(this):this].concat(slice.call(arguments,0)));};},process=function(el,ev,sel,cb,controller){var e=sel?controller.find(sel):$(el),h=shifter(controller,cb);e.bind(ev,h);return(function(){e.unbind(ev,h);});};for(var i=0,p=$.Controller.processors,l=processors.length;i<l;i++){if(processors[i]in p){continue;}
p[processors[i]]=process;}})(jQuery);
jQuery.Controller("bach.Player",{listensTo:["stop"],defaults:{buttonDoneEvent:('ontouchstart'in window)?'touchstart':'click',height:"",msgSrcError:'The media could not be loaded, either because the server or network failed or because the format is not supported.',msgUIError:'The media type requested is not supported in this browser.',qPlaylist:'div.BachPlaylistView',type:"video",width:""},detect:(function(ua){var androidMobile=/android.*mobile|silk/i.test(ua);var inlinePB=!androidMobile&&!(/iphone/i.test(ua));return({audio:Boolean(window.HTMLAudioElement),video:Boolean(window.HTMLVideoElement),inline:inlinePB,touch:('ontouchstart'in window),video_events:!androidMobile,z:inlinePB&&!(/ipad/i.test(ua))});})(window.navigator.userAgent),buttonNames:{audio:"bach:audio",video:"bach:video",playlist:"bach:playlist",player:"bach:player",captions:"bach:captions"},SEE_INITIAL:1,SEE_UI_LOADING:2,SEE_UI_LOADED:3,SEE_UI_RESET:4,SEE_UI_ERROR:5,SEE_MEDIA_EMPTY:6,SEE_MEDIA_LOADING:7,SEE_MEDIA_LOADED:8,SEE_MEDIA_ERROR:9,SEE_PLAYING:10,SEE_PAUSED:11,SEE_ENDED:12},{init:function(){this.currentMediaType(this.options.type);this.element.data("timedtracks",{});this.playlistView=this.find(this.options.qPlaylist);this.captionsView=this.find("div.BachCaptionsView");this.captionsText=this.captionsView.find("div.BachCaptionsText");this.errorView=this.find("div.BachErrorView");this.errorText=this.errorView.find("div.BachErrorText");this.playerStopButton=$(jQuery.grep(this.find('button[name="bach:player"]'),function(el){return $(el).attr('value')=='stop';}));this.see(null,this.constructor.SEE_INITIAL);this.loadUI(true);},setup:function(el,opt){var jEl=$(el);this.mediaView=jEl.find("div.BachMediaView");var video=$("<video>").addClass("BachMediaNone BachMedia BachShade LayoutMax PanelShadow").css("direction","ltr").prop({tabIndex:"1",webkitPlaysInline:true,controls:true}).bach_fullscreen().appendTo(this.mediaView);var audio=$("<audio>").addClass("BachMediaNone LayoutPBottom LayoutPLeft LayoutMaxH PanelShadow").css("direction","ltr").prop({tabIndex:"1"}).appendTo(this.mediaView);this._super(el,opt);},loadUI:function(){this.see(null,this.constructor.SEE_UI_LOADING);var z=parseInt(this.element.css('zIndex'))||parseInt(this.element.offsetParent().css('zIndex'))||0;var posters=this.playlistView.find("div.BachPosterView");if(posters.length>1){var hasTouch=this.constructor.detect.touch;var sweestak=this.playlistView.bach_sweestak({stak:"div.BachPosterView",touchy:hasTouch}).controller();if(!sweestak){return this.see(null,this.constructor.SEE_UI_ERROR);}
this.currentPosterView(sweestak.getCurrStak());z=z+sweestak.stakSize();this.element.bach_sweeroll({stak:this.options.qPlaylist,rollable:!hasTouch});}else{this.currentPosterView($(posters.get(0)));}
this.find(".BachOnTop").each(function(){$(this).css("zIndex",String((parseInt($(this).css("zIndex"))||0)+z));});this.find("button").each(function(){$(this).css("zIndex",String((parseInt($(this).css("zIndex"))||0)+1));});var selector='button[name="'.concat(this.constructor.buttonNames.captions).concat('"]');posters.find(selector).toggleClass('LayoutHidden',!this.constructor.detect.inline);var _this=this;posters.each(function(index){var poster=$(this),captionBtn=poster.find(selector);_this._handleTrackToggle(captionBtn,'captions',poster);_this.enableViewUI(poster,(index===0),index+1);});return this.see(null,this.constructor.SEE_UI_LOADED);},_handleTrackToggle:function(el,type,poster){if(!el||!type||!poster){return;}
el=jQuery(el);var src=(el.is('.Vis5'))?'':el.val();this.enableTrack(poster,type,src);},see:function(media,request){switch(this.seeing){case request:break;case this.constructor.SEE_MEDIA_LOADING:this.seeMediaLoading(false);this.doSee(media,request);break;case this.constructor.SEE_MEDIA_ERROR:this.seeMediaError(media,false);this.doSee(media,request);break;case this.constructor.SEE_UI_ERROR:this.seeUIError(false);this.doSee(media,request);break;case this.constructor.SEE_ENDED:if(request==this.constructor.SEE_PAUSED){break;}
if(request==this.constructor.SEE_PLAYING){break;}
if(request==this.constructor.SEE_MEDIA_LOADING){break;}
if(request==this.constructor.SEE_MEDIA_LOADED){this.seeMediaLoading(false);break;}
this.doSee(media,request);break;default:this.doSee(media,request);}},doSee:function(media,request){switch(request){case this.constructor.SEE_INITIAL:this.seeCanvas(true);break;case this.constructor.SEE_UI_LOADING:this.seePlaylist(false);this.seeClock(true);break;case this.constructor.SEE_UI_RESET:break;case this.constructor.SEE_UI_LOADED:this.seePlaylist(true);this.seeClock(false);break;case this.constructor.SEE_UI_ERROR:this.seeUIError(true);break;case this.constructor.SEE_MEDIA_EMPTY:this.seeMediaLoading(false);this.seeMedia(false);break;case this.constructor.SEE_MEDIA_LOADING:this.seeMediaLoading(true);this.seeSlides(false);break;case this.constructor.SEE_MEDIA_LOADED:this.seeMetadata(false);this.seeMediaLoaded(media,true);break;case this.constructor.SEE_MEDIA_ERROR:this.seeMetadata(false);this.seeMediaLoaded(media,false);this.seeMediaError(media,true);this.seeSlides(false);break;case this.constructor.SEE_PLAYING:this.seePlaying(media,true);break;case this.constructor.SEE_PAUSED:this.seePaused(media,true);break;case this.constructor.SEE_ENDED:this.seeEnded(media,true);this.seeSlides(true);break;default:this.seeCanvas(false);}
this.seeing=request;},seeCanvas:function(yes){if(this.options.height){this.element.height((yes)?this.options.height:"");}
if(this.options.width){this.element.width((yes)?this.options.width:"");}},seeClock:function(yes){this.find(".BachClock").toggleClass("LayoutHidden",!yes);},seeEnded:function(media,yes){var no=!yes;this.seeMetadata(yes);this.seeMediaLoaded(media,no);this.playerStopButton.toggleClass("LayoutHidden",no);this.seeStoppable(no);},seeMedia:function(yes){this.mediaView.toggleClass("BachMediaNone",!yes).find(this.currentMediaType()).toggleClass("BachMediaNone",!yes);},seeMediaError:function(media,yes){if(!yes){return this.seeErrorMessage();}
var err=media.prop('error');if(typeof err=='undefined'){this.seeEnded(media,yes);return;}
if(err===null||err.code==err.MEDIA_ERR_SRC_NOT_SUPPORTED){this.seeErrorMessage(this.options.msgSrcError);}
return;},seeMediaLoaded:function(media,yes){this.seeMedia(yes);if(!yes){if(media.controllers(bach.ControlOverVideo).length){media.bach_control_over_video("destroy");}
if(media.controllers(bach.TrackControl).length){media.bach_track_control("destroy");}}},seeMediaLoading:function(yes){this.playlistView.toggleClass("BachShader",yes);this.seeClock(yes);},seeMetadata:function(yes){this.currentPosterView().find("div.BachMetadataView").toggleClass("BachMediaNone",!yes);},seePlaying:function(media,yes){this.seeMetadata(!yes);this.seeStoppable(!yes);},seePaused:function(media,yes){this.seeStoppable(yes);},seePlaylist:function(yes){this.playlistView.toggleClass("BachMediaNone",!yes);},seeSlides:function(yes){if(this.playlistView.controllers(bach.Sweestak).length){this.playlistView.bach_sweestak("sweeble",yes);}},seeStoppable:function(yes){this.playerStopButton.toggleClass("LayoutHidden",!yes);},seeUIError:function(yes){var no=!yes;this.seeMetadata(no);this.seeErrorMessage((yes)?this.options.msgUIError:'');this.seeSlides(no);},seeErrorMessage:function(msg){var yes=Boolean(msg&&msg.length);this.errorView.toggleClass("BachShader",yes);this.seeStoppable(yes);this.errorText.html(msg);this.errorView.toggleClass('LayoutHidden',!yes);},currentMediaType:function(type){if(arguments.length||typeof type!=="undefined"){this._currentMediaType=type;}
return this._currentMediaType;},currentPosterView:function(el){if(arguments.length||typeof type!=="undefined"){this._currentPosterView=$(el);}
return this._currentPosterView;},enableViewUI:function(view,enable,tabindex){var v=(enable)?'visible':'hidden',btns=$(view).find('button'),i=parseInt(String(tabindex));btns.css('visibility',v);if(!isNaN(i)){btns.each(setTabIndex);}
function setTabIndex(){$(this).attr('tabindex',i.toString());}},startMedia:function(type,srcs){this.see(null,this.constructor.SEE_MEDIA_EMPTY);if(!this.constructor.detect[type]){return this.see(null,this.constructor.SEE_UI_ERROR);}
this.see(null,this.constructor.SEE_MEDIA_LOADING);var media=this.mediaView.find(type),loadedSrcs=jQuery.Deferred();this.currentMediaType(type);if(type=='video'&&this.constructor.detect.inline&&!this.constructor.detect.z){media.bach_control_over_video();}
var supportsEvents=this.constructor.detect[type.concat("_events")];media.bach_choose_source({srcs:srcs,onDone:loadedSrcs.resolve,onFail:loadedSrcs.reject,playOn:(!supportsEvents)?"loadstart":"loadeddata",errorOn:(!supportsEvents)?"load":"error"});var failCallback=this.callback("see",media,this.constructor.SEE_MEDIA_ERROR);loadedSrcs.fail(function(failedSrcs){failCallback();});loadedSrcs.done(this.callback("startTrack","captions"));},startTrack:function(type){var track_src=this.currentPosterView().data(type);if(!track_src){return;}
var cached_track_data=this.cacheTrack(track_src),media=this.find(this.currentMediaType());if(cached_track_data){media.bach_track_control({src:cached_track_data});return;}
var pipe=jQuery.get(track_src).pipe(bach.fn.parseNeroliCaptions);pipe.done(jQuery.proxy(function(data){this.cacheTrack(track_src,data);media.bach_track_control({src:data});},this));},cacheTrack:function(key,data){if(typeof key=="undefined"){return key;}
if(typeof data=="undefined"){return this.element.data("timedtracks")[key]}
return(this.element.data("timedtracks")[key]=data);},enableTrack:function(poster,type,src){if(src){poster.data(type,src);}else{poster.removeData(type);}},play:function(el){if(el.prop("paused")){el.get(0).play();}},stop:function(){this.see(this.find(this.currentMediaType()),this.constructor.SEE_ENDED);},"button {buttonDoneEvent}":function(el){var v=$(el).val(),n=$(el).prop("name");switch(n){case this.constructor.buttonNames.playlist:$("div.BachPlaylistView").trigger(v);break;case this.constructor.buttonNames.player:this.element.trigger(v);break;case this.constructor.buttonNames.video:this.startMedia("video",v);break;case this.constructor.buttonNames.audio:this.startMedia("audio",v);break;case this.constructor.buttonNames.captions:$(el).toggleClass("Vis5");this._handleTrackToggle(el,'captions',this.currentPosterView());break;}},"div.BachPlaylistView bachsweed":function(el,ev){this.enableViewUI(this.currentPosterView(),false);this.currentPosterView(ev.target);this.enableViewUI(this.currentPosterView(),true);this.see(null,this.constructor.SEE_UI_RESET);},"video,audio loadeddata":function(el){this.see(el,this.constructor.SEE_MEDIA_LOADED);},"video,audio ended":function(el){this.see(el,this.constructor.SEE_ENDED);},"video,audio pause":function(el){this.see(el,this.constructor.SEE_PAUSED);},"audio play":function(el){el.css("webkitTransform","translateX(0)");},"video,audio play":function(el){this.see(el,this.constructor.SEE_PLAYING);},"video playing":function(el){this.see(el,(this.constructor.detect.inline?this.constructor.SEE_PLAYING:this.constructor.SEE_ENDED));},"audio playing":function(el){this.see(el,this.constructor.SEE_PLAYING);},'video bachfullscreenchange':function(el,ev){var fs=el.controllers(bach.Fullscreen)[0];if(!fs){return;}
var api=fs.interfaceId;if(!api){return;}
if(api=='ios4'){this.see(el,this.constructor.SEE_ENDED);}},"video bachcontrolovervideoblocked":function(){this.seeStoppable(false);},"video bachcontrolovervideounblocked":function(){this.seeStoppable(true);},"video bachcuestart":function(el,ev,cue){this.captionsText.html(cue.t);this.captionsView.removeClass("LayoutHidden");},"video bachcueend":function(el,ev,cue){this.captionsView.addClass("LayoutHidden");}});
jQuery.Controller('bach.Sweeroll',{defaults:{qButton:'button[name="bach:roll"]',qButtons:'.BachPlaylistBeads',buttonActiveName:'BachButtonBulbOnFill',stak:'',rollable:true}},{init:function(){if(this.options.rollable){this.delegate(this.options.qButton,'click','clicked');}else{this.find(this.options.qButton).each(function(){$(this).attr("disabled","disabled");});}},setup:function(el,options){var jel=$(el).find(options.stak),sweestak=jel.controllers(bach.Sweestak)[0];if(sweestak){var html="";for(var i=0,l=sweestak.stakSize();i<l;i++){html=html.concat('<button name="bach:roll" value="',i,'" class="BachButton BachButtonBulb BachButtonBulbFill LayoutGutterRight',((i>0)?'':' BachButtonBulbOnFill'),'"','tabindex="',(i+1),'">',(i+1),'</button>');}
var buttons=$(el).find(this.constructor.defaults.qButtons).html(html);}
this._super(el,options);},clicked:function(el,ev){this.find(this.options.stak).bach_sweestak('rollStak',parseInt(jQuery(el).val()));},'{stak} bachsweechange':function(el,ev,sweeable){this.find(this.options.qButtons).toggle(sweeable);},'{stak} bachsweed':function(el,ev,id){var css_name=this.options.buttonActiveName;this.find(this.options.qButton).each(function(){jQuery(this).toggleClass(css_name,parseInt(jQuery(this).val())==id);});}});
jQuery.Controller("bach.Sweestak",{defaults:{stak:"img",height:"100%",width:"100%",speed:420,sweeble:true,touchy:true},canvasCss:"BachSweestak LayoutMask LayoutP",stakCss:"Swee LayoutMax Layout LayoutMask LayoutPTop LayoutPLeft StakShadow"},{init:function(){this.element.addClass(this.constructor.canvasCss).width(this.options.width);this.element.height(this.options.height);this.sweelength=this.element.width();this.currStak=0;this.stak();this.parent=this.element.offsetParent();this.bind(this.parent,"resize",$.throttle(500,this.callback("sweeSize")));this.sweeble(this.options.sweeble);},setup:function(el,opt){this._style_names={transitionDuration:bach.fn.getStyleName(el.style,'transitionDuration'),transform:bach.fn.getStyleName(el.style,'transform')};this._supports3D=this._style_names.transform.indexOf('Webkit')>-1;this._super(el,opt);},update:function(options){var update_options=options;this._super(options);this.sweeSize();if(typeof update_options.stak!="undefined"){this.unStak(update_options.stak);this.stak();}
if(typeof options.height!="undefined"){this.element.height(this.options.height);}},destroy:function(){this._super();this.unStak();this.element.removeClass(this.constructor.canvasCss);},hasBackId:function(curr){return this.currStak>0;},hasNext:function(curr){return this.getNextId(curr)!==curr;},getBackId:function(curr){return Math.max(curr-1,0);},getNextId:function(curr){return Math.min(curr+1,this.staks.length-1);},getCurrStak:function(){return this.staks.get(this.currStak);},backStak:function(){if(this.isSweeble&&this.hasBackId(this.currStak)){this.currStak=this.getBackId(this.currStak);this.swee(this.currStak,0,this.options.speed*0.5);this.sweed();}},nextStak:function(){if(this.isSweeble&&this.hasNext(this.currStak)){this.swee(this.currStak,this.sweelength,this.options.speed);this.currStak=this.getNextId(this.currStak);this.sweed();}},rollStak:function(id){if(!this.isSweeble){return;}
id=parseInt(id);if(isNaN(id)){return;}
var move_count=id-this.currStak;if(move_count==0){return;}
var i=0,l=Math.abs(move_count),move_func=this.callback((move_count<0)?'backStak':'nextStak'),stak=function(){if(i<l){move_func();return i++;}
return window.clearInterval(_timer);};stak();var _timer=window.setInterval(stak,this.options.speed/l);},sweeble:function(yes){if(this.isSweeble!=yes){this.element.trigger('bachsweechange',yes);}
this.isSweeble=Boolean(yes);},_handleSwipe:function(event,phase,direction,distance){if(!this.isSweeble||!this.options.touchy){return;}
if(phase=="move"&&(direction=="left"||direction=="right")){var duration=0;if(direction=="left"&&this.hasNext(this.currStak)){this.swee(this.currStak,distance,duration);}
else if(direction=="right"&&this.hasBackId(this.currStak)){this.swee(this.getBackId(this.currStak),this.sweelength-distance,duration);}}else if(phase=="cancel"){if(direction=="right"){this.swee(this.getBackId(this.currStak),this.sweelength,this.options.speed);}else if(direction=="left"){this.swee(this.currStak,0,this.options.speed);}}
else if(phase=="end"){if(direction=="right"){this.backStak();}else if(direction=="left"){this.nextStak();}}
return;},swee:function(stakIndex,distance,duration){var d=(duration/1000).toFixed(1)+"s",left=(distance*-1).toString().concat("px,0px"),t=(this._supports3D)?"translate3d(".concat(left).concat(",0px)"):"translate(".concat(left).concat(")"),stak=$(this.staks.get(stakIndex));var css={};css[this._style_names.transitionDuration]=d;css[this._style_names.transform]=t;stak.css(css);stak.toggleClass('SweePre',distance>0);},sweed:function(){$(this.getCurrStak()).trigger("bachsweed",[this.currStak]);},sweeSize:function(){this.sweelength=$(this.parent).width();},stakSize:function(){return this.staks.length;},stak:function(){this.staks=this.find(this.options.stak).addClass(this.constructor.stakCss).css("overflow","hidden").swipe({triggerOnTouchEnd:true,swipeStatus:this.callback("_handleSwipe"),allowPageScroll:"vertical"});var size=this.staks.length;$.each(this.staks,function(i){var jel=$(this);jel.css("zIndex",String(size-i));});},unStak:function(selector){this.staks=this.find(selector).removeClass(this.constructor.stakCss).css("zIndex","");},"bachback":function(){this.backStak();},"bachnext":function(){this.nextStak();}});
jQuery.Controller("bach.TrackControl",{defaults:{src:""}},{init:function(){this.cueIndex=0;this.activeCue=null;this.currentTime=NaN;this.cues=this.options.src;this.reEnableDelay=null;this.bind("pause","disable");this.bind("play","enable");this.timeUpdateHandler=jQuery.throttle(500,this.callback("timeUpdated"));if(!this.element.prop("paused")){this.enable();}},destroy:function(){this.disable();this._super();},compareCueRange:function(cue){return{started:cue.r[0]<=this.currentTime,ended:cue.r[1]<this.currentTime}},disable:function(reEnableDelay){if(this.element){this.element.unbind("timeupdate",this.timeUpdateHandler);}
this.activateCue(null);if(bach.fn.isPending(this.reEnableDelay)){this.reEnableDelay.reject();delete this.reEnableDelay;}
if(reEnableDelay){this.reEnableDelay=jQuery.Deferred(function(dfr){var tmr=window.setTimeout(doEnable,reEnableDelay);function doEnable(){dfr.resolve(tmr);}
dfr.fail(function(){window.clearTimeout(tmr);});});this.reEnableDelay.done(this.callback("enable"));}},enable:function(){if(bach.fn.isPending(this.reEnableDelay)){this.reEnableDelay.done();delete this.reEnableDelay;return;}
this.setActiveCue();this.bind("timeupdate",this.timeUpdateHandler);},setActiveCue:function(){var currentTime=NaN;if(this.element){currentTime=this.element.prop("currentTime");}
var reverse=currentTime<this.currentTime,d=(reverse)?-1:1;this.currentTime=currentTime;if(this.currentTime){for(var i=this.cueIndex,l=this.cues.length,d=d;i<l&&i>=0;i=i+d){var cue=this.cues[i];if(!cue){continue;}
var cueRange=this.compareCueRange(cue);if(cueRange.ended){continue;}
if(!cueRange.started){if(reverse&&i>0){continue;}else{this.cueIndex=i;break;}}
this.activateCue(cue);this.cueIndex=i;return;}}
this.activateCue(null);},activateCue:function(cue){var ev;if(cue){if(this.activeCue&&this.activeCue.i==cue.i){return;}
this.activeCue=cue;ev='bachcuestart';}else if(this.activeCue){delete this.activeCue;ev='bachcueend';}
if(this.element&&ev){this.element.trigger(ev,cue);}},timeUpdated:function(){if(this.element){if(this.element.prop("seeking")){this.disable(1000);return;}
if(this.element.prop("paused")){this.disable();return;}}
this.setActiveCue();}});